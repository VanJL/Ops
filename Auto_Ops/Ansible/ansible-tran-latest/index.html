

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ansible-cn 1.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  
    <link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />
  

  
    <link rel="top" title="None" href="index.html#document-index"/>
 
<!-- RTD Extra Head -->

    

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="http://ansible-tran.readthedocs.org/en/latest/" />
<script type="text/javascript">
  // This is included here because other places don't have access to the pagename variable.
  var READTHEDOCS_DATA = {
    project: "ansible-tran",
    version: "latest",
    language: "en",
    page: "index",
    builder: "sphinx",
    theme: "sphinx_rtd_theme",
    docroot: "/./",
    
    source_suffix: ".rst",
    
    api_host: "https://readthedocs.org/",
    commit: "4bdb8e9a"
  }
  // Old variables
  var doc_version = "latest";
  var doc_slug = "ansible-tran";
  var page_name = "index";
  var html_theme = "sphinx_rtd_theme";
</script>
<!-- RTD Analytics Code -->
<!-- Included in the header because you don't have a footer block. -->
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-17997319-1']);
  _gaq.push(['_trackPageview']);

  // User Analytics Code
  _gaq.push(['user._setAccount', 'None']);
  _gaq.push(['user._trackPageview']);
  // End User Analytics Code


  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<!-- end RTD Analytics Code -->
<!-- end RTD <extrahead> -->


  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html#document-index" class="icon icon-home"> ansible-cn
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/intro">总体介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/quickstart">快速学习视频</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/playbooks">Playbooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/playbooks_special_topics">Playbooks: Special Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/modules">模块相关</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/guides">详细指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/developing">开发者须知</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/tower">Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/community">Ansible用户</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/community#id6">对当前和未来的开发人员</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/community#id9">其它主题</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/galaxy">Ansible Galaxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/test_strategies">测试策略</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/faq">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/glossary">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-docs/YAMLSyntax">YAML 语法</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html#document-index">ansible-cn</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html#document-index">Docs</a> &raquo;</li>
      
    <li>ansible-cn 1.0.1 documentation</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="https://github.com/stanleylst/ansible-tran/blob/master/./index.rst" class="fa fa-github"> Edit on GitHub</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="welcome-to-ansible-cn-s-documentation">
<h1>Welcome to ansible-cn&#8217;s documentation!<a class="headerlink" href="#welcome-to-ansible-cn-s-documentation" title="Permalink to this headline">¶</a></h1>
<p>Contents:</p>
<div class="toctree-wrapper compound">
<span id="document-docs/intro"></span><div class="section" id="id1">
<h2>总体介绍<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>首先,我们要学一些Ansible的安装和一些基本概念,然后我们会开始研究一些真正有意思的东西 &#8211; playbook,配置管理,部署以及语法编排.我们将会学习如何使用/usr/bin/ansible执行ad-hoc并行命令,我们还会学习ansoble的核心有什么样的模块可供使用.当然以后你也可以写你自己的模块,我们会在后期讲到.</p>
<div class="toctree-wrapper compound">
<span id="document-docs/intro_installation"></span><div class="section" id="installation">
<h3><a class="toc-backref" href="#id8">Installation</a><a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#installation" id="id8">Installation</a><ul>
<li><a class="reference internal" href="#githubansible" id="id9">从Github获取Ansible</a></li>
<li><a class="reference internal" href="#what-will-be-installed" id="id10">需要安装些什么</a></li>
<li><a class="reference internal" href="#what-version" id="id11">选择哪一个版本?</a></li>
<li><a class="reference internal" href="#control-machine-requirements" id="id12">对管理主机的要求</a></li>
<li><a class="reference internal" href="#managed-node-requirements" id="id13">对托管节点的要求</a></li>
<li><a class="reference internal" href="#installing-the-control-machine" id="id14">安装管理主机</a><ul>
<li><a class="reference internal" href="#from-source" id="id15">从源码运行</a></li>
<li><a class="reference internal" href="#yum" id="id16">通过Yum安装最新发布版本</a></li>
<li><a class="reference internal" href="#apt-ubuntu" id="id17">通过Apt (Ubuntu)安装最新发布版本</a></li>
<li><a class="reference internal" href="#portage-gentoo" id="id18">通过 Portage (Gentoo)安装最新发布版本</a></li>
<li><a class="reference internal" href="#pkg-freebsd" id="id19">通过 pkg (FreeBSD)安装最新发布版本</a></li>
<li><a class="reference internal" href="#homebrew-mac-osx" id="id20">通过 Homebrew (Mac OSX)安装最新发布版本</a></li>
<li><a class="reference internal" href="#pip" id="id21">通过 Pip 安装最新发布版本</a></li>
<li><a class="reference internal" href="#tarball" id="id22">发行版的Tarball</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="githubansible">
<span id="getting-ansible"></span><h4><a class="toc-backref" href="#id9">从Github获取Ansible</a><a class="headerlink" href="#githubansible" title="Permalink to this headline">¶</a></h4>
<p>如果你有一个github账户,可以跟进Ansible在Github的项目: <a class="reference external" href="https://github.com/ansible/ansible">Github project</a> 我们在这里保持对bugs和feature ideas的跟踪.</p>
</div>
<div class="section" id="what-will-be-installed">
<span id="id1"></span><h4><a class="toc-backref" href="#id10">需要安装些什么</a><a class="headerlink" href="#what-will-be-installed" title="Permalink to this headline">¶</a></h4>
<p>Ansible默认通过  SSH 协议管理机器.</p>
<p>安装Ansible之后,不需要启动或运行一个后台进程,或是添加一个数据库.只要在一台电脑(可以是一台笔记本)上安装好,就可以通过这台电脑管理一组远程的机器.在远程被管理的机器上,不需要安装运行任何软件,因此升级Ansible版本不会有太多问题.</p>
</div>
<div class="section" id="what-version">
<span id="id2"></span><h4><a class="toc-backref" href="#id11">选择哪一个版本?</a><a class="headerlink" href="#what-version" title="Permalink to this headline">¶</a></h4>
<p>因为Ansible可以很简单的从源码运行,且不必在远程被管理机器上安装任何软件,很多Ansible用户会跟进使用开发版本.</p>
<p>Ansible一般每两个月出一个发行版本.小bugs一般在下一个发行版本中修复,并在稳定分支中做backports.大bugs会在必要时出一个维护版本,虽然这不是很频繁.</p>
<p>若你希望使用Ansible的最新版本,并且你使用的操作系统是 Red Hat Enterprise Linux (TM), CentOS, Fedora, Debian, Ubuntu,我们建议使用系统的软件包管理器.</p>
<p>另有一种选择是通过&#8221;pip&#8221;工具安装,&#8221;pip&#8221;是一个安装和管理Python包的工具.</p>
<p>若你希望跟进开发版本,想使用和测试最新的功能特性,我们会分享如何从源码运行Ansible的方法.从源码运行程序不需要进行软件安装.</p>
</div>
<div class="section" id="control-machine-requirements">
<span id="id3"></span><h4><a class="toc-backref" href="#id12">对管理主机的要求</a><a class="headerlink" href="#control-machine-requirements" title="Permalink to this headline">¶</a></h4>
<p>目前,只要机器上安装了 Python 2.6 (windows系统不可以做控制主机),都可以运行Ansible.</p>
<p>主机的系统可以是 Red Hat, Debian, CentOS, OS X, BSD的各种版本,等等.</p>
</div>
<div class="section" id="managed-node-requirements">
<span id="id4"></span><h4><a class="toc-backref" href="#id13">对托管节点的要求</a><a class="headerlink" href="#managed-node-requirements" title="Permalink to this headline">¶</a></h4>
<p>On the managed nodes, you only need Python 2.4 or later, but if you are running less than Python 2.5 on the remotes, you will also need:</p>
<p>托管节点上需要安装 Python 2.4 及以上的版本.但如果版本低于 Python 2.5 ,则需要额外安装一个模块:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">python-simplejson</span></code></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">没安装python-simplejson,也可以使用Ansible的&#8221;raw&#8221;模块和script模块,因此从技术上讲,你可以通过Ansible的&#8221;raw&#8221;模块安装python-simplejson,之后就可以使用Ansible的所有功能了.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果托管节点上开启了SElinux,你需要安装libselinux-python,这样才可使用Ansible中与copy/file/template相关的函数.你可以通过Ansible的yum模块在需要的托管节点上安装libselinux-python.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Python 3 与 Python 2 是稍有不同的语言,而大多数Python程序还不能在 Python 3 中正确运行.而一些Linux发行版(Gentoo, Arch)没有默认安装 Python 2.X 解释器.在这些系统上,你需要安装一个 Python 2.X 解释器,并在 inventory (详见 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a>) 中设置 &#8216;ansible_python_interpreter&#8217; 变量指向你的 2.X Python.你可以使用 &#8216;raw&#8217; 模块在托管节点上远程安装Python 2.X.</p>
<p class="last">Red Hat Enterprise Linux, CentOS, Fedora, and Ubuntu 等发行版都默认安装了 2.X 的解释器,包括几乎所有的Unix系统也是如此.</p>
</div>
</div>
<div class="section" id="installing-the-control-machine">
<span id="id5"></span><h4><a class="toc-backref" href="#id14">安装管理主机</a><a class="headerlink" href="#installing-the-control-machine" title="Permalink to this headline">¶</a></h4>
<div class="section" id="from-source">
<span id="id6"></span><h5><a class="toc-backref" href="#id15">从源码运行</a><a class="headerlink" href="#from-source" title="Permalink to this headline">¶</a></h5>
<p>从项目的checkout中可以很容易运行Ansible,Ansible的运行不要求root权限,也不依赖于其他软件,不要求运行后台进程,也不需要设置数据库.因此我们社区的许多用户一直使用Ansible的开发版本,这样可以利用最新的功能特性,也方便对项目做贡献.因为不需要安装任何东西,跟进Ansible的开发版相对于其他开源项目要容易很多.</p>
<p>从源码安装的步骤</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>git clone git://github.com/ansible/ansible.git --recursive
<span class="nv">$ </span><span class="nb">cd</span> ./ansible
<span class="nv">$ </span><span class="nb">source</span> ./hacking/env-setup
</pre></div>
</div>
<p>如果没有安装pip, 请先安装对应于你的Python版本的pip:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo easy_install pip
</pre></div>
</div>
<p>以下的Python模块也需要安装:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo pip install paramiko PyYAML Jinja2 httplib2
</pre></div>
</div>
<p>注意,当更新ansible版本时,不只要更新git的源码树,也要更新git中指向Ansible自身模块的 &#8220;submodules&#8221; (不是同一种模块)</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>git pull --rebase
<span class="nv">$ </span>git submodule update --init --recursive
</pre></div>
</div>
<p>一旦运行env-setup脚本,就意味着Ansible从源码中运行起来了.默认的inventory文件是 /etc/ansible/hosts.inventory文件也可以另行指定 (详见 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a>)</p>
<div class="highlight-python"><div class="highlight"><pre>.. code-block:: bash
</pre></div>
</div>
<blockquote>
<div>$ echo &#8220;127.0.0.1&#8221; &gt; ~/ansible_hosts
$ export ANSIBLE_HOSTS=~/ansible_hosts</div></blockquote>
<p>你可以在手册的后续章节阅读更多关于 inventory 文件的使用,现在让我们测试一条ping命令:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -m ping --ask-pass
</pre></div>
</div>
<p>你也可以使用命令 &#8220;sudo make install&#8221;</p>
</div>
<div class="section" id="yum">
<span id="from-yum"></span><h5><a class="toc-backref" href="#id16">通过Yum安装最新发布版本</a><a class="headerlink" href="#yum" title="Permalink to this headline">¶</a></h5>
<p>通过Yum安装RPMs适用于 <a class="reference external" href="http://fedoraproject.org/wiki/EPEL">EPEL</a> 6, 7, 以及仍在支持中的Fedora发行版.</p>
<p>托管节点的操作系统版本可以是更早的版本(如 EL5), 但必须安装 Python 2.4 或更高版本的Python.</p>
<p>Fedora 用户可直接安装Ansible, 但RHEL或CentOS用户,需要 <a class="reference external" href="http://fedoraproject.org/wiki/EPEL">配置 EPEL</a></p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># install the epel-release RPM if needed on CentOS, RHEL, or Scientific Linux</span>
<span class="nv">$ </span>sudo yum install ansible
</pre></div>
</div>
<p>你也可以自己创建RPM软件包.在Ansible项目的checkout的根目录下,或是在一个tarball中,使用 <code class="docutils literal"><span class="pre">make</span> <span class="pre">rpm</span></code> 命令创建RPM软件包.
然后可分发这个软件包或是使用它来安装Ansible.在创建之前,先确定你已安装了 <code class="docutils literal"><span class="pre">rpm-build</span></code>, <code class="docutils literal"><span class="pre">make</span></code>, and <code class="docutils literal"><span class="pre">python2-devel</span></code> .</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>git clone git://github.com/ansible/ansible.git
<span class="nv">$ </span><span class="nb">cd</span> ./ansible
<span class="nv">$ </span>make rpm
<span class="nv">$ </span>sudo rpm -Uvh ~/rpmbuild/ansible-*.noarch.rpm
</pre></div>
</div>
</div>
<div class="section" id="apt-ubuntu">
<span id="from-apt"></span><h5><a class="toc-backref" href="#id17">通过Apt (Ubuntu)安装最新发布版本</a><a class="headerlink" href="#apt-ubuntu" title="Permalink to this headline">¶</a></h5>
<p>Ubuntu 编译版可在PPA中获得: ` &lt;<a class="reference external" href="https://launchpad.net/~ansible/+archive/ansible">https://launchpad.net/~ansible/+archive/ansible</a>&gt;`_.</p>
<p>配置PPA及安装ansible,执行如下命令:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install software-properties-common
<span class="nv">$ </span>sudo apt-add-repository ppa:ansible/ansible
<span class="nv">$ </span>sudo apt-get update
<span class="nv">$ </span>sudo apt-get install ansible
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在早期Ubuntu发行版中, &#8220;software-properties-common&#8221; 名为 &#8220;python-software-properties&#8221;.</p>
</div>
<p>也可从源码checkout中创建 Debian/Ubuntu 软件包,执行:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>make deb
</pre></div>
</div>
<p>你或许也想从源码中运行最新发行版本,可看前面的说明.</p>
</div>
<div class="section" id="portage-gentoo">
<span id="from-pkg"></span><h5><a class="toc-backref" href="#id18">通过 Portage (Gentoo)安装最新发布版本</a><a class="headerlink" href="#portage-gentoo" title="Permalink to this headline">¶</a></h5>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>emerge -av app-admin/ansible
</pre></div>
</div>
<p>要安装最新版本,你或许需要...</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;app-admin/ansible&#39;</span> &gt;&gt; /etc/portage/package.accept_keywords
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">若在Gentoo托管节点中,Python 3 默认作为 Python slot(这也是默认设置),则你必须在你的 group 或 inventory 变量中设置 <code class="docutils literal"><span class="pre">ansible_python_interpreter</span> <span class="pre">=</span> <span class="pre">/usr/bin/python2</span></code></p>
</div>
</div>
<div class="section" id="pkg-freebsd">
<h5><a class="toc-backref" href="#id19">通过 pkg (FreeBSD)安装最新发布版本</a><a class="headerlink" href="#pkg-freebsd" title="Permalink to this headline">¶</a></h5>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo pkg install ansible
</pre></div>
</div>
<p>你或许想从ports中安装:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>sudo make -C /usr/ports/sysutils/ansible install
</pre></div>
</div>
</div>
<div class="section" id="homebrew-mac-osx">
<span id="from-brew"></span><h5><a class="toc-backref" href="#id20">通过 Homebrew (Mac OSX)安装最新发布版本</a><a class="headerlink" href="#homebrew-mac-osx" title="Permalink to this headline">¶</a></h5>
<p>在Mac中安装,确定你已安装 Homebrew:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>brew update
<span class="nv">$ </span>brew install ansible
</pre></div>
</div>
</div>
<div class="section" id="pip">
<span id="from-pip"></span><h5><a class="toc-backref" href="#id21">通过 Pip 安装最新发布版本</a><a class="headerlink" href="#pip" title="Permalink to this headline">¶</a></h5>
<p>Ansible可通过 &#8220;pip&#8221; 安装(安装和管理Python包的工具),若你还没有安装 pip,可执行如下命令安装:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo easy_install pip
</pre></div>
</div>
<p>然后安装Ansible:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo pip install ansible
</pre></div>
</div>
<p>如果你是在 OS X Mavericks 上安装,编译器可能或告警或报错,可通过如下设置避免这种情况:</p>
<div class="highlight-python"><div class="highlight"><pre>$ sudo CFLAGS=-Qunused-arguments CPPFLAGS=-Qunused-arguments pip install ansible
</pre></div>
</div>
<p>使用 virtualenv 的读者可通过 virtualenv 安装 Ansible, 然而我们建议不用这样做,直接在全局安装 Ansible.不要使用 easy_install 直接安装 ansible.</p>
</div>
<div class="section" id="tarball">
<span id="tagged-releases"></span><h5><a class="toc-backref" href="#id22">发行版的Tarball</a><a class="headerlink" href="#tarball" title="Permalink to this headline">¶</a></h5>
<p>不想通过git checkout 创建Ansible的软件包？在这里可获取Tarball <a class="reference external" href="http://releases.ansible.com/ansible">Ansible downloads</a></p>
<p>各种版本的Ansible在这里做了版本标注 <a class="reference external" href="https://github.com/ansible/ansible/releases">git repository</a></p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-docs/intro_getting_started"></span><div class="section" id="id1">
<h3><a class="toc-backref" href="#id6">新手上路</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id6">新手上路</a><ul>
<li><a class="reference internal" href="#gs-about" id="id7">前言</a></li>
<li><a class="reference internal" href="#id3" id="id8">你的第一条命令</a></li>
<li><a class="reference internal" href="#a-note-about-host-key-checking" id="id9">公钥认证</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="gs-about">
<span id="id2"></span><h4><a class="toc-backref" href="#id7">前言</a><a class="headerlink" href="#gs-about" title="Permalink to this headline">¶</a></h4>
<p>现在你已经阅读了 <a class="reference internal" href="index.html#document-docs/intro_installation"><em>Installation</em></a> 安装指南并安装了Ansible.是时候通过一些命令开始深入了解Ansible了.</p>
<p>我们最先展示的并非那强大的集配置,部署,自动化于一身的playbook.
Playbooks 相关内容将在另一章节中讲述.</p>
<p>本章节讲述如何进行初始化.一旦你有了这些概念,请去阅读 <a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a> 以获取更多细节,然后你就能去深入playbook并探索它最有趣的部分.</p>
<p id="remote-connection-information">远程连接概述</p>
<hr class="docutils" />
<p>在我们开始前要先理解Ansible是如何通过SSH与远程服务器连接是很重要的.</p>
<p>Ansible 1.3及之后的版本默认会在本地的 OpenSSH可用时会尝试用其进行远程通讯.这会启用ControlPersist(一个性能特性),Kerberos,和在~/.ssh/config中的配置选项如 Jump Host setup.然而,当你使用Linux企业版6作为主控机(红帽企业版及其衍生版如CentOS),其OpenSSH版本可能过于老旧无法支持ControlPersist.
在这些操作系统中,Ansible将会退回并采用 paramiko (由Python实现的高质量OpenSSH库).
如果你希望能够使用像是Kerberized SSH之类的特性,烦请考虑使用Fedora, OS X, 或 Ubuntu 作为你的主控机直到相关平台上有更新版本的OpenSSH可供使用,或者启用Ansible的“accelerated mode”.参见 <a class="reference internal" href="index.html#document-docs/playbooks_acceleration"><em>Accelerated Mode</em></a>.</p>
<p>在Ansible 1.2 及之前的版本,默认将会使用 paramiko. 本地OpenSSH必须通过-c ssh 或者 在配置文件中设定.</p>
<p>你偶尔会遇到不支持SFTP的设备.虽然这很少见,但你会有概率中奖.你可以通过在配置文件(<a class="reference internal" href="index.html#document-docs/intro_configuration"><em>Ansible的配置文件</em></a>)中切换至 SCP模式来与之链接.</p>
<p>说起远程设备,Ansible会默认假定你使用 SSH Key(我们推荐这种)但是密码也一样可以.通过在需要的地方添加 &#8211;ask-pass选项 来启用密码验证.如果使用了sudo 特性,当sudo需要密码时,也同样适当的提供了&#8211;ask-sudo-pass选项.</p>
<p>也许这是常识,但也值得分享:任何管理系统受益于被管理的机器在主控机附近运行.如果在云中运行,可以考虑在使用云中的一台机器来运行Ansible.</p>
<p>作为一个进阶话题,Ansible不止支持SSH来远程连接.连接方式是插件化的而且还有许多本地化管理的选项诸如管理 chroot, lxc, 和 jail containers.一个叫做‘ansible-pull’的模式能够反转主控关系并使远程系统通过定期从中央git目录检出 并 拉取 配置指令来实现背景连接通信.</p>
</div>
<div class="section" id="id3">
<span id="id4"></span><h4><a class="toc-backref" href="#id8">你的第一条命令</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>现在你已经安装了Ansible,是时候从一些基本知识开始了.
编辑(或创建)/etc/ansible/hosts 并在其中加入一个或多个远程系统.你的public SSH key必须在这些系统的``authorized_keys``中:</p>
<div class="highlight-python"><div class="highlight"><pre>192.168.1.50
aserver.example.org
bserver.example.org
</pre></div>
</div>
<p>这里有个节点设置文件(inventory file)将会在 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a> 中得到深入说明.
我们假定你使用SSH Key来授权.为了避免在建立SSH连接时,重复输入密码你可以这么
做:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ssh-agent bash
<span class="nv">$ </span>ssh-add ~/.ssh/id_rsa
</pre></div>
</div>
<p>(根据你的建立方式,你也许希望使用Ansible的 <code class="docutils literal"><span class="pre">--private-key</span></code> 选项,通过指定pem文件来代替SSH Key来授权)
现在ping 你的所有节点:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -m ping
</pre></div>
</div>
<p>Ansible会像SSH那样试图用你的当前用户名来连接你的远程机器.要覆写远程用户名,只需使用&#8217;-u&#8217;参数.
如果你想访问 sudo模式,这里也有标识(flags)来实现:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># as bruce</span>
<span class="nv">$ </span>ansible all -m ping -u bruce
<span class="c"># as bruce, sudoing to root</span>
<span class="nv">$ </span>ansible all -m ping -u bruce --sudo
<span class="c"># as bruce, sudoing to batman</span>
<span class="nv">$ </span>ansible all -m ping -u bruce --sudo --sudo-user batman
</pre></div>
</div>
<p>(如果你碰巧想要使用其他sudo的实现方式,你可以通过修改Ansible的配置文件来实现.也可以通过传递标识给sudo(如-H)来设置.)
现在对你的所有节点运行一个命令:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -a <span class="s2">&quot;/bin/echo hello&quot;</span>
</pre></div>
</div>
<p>恭喜你！你刚刚通过Ansible连接了你的所有节点.很快你就会阅读更多的关于现实案例 <a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a> 并探索可以通过不同的模块做什么以及研究Ansible的playbook语言</p>
<p><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> .Ansible不只是能运行命令,它同样也拥有强大的配置管理和部署特性.虽然还有更多内容等待你的探索,但你基础设施已经能完全工作了！</p>
</div>
<div class="section" id="a-note-about-host-key-checking">
<span id="id5"></span><h4><a class="toc-backref" href="#id9">公钥认证</a><a class="headerlink" href="#a-note-about-host-key-checking" title="Permalink to this headline">¶</a></h4>
<p>Ansible1.2.1及其之后的版本都会默认启用公钥认证.</p>
<p>如果有个主机重新安装并在“known_hosts”中有了不同的key,这会提示一个错误信息直到被纠正为止.在使用Ansible时,你可能不想遇到这样的情况:如果有个主机没有在“known_hosts”中被初始化将会导致在交互使用Ansible或定时执行Ansible时对key信息的确认提示.</p>
<p>如果你想禁用此项行为并明白其含义,你能够通过编辑 /etc/ansible/ansible.cfg or ~/.ansible.cfg来实现:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">defaults</span><span class="p">]</span>
<span class="n">host_key_checking</span> <span class="o">=</span> <span class="bp">False</span>
</pre></div>
</div>
<p>或者你也可以通过设置环境变量来实现:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False
</pre></div>
</div>
<p>同样注意在paramiko 模式中 公钥认证 相当的慢.因此,当使用这项特性时,切换至&#8217;SSH&#8217;是推荐做法.</p>
<p id="a-note-about-logging">Ansible将会对远程系统模块参数记录在远程的syslog中,除非一个任务或者play被标记了“no_log: True”属性,稍后解释.
在主控机上启用基本的日志功能参见 <a class="reference internal" href="index.html#document-docs/intro_configuration"><em>Ansible的配置文件</em></a> 文档 并 在配置文件中设置&#8217;log_path&#8217;.企业用户可能也对 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> 感兴趣.</p>
<p>塔提供了非常实用数据库日志.它使一次次向下钻取并查看基于主机,项目,和特定的结果集成为可能———— 同时提供了图形和 RESTful API.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a></dt>
<dd>More information about inventory</dd>
<dt><a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Learning Ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/intro_inventory"></span><div class="section" id="inventory">
<span id="id1"></span><h3><a class="toc-backref" href="#id7">Inventory文件</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#inventory" id="id7">Inventory文件</a><ul>
<li><a class="reference internal" href="#inventoryformat" id="id8">主机与组</a></li>
<li><a class="reference internal" href="#host-variables" id="id9">主机变量</a></li>
<li><a class="reference internal" href="#group-variables" id="id10">组的变量</a></li>
<li><a class="reference internal" href="#subgroups" id="id11">把一个组作为另一个组的子成员</a></li>
<li><a class="reference internal" href="#host-group" id="id12">分文件定义 Host 和 Group 变量</a></li>
<li><a class="reference internal" href="#behavioral-parameters" id="id13">Inventory 参数的说明</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible 可同时操作属于一个组的多台主机,组和主机之间的关系通过 inventory 文件配置.
默认的文件路径为 /etc/ansible/hosts</p>
<p>除默认文件外,你还可以同时使用多个 inventory 文件(后面会讲到),也可以从动态源,或云上拉取 inventory 配置信息.详见 <a class="reference internal" href="index.html#document-docs/intro_dynamic_inventory"><em>动态 Inventory</em></a>.</p>
<div class="section" id="inventoryformat">
<span id="id2"></span><h4><a class="toc-backref" href="#id8">主机与组</a><a class="headerlink" href="#inventoryformat" title="Permalink to this headline">¶</a></h4>
<p>/etc/ansible/hosts 文件的格式与windows的ini配置文件类似:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">mail</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="p">[</span><span class="n">webservers</span><span class="p">]</span>
<span class="n">foo</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">bar</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="p">[</span><span class="n">dbservers</span><span class="p">]</span>
<span class="n">one</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">two</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">three</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>方括号[]中是组名,用于对系统进行分类,便于对不同系统进行个别的管理.</p>
<p>一个系统可以属于不同的组,比如一台服务器可以同时属于 webserver组 和 dbserver组.这时属于两个组的变量都可以为这台主机所用,至于变量的优先级关系将于以后的章节中讨论.</p>
<p>如果有主机的SSH端口不是标准的22端口,可在主机名之后加上端口号,用冒号分隔.SSH 配置文件中列出的端口号不会在 paramiko 连接中使用,会在 openssh 连接中使用.</p>
<p>端口号不是默认设置时,可明确的表示为:</p>
<div class="highlight-python"><div class="highlight"><pre>badwolf.example.com:5309
</pre></div>
</div>
<p>假设你有一些静态IP地址,希望设置一些别名,但不是在系统的 host 文件中设置,又或者你是通过隧道在连接,那么可以设置如下:</p>
<div class="highlight-python"><div class="highlight"><pre>jumper ansible_ssh_port=5555 ansible_ssh_host=192.168.1.50
</pre></div>
</div>
<p>在这个例子中,通过 &#8220;jumper&#8221; 别名,会连接 192.168.1.50:5555.记住,这是通过 inventory 文件的特性功能设置的变量.
一般而言,这不是设置变量(描述你的系统策略的变量)的最好方式.后面会说到这个问题.</p>
<p>一组相似的 hostname , 可简写如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">webservers</span><span class="p">]</span>
<span class="n">www</span><span class="p">[</span><span class="mo">01</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>数字的简写模式中,01:50 也可写为 1:50,意义相同.你还可以定义字母范围的简写模式:</p>
<div class="highlight-python"><div class="highlight"><pre>[databases]
db-[a:f].example.com
</pre></div>
</div>
<p>对于每一个 host,你还可以选择连接类型和连接用户名:</p>
<div class="highlight-python"><div class="highlight"><pre>[targets]

localhost              ansible_connection=local
other1.example.com     ansible_connection=ssh        ansible_ssh_user=mpdehaan
other2.example.com     ansible_connection=ssh        ansible_ssh_user=mdehaan
</pre></div>
</div>
<p>所有以上讨论的对于 inventory 文件的设置是一种速记法,后面我们会讨论如何将这些设置保存为 &#8216;host_vars&#8217; 目录中的独立的文件.</p>
</div>
<div class="section" id="host-variables">
<span id="id3"></span><h4><a class="toc-backref" href="#id9">主机变量</a><a class="headerlink" href="#host-variables" title="Permalink to this headline">¶</a></h4>
<p>前面已经提到过,分配变量给主机很容易做到,这些变量定义后可在 playbooks 中使用:</p>
<div class="highlight-python"><div class="highlight"><pre>[atlanta]
host1 http_port=80 maxRequestsPerChild=808
host2 http_port=303 maxRequestsPerChild=909
</pre></div>
</div>
</div>
<div class="section" id="group-variables">
<span id="id4"></span><h4><a class="toc-backref" href="#id10">组的变量</a><a class="headerlink" href="#group-variables" title="Permalink to this headline">¶</a></h4>
<p>也可以定义属于整个组的变量:</p>
<div class="highlight-python"><div class="highlight"><pre>[atlanta]
host1
host2

[atlanta:vars]
ntp_server=ntp.atlanta.example.com
proxy=proxy.atlanta.example.com
</pre></div>
</div>
</div>
<div class="section" id="subgroups">
<span id="id5"></span><h4><a class="toc-backref" href="#id11">把一个组作为另一个组的子成员</a><a class="headerlink" href="#subgroups" title="Permalink to this headline">¶</a></h4>
<p>可以把一个组作为另一个组的子成员,以及分配变量给整个组使用.
这些变量可以给 /usr/bin/ansible-playbook 使用,但不能给 /usr/bin/ansible 使用:</p>
<div class="highlight-python"><div class="highlight"><pre>[atlanta]
host1
host2

[raleigh]
host2
host3

[southeast:children]
atlanta
raleigh

[southeast:vars]
some_server=foo.southeast.example.com
halon_system_timeout=30
self_destruct_countdown=60
escape_pods=2

[usa:children]
southeast
northeast
southwest
northwest
</pre></div>
</div>
<p>如果你需要存储一个列表或hash值,或者更喜欢把 host 和 group 的变量分开配置,请看下一节的说明.</p>
</div>
<div class="section" id="host-group">
<span id="splitting-out-vars"></span><h4><a class="toc-backref" href="#id12">分文件定义 Host 和 Group 变量</a><a class="headerlink" href="#host-group" title="Permalink to this headline">¶</a></h4>
<p>在 inventory 主文件中保存所有的变量并不是最佳的方式.还可以保存在独立的文件中,这些独立文件与 inventory 文件保持关联.
不同于 inventory 文件(INI 格式),这些独立文件的格式为 YAML.详见 <a class="reference internal" href="index.html#document-docs/YAMLSyntax"><em>YAML 语法</em></a> .</p>
<p>假设 inventory 文件的路径为:</p>
<div class="highlight-python"><div class="highlight"><pre>/etc/ansible/hosts
</pre></div>
</div>
<p>假设有一个主机名为 &#8216;foosball&#8217;, 主机同时属于两个组,一个是 &#8216;raleigh&#8217;, 另一个是 &#8216;webservers&#8217;.
那么以下配置文件(YAML 格式)中的变量可以为 &#8216;foosball&#8217; 主机所用.依次为 &#8216;raleigh&#8217; 的组变量,&#8217;webservers&#8217; 的组变量,&#8217;foosball&#8217; 的主机变量:</p>
<div class="highlight-python"><div class="highlight"><pre>/etc/ansible/group_vars/raleigh
/etc/ansible/group_vars/webservers
/etc/ansible/host_vars/foosball
</pre></div>
</div>
<p>举例来说,假设你有一些主机,属于不同的数据中心,并依次进行划分.每一个数据中心使用一些不同的服务器.比如 ntp 服务器, database 服务器等等.
那么 &#8216;raleigh&#8217; 这个组的组变量定义在文件 &#8216;/etc/ansible/group_vars/raleigh&#8217; 之中,可能类似这样:</p>
<div class="highlight-python"><div class="highlight"><pre>---
ntp_server: acme.example.org
database_server: storage.example.org
</pre></div>
</div>
<p>这些定义变量的文件不是一定要存在,因为这是可选的特性.</p>
<p>还有更进一步的运用,你可以为一个主机,或一个组,创建一个目录,目录名就是主机名或组名.目录中的可以创建多个文件,
文件中的变量都会被读取为主机或组的变量.如下 &#8216;raleigh&#8217; 组对应于 /etc/ansible/group_vars/raleigh/ 目录,其下有两个文件
db_settings 和 cluster_settings, 其中分别设置不同的变量:</p>
<div class="highlight-python"><div class="highlight"><pre>/etc/ansible/group_vars/raleigh/db_settings
/etc/ansible/group_vars/raleigh/cluster_settings
</pre></div>
</div>
<p>&#8216;raleigh&#8217; 组下的所有主机,都可以使用 &#8216;raleigh&#8217; 组的变量.当变量变得太多时,分文件定义变量更方便我们进行管理和组织.
还有一个方式也可参考,详见 <a class="reference internal" href="index.html#document-docs/playbooks_vault"><em>Ansible Vault</em></a> 关于组变量的部分.
注意,分文件定义变量的方式只适用于 Ansible 1.4 及以上版本.</p>
<p>Tip: Ansible 1.2 及以上的版本中,group_vars/ 和 host_vars/ 目录可放在 inventory 目录下,或是 playbook 目录下.
如果两个目录下都存在,那么 playbook 目录下的配置会覆盖 inventory 目录的配置.</p>
<p>Tip: 把你的 inventory 文件 和 变量 放入 git repo 中,以便跟踪他们的更新,这是一种非常推荐的方式.</p>
</div>
<div class="section" id="behavioral-parameters">
<span id="id6"></span><h4><a class="toc-backref" href="#id13">Inventory 参数的说明</a><a class="headerlink" href="#behavioral-parameters" title="Permalink to this headline">¶</a></h4>
<p>如同前面提到的,通过设置下面的参数,可以控制 ansible 与远程主机的交互方式,其中一些我们已经讲到过:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible_ssh_host
      将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.

ansible_ssh_port
      ssh端口号.如果不是默认的端口号,通过此变量设置.

ansible_ssh_user
      默认的 ssh 用户名

ansible_ssh_pass
      ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)

ansible_sudo_pass
      sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)

ansible_sudo_exe (new in version 1.8)
      sudo 命令路径(适用于1.8及以上版本)

ansible_connection
      与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 &#39;smart&#39;,&#39;smart&#39; 方式会根据是否支持 ControlPersist, 来判断&#39;ssh&#39; 方式是否可行.

ansible_ssh_private_key_file
      ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.

ansible_shell_type
      目标系统的shell类型.默认情况下,命令的执行使用 &#39;sh&#39; 语法,可设置为 &#39;csh&#39; 或 &#39;fish&#39;.

ansible_python_interpreter
      目标主机的 python 路径.适用于的情况: 系统中有多个 Python, 或者命令路径不是&quot;/usr/bin/python&quot;,比如  \*BSD, 或者 /usr/bin/python
      不是 2.X 版本的 Python.我们不使用 &quot;/usr/bin/env&quot; 机制,因为这要求远程用户的路径设置正确,且要求 &quot;python&quot; 可执行程序名不可为 python以外的名字(实际有可能名为python26).

      与 ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径....
</pre></div>
</div>
<p>一个主机文件的例子:</p>
<div class="highlight-python"><div class="highlight"><pre>some_host         ansible_ssh_port=2222     ansible_ssh_user=manager
aws_host          ansible_ssh_private_key_file=/home/example/.ssh/aws.pem
freebsd_host      ansible_python_interpreter=/usr/local/bin/python
ruby_module_host  ansible_ruby_interpreter=/usr/bin/ruby.1.9.3
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_dynamic_inventory"><em>动态 Inventory</em></a></dt>
<dd>Pulling inventory from dynamic sources, such as cloud providers</dd>
<dt><a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/intro_dynamic_inventory"></span><div class="section" id="inventory">
<span id="dynamic-inventory"></span><h3><a class="toc-backref" href="#id4">动态 Inventory</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#inventory" id="id4">动态 Inventory</a><ul>
<li><a class="reference internal" href="#cobbler-inventory" id="id5">Cobbler 外部 Inventory 脚本</a></li>
<li><a class="reference internal" href="#aws-ec2-inventory" id="id6">AWS EC2 外部 inventory 脚本</a></li>
<li><a class="reference internal" href="#other-inventory-scripts" id="id7">其它 inventory 脚本</a></li>
<li><a class="reference internal" href="#using-multiple-sources" id="id8">使用多个 inventory 源</a></li>
<li><a class="reference internal" href="#static-groups-of-dynamic" id="id9">动态组作为静态组的子组</a></li>
</ul>
</li>
</ul>
</div>
<p>使用配置管理系统经常有一种需求,可能要在其他的软件系统中保存自己的 inventory 配置信息.</p>
<p>Ansible 本身通过基于文本的方式来记录 inventory 配置信息,这在前面已介绍过（详见 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a> ）.</p>
<p>除此之外,Ansible 也支持用其他方式保存配置信息.</p>
<p>在其他软件系统保存配置信息的例子有:</p>
<div class="highlight-python"><div class="highlight"><pre>1, 从云端拉取 inventory
2, LDAP（Lightweight Directory Access Protocol,轻量级目录访问协议）
3, `Cobbler &lt;http://cobbler.github.com&gt;`_
4, 或者是一份昂贵的企业版的 CMDB（配置管理数据库） 软件.
</pre></div>
</div>
<p>对于这些需求,Ansible 可通过一个外部 inventory 系统来支持.在 ansible 的 &#8220;/plugins&#8221; 插件目录下已经含有一些选项 &#8211; 包括 EC2/Eucalyptus, Rackspace Cloud,and OpenStack,我们稍后会详细介绍它们.</p>
<p>Ansible <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> 提供了一个数据库来存储 inventory 配置信息, 这个数据库可以通过 web 访问,或通过 REST 访问.
Tower 与所有你使用的 Ansible 动态 inventory 源保持同步,并提供了一个图形化的 inventory 编辑器.
有了这个数据库,便可以很容易的关联过去的事件历史,可以看到在上一次 playbook 运行时,哪里出现了运行失败的情况.</p>
<p>关于如何编写你自己的动态 inventory 源,请参见 <a class="reference internal" href="index.html#document-docs/developing_inventory"><em>开发动态的Inventory数据源</em></a>.</p>
<div class="section" id="cobbler-inventory">
<span id="cobbler-example"></span><h4><a class="toc-backref" href="#id5">Cobbler 外部 Inventory 脚本</a><a class="headerlink" href="#cobbler-inventory" title="Permalink to this headline">¶</a></h4>
<p>当管理的物理机器到达了一定数量的时,很多使用 Ansible 的用户可能同时也会使用到 <a class="reference external" href="http://cobbler.github.com">Cobbler</a> .
（注: Cobbler 最初由 Michael DeHaan 编写,现在项目主导人是 James Cammarata, 他目前在 Ansible 公司工作）.</p>
<p>Cobbler 主要用于操作系统的 kickoff 安装,以及管理 DHCP 和 DNS,除此之外,它有一个通用层,可为多种配置管理系统（甚至是同时的）提供数据.
所以 Cobbler 也被一些管理员称为是轻量级的 CMDB.</p>
<p>如何将 Ansible 的 inventory 与 Cobbler 联系起来呢？方法是:
将脚本 <a class="reference external" href="https://raw.github.com/ansible/ansible/devel/plugins/inventory/cobbler.py">script</a> 拷贝到 /etc/ansible,通过 <cite>chmod +x</cite> 赋予可执行权限.</p>
<p>在使用 Ansible 之前,先启动 cobblerd 进程.</p>
<p>现在使用 Ansible 要加上  <code class="docutils literal"><span class="pre">-i</span></code> 选项 （ 例如:<code class="docutils literal"><span class="pre">-i</span> <span class="pre">/etc/ansible/cobbler.py</span></code>）.cobbler.py这个脚本使用 Cobbler 的 XMLRPC API 与 Cobbler 通信.</p>
<p>执行脚本 <code class="docutils literal"><span class="pre">/etc/ansible/cobbler.py</span></code> ,应该能看到一些 JSON 格式的数据输出（也许还没有具体的内容）.</p>
<p>在 cobbler 中,假设有一个如下的场景:</p>
<div class="highlight-python"><div class="highlight"><pre>cobbler profile add --name=webserver --distro=CentOS6-x86_64
cobbler profile edit --name=webserver --mgmt-classes=&quot;webserver&quot; --ksmeta=&quot;a=2 b=3&quot;
cobbler system edit --name=foo --dns-name=&quot;foo.example.com&quot; --mgmt-classes=&quot;atlanta&quot; --ksmeta=&quot;c=4&quot;
cobbler system edit --name=bar --dns-name=&quot;bar.example.com&quot; --mgmt-classes=&quot;atlanta&quot; --ksmeta=&quot;c=5&quot;
</pre></div>
</div>
<p>&#8216;foo.example.com&#8217; 是一个域名,Ansible 可以通过这个域名寻址找到对应的主机foo,对其进行操作.也可以通过组名 &#8216;webserver&#8217; 或者 &#8216;atlanta&#8217; 寻址找到这个主机,只要这个主机是属于这两个组的.直接使用 foo 是不行的.例如执行命令 &#8220;ansible foo&#8221; ,无法找到该主机,但使用 &#8220;ansible &#8216;foo*&#8217;&#8221; 却可以,因为域名 &#8216;foo.example.com&#8217; 以foo开头.</p>
<p>这个脚本不仅提供主机和组的信息.如果运行了 &#8216;setup&#8217; 模块（只要使用 playbooks,&#8217;setup&#8217; 模块会自动运行）,变量 a, b, c 可按照以下模板自动填充:</p>
<div class="highlight-python"><div class="highlight"><pre># file: /srv/motd.j2
Welcome, I am templated with a value of a={{ a }}, b={{ b }}, and c={{ c }}
</pre></div>
</div>
<p>模板的使用如下:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible webserver -m setup
ansible webserver -m template -a &quot;src=/tmp/motd.j2 dest=/etc/motd&quot;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">组名 &#8216;webserver&#8217; 是 cobbler 中定义的.你仍然可以在 Ansible 的配置文件中定义变量.
但要注意,变量名相同时,外部 inventory 脚本中定义的变量会覆盖 Ansible 中的变量.</p>
</div>
<p>执行上面命令后,主机 foo 的/etc/motd文件被写入如下的内容:</p>
<div class="highlight-python"><div class="highlight"><pre>Welcome, I am templated with a value of a=2, b=3, and c=4
</pre></div>
</div>
<p>主机 &#8216;bar&#8217; (bar.example.com)的 /etc/motd 中写入如下内容:</p>
<div class="highlight-python"><div class="highlight"><pre>Welcome, I am templated with a value of a=2, b=3, and c=5
</pre></div>
</div>
<p>你也可以通过下面这个命令测试变量的替换:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible webserver -m shell -a &quot;echo {{ a }}&quot;
</pre></div>
</div>
<p>也就是说,你可以在参数或命令操作中使用变量的替换.</p>
</div>
<div class="section" id="aws-ec2-inventory">
<span id="aws-example"></span><h4><a class="toc-backref" href="#id6">AWS EC2 外部 inventory 脚本</a><a class="headerlink" href="#aws-ec2-inventory" title="Permalink to this headline">¶</a></h4>
<p>使用 AWC EC2时,维护一份 inventory 文件有时不是最好的方法.因为主机的数量有可能发生变动,或者主机是由外部的应用管理的,或者使用了 AWS autoscaling.这时,使用 <a class="reference external" href="https://raw.github.com/ansible/ansible/devel/plugins/inventory/ec2.py">EC2 external inventory</a> 脚本是更好的选择.</p>
<p>脚本的使用方式有两种,最简单的是直接使用 Ansible 的命令行选项 <code class="docutils literal"><span class="pre">-i</span></code> ,指定脚本的路径（脚本要有可执行权限）:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible -i ec2.py -u ubuntu us-east-1d -m ping
</pre></div>
</div>
<p>第二种方式,把脚本拷贝为 <cite>/etc/ansible/hosts</cite> ,并赋予可执行权限.还需把 <a class="reference external" href="https://raw.githubusercontent.com/ansible/ansible/devel/plugins/inventory/ec2.ini">ec2.ini</a> 文件拷贝到 <cite>/etc/ansible/ec2.ini</cite>,然后运行 ansible.</p>
<p>要成功的调用 API 访问 AWS,需要配置 Boto （Boto 是 AWS 的 Python 接口）.可用的方法有多种,请参见: <a class="reference external" href="http://docs.pythonboto.org/en/latest/boto_config_tut.html">methods</a> .</p>
<p>最简单的方法是定义两个环境变量:</p>
<div class="highlight-python"><div class="highlight"><pre>export AWS_ACCESS_KEY_ID=&#39;AK123&#39;
export AWS_SECRET_ACCESS_KEY=&#39;abc123&#39;
</pre></div>
</div>
<p>如何知道配置是否正确,执行脚本来测试:</p>
<div class="highlight-python"><div class="highlight"><pre>cd plugins/inventory
./ec2.py --list
</pre></div>
</div>
<p>你可以看到以 JSON 格式表示的覆盖所有 regions 的 inventory 信息.</p>
<p>因为每一个 region 需要自己的 API 调用,如果你仅使用了所有 regions 中的一个子集,可以编辑 <code class="docutils literal"><span class="pre">ec2.ini</span></code> ,使之仅显示你所感兴趣的那些 regions.
在配置文件 <code class="docutils literal"><span class="pre">ec2.ini</span></code> 中,包含了其他配置选项,包括缓存控制和目的地址变量.</p>
<p>inventory 文件的核心部分,是一些名字到目的地址的映射.默认的 <code class="docutils literal"><span class="pre">ec2.ini</span></code> 设置适用于在 EC2 之外运行 Ansible（比如一台笔记本电脑）,但这不是最有效的方式.</p>
<p>在 EC2 内部运行 Ansible 时,内部的 DNS 名和 IP 地址比公共 DNS 名更容易理解.你可以在 <code class="docutils literal"><span class="pre">ec2.ini</span></code> 文件中修改 <code class="docutils literal"><span class="pre">destination_variable</span></code> 变量,
改为一个实例的私有 DNS 名.对于在私有子网的 VPC 上运行 Ansible ,这种设置很重要,使得我们可以使用内部IP地址之外的方式访问到一个VPC.在 <code class="docutils literal"><span class="pre">ec2.ini</span></code> 文件中,
<cite>vpc_destination_variable</cite> 可以命名为任意一个 <a class="reference external" href="http://docs.pythonboto.org/en/latest/ref/ec2.html#module-boto.ec2.instance">boto.ec2.instance</a> 变量.</p>
<p>EC2 外部 inventory 提供了一种从多个组到实例的映射:</p>
<p>全局
实例都属于 <code class="docutils literal"><span class="pre">ec2</span></code> 这个组.</p>
<dl class="docutils">
<dt>实例ID</dt>
<dd>例如:
<code class="docutils literal"><span class="pre">i-00112233</span></code>
<code class="docutils literal"><span class="pre">i-a1b1c1d1</span></code></dd>
<dt>Region</dt>
<dd>属于一个 AWS region 的所有实例构成的一个组.
例如:
<code class="docutils literal"><span class="pre">us-east-1</span></code>
<code class="docutils literal"><span class="pre">us-west-2</span></code></dd>
<dt>可用性区域</dt>
<dd>所有属于 availability zone 的实例构成一个组.
例如:
<code class="docutils literal"><span class="pre">us-east-1a</span></code>
<code class="docutils literal"><span class="pre">us-east-1b</span></code></dd>
<dt>安全组</dt>
<dd><p class="first">实例可属于一个或多个安全组.每一个组的前缀都是 <code class="docutils literal"><span class="pre">security_group_</span></code> ,符号(-) 已被转换为(_). with all characters except alphanumerics (这句没明白)</p>
<p class="last">例如:
<code class="docutils literal"><span class="pre">security_group_default</span></code>
<code class="docutils literal"><span class="pre">security_group_webservers</span></code>
<code class="docutils literal"><span class="pre">security_group_Pete_s_Fancy_Group</span></code></p>
</dd>
<dt>标签</dt>
<dd>每一个实例可有多个不同的 key/value 键值对,这些键值对被称为标签.标签名可以随意定义,最常见的标签是 &#8216;Name&#8217;.每一个键值对是这个实例自己的组.
特殊字符已转换为下划线,格式为 <code class="docutils literal"><span class="pre">tag_KEY_VALUE</span></code>
例如:
<code class="docutils literal"><span class="pre">tag_Name_Web</span></code>
<code class="docutils literal"><span class="pre">tag_Name_redis-master-001</span></code>
<code class="docutils literal"><span class="pre">tag_aws_cloudformation_logical-id_WebServerGroup</span></code></dd>
</dl>
<p>使用 Ansible 与指定的服务器进行交互时,EC2 inventory 脚本被再次调用（调用时加上了命令行选项  <code class="docutils literal"><span class="pre">--host</span> <span class="pre">HOST</span></code> ）,这个调用会在索引缓存中进行查找,获取实例 ID,然后调用 API 访问 AWS,获取指定实例的所有信息.这些信息被转换为 playbooks 中的变量,可以进行访问.每一个变量的前缀为 <code class="docutils literal"><span class="pre">ec2_</span></code>,下面是一些变量的示例:</p>
<ul class="simple">
<li>ec2_architecture</li>
<li>ec2_description</li>
<li>ec2_dns_name</li>
<li>ec2_id</li>
<li>ec2_image_id</li>
<li>ec2_instance_type</li>
<li>ec2_ip_address</li>
<li>ec2_kernel</li>
<li>ec2_key_name</li>
<li>ec2_launch_time</li>
<li>ec2_monitored</li>
<li>ec2_ownerId</li>
<li>ec2_placement</li>
<li>ec2_platform</li>
<li>ec2_previous_state</li>
<li>ec2_private_dns_name</li>
<li>ec2_private_ip_address</li>
<li>ec2_public_dns_name</li>
<li>ec2_ramdisk</li>
<li>ec2_region</li>
<li>ec2_root_device_name</li>
<li>ec2_root_device_type</li>
<li>ec2_security_group_ids</li>
<li>ec2_security_group_names</li>
<li>ec2_spot_instance_request_id</li>
<li>ec2_state</li>
<li>ec2_state_code</li>
<li>ec2_state_reason</li>
<li>ec2_status</li>
<li>ec2_subnet_id</li>
<li>ec2_tag_Name</li>
<li>ec2_tenancy</li>
<li>ec2_virtualization_type</li>
<li>ec2_vpc_id</li>
</ul>
<p>其中 <code class="docutils literal"><span class="pre">ec2_security_group_ids</span></code> 和 <code class="docutils literal"><span class="pre">ec2_security_group_names</span></code> 变量的值为所有安全组的列表,使用逗号分隔.每一个 EC2 标签是一个格式为 <code class="docutils literal"><span class="pre">ec2_tag_KEY</span></code> 的变量.</p>
<p>要查看一个实例的完整的可用变量的列表,执行脚本:</p>
<div class="highlight-python"><div class="highlight"><pre>cd plugins/inventory
./ec2.py --host ec2-12-12-12-12.compute-1.amazonaws.com
</pre></div>
</div>
<p>注意,AWS inventory 脚本会将结果进行缓存,以避免重复的 API 调用,这个缓存的设置可在 ec2.ini 文件中配置.要显式地清空缓存,你可以加上 <code class="docutils literal"><span class="pre">--refresh-cache</span></code> 选项,执行脚本如下:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># ./ec2.py --refresh-cache</span>
</pre></div>
</div>
</div>
<div class="section" id="other-inventory-scripts">
<span id="id1"></span><h4><a class="toc-backref" href="#id7">其它 inventory 脚本</a><a class="headerlink" href="#other-inventory-scripts" title="Permalink to this headline">¶</a></h4>
<p>除了 Cobbler 和 EC2 之外,还有以下的系统可以使用 inventory 脚本:</p>
<div class="highlight-python"><div class="highlight"><pre>BSD Jails
DigitalOcean
Google Compute Engine
Linode
OpenShift
OpenStack Nova
Red Hat&#39;s SpaceWalk
Vagrant (not to be confused with the provisioner in vagrant, which is preferred)
Zabbix
</pre></div>
</div>
<p>关于这些系统还没有专门的章节讲述如何操作,但步骤与上面所讲述的 AWS 一样,具体可看看Ansible checkout 的 &#8220;plugins/&#8221; 目录.</p>
<p>如果你开发了一个通用的 inventory 脚本,请提交一个 pull request,我们可能会把它放入项目中.</p>
</div>
<div class="section" id="using-multiple-sources">
<span id="id2"></span><h4><a class="toc-backref" href="#id8">使用多个 inventory 源</a><a class="headerlink" href="#using-multiple-sources" title="Permalink to this headline">¶</a></h4>
<p>如果 -i 选项后给出的地址是一个目录 （or as so configured in ansible.cfg）,Ansible 可以同一时间使用多个 inventory 源.这样在同一个 ansible 运行操作中,可混合的使用动态和静态的 inventory 源.</p>
</div>
<div class="section" id="static-groups-of-dynamic">
<span id="id3"></span><h4><a class="toc-backref" href="#id9">动态组作为静态组的子组</a><a class="headerlink" href="#static-groups-of-dynamic" title="Permalink to this headline">¶</a></h4>
<p>在静态 inventory 文件中,如果定义一个由一些组作为子成员的组,这些子组也需要定义（译者注:即包含具体的 host）,否则执行时 ansible 会返回一个错误.
如果定义一些动态组作为一个静态组的子组,也需在静态 inventory 文件中定义动态组,但是动态组定义为一个空的组即可:</p>
<div class="highlight-python"><div class="highlight"><pre>[tag_Name_staging_foo]

[tag_Name_staging_bar]

[staging:children]
tag_Name_staging_foo
tag_Name_staging_bar
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a></dt>
<dd>All about static inventory files</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/intro_patterns"></span><div class="section" id="patterns">
<h3><a class="toc-backref" href="#id1">Patterns</a><a class="headerlink" href="#patterns" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#patterns" id="id1">Patterns</a></li>
</ul>
</div>
<p>在Ansible中,Patterns 是指我们怎样确定由哪一台主机来管理. 意思就是与哪台主机进行交互. 但是在:doc:<cite>playbooks</cite> 中它指的是对应主机应用特定的配置或执行特定进程.</p>
<p>我们再来复习下:doc:<cite>intro_adhoc</cite> 章节中介绍的命令用法,命令格式如下:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible &lt;pattern_goes_here&gt; -m &lt;module_name&gt; -a &lt;arguments&gt;
</pre></div>
</div>
<p>示例如下:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible webservers -m service -a &quot;name=httpd state=restarted&quot;
</pre></div>
</div>
<p>一个pattern通常关联到一系列组(主机的集合) &#8211;如上示例中,所有的主机均在 &#8220;webservers&#8221; 组中.</p>
<p>不管怎么样,在使用Ansible前,我们需事先告诉Ansible哪台机器将被执行.
能这样做的前提是需要预先定义唯一的 host names 或者 主机组.</p>
<p>如下的patterns等同于目标为仓库(inventory)中的所有机器:</p>
<div class="highlight-python"><div class="highlight"><pre>all
*
</pre></div>
</div>
<p>也可以写IP地址或系列主机名:</p>
<div class="highlight-python"><div class="highlight"><pre>one.example.com
one.example.com:two.example.com
192.168.1.50
192.168.1.*
</pre></div>
</div>
<p>如下patterns分别表示一个或多个groups.多组之间以冒号分隔表示或的关系.这意味着一个主机可以同时存在多个组:</p>
<div class="highlight-python"><div class="highlight"><pre>webservers
webservers:dbservers
</pre></div>
</div>
<p>你也可以排队一个特定组,如下实例中,所有执行命令的机器必须隶属 webservers 组但同时不在 phoenix组:</p>
<div class="highlight-python"><div class="highlight"><pre>webservers:!phoenix
</pre></div>
</div>
<p>你也可以指定两个组的交集,如下实例表示,执行命令有机器需要同时隶属于 webservers 和 staging 组.</p>
<blockquote>
<div>webservers:&amp;staging</div></blockquote>
<p>你也可以组合更复杂的条件:</p>
<div class="highlight-python"><div class="highlight"><pre>webservers:dbservers:&amp;staging:!phoenix
</pre></div>
</div>
<p>上面这个例子表示&#8220;&#8216;webservers&#8217; 和 &#8216;dbservers&#8217; 两个组中隶属于 &#8216;staging&#8217; 组并且不属于 &#8216;phoenix&#8217; 组的机器才执行命令&#8221; ... 哟！唷! 好烧脑的说！</p>
<p>你也可以使用变量如果你希望通过传参指定group,ansible-playbook通过 &#8220;-e&#8221; 参数可以实现,但这种用法不常用:</p>
<div class="highlight-python"><div class="highlight"><pre>webservers:!{{excluded}}:&amp;{{required}}
</pre></div>
</div>
<p>你也可以不必严格定义groups,单个的host names, IPs , groups都支持通配符:</p>
<div class="highlight-python"><div class="highlight"><pre>*.example.com
*.com
</pre></div>
</div>
<p>Ansible同时也支持通配和groups的混合使用:</p>
<div class="highlight-python"><div class="highlight"><pre>one*.com:dbservers
</pre></div>
</div>
<p>在高级语法中,你也可以在group中选择对应编号的server:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">webservers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>或者一个group中的一部分servers:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">webservers</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">25</span><span class="p">]</span>
</pre></div>
</div>
<p>大部分人都在patterns应用正则表达式,但你可以.只需要以 &#8216;~&#8217; 开头即可:</p>
<div class="highlight-python"><div class="highlight"><pre>~(web|db).*\.example\.com
</pre></div>
</div>
<p>同时让我们提前了解一些技能,除了如上,你也可以通过 <code class="docutils literal"><span class="pre">--limit</span></code> 标记来添加排除条件,/usr/bin/ansible or /usr/bin/ansible-playbook都支持:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook site.yml --limit datacenter2
</pre></div>
</div>
<p>如果你想从文件读取hosts,文件名以&#64;为前缀即可.从Ansible 1.2开始支持该功能:</p>
<div class="highlight-python"><div class="highlight"><pre>ansible-playbook site.yml --limit @retry_hosts.txt
</pre></div>
</div>
<p>够简单吧. 为了更好的掌握该章节内容,可以先了解 <a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a> 再 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a></dt>
<dd>Examples of basic commands</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-docs/intro_adhoc"></span><div class="section" id="introduction-to-ad-hoc-commands">
<h3><a class="toc-backref" href="#id7">Introduction To Ad-Hoc Commands</a><a class="headerlink" href="#introduction-to-ad-hoc-commands" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction-to-ad-hoc-commands" id="id7">Introduction To Ad-Hoc Commands</a><ul>
<li><a class="reference internal" href="#parallelism-and-shell-commands" id="id8">Parallelism and Shell Commands</a></li>
<li><a class="reference internal" href="#file-transfer" id="id9">File Transfer</a></li>
<li><a class="reference internal" href="#managing-packages" id="id10">Managing Packages</a></li>
<li><a class="reference internal" href="#users-and-groups" id="id11">Users and Groups</a></li>
<li><a class="reference internal" href="#deploying-from-source-control" id="id12">Deploying From Source Control</a></li>
<li><a class="reference internal" href="#managing-services" id="id13">Managing Services</a></li>
<li><a class="reference internal" href="#time-limited-background-operations" id="id14">Time Limited Background Operations</a></li>
<li><a class="reference internal" href="#gathering-facts" id="id15">Gathering Facts</a></li>
</ul>
</li>
</ul>
</div>
<p>在下面的例子中,我们将演示如何使用 <cite>/usr/bin/ansible</cite> 运行 ad hoc 任务.</p>
<p>所谓 ad-hoc 命令是什么呢?</p>
<p>(这其实是一个概念性的名字,是相对于写 Ansible playbook 来说的.类似于在命令行敲入shell命令和
写shell scripts两者之间的关系)...</p>
<p>如果我们敲入一些命令去比较快的完成一些事情,而不需要将这些执行的命令特别保存下来,
这样的命令就叫做 ad-hoc 命令.</p>
<p>Ansible提供两种方式去完成任务,一是 ad-hoc 命令,一是写 Ansible playbook.前者可以解决一些简单的任务,
后者解决较复杂的任务.</p>
<p>一般而言,在学习了 playbooks 之后,你才能体会到 Ansible 真正的强大之处在哪里.</p>
<p>那我们会在什么情境下去使用ad-hoc 命令呢?</p>
<p>比如说因为圣诞节要来了,想要把所有实验室的电源关闭,我们只需要执行一行命令
就可以达成这个任务,而不需要写 playbook 来做这个任务.</p>
<p>至于说做配置管理或部署这种事,还是要借助 playbook 来完成,即使用 &#8216;/usr/bin/ansible-playbook&#8217; 这个命令.</p>
<p>(关于 playbook 的使用,请参考  <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> )</p>
<p>如果你还没有阅读 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a> ,最好先看一看,然后我们继续往下.</p>
<div class="section" id="parallelism-and-shell-commands">
<span id="id1"></span><h4><a class="toc-backref" href="#id8">Parallelism and Shell Commands</a><a class="headerlink" href="#parallelism-and-shell-commands" title="Permalink to this headline">¶</a></h4>
<p>举一个例子</p>
<p>这里我们要使用 Ansible 的命令行工具来重启 Atlanta 组中所有的 web 服务器,每次重启10个.</p>
<p>我们先设置 SSH-agent,将私钥纳入其管理:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ssh-agent bash
<span class="nv">$ </span>ssh-add ~/.ssh/id_rsa
</pre></div>
</div>
<p>如果不想使用 ssh-agent, 想通过密码验证的方式使用 SSH,可以在执行ansible命令时使用 <code class="docutils literal"><span class="pre">--ask-pass</span></code> (<code class="docutils literal"><span class="pre">-k</span></code>)选项,
但这里建议使用 ssh-agent.</p>
<p>现在执行如下命令,这个命令中,atlanta是一个组,这个组里面有很多服务器,&#8221;/sbin/reboot&#8221;命令会在atlanta组下
的所有机器上执行.这里ssh-agent会fork出10个子进程(bash),以并行的方式执行reboot命令.如前所说“每次重启10个”
即是以这种方式实现:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible atlanta -a <span class="s2">&quot;/sbin/reboot&quot;</span> -f 10
</pre></div>
</div>
<p>在执行 /usr/bin/ansible 时,默认是以当前用户的身份去执行这个命令.如果想以指定的用户执行 /usr/bin/ansible,
请添加 &#8220;-u username&#8221;选项,如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible atlanta -a <span class="s2">&quot;/usr/bin/foo&quot;</span> -u username
</pre></div>
</div>
<p>如果想通过 sudo 去执行命令,如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible atlanta -a <span class="s2">&quot;/usr/bin/foo&quot;</span> -u username --sudo <span class="o">[</span>--ask-sudo-pass<span class="o">]</span>
</pre></div>
</div>
<p>如果你不是以 passwordless 的模式执行 sudo,应加上 <code class="docutils literal"><span class="pre">--ask-sudo-pass</span></code> (<code class="docutils literal"><span class="pre">-K</span></code>)选项,加上之后会提示你输入
密码.使用 passwordless 模式的 sudo, 更容易实现自动化,但不要求一定要使用 passwordless sudo.</p>
<p>也可以通过``&#8211;sudo-user`` (<code class="docutils literal"><span class="pre">-U</span></code>)选项,使用 sudo 切换到其它用户身份,而不是 root(译者注:下面命令中好像写掉了&#8211;sudo):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible atlanta -a <span class="s2">&quot;/usr/bin/foo&quot;</span> -u username -U otheruser <span class="o">[</span>--ask-sudo-pass<span class="o">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在有些比较罕见的情况下,一些用户会受到安全规则的限制,使用 sudo 切换时只能运行指定的命令.这与 ansible的 no-bootstrapping 思想相悖,而且 ansible 有几百个模块,在这种限制下无法进行正常的工作.
所以执行 ansible 命令时,应使用一个没有受到这种限制的账号来执行.One way of doing this without sharing access to unauthorized users would be gating Ansible with <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a>, which
can hold on to an SSH credential and let members of certain organizations use it on their behalf without having direct access.</p>
</div>
<p>以上是关于 ansible 的基础.如果你还没阅读过 patterns 和 groups,应先阅读 <a class="reference internal" href="index.html#document-docs/intro_patterns"><em>Patterns</em></a> .</p>
<p>在前面写出的命令中, <code class="docutils literal"><span class="pre">-f</span> <span class="pre">10</span></code> 选项表示使用10个并行的进程.这个选项也可以在 <a class="reference internal" href="index.html#document-docs/intro_configuration"><em>Ansible的配置文件</em></a> 中设置,
在配置文件中指定的话,就不用在命令行中写出了.这个选项的默认值是 5,是比较小的.如果同时操作的主机数比较多的话,
可以调整到一个更大的值,只要不超出你系统的承受范围就没问题.如果主机数大于设置的并发进程数,Ansible会自行协调,
花得时间会更长一点.</p>
<p>ansible有许多模块,默认是 &#8216;command&#8217;,也就是命令模块,我们可以通过 <code class="docutils literal"><span class="pre">-m</span></code> 选项来指定不同的模块.在前面所示的例子中,
因为我们是要在 Atlanta 组下的服务器中执行 reboot 命令,所以就不需要显示的用这个选项指定 &#8216;command&#8217; 模块,使用
默认设定就OK了.一会在其他例子中,我们会使用 <code class="docutils literal"><span class="pre">-m</span></code> 运行其他的模块,详情参见 <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a> .</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><span class="xref std std-ref">command</span> 模块不支持 shell 变量,也不支持管道等 shell 相关的东西.如果你想使用 shell相关的这些东西, 请使用&#8217;shell&#8217; 模块.两个模块之前的差别请参考 <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a> .</p>
</div>
<p>使用 <span class="xref std std-ref">shell</span> 模块的示例如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible raleigh -m shell -a <span class="s1">&#39;echo $TERM&#39;</span>
</pre></div>
</div>
<p>使用 Ansible <em>ad hoc</em> 命令行接口时(与使用 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> 的情况相反),尤其注意 shell 引号的规则.
比如在上面的例子中,如果使用双引号&#8221;echo $TERM&#8221;,会求出TERM变量在当前系统的值,而我们实际希望的是把这个命令传递
到其它机器执行.</p>
<p>在此我们已经演示了一些简单命令如何去执行,但通常来讲大多数 Ansible 模块的工作方式与简单的脚本不同.They make the remote
system look like you state, and run the commands necessary to get it there.这一般被称为 &#8216;idempotence&#8217;,
是 Ansible 设计的核心目标.但我们也认识到,能运行任意命令也是重要的,所以 Ansible 对这两者都做支持.</p>
</div>
<div class="section" id="file-transfer">
<span id="id2"></span><h4><a class="toc-backref" href="#id9">File Transfer</a><a class="headerlink" href="#file-transfer" title="Permalink to this headline">¶</a></h4>
<p>这是 <cite>/usr/bin/ansible</cite> 的另一种用法.Ansible 能够以并行的方式同时 SCP 大量的文件到多台机器.
命令如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible atlanta -m copy -a <span class="s2">&quot;src=/etc/hosts dest=/tmp/hosts&quot;</span>
</pre></div>
</div>
<p>若你使用 playbooks, 则可以利用 <code class="docutils literal"><span class="pre">template</span></code> 模块来做到更进一步的事情.(请参见 module 和 playbook 的文档)</p>
<p>使用 <code class="docutils literal"><span class="pre">file</span></code> 模块可以做到修改文件的属主和权限,(在这里可替换为 <code class="docutils literal"><span class="pre">copy</span></code> 模块,是等效的):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m file -a <span class="s2">&quot;dest=/srv/foo/a.txt mode=600&quot;</span>
<span class="nv">$ </span>ansible webservers -m file -a <span class="s2">&quot;dest=/srv/foo/b.txt mode=600 owner=mdehaan group=mdehaan&quot;</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal"><span class="pre">file</span></code> 模块也可以创建目录,与执行 <code class="docutils literal"><span class="pre">mkdir</span> <span class="pre">-p</span></code> 效果类似:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m file -a <span class="s2">&quot;dest=/path/to/c mode=755 owner=mdehaan group=mdehaan state=directory&quot;</span>
</pre></div>
</div>
<p>删除目录(递归的删除)和删除文件:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m file -a <span class="s2">&quot;dest=/path/to/c state=absent&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="managing-packages">
<span id="id3"></span><h4><a class="toc-backref" href="#id10">Managing Packages</a><a class="headerlink" href="#managing-packages" title="Permalink to this headline">¶</a></h4>
<p>Ansible 提供对 yum 和 apt 的支持.这里是关于 yum 的示例.</p>
<p>确认一个软件包已经安装,但不去升级它:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m yum -a <span class="s2">&quot;name=acme state=present&quot;</span>
</pre></div>
</div>
<p>确认一个软件包的安装版本:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m yum -a <span class="s2">&quot;name=acme-1.5 state=present&quot;</span>
</pre></div>
</div>
<p>确认一个软件包还没有安装:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m yum -a <span class="s2">&quot;name=acme state=absent&quot;</span>
</pre></div>
</div>
<p>对于不同平台的软件包管理工具,Ansible都有对应的模块.如果没有,你也可以使用 command 模块去安装软件.
或者最好是来为那个软件包管理工具贡献一个相应的模块.请在 mailing list 中查看相关的信息和详情.</p>
</div>
<div class="section" id="users-and-groups">
<span id="id4"></span><h4><a class="toc-backref" href="#id11">Users and Groups</a><a class="headerlink" href="#users-and-groups" title="Permalink to this headline">¶</a></h4>
<p>使用 &#8216;user&#8217; 模块可以方便的创建账户,删除账户,或是管理现有的账户:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -m user -a <span class="s2">&quot;name=foo password=&lt;crypted password here&gt;&quot;</span>

<span class="nv">$ </span>ansible all -m user -a <span class="s2">&quot;name=foo state=absent&quot;</span>
</pre></div>
</div>
<p>更多可用的选项请参考 <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a> ,包括对组和组成员关系的操作.</p>
</div>
<div class="section" id="deploying-from-source-control">
<span id="from-source-control"></span><h4><a class="toc-backref" href="#id12">Deploying From Source Control</a><a class="headerlink" href="#deploying-from-source-control" title="Permalink to this headline">¶</a></h4>
<p>直接使用 git 部署 webapp:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m git -a <span class="s2">&quot;repo=git://foo.example.org/repo.git dest=/srv/myapp version=HEAD&quot;</span>
</pre></div>
</div>
<p>因为Ansible 模块可通知到 change handlers ,所以当源码被更新时,我们可以告知 Ansible 这个信息,并执行指定的任务,
比如直接通过 git 部署 Perl/Python/PHP/Ruby, 部署完成后重启 apache.</p>
</div>
<div class="section" id="managing-services">
<span id="id5"></span><h4><a class="toc-backref" href="#id13">Managing Services</a><a class="headerlink" href="#managing-services" title="Permalink to this headline">¶</a></h4>
<p>确认某个服务在所有的webservers上都已经启动:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m service -a <span class="s2">&quot;name=httpd state=started&quot;</span>
</pre></div>
</div>
<p>或是在所有的webservers上重启某个服务(译者注:可能是确认已重启的状态?):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m service -a <span class="s2">&quot;name=httpd state=restarted&quot;</span>
</pre></div>
</div>
<p>确认某个服务已经停止:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible webservers -m service -a <span class="s2">&quot;name=httpd state=stopped&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="time-limited-background-operations">
<span id="id6"></span><h4><a class="toc-backref" href="#id14">Time Limited Background Operations</a><a class="headerlink" href="#time-limited-background-operations" title="Permalink to this headline">¶</a></h4>
<p>需要长时间运行的命令可以放到后台去,在命令开始运行后我们也可以检查运行的状态.如果运行命令后,不想获取返回的信息,
可执行如下命令:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -B <span class="m">3600</span> -P <span class="m">0</span> -a <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<p>如果你确定要在命令运行后检查运行的状态,可以使用 async_status 模块.前面执行后台命令后会返回一个 job id,
将这个 id 传给 async_status 模块:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible web1.example.com -m async_status -a <span class="s2">&quot;jid=488359678239.2844&quot;</span>
</pre></div>
</div>
<p>获取状态的命令如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -B <span class="m">1800</span> -P <span class="m">60</span> -a <span class="s2">&quot;/usr/bin/long_running_operation --do-stuff&quot;</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal"><span class="pre">-B</span> <span class="pre">1800</span></code> 表示最多运行30分钟, <code class="docutils literal"><span class="pre">-P</span> <span class="pre">60</span></code> 表示每隔60秒获取一次状态信息.</p>
<p>Polling 获取状态信息的操作会在后台工作任务启动之后开始.若你希望所有的工作任务快速启动, <code class="docutils literal"><span class="pre">--forks</span></code> 这个选项的值
要设置得足够大,这是前面讲过的并发进程的个数.在运行指定的时间(由``-B``选项所指定)后,远程节点上的任务进程便会被终止.</p>
<p>一般你只能在把需要长时间运行的命令或是软件升级这样的任务放到后台去执行.对于 copy 模块来说,即使按照前面的示例想放到
后台执行文件传输,实际上并不会如你所愿.</p>
</div>
<div class="section" id="gathering-facts">
<span id="checking-facts"></span><h4><a class="toc-backref" href="#id15">Gathering Facts</a><a class="headerlink" href="#gathering-facts" title="Permalink to this headline">¶</a></h4>
<p>在 playbooks 中有对于 Facts 做描述,它代表的是一个系统中已发现的变量.These can be used to implement conditional execution
of tasks but also just to get ad-hoc information about your system. 可通过如下方式查看所有的 facts:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -m setup
</pre></div>
</div>
<p>我们也可以对这个命令的输出做过滤,只输出特定的一些 facts,详情请参考 &#8220;setup&#8221; 模块的文档.</p>
<p>如果你已准备好仔细研究 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> ,可以继续读读 <a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a> ,会对 facts有更多了解.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_configuration"><em>Ansible的配置文件</em></a></dt>
<dd>All about the Ansible config file</dd>
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>A list of available modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Using Ansible for configuration management &amp; deployment</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/intro_configuration"></span><div class="section" id="ansible">
<h3><a class="toc-backref" href="#id56">Ansible的配置文件</a><a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#ansible" id="id56">Ansible的配置文件</a><ul>
<li><a class="reference internal" href="#getting-the-latest-configuration" id="id57">获取最新配置文件</a></li>
<li><a class="reference internal" href="#environmental-configuration" id="id58">环境配置</a></li>
<li><a class="reference internal" href="#config-values-by-section" id="id59">配置文件不同段详解</a><ul>
<li><a class="reference internal" href="#general-defaults" id="id60">通用默认段</a><ul>
<li><a class="reference internal" href="#action-plugins" id="id61">action_plugins</a></li>
<li><a class="reference internal" href="#ansible-managed" id="id62">ansible_managed</a></li>
<li><a class="reference internal" href="#ask-pass" id="id63">ask_pass</a></li>
<li><a class="reference internal" href="#ask-sudo-pass" id="id64">ask_sudo_pass</a></li>
<li><a class="reference internal" href="#bin-ansible-callbacks" id="id65">bin_ansible_callbacks</a></li>
<li><a class="reference internal" href="#callback-plugins" id="id66">callback_plugins</a></li>
<li><a class="reference internal" href="#command-warnings" id="id67">command_warnings</a></li>
<li><a class="reference internal" href="#connection-plugins" id="id68">connection_plugins</a></li>
<li><a class="reference internal" href="#deprecation-warnings" id="id69">deprecation_warnings</a></li>
<li><a class="reference internal" href="#display-skipped-hosts" id="id70">display_skipped_hosts</a></li>
<li><a class="reference internal" href="#error-on-undefined-vars" id="id71">error_on_undefined_vars</a></li>
<li><a class="reference internal" href="#executable" id="id72">executable</a></li>
<li><a class="reference internal" href="#filter-plugins" id="id73">filter_plugins</a></li>
<li><a class="reference internal" href="#force-color" id="id74">force_color</a></li>
<li><a class="reference internal" href="#force-handlers" id="id75">force_handlers</a></li>
<li><a class="reference internal" href="#forks" id="id76">forks</a></li>
<li><a class="reference internal" href="#gathering" id="id77">gathering</a></li>
<li><a class="reference internal" href="#hash-behaviour" id="id78">hash_behaviour</a></li>
<li><a class="reference internal" href="#hostfile" id="id79">hostfile</a></li>
<li><a class="reference internal" href="#host-key-checking" id="id80">host_key_checking</a></li>
<li><a class="reference internal" href="#inventory" id="id81">inventory</a></li>
<li><a class="reference internal" href="#jinja2-extensions" id="id82">jinja2_extensions</a></li>
<li><a class="reference internal" href="#library" id="id83">library</a></li>
<li><a class="reference internal" href="#log-path" id="id84">log_path</a></li>
<li><a class="reference internal" href="#lookup-plugins" id="id85">lookup_plugins</a></li>
<li><a class="reference internal" href="#module-lang" id="id86">module_lang</a></li>
<li><a class="reference internal" href="#module-name" id="id87">module_name</a></li>
<li><a class="reference internal" href="#nocolor" id="id88">nocolor</a></li>
<li><a class="reference internal" href="#nocows" id="id89">nocows</a></li>
<li><a class="reference internal" href="#pattern" id="id90">pattern</a></li>
<li><a class="reference internal" href="#poll-interval" id="id91">poll_interval</a></li>
<li><a class="reference internal" href="#private-key-file" id="id92">private_key_file</a></li>
<li><a class="reference internal" href="#remote-port" id="id93">remote_port</a></li>
<li><a class="reference internal" href="#remote-tmp" id="id94">remote_tmp</a></li>
<li><a class="reference internal" href="#remote-user" id="id95">remote_user</a></li>
<li><a class="reference internal" href="#roles-path" id="id96">roles_path</a></li>
<li><a class="reference internal" href="#sudo-exe" id="id97">sudo_exe</a></li>
<li><a class="reference internal" href="#sudo-flags" id="id98">sudo_flags</a></li>
<li><a class="reference internal" href="#sudo-user" id="id99">sudo_user</a></li>
<li><a class="reference internal" href="#system-warnings" id="id100">system_warnings</a></li>
<li><a class="reference internal" href="#timeout" id="id101">timeout</a></li>
<li><a class="reference internal" href="#transport" id="id102">transport</a></li>
<li><a class="reference internal" href="#vars-plugins" id="id103">vars_plugins</a></li>
<li><a class="reference internal" href="#vault-password-file" id="id104">vault_password_file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#paramiko-specific-settings" id="id105">Paramiko Specific Settings</a><ul>
<li><a class="reference internal" href="#record-host-keys" id="id106">record_host_keys</a></li>
</ul>
</li>
<li><a class="reference internal" href="#openssh-specific-settings" id="id107">OpenSSH Specific Settings</a><ul>
<li><a class="reference internal" href="#ssh-args" id="id108">ssh_args</a></li>
<li><a class="reference internal" href="#control-path" id="id109">control_path</a></li>
<li><a class="reference internal" href="#scp-if-ssh" id="id110">scp_if_ssh</a></li>
<li><a class="reference internal" href="#pipelining" id="id111">pipelining</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accelerated-mode-settings" id="id112">Accelerated Mode Settings</a><ul>
<li><a class="reference internal" href="#accelerate-port" id="id113">accelerate_port</a></li>
<li><a class="reference internal" href="#accelerate-timeout" id="id114">accelerate_timeout</a></li>
<li><a class="reference internal" href="#accelerate-connect-timeout" id="id115">accelerate_connect_timeout</a></li>
<li><a class="reference internal" href="#accelerate-daemon-timeout" id="id116">accelerate_daemon_timeout</a></li>
<li><a class="reference internal" href="#accelerate-multi-key" id="id117">accelerate_multi_key</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>Ansible的一些的设置可以通过配置文件完成.在大多数场景下默认的配置就能满足大多数用户的需求,在一些特殊场景下,用户还是需要自行修改这些配置文件</p>
<p>用户可以修改一下配置文件来修改设置,他们的被读取的顺序如下:</p>
<div class="highlight-bash"><div class="highlight"><pre>* ANSIBLE_CONFIG <span class="o">(</span>一个环境变量<span class="o">)</span>
* ansible.cfg <span class="o">(</span>位于当前目录中<span class="o">)</span>
* .ansible.cfg <span class="o">(</span>位于家目录中<span class="o">)</span>
* /etc/ansible/ansible.cfg
</pre></div>
</div>
<p>版本1.5之前的读取顺序如下:</p>
<div class="highlight-bash"><div class="highlight"><pre>* ansible.cfg <span class="o">(</span>位于当前目录<span class="o">)</span>
* ANSIBLE_CONFIG <span class="o">(</span>一个环境变量<span class="o">)</span>
* .ansible.cfg <span class="o">(</span>位于家目录下<span class="o">)</span>
* /etc/ansible/ansible.cfg
</pre></div>
</div>
<p>Ansible 将会按以上顺序逐个查询这些文件,直到找到一个为止,并且使用第一个寻找到个配置文件的配置,这些配置将不会被叠加.</p>
<div class="section" id="getting-the-latest-configuration">
<span id="id1"></span><h4><a class="toc-backref" href="#id57">获取最新配置文件</a><a class="headerlink" href="#getting-the-latest-configuration" title="Permalink to this headline">¶</a></h4>
<p>如果使用程序包管理器安装ansible,最新的 ansible.cfg 配置文件有可能出现在 /etc/ansible 下并且命名为 &#8221;.rpmnew&#8221;, 也可能根据不同的更新命名为其它名称</p>
<p>如果你是通过 pip 或者其他方式安装,则可能需要自行创建这个文件,以免原配置文件被覆盖.Ansible 的默认设置将会将其覆盖</p>
<p>配置文件的详细参数以及取值范围请查看`ansible.cfg  &lt;<a class="reference external" href="https://raw.github.com/ansible/ansible/devel/examples/ansible.cfg">https://raw.github.com/ansible/ansible/devel/examples/ansible.cfg</a>&gt;`_</p>
</div>
<div class="section" id="environmental-configuration">
<span id="id2"></span><h4><a class="toc-backref" href="#id58">环境配置</a><a class="headerlink" href="#environmental-configuration" title="Permalink to this headline">¶</a></h4>
<p>Ansible 通过环境变量的形式来进行配置.这些设置后的环境变量将会覆盖掉所有配置文件读取的配置.为了节省篇幅,这些变量没有被列在这里,详情请见源代码目录中的 ‘constants.py’. 相对于配置文件它门会比当作遗产系统（legacy system) 来被使用,但是仍然有效</p>
</div>
<div class="section" id="config-values-by-section">
<span id="id3"></span><h4><a class="toc-backref" href="#id59">配置文件不同段详解</a><a class="headerlink" href="#config-values-by-section" title="Permalink to this headline">¶</a></h4>
<p>配置文件被切割成了不同段.多数配置选项位于“general”段, 也有一些属于特定的链接类型（connection type）</p>
<div class="section" id="general-defaults">
<span id="id4"></span><h5><a class="toc-backref" href="#id60">通用默认段</a><a class="headerlink" href="#general-defaults" title="Permalink to this headline">¶</a></h5>
<p>在 [defaults] 段中,一下选项是可以调节的:</p>
<div class="section" id="action-plugins">
<span id="id5"></span><h6><a class="toc-backref" href="#id61">action_plugins</a><a class="headerlink" href="#action-plugins" title="Permalink to this headline">¶</a></h6>
<p>“行为”是 ansible中的一段代码,用来激活一些事件,例如执行一个模块,一个模版,等等</p>
<p>这是一个以开发者为中心的特性,使得一些底层模块可以从外部不同地方加载:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">action_plugins</span> <span class="o">=</span> ~/.ansible/plugins/action_plugins/:/usr/share/ansible_plugins/action_plugins
</pre></div>
</div>
<p>大多数用户都会使用这一特性,详情请见 <a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a> .</p>
</div>
<div class="section" id="ansible-managed">
<span id="id6"></span><h6><a class="toc-backref" href="#id62">ansible_managed</a><a class="headerlink" href="#ansible-managed" title="Permalink to this headline">¶</a></h6>
<p>Ansible-managed 是一个字符串.可以插入到Ansible配置模版系统生成的文件中.如果你使用以下的自字符:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_managed <span class="o">}}</span>
</pre></div>
</div>
<p>默认设置可以哪个用户修改和修改时间:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">ansible_managed</span> <span class="o">=</span> Ansible managed: <span class="o">{</span>file<span class="o">}</span> modified on %Y-%m-%d %H:%M:%S by <span class="o">{</span>uid<span class="o">}</span> on <span class="o">{</span>host<span class="o">}</span>
</pre></div>
</div>
<p>这个设置可以告知用户,Ansible修改了一个文件,并且手动写入的内容可能已经被覆盖.</p>
<p>需要注意的是,如果使用这一特性,这个字符串中将包含一个日期注释,如果日期更新,模版系统将会在每一次报告文件修改.</p>
</div>
<div class="section" id="ask-pass">
<span id="id7"></span><h6><a class="toc-backref" href="#id63">ask_pass</a><a class="headerlink" href="#ask-pass" title="Permalink to this headline">¶</a></h6>
<dl class="docutils">
<dt>这个可以控制,Ansible 剧本playbook 是否会自动默认弹出弹出密码.默认为no::</dt>
<dd>ask_pass=True</dd>
</dl>
<p>如果使用SSH 密钥匙做身份认证.可能需要修改这一参数</p>
</div>
<div class="section" id="ask-sudo-pass">
<span id="id8"></span><h6><a class="toc-backref" href="#id64">ask_sudo_pass</a><a class="headerlink" href="#ask-sudo-pass" title="Permalink to this headline">¶</a></h6>
<p>类似 ask_pass,用来控制Ansible playbook 在执行sudo之前是否询问sudo密码.默认为no:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">ask_sudo_pass</span><span class="o">=</span>True
</pre></div>
</div>
<p>如果用户使用的系统平台开启了sudo 密码的话,应该开绿这一参数</p>
</div>
<div class="section" id="bin-ansible-callbacks">
<span id="id9"></span><h6><a class="toc-backref" href="#id65">bin_ansible_callbacks</a><a class="headerlink" href="#bin-ansible-callbacks" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>用来控制callback插件是否在运行 /usr/bin/ansible 的时候被加载. 这个模块将用于命令行的日志系统,发出通知等特性.
Callback插件如果存在将会永久性的被 /usr/bin/ansible-playbook 加载,不能被禁用:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">bin_ansible_callbacks</span><span class="o">=</span>False
</pre></div>
</div>
<p>1.8 版本之前,callbacks 插件不可以被 /usr/bin/ansible加载.
.. _callback_plugins:</p>
</div>
<div class="section" id="callback-plugins">
<h6><a class="toc-backref" href="#id66">callback_plugins</a><a class="headerlink" href="#callback-plugins" title="Permalink to this headline">¶</a></h6>
<p>Callbacks 在ansible中是一段代码,在特殊事件时将被调用.并且允许出发通知.
这是一个以开发者为中心的特性,可以实现对Ansible的底层拓展,并且拓展模块可以位于任何位置:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">callback_plugins</span> <span class="o">=</span> ~/.ansible/plugins/callback_plugins/:/usr/share/ansible_plugins/callback_plugins
</pre></div>
</div>
<p>大多数的用户将会用到这一特性,详见 <a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a>.</p>
</div>
<div class="section" id="command-warnings">
<span id="id10"></span><h6><a class="toc-backref" href="#id67">command_warnings</a><a class="headerlink" href="#command-warnings" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>从Ansible 1.8 开始,当shell和命令行模块被默认模块简化的时,Ansible 将默认发出警告.
这个包含提醒使用&#8217;git&#8217;但不是通过命令行执行.使用模块调用比冒然使用命令行调用可以使playbook工作更具有一致性也更加可靠同时也更加便于维护:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">command_warnings</span> <span class="o">=</span> False
</pre></div>
</div>
<p>我们可以通过在命令行末尾添加 warn=yes 或者 warn=no选项来控制是否开启警告提示:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: usage of git that could be replaced with the git module
  shell: git update foo <span class="nv">warn</span><span class="o">=</span>yes
</pre></div>
</div>
</div>
<div class="section" id="connection-plugins">
<span id="id11"></span><h6><a class="toc-backref" href="#id68">connection_plugins</a><a class="headerlink" href="#connection-plugins" title="Permalink to this headline">¶</a></h6>
<p>连接插件允许拓展ansible拓展通讯信道,用来传输命令或者文件.
这是一个开发者中心特性,拓展插件可以从任何不同地方加载:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">connection_plugins</span> <span class="o">=</span> ~/.ansible/plugins/connection_plugins/:/usr/share/ansible_plugins/connection_plugins
</pre></div>
</div>
<p>大多数用户会用到这一特性, 详见:<a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a>
.. _deprecation_warnings:</p>
</div>
<div class="section" id="deprecation-warnings">
<h6><a class="toc-backref" href="#id69">deprecation_warnings</a><a class="headerlink" href="#deprecation-warnings" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>允许在ansible-playbook输出结果中禁用“不建议使用”警告:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">deprecation_warnings</span> <span class="o">=</span> True
</pre></div>
</div>
<p>“不建议警告”指的是使用一些在新版本中可能会被淘汰的遗留特性.</p>
</div>
<div class="section" id="display-skipped-hosts">
<span id="id12"></span><h6><a class="toc-backref" href="#id70">display_skipped_hosts</a><a class="headerlink" href="#display-skipped-hosts" title="Permalink to this headline">¶</a></h6>
<dl class="docutils">
<dt>如果设置为`False`,ansible 将不会显示任何跳过任务的状态.默认选项是现实跳过任务的状态::</dt>
<dd>display_skipped_hosts=True</dd>
</dl>
<p>注意Ansible 总是会显示任何任务的头文件, 不管这个任务被跳过与否.</p>
</div>
<div class="section" id="error-on-undefined-vars">
<span id="id13"></span><h6><a class="toc-backref" href="#id71">error_on_undefined_vars</a><a class="headerlink" href="#error-on-undefined-vars" title="Permalink to this headline">¶</a></h6>
<dl class="docutils">
<dt>从Ansible 1.3开始,这个选项将为默认,如果所引用的变量名称错误的话, 将会导致ansible在执行步骤上失败::</dt>
<dd>error_on_undefined_vars=True</dd>
</dl>
<p>If set to False, any &#8216;{{ template_expression }}&#8217; that contains undefined variables will be rendered in a template
or ansible action line exactly as written.</p>
</div>
<div class="section" id="executable">
<span id="id14"></span><h6><a class="toc-backref" href="#id72">executable</a><a class="headerlink" href="#executable" title="Permalink to this headline">¶</a></h6>
<dl class="docutils">
<dt>这个选项可以在sudo环境下产生一个shell交互接口. 用户只在/bin/bash的或者sudo限制的一些场景中需要修改.大部分情况下不需要修改::</dt>
<dd>executable = /bin/bash</dd>
</dl>
</div>
<div class="section" id="filter-plugins">
<span id="id15"></span><h6><a class="toc-backref" href="#id73">filter_plugins</a><a class="headerlink" href="#filter-plugins" title="Permalink to this headline">¶</a></h6>
<p>过滤器是一种特殊的函数,用来拓展模版系统 .</p>
<p>这是一个开发者核心的特性,允许Ansible从任何地方载入底层拓展模块:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">filter_plugins</span> <span class="o">=</span> ~/.ansible/plugins/filter_plugins/:/usr/share/ansible_plugins/filter_plugins
</pre></div>
</div>
<p>Most users will not need to use this feature.  See <a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a> for more details
大部分用户不会用到这个特性,详见:doc:<cite>developing_plugins</cite>.</p>
</div>
<div class="section" id="force-color">
<span id="id16"></span><h6><a class="toc-backref" href="#id74">force_color</a><a class="headerlink" href="#force-color" title="Permalink to this headline">¶</a></h6>
<dl class="docutils">
<dt>到没有使用TTY终端的时候,这个选项当用来强制颜色模式::</dt>
<dd>force_color = 1</dd>
</dl>
</div>
<div class="section" id="force-handlers">
<span id="id17"></span><h6><a class="toc-backref" href="#id75">force_handlers</a><a class="headerlink" href="#force-handlers" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.9.1.</span></p>
</div>
<p>即便这个用户崩溃,这个选项仍可以继续运行这个用户:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">force_handlers</span> <span class="o">=</span> True
</pre></div>
</div>
<p>The default is False, meaning that handlers will not run if a failure has occurred on a host.
This can also be set per play or on the command line. See <code class="xref doc docutils literal"><span class="pre">_handlers_and_failure</span></code> for more details.
如果这个选项是False. 如果一个主机崩溃了,handlers将不会再运行这个主机.这个选项也可以通过命令行临时使用.详见:doc:<cite>_handlers_and_failure</cite>.</p>
</div>
<div class="section" id="forks">
<span id="id18"></span><h6><a class="toc-backref" href="#id76">forks</a><a class="headerlink" href="#forks" title="Permalink to this headline">¶</a></h6>
<p>这个选项设置在与主机通信时的默认并行进程数.从Ansible 1.3开始,fork数量默认自动设置为主机数量或者潜在的主机数量,
这将直接控制有多少网络资源活着cpu可以被使用.很多用户把这个设置为50,有些设置为500或者更多.如果你有很多的主机,
高数值将会使得跨主机行为变快.默认值比较保守:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">_forks</span><span class="o">=</span>5
</pre></div>
</div>
</div>
<div class="section" id="gathering">
<span id="id19"></span><h6><a class="toc-backref" href="#id77">gathering</a><a class="headerlink" href="#gathering" title="Permalink to this headline">¶</a></h6>
<p>1.6版本中的新特性,这个设置控制默认facts收集（远程系统变量）.
默认值为&#8217;implicit&#8217;, 每一次play,facts都会被手机,除非设置&#8217;gather_facts: False&#8217;. 选项‘explicit’正好相反,facts不会被收集,直到play中需要.
‘smart’选项意思是,没有facts的新hosts将不会被扫描, 但是如果同样一个主机,在不同的plays里面被记录地址,在playbook运行中将不会通信.这个选项当有需求节省fact收集时比较有用.</p>
</div>
<div class="section" id="hash-behaviour">
<h6><a class="toc-backref" href="#id78">hash_behaviour</a><a class="headerlink" href="#hash-behaviour" title="Permalink to this headline">¶</a></h6>
<p>Ansible 默认将会以一种特定的优先级覆盖变量,详见:doc:<cite>playbooks_variables</cite>.拥有更高优先级的参数将会覆盖掉其他参数</p>
<p>有些用户希望被hashed的参数（python 中的数据结构&#8217;dictionaries&#8217;）被合并. 这个设置叫做‘merge’.这不是一个默认设置,而且不影响数组类型的数组.我不建议使用这个设置除非你觉得一定需要这个设置.官方实例中不使用这个选项:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">hash_behaviour</span><span class="o">=</span>replace
</pre></div>
</div>
<p>合法的值为&#8217;replace&#8217;(默认值)或者‘merge’.</p>
</div>
<div class="section" id="hostfile">
<span id="id20"></span><h6><a class="toc-backref" href="#id79">hostfile</a><a class="headerlink" href="#hostfile" title="Permalink to this headline">¶</a></h6>
<p>在1.9版本中,这不是一个合法设置.详见:ref:<cite>inventory</cite>.</p>
</div>
<div class="section" id="host-key-checking">
<span id="id21"></span><h6><a class="toc-backref" href="#id80">host_key_checking</a><a class="headerlink" href="#host-key-checking" title="Permalink to this headline">¶</a></h6>
<p>这个特性详见:doc:<cite>intro_getting_started</cite>,在Ansible 1.3或更新版本中将会检测主机密钥. 如果你了解怎么使用并且希望禁用这个功能,你可以将这个值设置为False:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">host_key_checking</span><span class="o">=</span>True
</pre></div>
</div>
</div>
<div class="section" id="inventory">
<span id="id22"></span><h6><a class="toc-backref" href="#id81">inventory</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h6>
<p>这个事默认库文件位置,脚本,或者存放可通信主机的目录:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">inventory</span> <span class="o">=</span> /etc/ansible/hosts
</pre></div>
</div>
<p>在1.9版本中被叫做hostfile.</p>
</div>
<div class="section" id="jinja2-extensions">
<span id="id23"></span><h6><a class="toc-backref" href="#id82">jinja2_extensions</a><a class="headerlink" href="#jinja2-extensions" title="Permalink to this headline">¶</a></h6>
<p>这是一个开发者中心特性,允许开启Jinja2拓展模块:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">jinja2_extensions</span> <span class="o">=</span> jinja2.ext.do,jinja2.ext.i18n
</pre></div>
</div>
<p>如果你不太清楚这些都是啥,还是不要改的好:)</p>
</div>
<div class="section" id="library">
<span id="id24"></span><h6><a class="toc-backref" href="#id83">library</a><a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h6>
<p>这个事Ansible默认搜寻模块的位置:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">library</span> <span class="o">=</span> /usr/share/ansible
</pre></div>
</div>
<p>Ansible知道如何搜寻多个用冒号隔开的路径,同时也会搜索在playbook中的“./library”.</p>
</div>
<div class="section" id="log-path">
<span id="id25"></span><h6><a class="toc-backref" href="#id84">log_path</a><a class="headerlink" href="#log-path" title="Permalink to this headline">¶</a></h6>
<p>如果出现在ansible.cfg文件中.Ansible 将会在选定的位置登陆执行信息.请留意用户运行的Ansible对于logfile有权限:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">log_path</span><span class="o">=</span>/var/log/ansible.log
</pre></div>
</div>
<p>这个特性不是默认开启的.如果不设置,ansible将会吧模块加载纪录在系统日志系统中.不包含用密码.</p>
<p>对于需要了解更多日志系统的企业及用户,你也许对:doc:<cite>tower</cite> 感兴趣.</p>
</div>
<div class="section" id="lookup-plugins">
<span id="id26"></span><h6><a class="toc-backref" href="#id85">lookup_plugins</a><a class="headerlink" href="#lookup-plugins" title="Permalink to this headline">¶</a></h6>
<p>这是一个开发者中心选项,允许模块插件在不同区域被加载:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">lookup_plugins</span> <span class="o">=</span> ~/.ansible/plugins/lookup_plugins/:/usr/share/ansible_plugins/lookup_plugins
</pre></div>
</div>
<p>绝大部分用户将不会使用这个特性,详见:doc:<cite>developing_plugins</cite></p>
</div>
<div class="section" id="module-lang">
<span id="id27"></span><h6><a class="toc-backref" href="#id86">module_lang</a><a class="headerlink" href="#module-lang" title="Permalink to this headline">¶</a></h6>
<p>这是默认模块和系统之间通信的计算机语言,默认为&#8217;C&#8217;语言.</p>
</div>
<div class="section" id="module-name">
<span id="id28"></span><h6><a class="toc-backref" href="#id87">module_name</a><a class="headerlink" href="#module-name" title="Permalink to this headline">¶</a></h6>
<p>这个是/usr/bin/ansible的默认模块名（-m）. 默认是&#8217;command&#8217;模块. 之前提到过,command模块不支持shell变量,管道,配额.
所以也许你希望把这个参数改为&#8217;shell&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">module_name</span> <span class="o">=</span> <span class="nb">command</span>
</pre></div>
</div>
</div>
<div class="section" id="nocolor">
<span id="id29"></span><h6><a class="toc-backref" href="#id88">nocolor</a><a class="headerlink" href="#nocolor" title="Permalink to this headline">¶</a></h6>
<p>默认ansible会为输出结果加上颜色,用来更好的区分状态信息和失败信息.如果你想关闭这一功能,可以把&#8217;nocolor&#8217;设置为‘1’:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">nocolor</span><span class="o">=</span>0
</pre></div>
</div>
</div>
<div class="section" id="nocows">
<span id="id30"></span><h6><a class="toc-backref" href="#id89">nocows</a><a class="headerlink" href="#nocows" title="Permalink to this headline">¶</a></h6>
<p>默认ansible可以调用一些cowsay的特性,使得/usr/bin/ansible-playbook运行起来更加愉快.为啥呢,因为我们相信系统应该是一
比较愉快的经历.如果你不喜欢cows,你可以通通过将&#8217;nocows&#8217;设置为‘1’来禁用这一选项:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">nocows</span><span class="o">=</span>0
</pre></div>
</div>
</div>
<div class="section" id="pattern">
<span id="id31"></span><h6><a class="toc-backref" href="#id90">pattern</a><a class="headerlink" href="#pattern" title="Permalink to this headline">¶</a></h6>
<p>如果没有提供“hosts”节点,这是playbook要通信的默认主机组.默认值是对所有主机通信,如果不想被惊吓到,最好还是设置个个选项:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">hosts</span><span class="o">=</span>*
</pre></div>
</div>
<p>注意 /usr/bin/ansible 一直需要一个host pattern,并且不使用这个选项.这个选项只作用于/usr/bin/ansible-playbook.</p>
</div>
<div class="section" id="poll-interval">
<span id="id32"></span><h6><a class="toc-backref" href="#id91">poll_interval</a><a class="headerlink" href="#poll-interval" title="Permalink to this headline">¶</a></h6>
<p>对于Ansible中的异步任务(详见 <a class="reference internal" href="index.html#document-docs/playbooks_async"><em>异步操作和轮询</em></a>）, 这个是设置定义,当具体的poll interval 没有定义时,多少时间回查一下这些任务的状态,
默认值是一个折中选择15秒钟.这个时间是个回查频率和任务完成叫回频率和当任务完成时的回转频率的这种:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">poll_interval</span><span class="o">=</span>15
</pre></div>
</div>
</div>
<div class="section" id="private-key-file">
<span id="id33"></span><h6><a class="toc-backref" href="#id92">private_key_file</a><a class="headerlink" href="#private-key-file" title="Permalink to this headline">¶</a></h6>
<p>如果你是用pem密钥文件而不是SSH 客户端或秘密啊认证的话,你可以设置这里的默认值,来避免每一次提醒设置密钥文件位置``&#8211;ansible-private-keyfile``:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">private_key_file</span><span class="o">=</span>/path/to/file.pem
</pre></div>
</div>
</div>
<div class="section" id="remote-port">
<span id="id34"></span><h6><a class="toc-backref" href="#id93">remote_port</a><a class="headerlink" href="#remote-port" title="Permalink to this headline">¶</a></h6>
<p>这个设置是你系统默认的远程SSH端口,如果不指定,默认为22号端口:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">remote_port</span> <span class="o">=</span> 22
</pre></div>
</div>
</div>
<div class="section" id="remote-tmp">
<span id="id35"></span><h6><a class="toc-backref" href="#id94">remote_tmp</a><a class="headerlink" href="#remote-tmp" title="Permalink to this headline">¶</a></h6>
<p>Ansible 通过远程传输模块到远程主机,然后远程执行,执行后在清理现场.在有些场景下,你也许想使用默认路径希望像更换补丁一样使用,
这时候你可以使用这个选项.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">remote_tmp</span> <span class="o">=</span> <span class="nv">$HOME</span>/.ansible/tmp
</pre></div>
</div>
<p>默认路径是在用户家目录下属的目录.Ansible 会在这个目录中使用一个随机的文件夹名称.</p>
</div>
<div class="section" id="remote-user">
<span id="id36"></span><h6><a class="toc-backref" href="#id95">remote_user</a><a class="headerlink" href="#remote-user" title="Permalink to this headline">¶</a></h6>
<p>这是个ansible使用/usr/bin/ansible-playbook链接的默认用户名. 注意如果不指定,/usr/bin/ansible默认使用当前用户名称:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">remote_user</span> <span class="o">=</span> root
</pre></div>
</div>
</div>
<div class="section" id="roles-path">
<span id="id37"></span><h6><a class="toc-backref" href="#id96">roles_path</a><a class="headerlink" href="#roles-path" title="Permalink to this headline">¶</a></h6>
<p>roles 路径指的是&#8217;roles/&#8217;下的额外目录,用于playbook搜索Ansible roles.比如, 如果我们有个用于common roles源代码控制仓库和一个不同的
playbooks仓库,你也许会建立一个惯例去在 /opt/mysite/roles 里面查找roles.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">roles_path</span> <span class="o">=</span> /opt/mysite/roles
</pre></div>
</div>
<p>多余的路径可以用冒号分隔,类似于其他path字符串:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">roles_path</span> <span class="o">=</span> /opt/mysite/roles:/opt/othersite/roles
</pre></div>
</div>
<p>Roles将会在playbook目录中开始搜索.如果role没有找到,这个参数指定了其它可能的搜索路径.</p>
</div>
<div class="section" id="sudo-exe">
<span id="id38"></span><h6><a class="toc-backref" href="#id97">sudo_exe</a><a class="headerlink" href="#sudo-exe" title="Permalink to this headline">¶</a></h6>
<p>如果在其他远程主机上使用另一种方式执行sudo草做, sudo程序的路径可以用这个参数更换,使用命令行标签来拟合标准sudo:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">sudo_exe</span><span class="o">=</span>sudo
</pre></div>
</div>
</div>
<div class="section" id="sudo-flags">
<span id="id39"></span><h6><a class="toc-backref" href="#id98">sudo_flags</a><a class="headerlink" href="#sudo-flags" title="Permalink to this headline">¶</a></h6>
<p>当使用sudo支持的时候,传递给sudo而外的标签. 默认值为&#8221;-H&#8221;, 意思是保留原用户的环境.在有些场景下也许需要添加或者删除
标签,大多数用户不需要修改这个选项:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">sudo_flags</span><span class="o">=</span>-H
</pre></div>
</div>
</div>
<div class="section" id="sudo-user">
<span id="id40"></span><h6><a class="toc-backref" href="#id99">sudo_user</a><a class="headerlink" href="#sudo-user" title="Permalink to this headline">¶</a></h6>
<p>这个是sudo使用的默认用户,如果``&#8211;sudo-user`` 没有特指或者&#8217;sudo_user&#8217; 在Ansible playbooks中没有特指,在大多数的逻辑中
默认为: &#8216;root&#8217;</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">sudo_user</span><span class="o">=</span>root
</pre></div>
</div>
</div>
<div class="section" id="system-warnings">
<span id="id41"></span><h6><a class="toc-backref" href="#id100">system_warnings</a><a class="headerlink" href="#system-warnings" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>允许禁用系统运行ansible相关的潜在问题警告（不包括操作主机）:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">system_warnings</span> <span class="o">=</span> True
</pre></div>
</div>
<p>这个包括第三方库或者一些需要解决问题的警告.</p>
</div>
<div class="section" id="timeout">
<span id="id42"></span><h6><a class="toc-backref" href="#id101">timeout</a><a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h6>
<p>这个事默认SSH链接尝试超市时间:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">timeout</span> <span class="o">=</span> 10
</pre></div>
</div>
</div>
<div class="section" id="transport">
<span id="id43"></span><h6><a class="toc-backref" href="#id102">transport</a><a class="headerlink" href="#transport" title="Permalink to this headline">¶</a></h6>
<p>如果&#8221;-c  &lt;transport_name&gt;&#8221; 选项没有在使用/usr/bin/ansible 或者 /usr/bin/ansible-playbook 特指的话,这个参数提供了默认通信机制.默认
值为&#8217;smart&#8217;, 如果本地系统支持 ControlPersist技术的话,将会使用(基于OpenSSH)‘ssh’,如果不支持讲使用‘paramiko’.其他传输选项包括‘local’,
&#8216;chroot&#8217;,&#8217;jail&#8217;等等.</p>
<p>用户通常可以这个设置为‘smart’,让playbook在需要的条件自己选择‘connectin:’参数.</p>
</div>
<div class="section" id="vars-plugins">
<span id="id44"></span><h6><a class="toc-backref" href="#id103">vars_plugins</a><a class="headerlink" href="#vars-plugins" title="Permalink to this headline">¶</a></h6>
<p>这是一个开发者中心选项,允许底层拓展模块从任何地方加载:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">vars_plugins</span> <span class="o">=</span> ~/.ansible/plugins/vars_plugins/:/usr/share/ansible_plugins/vars_plugins
</pre></div>
</div>
<p>大部分的用户不会用到这个特性,详见:doc:<cite>developing_plugins</cite></p>
</div>
<div class="section" id="vault-password-file">
<span id="id45"></span><h6><a class="toc-backref" href="#id104">vault_password_file</a><a class="headerlink" href="#vault-password-file" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.7.</span></p>
</div>
<p>这个用来设置密码文件,也可以通过命令行指定``&#8211;vault-password-file``:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">vault_password_file</span> <span class="o">=</span> /path/to/vault_password_file
</pre></div>
</div>
<p>在1.7版本中,这个文件也可以称为一个脚本的形式.如果你使用脚本而不是单纯文件的话,请确保它可以执行并且密码可以在标准输出上打印出来.如果你的脚本需要提示请求数据,请求将会发到标准错误输出中.</p>
</div>
</div>
<div class="section" id="paramiko-specific-settings">
<span id="paramiko-settings"></span><h5><a class="toc-backref" href="#id105">Paramiko Specific Settings</a><a class="headerlink" href="#paramiko-specific-settings" title="Permalink to this headline">¶</a></h5>
<p>Paramiko 是商业版linux 6 的默认SSH链接.但在其他平台上不是默认使用的.请在[paramiko]头文件下激活它.</p>
<div class="section" id="record-host-keys">
<span id="id46"></span><h6><a class="toc-backref" href="#id106">record_host_keys</a><a class="headerlink" href="#record-host-keys" title="Permalink to this headline">¶</a></h6>
<p>默认设置会记录并验证通过在用户hostfile中新发现的的主机（如果host key checking 被激活的话）. 这个选项在有很多主机的时候将会性能很差.在
这种情况下,建议使用SSH传输代替. 当设置为False时, 性能将会提升,在hostkey checking 被禁用时候,建议使用.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">record_host_keys</span><span class="o">=</span>True
</pre></div>
</div>
</div>
</div>
<div class="section" id="openssh-specific-settings">
<span id="openssh-settings"></span><h5><a class="toc-backref" href="#id107">OpenSSH Specific Settings</a><a class="headerlink" href="#openssh-specific-settings" title="Permalink to this headline">¶</a></h5>
<p>在[ssh_connection]头文件之下,用来调整SSH的通信连接.OpenSSH是Ansible在操作系统上默认的通讯连接,对于支持ControlPersist足够新了.（意思除了Enterprise linux 6版以及更早的系统外的所有的操作系统).</p>
<div class="section" id="ssh-args">
<span id="id47"></span><h6><a class="toc-backref" href="#id108">ssh_args</a><a class="headerlink" href="#ssh-args" title="Permalink to this headline">¶</a></h6>
<p>如果设置了的话,这个选项将会传递一组选项给Ansible 然不是使用以前的默认值:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">ssh_args</span> <span class="o">=</span> -o <span class="nv">ControlMaster</span><span class="o">=</span>auto -o <span class="nv">ControlPersist</span><span class="o">=</span>60s
</pre></div>
</div>
<p>用户可以提高ControlPersist值来提高性能.30 分钟通常比较合适.</p>
</div>
<div class="section" id="control-path">
<span id="id48"></span><h6><a class="toc-backref" href="#id109">control_path</a><a class="headerlink" href="#control-path" title="Permalink to this headline">¶</a></h6>
<p>这个是保存ControlPath套接字的位置. 默认值是:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">control_path</span><span class="o">=</span>%<span class="o">(</span>directory<span class="o">)</span>s/ansible-ssh-%%h-%%p-%%r
</pre></div>
</div>
<p>在有些系统上面,会遇到很长的主机名或者很长的路径名称（也许因为很长的用户名,或者比较深的家目录）,这些都会
超出套接字文件名字符上限（对于大多数平台上限为108个字符）.在这种情况下,你也许希望按照以下方式缩短字符串:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">control_path</span> <span class="o">=</span> %<span class="o">(</span>directory<span class="o">)</span>s/%%h-%%r
</pre></div>
</div>
<p>Ansible 1.4 以后的版本会引导用户在这种情况下使用&#8221;-vvvv&#8221;参数,这样很容易分辨 Control Path 文件名是否过长.这个
问题在EC2上会频繁的遇到.</p>
</div>
<div class="section" id="scp-if-ssh">
<span id="id49"></span><h6><a class="toc-backref" href="#id110">scp_if_ssh</a><a class="headerlink" href="#scp-if-ssh" title="Permalink to this headline">¶</a></h6>
<p>又是用户操控一个一个没有开启SFTP协议的远程系统.如果这个设置为True,scp将代替用来为远程主机传输文件:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">scp_if_ssh</span><span class="o">=</span>False
</pre></div>
</div>
<p>如果没有遇到这样的问题没有必要来修改这个设置.当然修改这个设置也没有什么明显的弊端.大部分的系统环境都默认支持SFTP,
通常情况下不需要修改.</p>
</div>
<div class="section" id="pipelining">
<span id="id50"></span><h6><a class="toc-backref" href="#id111">pipelining</a><a class="headerlink" href="#pipelining" title="Permalink to this headline">¶</a></h6>
<p>在不通过实际文件传输的情况下执行ansible模块来使用管道特性,从而减少执行远程模块SSH操作次数.如果开启这个设置,将显著提高性能.
然而当使用&#8221;sudo:&#8221;操作的时候, 你必须在所有管理的主机的/etc/sudoers中禁用&#8217;requiretty&#8217;.</p>
<p>默认这个选项为了保证与sudoers requiretty的设置（在很多发行版中时默认的设置）的兼容性是禁用的.
但是为了提高性能强烈建议开启这个设置.详见:doc:<cite>playbooks_acceleration</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">pipelining</span><span class="o">=</span>False
</pre></div>
</div>
</div>
</div>
<div class="section" id="accelerated-mode-settings">
<span id="accelerate-settings"></span><h5><a class="toc-backref" href="#id112">Accelerated Mode Settings</a><a class="headerlink" href="#accelerated-mode-settings" title="Permalink to this headline">¶</a></h5>
<p>在[accelerate]首部下, 以下设置可以调整,详见:doc:<cite>playbooks_acceleration</cite>.如果你不能在你的环境中开启:ref:<cite>pipelining</cite> ,
Accelertation 是一个很有用的性能特性. 但是如果你可以开启管道,这个选项也许对你无用.</p>
<div class="section" id="accelerate-port">
<span id="id51"></span><h6><a class="toc-backref" href="#id113">accelerate_port</a><a class="headerlink" href="#accelerate-port" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>在急速模式下使用的端口:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">accelerate_port</span> <span class="o">=</span> 5099
</pre></div>
</div>
</div>
<div class="section" id="accelerate-timeout">
<span id="id52"></span><h6><a class="toc-backref" href="#id114">accelerate_timeout</a><a class="headerlink" href="#accelerate-timeout" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>这个设置时用来控制从客户机获取数据的超时时间.如果在这段时间内没有数据传输,套接字连接会被关闭. 一个保持连接（keepalive）数据包通常每15秒回发回给控制台,所以这个超时时间不应该低于15秒（默认值为30秒）:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">accelerate_timeout</span> <span class="o">=</span> 30
</pre></div>
</div>
</div>
<div class="section" id="accelerate-connect-timeout">
<span id="id53"></span><h6><a class="toc-backref" href="#id115">accelerate_connect_timeout</a><a class="headerlink" href="#accelerate-connect-timeout" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>这个设置空着套接字调用的超时时间.这个应该设置相对比较短.这个和`accelerate_port`连接在回滚到ssh或者paramiko（受限于你默认的连接设置）连接方式之前会尝试三次开始远程加速daemon守护进程.默认设置为1.0秒:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">accelerate_connect_timeout</span> <span class="o">=</span> 1.0
</pre></div>
</div>
<p>注意,这个选项值可以设置为小于1秒钟,但是除非你拥有一个速度很快而且很可靠的网络,否则也许这样并不是一个很好的选择.如果你使用英特网访问你的系统,最好提高这个值.</p>
</div>
<div class="section" id="accelerate-daemon-timeout">
<span id="id54"></span><h6><a class="toc-backref" href="#id116">accelerate_daemon_timeout</a><a class="headerlink" href="#accelerate-daemon-timeout" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>This setting controls the timeout for the accelerated daemon, as measured in minutes. The default daemon timeout is 30 minutes::
这个控制加速daemon守护进程的超时时间,用分钟来衡量.默认为30分钟:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">accelerate_daemon_timeout</span> <span class="o">=</span> 30
</pre></div>
</div>
<p>注意, 在1.6版本之前,daemon发起的超时时间是硬编码的.对于1.6以后的版本,超时时间是根据daemon上一次活动信息和这个可设置的选项.</p>
</div>
<div class="section" id="accelerate-multi-key">
<span id="id55"></span><h6><a class="toc-backref" href="#id117">accelerate_multi_key</a><a class="headerlink" href="#accelerate-multi-key" title="Permalink to this headline">¶</a></h6>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.6.</span></p>
</div>
<p>If enabled, this setting allows multiple private keys to be uploaded to the daemon. Any clients connecting to the daemon must also enable this option::
如果这个选项开启,这个设置将允许多个私钥被加载到daemon. 任何客户端要想连接daemon都需要开启这个选项:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">accelerate_multi_key</span> <span class="o">=</span> yes
</pre></div>
</div>
<p>通过本地套接字文件连接的通过SSH上传密钥文件到目标节点的新客户端,必须在登陆daemon时使用原始的登陆密钥登陆.</p>
</div>
</div>
</div>
</div>
<span id="document-docs/intro_windows"></span><div class="section" id="windows-support">
<h3><a class="toc-backref" href="#id7">Windows Support</a><a class="headerlink" href="#windows-support" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#windows-support" id="id7">Windows Support</a><ul>
<li><a class="reference internal" href="#windows" id="id8">windows下的运行方式</a></li>
<li><a class="reference internal" href="#windows-installing" id="id9">安装管理机</a></li>
<li><a class="reference internal" href="#inventory" id="id10">Inventory</a></li>
<li><a class="reference internal" href="#windows-system-prep" id="id11">Windows System Prep</a></li>
<li><a class="reference internal" href="#getting-to-powershell-3-0-or-higher" id="id12">Getting to PowerShell 3.0 or higher</a></li>
<li><a class="reference internal" href="#id3" id="id13">可用的windows模块</a></li>
<li><a class="reference internal" href="#developers-developers-developers" id="id14">开发者:支持的模块及工作原理</a></li>
<li><a class="reference internal" href="#linux" id="id15">提醒:控制机必须是Linux系统</a></li>
<li><a class="reference internal" href="#windows-facts" id="id16">Windows Facts</a></li>
<li><a class="reference internal" href="#windows-playbook-examples" id="id17">Windows Playbook Examples</a></li>
<li><a class="reference internal" href="#windows-contributions" id="id18">Windows Contributions</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="windows">
<span id="windows-how-does-it-work"></span><h4><a class="toc-backref" href="#id8">windows下的运行方式</a><a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h4>
<p>就如你刚所了解到的,Ansible默认是通过SSH协议来管理Linux/Unix服务器.</p>
<p>从1.7版本开始,Ansible也开始支持Windows机器的管理.不过是通过本机的PowerShell来实现远程管理,而不是SSH.</p>
<p>Ansible仍然通过一台Linux系统机器来进行集中管理,使用Python的 &#8220;winrm&#8221; 模块来和远程主机交互.</p>
<p>在管理的过程是 Ansible无需在远程主机上安装任何额外的软件,Ansible仍然使用 agentless(非c/s架构) 来保证其在 Linux/Unix的流行度.</p>
<p>需要注意的是有开始这章前你最好对对 Ansible 有一个预先的了解,如果你还没有写过一个 Playbook, 那最好先跳到playbook的章节先了解熟悉再开始本章内容.</p>
</div>
<div class="section" id="windows-installing">
<span id="id1"></span><h4><a class="toc-backref" href="#id9">安装管理机</a><a class="headerlink" href="#windows-installing" title="Permalink to this headline">¶</a></h4>
<p>On a Linux control machine:</p>
<div class="highlight-bash"><div class="highlight"><pre>pip install http://github.com/diyan/pywinrm/archive/master.zip#egg<span class="o">=</span>pywinrm
</pre></div>
</div>
<p>如果你想通过活动目录连接域帐户进行发布(相对本地帐户在远程主机上创建):</p>
<div class="highlight-bash"><div class="highlight"><pre>pip install kerberos
</pre></div>
</div>
<p>Kerberos 在 OS X 和许多 Linux 发行版中是默认安装且配置好的.如果你的管理机上还没有安装,那你需要执行如上的命令.</p>
</div>
<div class="section" id="inventory">
<span id="windows-inventory"></span><h4><a class="toc-backref" href="#id10">Inventory</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h4>
<p>Ansible&#8217;s支持windows需要依赖于少量标准变量来表明远程主机的username, password, and connection type (windows).这些变量大部分都很容易被设置好.在 Ansible 中通过用来代替 SSH-keys 或 密码输入:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>windows<span class="o">]</span>
winserver1.example.com
winserver2.example.com
</pre></div>
</div>
<p>在 group_vars/windows.yml,定义如下 inventory 变量:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># it is suggested that these be encrypted with ansible-vault:</span>
<span class="c"># ansible-vault edit group_vars/windows.yml</span>

ansible_ssh_user: Administrator
ansible_ssh_pass: SecretPasswordGoesHere
ansible_ssh_port: 5986
ansible_connection: winrm
</pre></div>
</div>
<p>需要注意的是这里的 ssh_port 不是真正的SSH协议的端口,but this is a holdover variable name from how Ansible is mostly an SSH-oriented system.(这句也没看懂)再重复一遍,Windows 管理主机不是通过SSH协议.</p>
<p>如果你已经安装了 <code class="docutils literal"><span class="pre">kerberos</span></code> 模块和 <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code> 包括 <code class="docutils literal"><span class="pre">&#64;</span></code> (e.g. <code class="docutils literal"><span class="pre">username&#64;realm</span></code>), Ansible会先尝试Kerberos认证. * 这种方式主要用你通过Kerberos在远程主机上的认证而不是 <code class="docutils literal"><span class="pre">ansible_ssh_user</span></code> * .如果上述办法失败了,要么是因为你没有在管理机上签署(signed into)Kerberos,要么是因为远程主机上对应的域帐户不可用,接着 Ansible 将返回原始(&#8220;plain&#8221;)username/password的认证方式.</p>
<p>当你使用 playbook 时,请不要忘记指定 &#8211;ask-vault-pass 提供密码来解锁文件.</p>
<p>使用如下命令来测试你的配置,尝试连接你的 Windows 节点.注意:这不是ICMP ping,只是利用 Windows 远程工具来检测 Ansible 的信道是否正常:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible windows <span class="o">[</span>-i inventory<span class="o">]</span> -m win_ping --ask-vault-pass
</pre></div>
</div>
<p>如果你还没有在你的系统上做任何准备工作,那上面的命令是无法正常工作的. 在下面最近的章节将会介绍 &#8220;how to enable PowerShell remoting&#8221; - 如果有需要的话也将介绍 &#8220;how to upgrade PowerShell to a version that is 3 or higher&#8221; .</p>
<p>你可以稍后再执行该命令,以确保一切都能正常工作.</p>
</div>
<div class="section" id="windows-system-prep">
<span id="id2"></span><h4><a class="toc-backref" href="#id11">Windows System Prep</a><a class="headerlink" href="#windows-system-prep" title="Permalink to this headline">¶</a></h4>
<p>为了 Ansible 能管理你的windows机器,你将必须开启并配置远程机器上PowerShell.</p>
<p>为了能自动化设置 WinRM,你可以在远程机器上执行 <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1">this PowerShell script</a></p>
<p>Admins有可能希望微调配置,例如延长证过期时间.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Windows 7 和 Server 2008 R2 系统因为 Windows
Management Framework 3.0的BUG,你必须安装 hotfix <a class="reference external" href="http://support.microsoft.com/kb/2842230">http://support.microsoft.com/kb/2842230</a> 来避免内存溢出(OOM)和堆栈异常. 新安装的 Server 2008 R2 系统没有升级到最新版本的均存在这个问题.</p>
<p class="last">Windows 8.1 and Server 2012 R2 不受影响是因为他们自身默认使用的是 Windows Management Framework 4.0.</p>
</div>
</div>
<div class="section" id="getting-to-powershell-3-0-or-higher">
<span id="getting-to-powershell-three-or-higher"></span><h4><a class="toc-backref" href="#id12">Getting to PowerShell 3.0 or higher</a><a class="headerlink" href="#getting-to-powershell-3-0-or-higher" title="Permalink to this headline">¶</a></h4>
<p>多数 Ansible Windows 模块需要 PowerShell 3.0 或更高版本,同时也需要在其基础上运行安装脚本. 需要注意的是 PowerShell 3.0 只在 Windows 7 SP1 ,Windows Server 2008 SP1, 和更新的windows发布版才被支持.</p>
<p>找到 Ansible 的checkout版本,复制 copy the <a class="reference external" href="https://github.com/cchurch/ansible/blob/devel/examples/scripts/upgrade_to_ps3.ps1">examples/scripts/upgrade_to_ps3.ps1</a> 脚本到远程主机同时以Administrator角色的帐户运行 PowerShell 控制台. 你就可以运行 PowerShell 3 并可以通过上面介绍的 win_ping 技术来测试连通性.</p>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id13">可用的windows模块</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>大多数 Ansible 模块尤其核心Ansible设计来组合 Linux/Unix 机器和任意 web services. 尽管 <a class="reference external" href="http://docs.ansible.com/list_of_windows_modules.html">&#8220;windows&#8221; subcategory of the Ansible module index</a> 列举了各种各校的 Windows 模块.</p>
<p>浏览上面的索引查看可用模块.</p>
<p>很多情况下, 其实没有必要写或者使用 Ansible 模块.</p>
<p>尤其, &#8220;script&#8221; 模块可以用来执行任意 PowerShell 脚本,允许 Windows administrators 组所有用户通过 PowerSehll 以非常本地化的方式做任何事情.就像如下的 playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: windows
  tasks:
    - script: foo.ps1 --argument --other-argument
</pre></div>
</div>
<p>注意: 有一小部分 Ansible 模块不是以 &#8220;win&#8221; 开头但依然是函数,包括 &#8220;slurp&#8221;,&#8221;raw&#8221;,和&#8221;setup&#8221;(fact 收集的工作原理).</p>
</div>
<div class="section" id="developers-developers-developers">
<span id="id4"></span><h4><a class="toc-backref" href="#id14">开发者:支持的模块及工作原理</a><a class="headerlink" href="#developers-developers-developers" title="Permalink to this headline">¶</a></h4>
<p>开发 ansible 模块主要在 <a class="reference external" href="http://docs.ansible.com/developing_modules.html">later section of the documentation</a> 介绍,专注于 Linux/Unix 平台. 如果你想编写 Windows 的 ansible 模块该怎么办呢?</p>
<p>Windows 平台主要通过 PowerShell 模块实现. 开始之前可以先略过 Linux/Unix 模块开发章节.</p>
<p>Windows 模块在 Ansible &#8220;library/&#8221; 子目录下的 &#8220;windows/&#8221; 子目录下. 例如,如果一个模块命名为 &#8220;library/windows/win_ping&#8221;,那将会在 &#8220;win_ping&#8221; 文件中嵌入一个文档,实际的 PowerShell 代码将存在 &#8220;win_ping.ps1&#8221; 文件. 看下源代码会有更深入的了解.</p>
<p>模块(ps1 files)文件应该以如下格式开头:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!powershell</span>
<span class="c"># &lt;license&gt;</span>

<span class="c"># WANT_JSON</span>
<span class="c"># POWERSHELL_COMMON</span>

<span class="c"># code goes here, reading in stdin as JSON and outputting JSON</span>
</pre></div>
</div>
<p>如上代码是为了告诉 ansible 合入一些代码并且
The above magic is necessary to tell Ansible to mix in some common code and also know how to push modules out.  常规代码包括好包装例如哈希数据结构,jason格式标准输出,还有一些更有用的东西.常规 Ansible 有着重复利用 Python 代码的理念 - 这点 Windows 也是等同的.
你刚看到的 windows/ 模块只是一个开始. 附加模块已经被 git push 到 github上了.</p>
</div>
<div class="section" id="linux">
<span id="windows-and-linux-control-machine"></span><h4><a class="toc-backref" href="#id15">提醒:控制机必须是Linux系统</a><a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<p>Windows 控制机不是这个项目的目标. Ansible 不会开发这个功能,因为受限于技术,产品和我们未来主要项目使用的代码. 一台Linux控制机是必须的,可以用来管理 Windows 机器. Cygwin 也是不被支持的,所以请不要要求 Ansible 基于 Cygwin 来运行.</p>
</div>
<div class="section" id="windows-facts">
<span id="id5"></span><h4><a class="toc-backref" href="#id16">Windows Facts</a><a class="headerlink" href="#windows-facts" title="Permalink to this headline">¶</a></h4>
<p>Just as with Linux/Unix, facts can be gathered for windows hosts, which will return things such as the operating system version.  To see what variables are available about a windows host, run the following:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible winhost.example.com -m setup
</pre></div>
</div>
<p>Note that this command invocation is exactly the same as the Linux/Unix equivalent.</p>
</div>
<div class="section" id="windows-playbook-examples">
<span id="windows-playbook-example"></span><h4><a class="toc-backref" href="#id17">Windows Playbook Examples</a><a class="headerlink" href="#windows-playbook-examples" title="Permalink to this headline">¶</a></h4>
<p>Look to the list of windows modules for most of what is possible, though also some modules like &#8220;raw&#8221; and &#8220;script&#8221; also work on Windows, as do &#8220;fetch&#8221; and &#8220;slurp&#8221;.</p>
<p>Here is an example of pushing and running a PowerShell script:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: <span class="nb">test </span>script module
  hosts: windows
  tasks:
    - name: run <span class="nb">test </span>script
      script: files/test_script.ps1
</pre></div>
</div>
<p>Running individual commands uses the &#8216;raw&#8217; module, as opposed to the shell or command module as is common on Linux/Unix operating systems:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: <span class="nb">test </span>raw module
  hosts: windows
  tasks:
    - name: run ipconfig
      raw: ipconfig
      register: ipconfig
    - debug: <span class="nv">var</span><span class="o">=</span>ipconfig
</pre></div>
</div>
<p>And for a final example, here&#8217;s how to use the win_stat module to test for file existence.  Note that the data returned by the win_stat module is slightly different than what is provided by the Linux equivalent:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: <span class="nb">test </span>stat module
  hosts: windows
  tasks:
    - name: <span class="nb">test </span>stat module on file
      win_stat: <span class="nv">path</span><span class="o">=</span><span class="s2">&quot;C:/Windows/win.ini&quot;</span>
      register: stat_file

    - debug: <span class="nv">var</span><span class="o">=</span>stat_file

    - name: check stat_file result
      assert:
          that:
             - <span class="s2">&quot;stat_file.stat.exists&quot;</span>
             - <span class="s2">&quot;not stat_file.stat.isdir&quot;</span>
             - <span class="s2">&quot;stat_file.stat.size &gt; 0&quot;</span>
             - <span class="s2">&quot;stat_file.stat.md5&quot;</span>
</pre></div>
</div>
<p>Again, recall that the Windows modules are all listed in the Windows category of modules, with the exception that the &#8220;raw&#8221;, &#8220;script&#8221;, and &#8220;fetch&#8221; modules are also available.  These modules do not start with a &#8220;win&#8221; prefix.</p>
</div>
<div class="section" id="windows-contributions">
<span id="id6"></span><h4><a class="toc-backref" href="#id18">Windows Contributions</a><a class="headerlink" href="#windows-contributions" title="Permalink to this headline">¶</a></h4>
<p>Windows support in Ansible is still very new, and contributions are quite welcome, whether this is in the
form of new modules, tweaks to existing modules, documentation, or something else.  Please stop by the ansible-devel mailing list if you would like to get involved and say hi.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>How to write modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Learning ansible&#8217;s configuration management language</dd>
<dt><a class="reference external" href="http://docs.ansible.com/list_of_windows_modules.html">List of Windows Modules</a></dt>
<dd>Windows specific module list, all implemented in PowerShell</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/quickstart"></span><div class="section" id="id1">
<h2>快速学习视频<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>我们录制了一个简短的视频来展示如何开始使用Ansible，当你阅读文档时可以用到它。</p>
<p><a class="reference external" href="http://ansible.com/resources">快速学习视频</a> 长度大概为30分钟，介绍了刚开始使用Ansible的一些基本知识。</p>
<p>欢迎观看本视频，请确保阅读剩余的文档来进行进一步的学习。</p>
</div>
<span id="document-docs/playbooks"></span><div class="section" id="playbooks">
<h2>Playbooks<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h2>
<p>Playbooks 是 Ansible的配置,部署,编排语言.他们可以被描述为一个需要希望远程主机执行命令的方案,或者一组IT程序运行的命令集合.</p>
<p>如果 Ansible 模块你是工作室中的工具,那么 playbooks 就是你设置的方案计划.</p>
<p>在基础层面, playbooks 可以被用来管理用于部署到远程主机的配置文件.在更高的层面上,playbooks 可以依次对多层式架构上的服务器执行上线包括滚动更新在内的操作并可以将操作委托给其他主机包括在此过程中发生的与监视服务器,负载均衡服务器的交互操作在内.</p>
<p>虽然这里讲发很多,但是不需要立刻一次性全部学完.你可以从小功能开始,当你需要的时候再来这里找对应的功能即可.</p>
<p>Playbooks 被设计的非常简单易懂和基于text language二次开发.有多种办法来组织 playbooks 和其附属的文件,同时我们也会提供一些关于学习 Ansible 的建议.</p>
<p>这里强烈建议在阅读的 playbook 文档的时候同步参阅 <cite>Example Playbooks &lt;https://github.com/ansible/ansible-examples&gt;</cite> 章节. 这些例子是最佳实战以及如何将各种概念灵活贯穿结合在一起.</p>
<div class="toctree-wrapper compound">
<span id="document-docs/playbooks_intro"></span><div class="section" id="playbooks">
<h3>Playbooks 介绍<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h3>
<div class="section" id="about-playbooks">
<span id="id1"></span><h4>Playbooks 简介<a class="headerlink" href="#about-playbooks" title="Permalink to this headline">¶</a></h4>
<p>Playbooks 与 adhoc 相比,是一种完全不同的运用 ansible 的方式,是非常之强大的.</p>
<p>简单来说,playbooks 是一种简单的配置管理系统与多机器部署系统的基础.与现有的其他系统有不同之处,且非常适合于复杂应用的部署.</p>
<p>Playbooks 可用于声明配置,更强大的地方在于,在 playbooks 中可以编排有序的执行过程,甚至于做到在多组机器间,来回有序的执行特别指定的步骤.并且可以同步或异步的发起任务.</p>
<p>我们使用 adhoc 时,主要是使用 /usr/bin/ansible 程序执行任务.而使用 playbooks 时,更多是将之放入源码控制之中,用之推送你的配置或是用于确认你的远程系统的配置是否符合配置规范.</p>
<p>在如右的连接中: <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-examples repository</a> ,有一些整套的playbooks,它们阐明了上述的这些技巧.我们建议你在另一个标签页中打开它看看,配合本章节一起看.</p>
<p>即便学完 playbooks 这个章节,仍有许多知识点只是入门的级别,完成本章的学习后,可回到文档索引继续学习.</p>
</div>
<div class="section" id="playbook">
<span id="playbook-language-example"></span><h4>Playbook 语言的示例<a class="headerlink" href="#playbook" title="Permalink to this headline">¶</a></h4>
<p>Playbooks 的格式是YAML（详见:<a class="reference internal" href="index.html#document-docs/YAMLSyntax"><em>YAML 语法</em></a>）,语法做到最小化,意在避免 playbooks 成为一种编程语言或是脚本,但它也并不是一个配置模型或过程的模型.</p>
<p>playbook 由一个或多个 &#8216;plays&#8217; 组成.它的内容是一个以 &#8216;plays&#8217; 为元素的列表.</p>
<p>在 play 之中,一组机器被映射为定义好的角色.在 ansible 中,play 的内容,被称为 tasks,即任务.在基本层次的应用中,一个任务是一个对 ansible 模块的调用,这在前面章节学习过.</p>
<p>&#8216;plays&#8217; 好似音符,playbook 好似由 &#8216;plays&#8217; 构成的曲谱,通过 playbook,可以编排步骤进行多机器的部署,比如在 webservers 组的所有机器上运行一定的步骤,
然后在 database server 组运行一些步骤,最后回到 webservers 组,再运行一些步骤,诸如此类.</p>
<p>&#8220;plays&#8221; 算是一个体育方面的类比,你可以通过多个 plays 告诉你的系统做不同的事情,不仅是定义一种特定的状态或模型.你可以在不同时间运行不同的 plays.</p>
<p>对初学者,这里有一个 playbook,其中仅包含一个 play:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
  - name: ensure apache is at the latest version
    yum: <span class="nv">pkg</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>latest
  - name: write the apache config file
    template: <span class="nv">src</span><span class="o">=</span>/srv/httpd.j2 <span class="nv">dest</span><span class="o">=</span>/etc/httpd.conf
    notify:
    - restart apache
  - name: ensure apache is running
    service: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>started
  handlers:
    - name: restart apache
      service: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>在下面,我们将分别讲解 playbook 语言的多个特性.</p>
</div>
<div class="section" id="playbook-basics">
<span id="id2"></span><h4>playbook基础<a class="headerlink" href="#playbook-basics" title="Permalink to this headline">¶</a></h4>
<div class="section" id="playbook-hosts-and-users">
<span id="id3"></span><h5>主机与用户<a class="headerlink" href="#playbook-hosts-and-users" title="Permalink to this headline">¶</a></h5>
<p>你可以为 playbook 中的每一个 play,个别地选择操作的目标机器是哪些,以哪个用户身份去完成要执行的步骤（called tasks）.</p>
<dl class="docutils">
<dt><cite>hosts</cite> 行的内容是一个或多个组或主机的 patterns,以逗号为分隔符,详见 <a class="reference internal" href="index.html#document-docs/intro_patterns"><em>Patterns</em></a> 章节.</dt>
<dd><p class="first"><cite>remote_user</cite> 就是账户名:</p>
<div class="last highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  remote_user: root
</pre></div>
</div>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">参数 <cite>remote_user</cite> 以前写做 <cite>user</cite>,在 Ansible 1.4 以后才改为 remote_user.主要为了不跟 <cite>user</cite> 模块混淆（user 模块用于在远程系统上创建用户）.</p>
</div>
<p>再者,在每一个 task 中,可以定义自己的远程用户:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  remote_user: root
  tasks:
    - name: <span class="nb">test </span>connection
      ping:
      remote_user: yourname
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">task 中的 <cite>remote_user</cite> 参数在 1.4 版本以后添加.</p>
</div>
<p>也支持从 sudo 执行命令:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  remote_user: yourname
  sudo: yes
</pre></div>
</div>
<p>同样的,你可以仅在一个 task 中,使用 sudo 执行命令,而不是在整个 play 中使用 sudo:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  remote_user: yourname
  tasks:
    - service: <span class="nv">name</span><span class="o">=</span>nginx <span class="nv">state</span><span class="o">=</span>started
      sudo: yes
</pre></div>
</div>
<p>你也可以登陆后,sudo 到不同的用户身份,而不是使用 root:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  remote_user: yourname
  sudo: yes
  sudo_user: postgres
</pre></div>
</div>
<p>如果你需要在使用 sudo 时指定密码,可在运行 <cite>ansible-playbook</cite> 命令时加上选项 <code class="docutils literal"><span class="pre">--ask-sudo-pass</span></code> (<cite>-K</cite>).
如果使用 sudo 时,playbook 疑似被挂起,可能是在 sudo prompt 处被卡住,这时可执行 <cite>Control-C</cite> 杀死卡住的任务,再重新运行一次.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">当使用 <cite>sudo_user</cite> 切换到 非root 用户时,模块的参数会暂时写入 /tmp 目录下的一个随机临时文件.
当命令执行结束后,临时文件立即删除.这种情况发生在普通用户的切换时,比如从 &#8216;bob&#8217; 切换到 &#8216;timmy&#8217;,
切换到 root 账户时,不会发生,如从 &#8216;bob&#8217; 切换到 &#8216;root&#8217;,直接以普通用户或root身份登录也不会发生.
如果你不希望这些数据在短暂的时间内可以被读取（不可写）,请避免在 <cite>sudo_user</cite> 中传递未加密的密码.
其他情况下,&#8217;/tmp&#8217; 目录不被使用,这种情况不会发生.Ansible 也有意识的在日志中不记录密码参数.</p>
</div>
</div>
<div class="section" id="tasks">
<span id="tasks-list"></span><h5>Tasks 列表<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h5>
<p>每一个 play 包含了一个 task 列表（任务列表）.一个 task 在其所对应的所有主机上（通过 host pattern 匹配的所有主机）执行完毕之后,下一个 task 才会执行.有一点需要明白的是（很重要）,在一个 play 之中,所有 hosts 会获取相同的任务指令,这是 play 的一个目的所在,也就是将一组选出的 hosts 映射到 task.（注:此处翻译未必准确,暂时保留原文）</p>
<p>在运行 playbook 时（从上到下执行）,如果一个 host 执行 task 失败,这个 host 将会从整个 playbook 的 rotation 中移除.
如果发生执行失败的情况,请修正 playbook 中的错误,然后重新执行即可.</p>
<p>每个 task 的目标在于执行一个 moudle, 通常是带有特定的参数来执行.在参数中可以使用变量（variables）.</p>
<p>modules 具有&#8221;幂等&#8221;性,意思是如果你再一次地执行 moudle（译者注:比如遇到远端系统被意外改动,需要恢复原状）,moudle
只会执行必要的改动,只会改变需要改变的地方.所以重复多次执行 playbook 也很安全.</p>
<p>对于 <cite>command</cite> module 和 <cite>shell</cite> module,重复执行 playbook,实际上是重复运行同样的命令.如果执行的命令类似于 &#8216;chmod&#8217; 或者 &#8216;setsebool&#8217; 这种命令,这没有任何问题.也可以使用一个叫做 &#8216;creates&#8217; 的 flag 使得这两个 module 变得具有&#8221;幂等&#8221;特性
（不是必要的）.</p>
<p>每一个 task 必须有一个名称 <cite>name</cite>,这样在运行 playbook 时,从其输出的任务执行信息中可以很好的辨别出是属于哪一个 task 的.
如果没有定义 <cite>name</cite>,‘action’ 的值将会用作输出信息中标记特定的 task.</p>
<p>如果要声明一个 task,以前有一种格式: &#8220;action: module options&#8221; （可能在一些老的 playbooks 中还能见到）.现在推荐使用更常见的格式:&#8221;module: options&#8221; ,本文档使用的就是这种格式.</p>
<p>下面是一种基本的 task 的定义,service moudle 使用 key=value 格式的参数,这也是大多数 module 使用的参数格式:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: make sure apache is running
    service: <span class="nv">name</span><span class="o">=</span>httpd <span class="nv">state</span><span class="o">=</span>running
</pre></div>
</div>
<p>比较特别的两个 modudle 是  <cite>command</cite> 和 <cite>shell</cite> ,它们不使用 key=value 格式的参数,而是这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: disable selinux
    <span class="nb">command</span>: /sbin/setenforce 0
</pre></div>
</div>
<p>使用 command module 和 shell module 时,我们需要关心返回码信息,如果有一条命令,它的成功执行的返回码不是0,
你或许希望这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: run this <span class="nb">command </span>and ignore the result
    shell: /usr/bin/somecommand <span class="o">||</span> /bin/true
</pre></div>
</div>
<p>或者是这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: run this <span class="nb">command </span>and ignore the result
    shell: /usr/bin/somecommand
    ignore_errors: True
</pre></div>
</div>
<p>如果 action 行看起来太长,你可以使用 space（空格） 或者 indent（缩进） 隔开连续的一行:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: Copy ansible inventory file to client
    copy: <span class="nv">src</span><span class="o">=</span>/etc/ansible/hosts <span class="nv">dest</span><span class="o">=</span>/etc/ansible/hosts
            <span class="nv">owner</span><span class="o">=</span>root <span class="nv">group</span><span class="o">=</span>root <span class="nv">mode</span><span class="o">=</span>0644
</pre></div>
</div>
<p>在 action 行中可以使用变量.假设在 &#8216;vars&#8217; 那里定义了一个变量 &#8216;vhost&#8217; ,可以这样使用它:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: create a virtual host file <span class="k">for</span> <span class="o">{{</span> vhost <span class="o">}}</span>
    template: <span class="nv">src</span><span class="o">=</span>somefile.j2 <span class="nv">dest</span><span class="o">=</span>/etc/httpd/conf.d/<span class="o">{{</span> vhost <span class="o">}}</span>
</pre></div>
</div>
<p>这些变量在 tempates 中也是可用的,稍后会讲到.</p>
<p>在一个基础的 playbook 中,所有的 task 都是在一个 play 中列出,稍后将介绍一种更合理的安排 task 的方式:使用 &#8216;include:&#8217;
指令.</p>
</div>
</div>
<div class="section" id="action-shorthand">
<span id="id4"></span><h4>Action Shorthand<a class="headerlink" href="#action-shorthand" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.8.</span></p>
</div>
<p>在 0.8 及以后的版本中,ansible 更喜欢使用如下的格式列出 modules:</p>
<div class="highlight-bash"><div class="highlight"><pre>template: <span class="nv">src</span><span class="o">=</span>templates/foo.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
</pre></div>
</div>
<p>在早期的版本中,使用以下的格式:</p>
<div class="highlight-bash"><div class="highlight"><pre>action: template <span class="nv">src</span><span class="o">=</span>templates/foo.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
</pre></div>
</div>
<p>早期的格式在新版本中仍然可用,并且没有计划将这种旧的格式弃用.</p>
</div>
<div class="section" id="handlers">
<span id="id5"></span><h4>Handlers: 在发生改变时执行的操作<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h4>
<p>上面我们曾提到过,module 具有&#8221;幂等&#8221;性,所以当远端系统被人改动时,可以重放 playbooks 达到恢复的目的.
playbooks 本身可以识别这种改动,并且有一个基本的 event system（事件系统）,可以响应这种改动.</p>
<p>（当发生改动时）&#8217;notify&#8217; actions 会在 playbook 的每一个 task 结束时被触发,而且即使有多个不同的 task 通知改动的发生,
&#8216;notify&#8217; actions 只会被触发一次.</p>
<p>举例来说,比如多个 resources 指出因为一个配置文件被改动,所以 apache 需要重新启动,但是重新启动的操作只会被执行一次.</p>
<p>这里有一个例子,当一个文件的内容被改动时,重启两个 services:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: template configuration file
  template: <span class="nv">src</span><span class="o">=</span>template.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
  notify:
     - restart memcached
     - restart apache
</pre></div>
</div>
<p>&#8216;notify&#8217; 下列出的即是 handlers.</p>
<p>Handlers 也是一些 task 的列表,通过名字来引用,它们和一般的 task 并没有什么区别.Handlers 是由通知者进行 notify,
如果没有被 notify,handlers 不会执行.不管有多少个通知者进行了 notify,等到 play 中的所有 task 执行完成之后,handlers  也只会被执行一次.</p>
<p>这里是一个 handlers 的示例:</p>
<div class="highlight-bash"><div class="highlight"><pre>handlers:
    - name: restart memcached
      service:  <span class="nv">name</span><span class="o">=</span>memcached <span class="nv">state</span><span class="o">=</span>restarted
    - name: restart apache
      service: <span class="nv">name</span><span class="o">=</span>apache <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>Handlers 最佳的应用场景是用来重启服务,或者触发系统重启操作.除此以外很少用到了.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">handlers 会按照声明的顺序执行</p>
</div>
<p>Roles 将在下一章节讲述.值得指出的是,handlers 会在 &#8216;pre_tasks&#8217;, &#8216;roles&#8217;, &#8216;tasks&#8217;, 和 &#8216;post_tasks&#8217; 之间自动执行.
如果你想立即执行所有的 handler 命令,在1.2及以后的版本,你可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
   - shell: some tasks go here
   - meta: flush_handlers
   - shell: some other tasks
</pre></div>
</div>
<p>在以上的例子中,任何在排队等候的 handlers 会在执行到 &#8216;meta&#8217; 部分时,优先执行.这个技巧在有些时候也能派上用场.</p>
</div>
<div class="section" id="executing-a-playbook">
<span id="id6"></span><h4>执行一个 playbook<a class="headerlink" href="#executing-a-playbook" title="Permalink to this headline">¶</a></h4>
<p>既然现在你已经学习了 playbook 的语法,那要如何运行一个 playbook 呢？这很简单,这里的示例是并行的运行 playbook,并行的级别
是10（译者注:是10个并发的进程？）:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook playbook.yml -f 10
</pre></div>
</div>
</div>
<div class="section" id="ansible-pull">
<span id="id7"></span><h4>Ansible-Pull（拉取配置而非推送配置）<a class="headerlink" href="#ansible-pull" title="Permalink to this headline">¶</a></h4>
<p>我们可不可以将 ansible 的体系架构颠倒过来,让托管节点从一个 central location 做 check in 获取配置信息,而不是
推送配置信息到所有的托管节点？是可以的.</p>
<p>Ansible-pull 是一个小脚本,它从 git 上 checkout 一个关于配置指令的 repo,然后以这个配置指令来运行 ansible-playbook.</p>
<p>假设你对你的 checkout location 做负载均衡,ansible-pull 基本上可以无限的提升规模.</p>
<p>可执行 <code class="docutils literal"><span class="pre">ansible-pull</span> <span class="pre">--help</span></code> 获取详细的帮助信息.</p>
<p>也有一个叫做 clever playbook 的东西:  <a class="reference external" href="https://github.com/ansible/ansible-examples/blob/master/language_features/ansible_pull.yml">clever playbook</a> .
这个可以通过 crontab 来配置 ansible-pull（from push mode）.</p>
</div>
<div class="section" id="tips-and-tricks">
<span id="id8"></span><h4>提示与技巧<a class="headerlink" href="#tips-and-tricks" title="Permalink to this headline">¶</a></h4>
<p>在 playbook 执行输出信息的底部,可以找到关于托管节点的信息.也可看到一般的失败信息,和严重的 &#8220;unreachable&#8221; 信息.
这两个是分开计数的.</p>
<p>如果你想看到执行成功的 modules 的输出信息,使用 <code class="docutils literal"><span class="pre">--verbose</span></code> flag（否则只有执行失败的才会有输出信息）.这在 0.5 及以后的版本中可用.</p>
<p>如果安装了 cowsay 软件包,ansible playbook 的输出已经进行了广泛的升级.可以尝试一下！</p>
<p>在执行一个 playbook 之前,想看看这个 playbook 的执行会影响到哪些 hosts,你可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook playbook.yml --list-hosts
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/YAMLSyntax"><em>YAML 语法</em></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Various tips about managing playbooks in the real world</dd>
<dt><a class="reference internal" href="index.html#document-docs/index"><em>Ansible 文档</em></a></dt>
<dd>Hop back to the documentation index for a lot of special topics about playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/intro_patterns"><em>Patterns</em></a></dt>
<dd>Learn about how to select hosts</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">Github examples directory</a></dt>
<dd>Complete end-to-end playbook examples</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_roles"></span><div class="section" id="playbook-roles-and-include-statements">
<h3><a class="toc-backref" href="#id4">Playbook Roles and Include Statements</a><a class="headerlink" href="#playbook-roles-and-include-statements" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#playbook-roles-and-include-statements" id="id4">Playbook Roles and Include Statements</a><ul>
<li><a class="reference internal" href="#id1" id="id5">介绍</a></li>
<li><a class="reference internal" href="#task-include-files" id="id6">Task Include Files 和鼓励重用机制</a></li>
<li><a class="reference internal" href="#roles" id="id7">Roles</a></li>
<li><a class="reference internal" href="#role-default-variables" id="id8">Role Default Variables</a></li>
<li><a class="reference internal" href="#role-dependencies" id="id9">Role Dependencies</a></li>
<li><a class="reference internal" href="#embedding-modules-in-roles" id="id10">Embedding Modules In Roles</a></li>
<li><a class="reference internal" href="#ansible-galaxy" id="id11">Ansible Galaxy</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id5">介绍</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>当 playbook 文件越来越大的时候(你可以跳出来去学习 playbooks 了),最后一定会有文件重用时候,此刻就需要我们来重新组织 playbooks 了.</p>
<p>从最基本来讲, task files 请允许我们拆分配置策略到多个小文件. Task 可以从其它文件中读取 tasks. 因为 handler 也是tasks, 所以你也可以在在 &#8216;handlers:&#8217; 区域引用 handler 文件.</p>
<p>你可以查阅 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> 来复习该章节内容.</p>
<p>Playbooks 也可以引用其它 playbooks 文件中的命令条目.当所有文件均读取完毕后, 所有的命令条目将被插入到一个 playbook 中组合成一条长的命令列表.</p>
<p>当你开始思考 &#8211; tasks, handlers, variables等 &#8211; 开始形成大的想法概念,当你开始创造一些东西,而非模仿某些东西. It&#8217;s no longer &#8220;apply this handful of THINGS to these hosts&#8221; ,你决定 &#8220;这些 hosts 是 dbservers&#8221; 或者 这些 hosts 是 webservers&#8221;. 在编程语言中,我们称之为&#8221;封装&#8221;.举个例子,你会开车但不需要知道发动机工作原理.</p>
<p>Roles 在 Ansible中起到的宗旨是把配置文件整合到一起并最大程度保证其干净整洁,可重用 &#8211; 他允许我们把重点放在大局上只有在需要的时候才再深入了解.</p>
<p>了解 includes 的对深入 roles 有重要意义,但我们最终的目标是理解 roles &#8211; roles是非常伟大的产品,所以当我们写 playbooks 时一定要使用 roles.</p>
<p>阅读 <cite>ansible-examples &lt;https://github.com/ansible/ansible-examples&gt;</cite> 获取更多实例. 你可以打开单独的页面进行深入学习.</p>
</div>
<div class="section" id="task-include-files">
<h4><a class="toc-backref" href="#id6">Task Include Files 和鼓励重用机制</a><a class="headerlink" href="#task-include-files" title="Permalink to this headline">¶</a></h4>
<p>猜想你希望在不同 tasks 之间plays 和 playbooks 可以重复调用. include files可以达成目的. 系统通过使用 include task 来完美实现 role 定义. 记住, playbook 中的 play 最终目的是映射系统群到多 roles中. 我们来举个例子吧...</p>
<p>只简单包括 tasks 的 task 文件如下示例:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># possibly saved as tasks/foo.yml</span>

- name: placeholder foo
  <span class="nb">command</span>: /bin/foo

- name: placeholder bar
  <span class="nb">command</span>: /bin/bar
</pre></div>
</div>
<p>Include 指令类似如下,可以像普通 tasks 命令一样在 playbook 中混合使用:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

  - include: tasks/foo.yml
</pre></div>
</div>
<p>你也可以传输变量到 includes 指令, 我们称之为 &#8216;parameterized include&#8217;.</p>
<p>例如,如何分发多个 wordpress 实例,我可以包涵所有 wordpress 命令到一个 wordpress.yml 文件,按如下方式使用:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - include: wordpress.yml <span class="nv">wp_user</span><span class="o">=</span>timmy
  - include: wordpress.yml <span class="nv">wp_user</span><span class="o">=</span>alice
  - include: wordpress.yml <span class="nv">wp_user</span><span class="o">=</span>bob
</pre></div>
</div>
<p>如果你使用的是 Ansible 1.4以上版本(包括1.4), include 语法简化了匹配 roles, 同时允许传递参数列表和字典:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
 - <span class="o">{</span> include: wordpress.yml, wp_user: timmy, ssh_keys: <span class="o">[</span> <span class="s1">&#39;keys/one.txt&#39;</span>, <span class="s1">&#39;keys/two.txt&#39;</span> <span class="o">]</span> <span class="o">}</span>
</pre></div>
</div>
<p>使用任意一种语法, 变量传递均可以在 included 文件中被使用. 我们将在 <a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a> 详细讨论. 你可以这样引用他们:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> wp_user <span class="o">}}</span>
</pre></div>
</div>
<p>(除了明确声明定义参数,所有 vars 区块定义的变量在这里同样适用.)</p>
<p>从1.0开始, ansible 还支持另外一种变量传参到 include files 的方式-结构化变量,方式如下:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

  - include: wordpress.yml
    vars:
        wp_user: timmy
        ssh_keys:
          - keys/one.txt
          - keys/two.txt
</pre></div>
</div>
<p>Playbooks 也同样可以 include 引用其它 playbooks,但这部分内容将在另外章节介绍.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">截止1.0版本,task include 声明可以在任意层级目录使用.在这之前,变量只能同层级目录引用,所以 task includes 不能引用其实包含有 task includes 引用的task文件.</p>
</div>
<p>Includes 功能也可以被用在用 handlers 区域,例如,如果你希望定义如何重启apache,你只需要定义一个playbook,只需要做一次.编辑类似如下样例的 handers.yml:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># this might be in a file like handlers/handlers.yml</span>
- name: restart apache
  service: <span class="nv">name</span><span class="o">=</span>apache <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>然后像如下方式在 main playbook 的询问引用play即可:</p>
<div class="highlight-bash"><div class="highlight"><pre>handlers:
  - include: handlers/handlers.yml
</pre></div>
</div>
<p>Includes也可以在常规不包含 included 的tasks和handlers文件中混合引用.
Includes常被用作将一个playbook文件中的命令导入到另外一个playbook.这种方式允许我们定义由其它playbooks组成的顶层playbook(top-level playbook).</p>
<p>For example:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: this is a play at the top level of a file
  hosts: all
  remote_user: root

  tasks:

  - name: say hi
    tags: foo
    shell: <span class="nb">echo</span> <span class="s2">&quot;hi...&quot;</span>

- include: load_balancers.yml
- include: webservers.yml
- include: dbservers.yml
</pre></div>
</div>
<p>注意: 引用playbook到其它playbook时,变量替换功能将失效不可用.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">你不能有条件的指定位置的 include 文件,就像在你使用 &#8216;vars_files&#8217; 时一样.
如果你发展你必须这么做,那请重新规划调整 playbook 的class/role 编排.这样
说其实是想明确告诉你不要妄想 include 指定位置的file. 所有被包含在 play
中的主机都将执行相同的tasks.(&#8216;<em>when</em>&#8216;提供了一些指定条件来跳过tasks)</p>
</div>
</div>
<div class="section" id="roles">
<span id="id2"></span><h4><a class="toc-backref" href="#id7">Roles</a><a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.2.</span></p>
</div>
<p>Now that you have learned about tasks and handlers, what is the best way to organize your playbooks?
The short answer is to use roles!  Roles are ways of automatically loading certain vars_files, tasks, and
handlers based on a known file structure.  Grouping content by roles also allows easy sharing of roles with other users.</p>
<p>Roles are just automation around &#8216;include&#8217; directives as described above, and really don&#8217;t contain much
additional magic beyond some improvements to search path handling for referenced files.  However, that can be a big thing!</p>
<p>Example project structure:</p>
<div class="highlight-bash"><div class="highlight"><pre>site.yml
webservers.yml
fooservers.yml
roles/
   common/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
   webservers/
     files/
     templates/
     tasks/
     handlers/
     vars/
     defaults/
     meta/
</pre></div>
</div>
<p>In a playbook, it would look like this:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: webservers
  roles:
     - common
     - webservers
</pre></div>
</div>
<p>This designates the following behaviors, for each role &#8216;x&#8217;:</p>
<ul class="simple">
<li>If roles/x/tasks/main.yml exists, tasks listed therein will be added to the play</li>
<li>If roles/x/handlers/main.yml exists, handlers listed therein will be added to the play</li>
<li>If roles/x/vars/main.yml exists, variables listed therein will be added to the play</li>
<li>If roles/x/meta/main.yml exists, any role dependencies listed therein will be added to the list of roles (1.3 and later)</li>
<li>Any copy tasks can reference files in roles/x/files/ without having to path them relatively or absolutely</li>
<li>Any script tasks can reference scripts in roles/x/files/ without having to path them relatively or absolutely</li>
<li>Any template tasks can reference files in roles/x/templates/ without having to path them relatively or absolutely</li>
<li>Any include tasks can reference files in roles/x/tasks/ without having to path them relatively or absolutely</li>
</ul>
<p>In Ansible 1.4 and later you can configure a roles_path to search for roles.  Use this to check all of your common roles out to one location, and share
them easily between multiple playbook projects.  See <a class="reference internal" href="index.html#document-docs/intro_configuration"><em>Ansible的配置文件</em></a> for details about how to set this up in ansible.cfg.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Role dependencies are discussed below.</p>
</div>
<p>If any files are not present, they are just ignored.  So it&#8217;s ok to not have a &#8216;vars/&#8217; subdirectory for the role,
for instance.</p>
<p>Note, you are still allowed to list tasks, vars_files, and handlers &#8220;loose&#8221; in playbooks without using roles,
but roles are a good organizational feature and are highly recommended.  If there are loose things in the playbook,
the roles are evaluated first.</p>
<p>Also, should you wish to parameterize roles, by adding variables, you can do so, like this:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers
  roles:
    - common
    - <span class="o">{</span> role: foo_app_instance, dir: <span class="s1">&#39;/opt/a&#39;</span>,  port: <span class="m">5000</span> <span class="o">}</span>
    - <span class="o">{</span> role: foo_app_instance, dir: <span class="s1">&#39;/opt/b&#39;</span>,  port: <span class="m">5001</span> <span class="o">}</span>
</pre></div>
</div>
<p>While it&#8217;s probably not something you should do often, you can also conditionally apply roles like so:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers
  roles:
    - <span class="o">{</span> role: some_role, when: <span class="s2">&quot;ansible_os_family == &#39;RedHat&#39;&quot;</span> <span class="o">}</span>
</pre></div>
</div>
<p>This works by applying the conditional to every task in the role.  Conditionals are covered later on in
the documentation.</p>
<p>Finally, you may wish to assign tags to the roles you specify. You can do so inline::</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers
  roles:
    - <span class="o">{</span> role: foo, tags: <span class="o">[</span><span class="s2">&quot;bar&quot;</span>, <span class="s2">&quot;baz&quot;</span><span class="o">]</span> <span class="o">}</span>
</pre></div>
</div>
<p>If the play still has a &#8216;tasks&#8217; section, those tasks are executed after roles are applied.</p>
<p>If you want to define certain tasks to happen before AND after roles are applied, you can do this:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers

  pre_tasks:
    - shell: <span class="nb">echo</span> <span class="s1">&#39;hello&#39;</span>

  roles:
    - <span class="o">{</span> role: some_role <span class="o">}</span>

  tasks:
    - shell: <span class="nb">echo</span> <span class="s1">&#39;still busy&#39;</span>

  post_tasks:
    - shell: <span class="nb">echo</span> <span class="s1">&#39;goodbye&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If using tags with tasks (described later as a means of only running part of a playbook),
be sure to also tag your pre_tasks and post_tasks and pass those along as well, especially if the pre
and post tasks are used for monitoring outage window control or load balancing.</p>
</div>
</div>
<div class="section" id="role-default-variables">
<h4><a class="toc-backref" href="#id8">Role Default Variables</a><a class="headerlink" href="#role-default-variables" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Role default variables allow you to set default variables for included or dependent roles (see below). To create
defaults, simply add a <cite>defaults/main.yml</cite> file in your role directory. These variables will have the lowest priority
of any variables available, and can be easily overridden by any other variable, including inventory variables.</p>
</div>
<div class="section" id="role-dependencies">
<h4><a class="toc-backref" href="#id9">Role Dependencies</a><a class="headerlink" href="#role-dependencies" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>Role dependencies allow you to automatically pull in other roles when using a role. Role dependencies are stored in the
<cite>meta/main.yml</cite> file contained within the role directory. This file should contain
a list of roles and parameters to insert before the specified role, such as the following in an example
<cite>roles/myapp/meta/main.yml</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
dependencies:
  - <span class="o">{</span> role: common, some_parameter: <span class="m">3</span> <span class="o">}</span>
  - <span class="o">{</span> role: apache, port: <span class="m">80</span> <span class="o">}</span>
  - <span class="o">{</span> role: postgres, dbname: blarg, other_parameter: <span class="m">12</span> <span class="o">}</span>
</pre></div>
</div>
<p>Role dependencies can also be specified as a full path, just like top level roles:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
dependencies:
   - <span class="o">{</span> role: <span class="s1">&#39;/path/to/common/roles/foo&#39;</span>, x: <span class="m">1</span> <span class="o">}</span>
</pre></div>
</div>
<p>Role dependencies can also be installed from source control repos or tar files (via <cite>galaxy</cite>) using comma separated format of path, an optional version (tag, commit, branch etc) and optional friendly role name (an attempt is made to derive a role name from the repo name or archive filename). Both through the command line or via a requirements.yml passed to ansible-galaxy.</p>
<p>Roles dependencies are always executed before the role that includes them, and are recursive. By default,
roles can also only be added as a dependency once - if another role also lists it as a dependency it will
not be run again. This behavior can be overridden by adding <cite>allow_duplicates: yes</cite> to the <cite>meta/main.yml</cite> file.
For example, a role named &#8216;car&#8217; could add a role named &#8216;wheel&#8217; to its dependencies as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
dependencies:
- <span class="o">{</span> role: wheel, n: <span class="m">1</span> <span class="o">}</span>
- <span class="o">{</span> role: wheel, n: <span class="m">2</span> <span class="o">}</span>
- <span class="o">{</span> role: wheel, n: <span class="m">3</span> <span class="o">}</span>
- <span class="o">{</span> role: wheel, n: <span class="m">4</span> <span class="o">}</span>
</pre></div>
</div>
<p>And the <cite>meta/main.yml</cite> for wheel contained the following:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
allow_duplicates: yes
dependencies:
- <span class="o">{</span> role: tire <span class="o">}</span>
- <span class="o">{</span> role: brake <span class="o">}</span>
</pre></div>
</div>
<p>The resulting order of execution would be as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre>tire<span class="o">(</span><span class="nv">n</span><span class="o">=</span>1<span class="o">)</span>
brake<span class="o">(</span><span class="nv">n</span><span class="o">=</span>1<span class="o">)</span>
wheel<span class="o">(</span><span class="nv">n</span><span class="o">=</span>1<span class="o">)</span>
tire<span class="o">(</span><span class="nv">n</span><span class="o">=</span>2<span class="o">)</span>
brake<span class="o">(</span><span class="nv">n</span><span class="o">=</span>2<span class="o">)</span>
wheel<span class="o">(</span><span class="nv">n</span><span class="o">=</span>2<span class="o">)</span>
...
car
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Variable inheritance and scope are detailed in the <a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a>.</p>
</div>
</div>
<div class="section" id="embedding-modules-in-roles">
<h4><a class="toc-backref" href="#id10">Embedding Modules In Roles</a><a class="headerlink" href="#embedding-modules-in-roles" title="Permalink to this headline">¶</a></h4>
<p>This is an advanced topic that should not be relevant for most users.</p>
<p>If you write a custom module (see <a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a>) you may wish to distribute it as part of a role.  Generally speaking, Ansible as a project is very interested
in taking high-quality modules into ansible core for inclusion, so this shouldn&#8217;t be the norm, but it&#8217;s quite easy to do.</p>
<p>A good example for this is if you worked at a company called AcmeWidgets, and wrote an internal module that helped configure your internal software, and you wanted other
people in your organization to easily use this module &#8211; but you didn&#8217;t want to tell everyone how to configure their Ansible library path.</p>
<p>Alongside the &#8216;tasks&#8217; and &#8216;handlers&#8217; structure of a role, add a directory named &#8216;library&#8217;.  In this &#8216;library&#8217; directory, then include the module directly inside of it.</p>
<p>Assuming you had this:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles/
   my_custom_modules/
       library/
          module1
          module2
</pre></div>
</div>
<p>The module will be usable in the role itself, as well as any roles that are called <em>after</em> this role, as follows:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: webservers
  roles:
    - my_custom_modules
    - some_other_role_using_my_custom_modules
    - yet_another_role_using_my_custom_modules
</pre></div>
</div>
<p>This can also be used, with some limitations, to modify modules in Ansible&#8217;s core distribution, such as to use development versions of modules before they are released
in production releases.  This is not always advisable as API signatures may change in core components, however, and is not always guaranteed to work.  It can be a handy
way of carrying a patch against a core module, however, should you have good reason for this.  Naturally the project prefers that contributions be directed back
to github whenever possible via a pull request.</p>
</div>
<div class="section" id="ansible-galaxy">
<h4><a class="toc-backref" href="#id11">Ansible Galaxy</a><a class="headerlink" href="#ansible-galaxy" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://galaxy.ansible.com">Ansible Galaxy</a> is a free site for finding, downloading, rating, and reviewing all kinds of community developed Ansible roles and can be a great way to get a jumpstart on your automation projects.</p>
<p>You can sign up with social auth, and the download client &#8216;ansible-galaxy&#8217; is included in Ansible 1.4.2 and later.</p>
<p>Read the &#8220;About&#8221; page on the Galaxy site for more information.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/galaxy"><em>Ansible Galaxy</em></a></dt>
<dd>How to share roles on galaxy, role management</dd>
<dt><a class="reference internal" href="index.html#document-docs/YAMLSyntax"><em>YAML 语法</em></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Review the basic Playbook language features</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Various tips about managing playbooks in the real world</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a></dt>
<dd>All about variables in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a></dt>
<dd>Conditionals in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_loops"><em>循环</em></a></dt>
<dd>Loops in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">GitHub Ansible examples</a></dt>
<dd>Complete playbook files from the GitHub project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_variables"></span><div class="section" id="variables">
<h3><a class="toc-backref" href="#id10">Variables</a><a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#variables" id="id10">Variables</a><ul>
<li><a class="reference internal" href="#valid-variable-names" id="id11">合法的变量名</a></li>
<li><a class="reference internal" href="#inventory" id="id12">在Inventory中定义变量</a></li>
<li><a class="reference internal" href="#playbook" id="id13">在playbook中定义变量</a></li>
<li><a class="reference internal" href="#role" id="id14">在文件和role中定义变量</a></li>
<li><a class="reference internal" href="#jinja2" id="id15">使用变量: 关于Jinja2</a></li>
<li><a class="reference internal" href="#jinja2-filters" id="id16">Jinja2过滤器</a></li>
<li><a class="reference internal" href="#yaml" id="id17">YAML陷阱</a></li>
<li><a class="reference internal" href="#facts" id="id18">使用Facts获取的信息</a></li>
<li><a class="reference internal" href="#disabling-facts" id="id19">关闭Facts</a></li>
<li><a class="reference internal" href="#facts-facts-d" id="id20">本地Facts(Facts.d)</a></li>
<li><a class="reference internal" href="#fact" id="id21">Fact缓存</a></li>
<li><a class="reference internal" href="#registered-variables" id="id22">注册变量</a></li>
<li><a class="reference internal" href="#accessing-complex-variable-data" id="id23">访问复杂变量数据</a></li>
<li><a class="reference internal" href="#magic-variables-and-hostvars" id="id24">魔法变量,以及如何访问其它主机的信息</a></li>
<li><a class="reference internal" href="#variable-file-separation-details" id="id25">变量文件分割</a></li>
<li><a class="reference internal" href="#passing-variables-on-the-command-line" id="id26">命令行中传递变量</a></li>
<li><a class="reference internal" href="#variable-precedence" id="id27">变量的优先级: 我该在什么地方放置变量?</a></li>
</ul>
</li>
</ul>
</div>
<p>已经存在的自动化技术使得重复做事变得更加容易,但你的所有系统有时则不会这样.
在有些系统中你想设置一些行为或者配置,这与其它系统稍有不同.</p>
<p>并且,远程系统的可视行为或状态会影响我们配置这些系统.（比如你需要得到一个系统的IP地址,甚至用该值来配置另一个系统）.</p>
<p>你可能有一些非常相似的模板或配置文件,而有些变量则稍微不同.
Ansible中的变量用来处理系统间的不同.</p>
<p>为了理解变量,你也需要深入阅读 <a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a> 和 <a class="reference internal" href="index.html#document-docs/playbooks_loops"><em>循环</em></a>.有用的模块(比如&#8221;group_by&#8221;模块和&#8221;when&#8221;条件)也可以结合变量使用,用于管理系统间的不同之处.</p>
<p>强烈建议你学习 ansible-examples github代码库,里面有大量使用变量的例子.</p>
<div class="section" id="valid-variable-names">
<span id="id1"></span><h4><a class="toc-backref" href="#id11">合法的变量名</a><a class="headerlink" href="#valid-variable-names" title="Permalink to this headline">¶</a></h4>
<p>在使用变量之前最好先知道什么是合法的变量名.
变量名可以为字母,数字以及下划线.变量始终应该以字母开头.
&#8220;foo_port&#8221;是个合法的变量名.&#8221;foo5&#8221;也是.
&#8220;foo-port&#8221;, &#8220;foo port&#8221;, &#8220;foo.port&#8221; 和 &#8220;12&#8221;则不是合法的变量名.</p>
<p>很简单吧,继续往下看.</p>
</div>
<div class="section" id="inventory">
<span id="variables-in-inventory"></span><h4><a class="toc-backref" href="#id12">在Inventory中定义变量</a><a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h4>
<p>我们已经在其它文档中覆盖了大量关于使用变量的场景,所以这里没多少新的知识点,权当加深记忆.</p>
<p>通常你想基于一个机器位于哪个群组而设置变量.比如,位于波士顿的很多机器会使用 &#8216;boston.ntp.example.com&#8217; 作为NTP服务器.</p>
<p>请看 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a> 文档来学习在inventory中使用多种方式来定义变量.</p>
</div>
<div class="section" id="playbook">
<span id="playbook-variables"></span><h4><a class="toc-backref" href="#id13">在playbook中定义变量</a><a class="headerlink" href="#playbook" title="Permalink to this headline">¶</a></h4>
<p>在playbook中,可以直接定义变量,如下所示:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: webservers
  vars:
    http_port: 80
</pre></div>
</div>
<p>这种所见即所得的方式非常好.</p>
</div>
<div class="section" id="role">
<span id="included-variables"></span><h4><a class="toc-backref" href="#id14">在文件和role中定义变量</a><a class="headerlink" href="#role" title="Permalink to this headline">¶</a></h4>
<p>事实上在其它地方我们也讲过这点了.
正如在 <a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a> 描述的一样,变量也可以通过文件包含在playbook中,该变量可以作为或者不作为“Ansible Role”的一部分.使用role是首选,因为它提供了一个很好的组织体系.</p>
</div>
<div class="section" id="jinja2">
<span id="about-jinja2"></span><h4><a class="toc-backref" href="#id15">使用变量: 关于Jinja2</a><a class="headerlink" href="#jinja2" title="Permalink to this headline">¶</a></h4>
<p>我们已经知道很多关于定义变量的知识,那么你知道如何使用它们吗？</p>
<p>Ansible允许你使用Jinja2模板系统在playbook中引用变量.借助Jinja你能做很多复杂的操作,首先你要学习基本使用.
例如,在简单的模板中你可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>My amp goes to <span class="o">{{</span> max_amp_value <span class="o">}}</span>
</pre></div>
</div>
<p>这就是变量替换最基本的形式.
你也可以在playbook中直接这样用,你偶尔想这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>template: <span class="nv">src</span><span class="o">=</span>foo.cfg.j2 <span class="nv">dest</span><span class="o">={{</span> remote_install_path <span class="o">}}</span>/foo.cfg
</pre></div>
</div>
<p>In the above example, we used a variable to help decide where to place a file.
在上述的例子中,我们使用变量来决定文件放置在哪里.
在模板中你自动会获取在主机范围之内的所有变量的访问权.事实上更多,你可以读取其它主机的变量.我们将演示如何做.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在模板中Jinja2可以用循环和条件语句,而在playbook中则不行.Ansible playbook是纯粹的机器解析的YAML.这是一个非常重要的功能,这意味着根据文件可以生成代码,或者其它系统工具能够读取Ansible文件.虽然并不是所有人都需要这个功能,但我们不能封锁可能性.</p>
</div>
</div>
<div class="section" id="jinja2-filters">
<span id="id2"></span><h4><a class="toc-backref" href="#id16">Jinja2过滤器</a><a class="headerlink" href="#jinja2-filters" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这并不是常用的特性.只在合适的时候使用它们,这是一个附加知识点.</p>
</div>
<p>Jinja2中的过滤器可以把一个模板表达式转换为另一个.Jinja2附带了很多这样的功能.请参见Jinja2官方模板文档中的 <a class="reference external" href="http://jinja.pocoo.org/docs/templates/#builtin-filters">builtin filters</a>.</p>
<p>另外,Ansible还支持其它特性.请看 <code class="xref doc docutils literal"><span class="pre">playbooks_filters</span></code> 文档中关于一系列可用的过滤器及示例.</p>
</div>
<div class="section" id="yaml">
<span id="yaml-gotchas"></span><h4><a class="toc-backref" href="#id17">YAML陷阱</a><a class="headerlink" href="#yaml" title="Permalink to this headline">¶</a></h4>
<p>YAML语法要求如果值以{{ foo }}开头的话我们需要将整行用双引号包起来.这是为了确认你不是想声明一个YAML字典.该知识点在 <a class="reference internal" href="index.html#document-docs/YAMLSyntax"><em>YAML 语法</em></a> 页面有所讲述.</p>
<p>这样是不行的:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: app_servers
  vars:
      app_path: <span class="o">{{</span> base_path <span class="o">}}</span>/22
</pre></div>
</div>
<p>你应该这么做:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: app_servers
  vars:
       app_path: <span class="s2">&quot;{{ base_path }}/22&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="facts">
<span id="vars-and-facts"></span><h4><a class="toc-backref" href="#id18">使用Facts获取的信息</a><a class="headerlink" href="#facts" title="Permalink to this headline">¶</a></h4>
<p>还有其它地方可以获取变量,这些变量是自动发现的,而不是用户自己设置的.</p>
<p>Facts通过访问远程系统获取相应的信息.
一个例子就是远程主机的IP地址或者操作系统是什么.
使用以下命令可以查看哪些信息是可用的:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible hostname -m setup
</pre></div>
</div>
<p>这会返回巨量的变量数据,比如对于Ubutu 12.04系统,Ansible 1.4获取的信息显示如下:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="s2">&quot;ansible_all_ipv4_addresses&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;REDACTED IP ADDRESS&quot;</span>
<span class="o">]</span>,
<span class="s2">&quot;ansible_all_ipv6_addresses&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;REDACTED IPV6 ADDRESS&quot;</span>
<span class="o">]</span>,
<span class="s2">&quot;ansible_architecture&quot;</span>: <span class="s2">&quot;x86_64&quot;</span>,
<span class="s2">&quot;ansible_bios_date&quot;</span>: <span class="s2">&quot;09/20/2012&quot;</span>,
<span class="s2">&quot;ansible_bios_version&quot;</span>: <span class="s2">&quot;6.00&quot;</span>,
<span class="s2">&quot;ansible_cmdline&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;BOOT_IMAGE&quot;</span>: <span class="s2">&quot;/boot/vmlinuz-3.5.0-23-generic&quot;</span>,
    <span class="s2">&quot;quiet&quot;</span>: <span class="nb">true</span>,
    <span class="s2">&quot;ro&quot;</span>: <span class="nb">true</span>,
    <span class="s2">&quot;root&quot;</span>: <span class="s2">&quot;UUID=4195bff4-e157-4e41-8701-e93f0aec9e22&quot;</span>,
    <span class="s2">&quot;splash&quot;</span>: <span class="nb">true</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_date_time&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;date&quot;</span>: <span class="s2">&quot;2013-10-02&quot;</span>,
    <span class="s2">&quot;day&quot;</span>: <span class="s2">&quot;02&quot;</span>,
    <span class="s2">&quot;epoch&quot;</span>: <span class="s2">&quot;1380756810&quot;</span>,
    <span class="s2">&quot;hour&quot;</span>: <span class="s2">&quot;19&quot;</span>,
    <span class="s2">&quot;iso8601&quot;</span>: <span class="s2">&quot;2013-10-02T23:33:30Z&quot;</span>,
    <span class="s2">&quot;iso8601_micro&quot;</span>: <span class="s2">&quot;2013-10-02T23:33:30.036070Z&quot;</span>,
    <span class="s2">&quot;minute&quot;</span>: <span class="s2">&quot;33&quot;</span>,
    <span class="s2">&quot;month&quot;</span>: <span class="s2">&quot;10&quot;</span>,
    <span class="s2">&quot;second&quot;</span>: <span class="s2">&quot;30&quot;</span>,
    <span class="s2">&quot;time&quot;</span>: <span class="s2">&quot;19:33:30&quot;</span>,
    <span class="s2">&quot;tz&quot;</span>: <span class="s2">&quot;EDT&quot;</span>,
    <span class="s2">&quot;year&quot;</span>: <span class="s2">&quot;2013&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_default_ipv4&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
    <span class="s2">&quot;alias&quot;</span>: <span class="s2">&quot;eth0&quot;</span>,
    <span class="s2">&quot;gateway&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
    <span class="s2">&quot;interface&quot;</span>: <span class="s2">&quot;eth0&quot;</span>,
    <span class="s2">&quot;macaddress&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
    <span class="s2">&quot;mtu&quot;</span>: 1500,
    <span class="s2">&quot;netmask&quot;</span>: <span class="s2">&quot;255.255.255.0&quot;</span>,
    <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;ether&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_default_ipv6&quot;</span>: <span class="o">{}</span>,
<span class="s2">&quot;ansible_devices&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;fd0&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;holders&quot;</span>: <span class="o">[]</span>,
        <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;&quot;</span>,
        <span class="s2">&quot;model&quot;</span>: null,
        <span class="s2">&quot;partitions&quot;</span>: <span class="o">{}</span>,
        <span class="s2">&quot;removable&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;rotational&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;scheduler_mode&quot;</span>: <span class="s2">&quot;deadline&quot;</span>,
        <span class="s2">&quot;sectors&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;sectorsize&quot;</span>: <span class="s2">&quot;512&quot;</span>,
        <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;0.00 Bytes&quot;</span>,
        <span class="s2">&quot;support_discard&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;vendor&quot;</span>: null
    <span class="o">}</span>,
    <span class="s2">&quot;sda&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;holders&quot;</span>: <span class="o">[]</span>,
        <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;SCSI storage controller: LSI Logic / Symbios Logic 53c1030 PCI-X Fusion-MPT Dual Ultra320 SCSI (rev 01)&quot;</span>,
        <span class="s2">&quot;model&quot;</span>: <span class="s2">&quot;VMware Virtual S&quot;</span>,
        <span class="s2">&quot;partitions&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;sda1&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;sectors&quot;</span>: <span class="s2">&quot;39843840&quot;</span>,
                <span class="s2">&quot;sectorsize&quot;</span>: 512,
                <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;19.00 GB&quot;</span>,
                <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2048&quot;</span>
            <span class="o">}</span>,
            <span class="s2">&quot;sda2&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;sectors&quot;</span>: <span class="s2">&quot;2&quot;</span>,
                <span class="s2">&quot;sectorsize&quot;</span>: 512,
                <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;1.00 KB&quot;</span>,
                <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;39847934&quot;</span>
            <span class="o">}</span>,
            <span class="s2">&quot;sda5&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;sectors&quot;</span>: <span class="s2">&quot;2093056&quot;</span>,
                <span class="s2">&quot;sectorsize&quot;</span>: 512,
                <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;1022.00 MB&quot;</span>,
                <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;39847936&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>,
        <span class="s2">&quot;removable&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;rotational&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;scheduler_mode&quot;</span>: <span class="s2">&quot;deadline&quot;</span>,
        <span class="s2">&quot;sectors&quot;</span>: <span class="s2">&quot;41943040&quot;</span>,
        <span class="s2">&quot;sectorsize&quot;</span>: <span class="s2">&quot;512&quot;</span>,
        <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;20.00 GB&quot;</span>,
        <span class="s2">&quot;support_discard&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;vendor&quot;</span>: <span class="s2">&quot;VMware,&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;sr0&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;holders&quot;</span>: <span class="o">[]</span>,
        <span class="s2">&quot;host&quot;</span>: <span class="s2">&quot;IDE interface: Intel Corporation 82371AB/EB/MB PIIX4 IDE (rev 01)&quot;</span>,
        <span class="s2">&quot;model&quot;</span>: <span class="s2">&quot;VMware IDE CDR10&quot;</span>,
        <span class="s2">&quot;partitions&quot;</span>: <span class="o">{}</span>,
        <span class="s2">&quot;removable&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;rotational&quot;</span>: <span class="s2">&quot;1&quot;</span>,
        <span class="s2">&quot;scheduler_mode&quot;</span>: <span class="s2">&quot;deadline&quot;</span>,
        <span class="s2">&quot;sectors&quot;</span>: <span class="s2">&quot;2097151&quot;</span>,
        <span class="s2">&quot;sectorsize&quot;</span>: <span class="s2">&quot;512&quot;</span>,
        <span class="s2">&quot;size&quot;</span>: <span class="s2">&quot;1024.00 MB&quot;</span>,
        <span class="s2">&quot;support_discard&quot;</span>: <span class="s2">&quot;0&quot;</span>,
        <span class="s2">&quot;vendor&quot;</span>: <span class="s2">&quot;NECVMWar&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_distribution&quot;</span>: <span class="s2">&quot;Ubuntu&quot;</span>,
<span class="s2">&quot;ansible_distribution_release&quot;</span>: <span class="s2">&quot;precise&quot;</span>,
<span class="s2">&quot;ansible_distribution_version&quot;</span>: <span class="s2">&quot;12.04&quot;</span>,
<span class="s2">&quot;ansible_domain&quot;</span>: <span class="s2">&quot;&quot;</span>,
<span class="s2">&quot;ansible_env&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;COLORTERM&quot;</span>: <span class="s2">&quot;gnome-terminal&quot;</span>,
    <span class="s2">&quot;DISPLAY&quot;</span>: <span class="s2">&quot;:0&quot;</span>,
    <span class="s2">&quot;HOME&quot;</span>: <span class="s2">&quot;/home/mdehaan&quot;</span>,
    <span class="s2">&quot;LANG&quot;</span>: <span class="s2">&quot;C&quot;</span>,
    <span class="s2">&quot;LESSCLOSE&quot;</span>: <span class="s2">&quot;/usr/bin/lesspipe %s %s&quot;</span>,
    <span class="s2">&quot;LESSOPEN&quot;</span>: <span class="s2">&quot;| /usr/bin/lesspipe %s&quot;</span>,
    <span class="s2">&quot;LOGNAME&quot;</span>: <span class="s2">&quot;root&quot;</span>,
    <span class="s2">&quot;LS_COLORS&quot;</span>: <span class="s2">&quot;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arj=01;31:*.taz=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lz=01;31:*.xz=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.jpg=01;35:*.jpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.axv=01;35:*.anx=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.axa=00;36:*.oga=00;36:*.spx=00;36:*.xspf=00;36:&quot;</span>,
    <span class="s2">&quot;MAIL&quot;</span>: <span class="s2">&quot;/var/mail/root&quot;</span>,
    <span class="s2">&quot;OLDPWD&quot;</span>: <span class="s2">&quot;/root/ansible/docsite&quot;</span>,
    <span class="s2">&quot;PATH&quot;</span>: <span class="s2">&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,
    <span class="s2">&quot;PWD&quot;</span>: <span class="s2">&quot;/root/ansible&quot;</span>,
    <span class="s2">&quot;SHELL&quot;</span>: <span class="s2">&quot;/bin/bash&quot;</span>,
    <span class="s2">&quot;SHLVL&quot;</span>: <span class="s2">&quot;1&quot;</span>,
    <span class="s2">&quot;SUDO_COMMAND&quot;</span>: <span class="s2">&quot;/bin/bash&quot;</span>,
    <span class="s2">&quot;SUDO_GID&quot;</span>: <span class="s2">&quot;1000&quot;</span>,
    <span class="s2">&quot;SUDO_UID&quot;</span>: <span class="s2">&quot;1000&quot;</span>,
    <span class="s2">&quot;SUDO_USER&quot;</span>: <span class="s2">&quot;mdehaan&quot;</span>,
    <span class="s2">&quot;TERM&quot;</span>: <span class="s2">&quot;xterm&quot;</span>,
    <span class="s2">&quot;USER&quot;</span>: <span class="s2">&quot;root&quot;</span>,
    <span class="s2">&quot;USERNAME&quot;</span>: <span class="s2">&quot;root&quot;</span>,
    <span class="s2">&quot;XAUTHORITY&quot;</span>: <span class="s2">&quot;/home/mdehaan/.Xauthority&quot;</span>,
    <span class="s2">&quot;_&quot;</span>: <span class="s2">&quot;/usr/local/bin/ansible&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_eth0&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;active&quot;</span>: <span class="nb">true</span>,
    <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;eth0&quot;</span>,
    <span class="s2">&quot;ipv4&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
        <span class="s2">&quot;netmask&quot;</span>: <span class="s2">&quot;255.255.255.0&quot;</span>,
        <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;ipv6&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
            <span class="s2">&quot;prefix&quot;</span>: <span class="s2">&quot;64&quot;</span>,
            <span class="s2">&quot;scope&quot;</span>: <span class="s2">&quot;link&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>,
    <span class="s2">&quot;macaddress&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
    <span class="s2">&quot;module&quot;</span>: <span class="s2">&quot;e1000&quot;</span>,
    <span class="s2">&quot;mtu&quot;</span>: 1500,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;ether&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_form_factor&quot;</span>: <span class="s2">&quot;Other&quot;</span>,
<span class="s2">&quot;ansible_fqdn&quot;</span>: <span class="s2">&quot;ubuntu2.example.com&quot;</span>,
<span class="s2">&quot;ansible_hostname&quot;</span>: <span class="s2">&quot;ubuntu2&quot;</span>,
<span class="s2">&quot;ansible_interfaces&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;lo&quot;</span>,
    <span class="s2">&quot;eth0&quot;</span>
<span class="o">]</span>,
<span class="s2">&quot;ansible_kernel&quot;</span>: <span class="s2">&quot;3.5.0-23-generic&quot;</span>,
<span class="s2">&quot;ansible_lo&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;active&quot;</span>: <span class="nb">true</span>,
    <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;lo&quot;</span>,
    <span class="s2">&quot;ipv4&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;127.0.0.1&quot;</span>,
        <span class="s2">&quot;netmask&quot;</span>: <span class="s2">&quot;255.0.0.0&quot;</span>,
        <span class="s2">&quot;network&quot;</span>: <span class="s2">&quot;127.0.0.0&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;ipv6&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;address&quot;</span>: <span class="s2">&quot;::1&quot;</span>,
            <span class="s2">&quot;prefix&quot;</span>: <span class="s2">&quot;128&quot;</span>,
            <span class="s2">&quot;scope&quot;</span>: <span class="s2">&quot;host&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>,
    <span class="s2">&quot;mtu&quot;</span>: 16436,
    <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;loopback&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_lsb&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;codename&quot;</span>: <span class="s2">&quot;precise&quot;</span>,
    <span class="s2">&quot;description&quot;</span>: <span class="s2">&quot;Ubuntu 12.04.2 LTS&quot;</span>,
    <span class="s2">&quot;id&quot;</span>: <span class="s2">&quot;Ubuntu&quot;</span>,
    <span class="s2">&quot;major_release&quot;</span>: <span class="s2">&quot;12&quot;</span>,
    <span class="s2">&quot;release&quot;</span>: <span class="s2">&quot;12.04&quot;</span>
<span class="o">}</span>,
<span class="s2">&quot;ansible_machine&quot;</span>: <span class="s2">&quot;x86_64&quot;</span>,
<span class="s2">&quot;ansible_memfree_mb&quot;</span>: 74,
<span class="s2">&quot;ansible_memtotal_mb&quot;</span>: 991,
<span class="s2">&quot;ansible_mounts&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
        <span class="s2">&quot;device&quot;</span>: <span class="s2">&quot;/dev/sda1&quot;</span>,
        <span class="s2">&quot;fstype&quot;</span>: <span class="s2">&quot;ext4&quot;</span>,
        <span class="s2">&quot;mount&quot;</span>: <span class="s2">&quot;/&quot;</span>,
        <span class="s2">&quot;options&quot;</span>: <span class="s2">&quot;rw,errors=remount-ro&quot;</span>,
        <span class="s2">&quot;size_available&quot;</span>: 15032406016,
        <span class="s2">&quot;size_total&quot;</span>: 20079898624
    <span class="o">}</span>
<span class="o">]</span>,
<span class="s2">&quot;ansible_nodename&quot;</span>: <span class="s2">&quot;ubuntu2.example.com&quot;</span>,
<span class="s2">&quot;ansible_os_family&quot;</span>: <span class="s2">&quot;Debian&quot;</span>,
<span class="s2">&quot;ansible_pkg_mgr&quot;</span>: <span class="s2">&quot;apt&quot;</span>,
<span class="s2">&quot;ansible_processor&quot;</span>: <span class="o">[</span>
    <span class="s2">&quot;Intel(R) Core(TM) i7 CPU         860  @ 2.80GHz&quot;</span>
<span class="o">]</span>,
<span class="s2">&quot;ansible_processor_cores&quot;</span>: 1,
<span class="s2">&quot;ansible_processor_count&quot;</span>: 1,
<span class="s2">&quot;ansible_processor_threads_per_core&quot;</span>: 1,
<span class="s2">&quot;ansible_processor_vcpus&quot;</span>: 1,
<span class="s2">&quot;ansible_product_name&quot;</span>: <span class="s2">&quot;VMware Virtual Platform&quot;</span>,
<span class="s2">&quot;ansible_product_serial&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
<span class="s2">&quot;ansible_product_uuid&quot;</span>: <span class="s2">&quot;REDACTED&quot;</span>,
<span class="s2">&quot;ansible_product_version&quot;</span>: <span class="s2">&quot;None&quot;</span>,
<span class="s2">&quot;ansible_python_version&quot;</span>: <span class="s2">&quot;2.7.3&quot;</span>,
<span class="s2">&quot;ansible_selinux&quot;</span>: <span class="nb">false</span>,
<span class="s2">&quot;ansible_ssh_host_key_dsa_public&quot;</span>: <span class="s2">&quot;REDACTED KEY VALUE&quot;</span>
<span class="s2">&quot;ansible_ssh_host_key_ecdsa_public&quot;</span>: <span class="s2">&quot;REDACTED KEY VALUE&quot;</span>
<span class="s2">&quot;ansible_ssh_host_key_rsa_public&quot;</span>: <span class="s2">&quot;REDACTED KEY VALUE&quot;</span>
<span class="s2">&quot;ansible_swapfree_mb&quot;</span>: 665,
<span class="s2">&quot;ansible_swaptotal_mb&quot;</span>: 1021,
<span class="s2">&quot;ansible_system&quot;</span>: <span class="s2">&quot;Linux&quot;</span>,
<span class="s2">&quot;ansible_system_vendor&quot;</span>: <span class="s2">&quot;VMware, Inc.&quot;</span>,
<span class="s2">&quot;ansible_user_id&quot;</span>: <span class="s2">&quot;root&quot;</span>,
<span class="s2">&quot;ansible_userspace_architecture&quot;</span>: <span class="s2">&quot;x86_64&quot;</span>,
<span class="s2">&quot;ansible_userspace_bits&quot;</span>: <span class="s2">&quot;64&quot;</span>,
<span class="s2">&quot;ansible_virtualization_role&quot;</span>: <span class="s2">&quot;guest&quot;</span>,
<span class="s2">&quot;ansible_virtualization_type&quot;</span>: <span class="s2">&quot;VMware&quot;</span>
</pre></div>
</div>
<p>可以在playbook中这样引用以上例子中第一个硬盘的模型:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_devices.sda.model <span class="o">}}</span>
</pre></div>
</div>
<p>同样,作为系统报告的主机名如以下所示:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_nodename <span class="o">}}</span>
</pre></div>
</div>
<p>不合格的主机名显示了句号(.)之前的字符串:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_hostname <span class="o">}}</span>
</pre></div>
</div>
<p>在模板和条件判断(请看 <code class="xref doc docutils literal"><span class="pre">playbook_conditionals</span></code> )中会经常使用Facts.</p>
<p>还可以使用Facts根据特定的条件动态创建主机群组,请查看 <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a> 文档中的 &#8216;group_by&#8217; 小节获取详细内容.以及参见 <a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a> 章节讨论的广义条件语句部分.</p>
</div>
<div class="section" id="disabling-facts">
<span id="id3"></span><h4><a class="toc-backref" href="#id19">关闭Facts</a><a class="headerlink" href="#disabling-facts" title="Permalink to this headline">¶</a></h4>
<p>如果你不需要使用你主机的任何fact数据,你已经知道了你系统的一切,那么你可以关闭fact数据的获取.这有利于增强Ansilbe面对大量系统的push模块,或者你在实验性平台中使用Ansible.在任何playbook中可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: whatever
  gather_facts: no
</pre></div>
</div>
</div>
<div class="section" id="facts-facts-d">
<span id="local-facts"></span><h4><a class="toc-backref" href="#id20">本地Facts(Facts.d)</a><a class="headerlink" href="#facts-facts-d" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>正如在playbook章节讨论的一样,Ansible facts主要用于获取远程系统的数据,从而可以在playbook中作为变量使用.</p>
<p>通常facts中的数据是由Ansible中的 ‘setup’模块自动发现的.用户也可以自定义facts模块,在API文档中有说明.然而,如果不借助于fact模块,而是通过一个简单的方式为Ansible变量提供系统或用户数据？</p>
<p>比如,你想用户能够控制受他们管理的系统的一些切面,那么应该怎么做？ &#8220;Facts.d&#8221;是这样的一种机制.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">可能 &#8220;局部facts&#8221;有点用词不当,它与 &#8220;中心供应的用户值&#8221;相对应,为&#8221;局部供应的用户值&#8221;,或者facts是 &#8220;局部动态测定的值&#8221;.</p>
</div>
<p>如果远程受管理的机器有一个 &#8220;/etc/ansible/facts.d&#8221; 目录,那么在该目录中任何以 &#8221;.fact&#8221;结尾的文件都可以在Ansible中提供局部facts.这些文件可以是JSON,INI或者任何可以返回JSON的可执行文件.</p>
<p>例如建设有一个 /etc/ansible/facts.d/perferences.fact文件:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>general<span class="o">]</span>
<span class="nv">asdf</span><span class="o">=</span>1
<span class="nv">bar</span><span class="o">=</span>2
</pre></div>
</div>
<p>这将产生一个名为 &#8220;general&#8221; 的哈希表fact,里面成员有 &#8216;asdf&#8217; 和 &#8216;bar&#8217;.
可以这样验证:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible &lt;hostname&gt; -m setup -a <span class="s2">&quot;filter=ansible_local&quot;</span>
</pre></div>
</div>
<p>然后你会看到有以下fact被添加:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="s2">&quot;ansible_local&quot;</span>: <span class="o">{</span>
        <span class="s2">&quot;preferences&quot;</span>: <span class="o">{</span>
            <span class="s2">&quot;general&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;asdf&quot;</span> : <span class="s2">&quot;1&quot;</span>,
                <span class="s2">&quot;bar&quot;</span>  : <span class="s2">&quot;2&quot;</span>
            <span class="o">}</span>
        <span class="o">}</span>
 <span class="o">}</span>
</pre></div>
</div>
<p>而且也可以在template或palybook中访问该数据:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_local.preferences.general.asdf <span class="o">}}</span>
</pre></div>
</div>
<p>本地命名空间放置其它用户提供的fact或者playbook中定义的变量覆盖系统facts值.</p>
<p>如果你有个一个playook,它复制了一个自定义的fact,然后运行它,请显式调用来重新运行setup模块,这样可以让我们在该playbook中使用这些fact.否则,在下一个play中才能获取这些自定义的fact信息.这里有一个示例:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: webservers
  tasks:
    - name: create directory <span class="k">for</span> ansible custom facts
      file: <span class="nv">state</span><span class="o">=</span>directory <span class="nv">recurse</span><span class="o">=</span>yes <span class="nv">path</span><span class="o">=</span>/etc/ansible/facts.d
    - name: install custom impi fact
      copy: <span class="nv">src</span><span class="o">=</span>ipmi.fact <span class="nv">dest</span><span class="o">=</span>/etc/ansible/facts.d
    - name: re-read facts after adding custom fact
      setup: <span class="nv">filter</span><span class="o">=</span>ansible_local
</pre></div>
</div>
<p>然而在该模式中你也可以编写一个fact模块,这只不过是多了一个选项.</p>
</div>
<div class="section" id="fact">
<span id="fact-caching"></span><h4><a class="toc-backref" href="#id21">Fact缓存</a><a class="headerlink" href="#fact" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.8.</span></p>
</div>
<p>正如该文档中其它地方所示,从一个服务器引用另一个服务器的变量是可行的.比如:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> hostvars<span class="o">[</span><span class="s1">&#39;asdf.example.com&#39;</span><span class="o">][</span><span class="s1">&#39;ansible_os_family&#39;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>如果禁用 &#8220;Fact Caching&#8221;,为了实现以上功能,Ansible在当前play之前已经与 &#8216;asdf.example.com&#8217; 通讯过,或者在playbook有其它优先的play.这是ansible的默认配置.</p>
<p>为了避免这些,Ansible 1.8允许在playbook运行期间保存facts.但该功能需要手动开启.这有什么用处那？</p>
<p>想象一下,如果我们有一个非常大的基础设施,里面有数千个主机.Fact缓存可以配置在夜间运行,但小型服务器集群可以配置fact随时运行,或者在白天定期运行.即使开启了fact缓存,也不需要访问所有服务器来引用它们的变量和信息.</p>
<p>使用fact缓存可以跨群组访问变量,即使群组间在当前/user/bin/ansible-playbook执行中并没有通讯过.</p>
<p>为了启用fact缓存,在大多数plays中你可以修改 &#8216;gathering&#8217; 设置为 &#8216;smart&#8217; 或者 &#8216;explicit&#8217;,也可以设置 &#8216;gather_facts&#8217; 为False.</p>
<p>当前,Ansible可以使用两种持久的缓存插件: redis和jsonfile.</p>
<p>可以在ansible.cfg中配置fact缓存使用redis:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>defaults<span class="o">]</span>
<span class="nv">gathering</span> <span class="o">=</span> smart
<span class="nv">fact_caching</span> <span class="o">=</span> redis
<span class="nv">fact_caching_timeout</span> <span class="o">=</span> 86400
<span class="c"># seconds</span>
</pre></div>
</div>
<p>请执行适当的系统命令来启动和运行redis:</p>
<div class="highlight-bash"><div class="highlight"><pre>yum install redis
service redis start
pip install redis
</pre></div>
</div>
<p>请注意可以使用pip来安装Python redis库,在EPEL中的包版本对Ansible来说太旧了.
在当前Ansible版本中,该功能还处于试用状态,Redis插件还不支持端口或密码配置,以后会改善这点.
在ansible.cfg中使用以下代码来配置fact缓存使用jsonfile:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>defaults<span class="o">]</span>
<span class="nv">gathering</span> <span class="o">=</span> smart
<span class="nv">fact_caching</span> <span class="o">=</span> jsonfile
<span class="nv">fact_caching_connection</span> <span class="o">=</span> /path/to/cachedir
<span class="nv">fact_caching_timeout</span> <span class="o">=</span> 86400
<span class="c"># seconds</span>
</pre></div>
</div>
<p><cite>fact_caching_connection</cite> 是一个放置在可读目录(如果目录不存在,ansible会试图创建它)中的本地文件路径.</p>
</div>
<div class="section" id="registered-variables">
<span id="id4"></span><h4><a class="toc-backref" href="#id22">注册变量</a><a class="headerlink" href="#registered-variables" title="Permalink to this headline">¶</a></h4>
<p>变量的另一个主要用途是在运行命令时,把命令结果存储到一个变量中.不同模块的执行结果是不同的.运行playbook时使用-v选项可以看到可能的结果值.
在ansible执行任务的结果值可以保存在变量中,以便稍后使用它.在 <a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a> 章节有一些示例.</p>
<p>这里有一个语法示例,在上面文档中也有所提及:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: web_servers

  tasks:

     - shell: /usr/bin/foo
       register: foo_result
       ignore_errors: True

     - shell: /usr/bin/bar
       when: foo_result.rc <span class="o">==</span> 5
</pre></div>
</div>
<p>在当前主机接下来playbook运行过程中注册的变量是有效地.这与Ansile中的 &#8220;facts&#8221; 生命周期一样. 实际上注册变量和facts很相似.</p>
</div>
<div class="section" id="accessing-complex-variable-data">
<span id="id5"></span><h4><a class="toc-backref" href="#id23">访问复杂变量数据</a><a class="headerlink" href="#accessing-complex-variable-data" title="Permalink to this headline">¶</a></h4>
<p>在该文档中我们已经讨论了一些与facts有关的高级特性.</p>
<p>有些提供的facts,比如网络信息等,是一个嵌套的数据结构.访问它们使用简单的 {{ foo }} 语法并不够用,当仍然很容易.如下所示:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_eth0<span class="o">[</span><span class="s2">&quot;ipv4&quot;</span><span class="o">][</span><span class="s2">&quot;address&quot;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>或者这样写:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> ansible_eth0.ipv4.address <span class="o">}}</span>
</pre></div>
</div>
<p>相似的,以下代码展示了我们如何访问数组的第一个元素:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> foo<span class="o">[</span>0<span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="magic-variables-and-hostvars">
<span id="id6"></span><h4><a class="toc-backref" href="#id24">魔法变量,以及如何访问其它主机的信息</a><a class="headerlink" href="#magic-variables-and-hostvars" title="Permalink to this headline">¶</a></h4>
<p>Ansible会自动提供给你一些变量,即使你并没有定义过它们.这些变量中重要的有 &#8216;hostvars&#8217;,&#8217;group_names&#8217;,和 &#8216;groups&#8217;.由于这些变量名是预留的,所以用户不应当覆盖它们. &#8216;environmen&#8217; 也是预留的.
hostvars可以让你访问其它主机的变量,包括哪些主机中获取到的facts.如果你还没有在当前playbook或者一组playbook的任何play中访问那个主机,那么你可以获取变量,但无法看到facts值.
如果数据库服务器想使用另一个节点的某个 &#8216;fact&#8217; 值,或者赋值给该节点的一个inventory变量.可以在一个模板中甚至命令行中轻松实现:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> hostvars<span class="o">[</span><span class="s1">&#39;test.example.com&#39;</span><span class="o">][</span><span class="s1">&#39;ansible_distribution&#39;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>另外, <em>group_names</em> 是当前主机所在所有群组的列表(数组).所以可以使用Jinja2语法在模板中根据该主机所在群组关系(或角色)来产生变化:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>% <span class="k">if</span> <span class="s1">&#39;webserver&#39;</span> in group_names %<span class="o">}</span>
   <span class="c"># some part of a configuration file that only applies to webservers</span>
<span class="o">{</span>% endif %<span class="o">}</span>
</pre></div>
</div>
<p><em>groups</em> 是inventory中所有群组(主机)的列表.可用于枚举群组中的所有主机.例如:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>% <span class="k">for</span> host in groups<span class="o">[</span><span class="s1">&#39;app_servers&#39;</span><span class="o">]</span> %<span class="o">}</span>
   <span class="c"># something that applies to all app servers.</span>
<span class="o">{</span>% endfor %<span class="o">}</span>
</pre></div>
</div>
<p>一个经常使用的范式是找出该群组中的所有IP地址:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>% <span class="k">for</span> host in groups<span class="o">[</span><span class="s1">&#39;app_servers&#39;</span><span class="o">]</span> %<span class="o">}</span>
   <span class="o">{{</span> hostvars<span class="o">[</span>host<span class="o">][</span><span class="s1">&#39;ansible_eth0&#39;</span><span class="o">][</span><span class="s1">&#39;ipv4&#39;</span><span class="o">][</span><span class="s1">&#39;address&#39;</span><span class="o">]</span> <span class="o">}}</span>
<span class="o">{</span>% endfor %<span class="o">}</span>
</pre></div>
</div>
<p>比如,一个前端代理服务器需要指向所有的应用服务器,在服务器间设置正确的防火墙规则等.你需要确保所有主机的facts在使用前都已被获取到,例如运行一个play来检查这些facts是否已经被缓存起来(fact缓存是Ansible 1.8中的新特性).</p>
<p>另外, <em>inventory_hostname</em> 是Ansible inventory主机文件中配置的主机名称.由于其它一些神秘原因你不想使用自发现的主机名 <cite>ansible_hostname</cite> 时,你可以使用 <em>inventory_hostname</em> .如果主机的FQDN很长,那么*inventory_hostname_short*则会只包含域名第一个分号之前的部分,而舍弃其它部分.</p>
<p><em>play_hosts</em> 是在当前play范围中可用的一组主机名.比如可以为多个主机填写模板,以便将这些主机注入负载均衡器规则.</p>
<p><em>delegate_to</em> is the inventory hostname of the host that the current task has been delegated to using &#8216;delegate_to&#8217;.</p>
<p><em>delegate_to</em> 是使用 &#8216;delegate_to&#8217; 代理的任务中主机的inventory主机名.</p>
<p>不要担心以上东西,除非你需要使用它们.你会知道什么时候用它们.</p>
<p><em>inventory_dir</em> 是保存Ansible inventory主机文件的目录路径, <em>inventory_file</em> 是指向Ansible inventory主机文件的路径和文件名.</p>
<p>最后, <em>role_path</em> 会返回当前role的目录名(1.8及以后).只有在role中才能使用该变量.</p>
</div>
<div class="section" id="variable-file-separation-details">
<span id="id7"></span><h4><a class="toc-backref" href="#id25">变量文件分割</a><a class="headerlink" href="#variable-file-separation-details" title="Permalink to this headline">¶</a></h4>
<p>把playbook置于源代码管理之下是个很好的注意,当你可能会想把playbook源码公开之余还想保持某些重要的变量私有.有时你也想把某些信息放置在不同的文件中,远离主playbook文件.</p>
<p>你可以使用外部的变量文件来实现:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: all
  remote_user: root
  vars:
    favcolor: blue
  vars_files:
    - /vars/external_vars.yml

  tasks:

  - name: this is just a placeholder
    <span class="nb">command</span>: /bin/echo foo
</pre></div>
</div>
<p>这可以保证你共享playbook源码时隔离敏感数据的风险.</p>
<p>每个变量文件的内容是一个简单的YAML文件,如下所示:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># in the above example, this would be vars/external_vars.yml</span>
somevar: somevalue
password: magic
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It&#8217;s also possible to keep per-host and per-group variables in very
similar files, this is covered in <a class="reference internal" href="index.html#splitting-out-vars"><span>分文件定义 Host 和 Group 变量</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">保持每个主机和群组的变量在非常小的文件中是可能,请参见 <a class="reference internal" href="index.html#splitting-out-vars"><span>分文件定义 Host 和 Group 变量</span></a>.</p>
</div>
</div>
<div class="section" id="passing-variables-on-the-command-line">
<span id="id8"></span><h4><a class="toc-backref" href="#id26">命令行中传递变量</a><a class="headerlink" href="#passing-variables-on-the-command-line" title="Permalink to this headline">¶</a></h4>
<p>除了`vars_prompt`和`vars_files`也可以通过Ansible命令行发送变量.如果你想编写一个通用的发布playbook时则特别有用,你可以传递应用的版本以便部署:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook release.yml --extra-vars <span class="s2">&quot;version=1.23.45 other_variable=foo&quot;</span>
</pre></div>
</div>
<p>其它场景中也很有用,比如为playbook设置主机群组或用户.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: <span class="s1">&#39;{{ hosts }}&#39;</span>
  remote_user: <span class="s1">&#39;{{ user }}&#39;</span>

  tasks:
     - ...

ansible-playbook release.yml --extra-vars <span class="s2">&quot;hosts=vipers user=starbuck&quot;</span>
</pre></div>
</div>
<p>Ansible 1.2中你也可以给extra-vars传递JSON,比如:</p>
<div class="highlight-bash"><div class="highlight"><pre>--extra-vars <span class="s1">&#39;{&quot;pacman&quot;:&quot;mrs&quot;,&quot;ghosts&quot;:[&quot;inky&quot;,&quot;pinky&quot;,&quot;clyde&quot;,&quot;sue&quot;]}&#39;</span>
</pre></div>
</div>
<p>key=value形式非常简单,但很实用!</p>
<p>Ansible 1.3中,实用&#8221;&#64;&#8221;语法可以为extra-vars传递JSON文件:</p>
<div class="highlight-bash"><div class="highlight"><pre>--extra-vars <span class="s2">&quot;@some_file.json&quot;</span>
</pre></div>
</div>
<p>同样在Ansible 1.3中,我们可以为extra-vars传递YAML格式,无论直接通过命令行还是放置在文件中.</p>
</div>
<div class="section" id="variable-precedence">
<span id="id9"></span><h4><a class="toc-backref" href="#id27">变量的优先级: 我该在什么地方放置变量?</a><a class="headerlink" href="#variable-precedence" title="Permalink to this headline">¶</a></h4>
<p>很多人都在问变量重载的规则是怎么样的.最终Ansible的哲学是你最好知道哪里放置变量,然后会简化变量覆盖的复杂度.</p>
<p>避免在47个地方定义 &#8220;x&#8221; 变量然后询问 &#8220;那个x会被使用&#8221;. 为什么那？ 因为这不是Ansible做事的哲学.</p>
<p>世界上只有一个帝国大厦.也只有一个蒙娜丽莎.请弄明白在那里定义变量,而不要把事情搞复杂.</p>
<p>然而,我们还是来讨卵一下优先权的问题.它存在.你有可能会用到它.</p>
<p>如果同样名称的变量在多个地方都有定义,那么采纳是有个确定的顺序,如下:</p>
<div class="highlight-bash"><div class="highlight"><pre>* extra vars <span class="o">(</span>-e in the <span class="nb">command </span>line<span class="o">)</span> always win
* <span class="k">then</span> comes connection variables defined in inventory <span class="o">(</span>ansible_ssh_user, etc<span class="o">)</span>
* <span class="k">then</span> comes <span class="s2">&quot;most everything else&quot;</span> <span class="o">(</span><span class="nb">command </span>line switches, vars in play, included vars, role vars, etc<span class="o">)</span>
* <span class="k">then</span> comes the rest of the variables defined in inventory
* <span class="k">then</span> comes facts discovered about a system
* <span class="k">then</span> <span class="s2">&quot;role defaults&quot;</span>, which are the most <span class="s2">&quot;defaulty&quot;</span> and lose in priority to everything.

* extra vars <span class="o">(</span>在命令行中使用 -e<span class="o">)</span>优先级最高
* 然后是在inventory中定义的连接变量<span class="o">(</span>比如ansible_ssh_user<span class="o">)</span>
* 接着是大多数的其它变量<span class="o">(</span>命令行转换,play中的变量,included的变量,role中的变量等<span class="o">)</span>
* 然后是在inventory定义的其它变量
* 然后是由系统发现的facts
* 然后是 <span class="s2">&quot;role默认变量&quot;</span>, 这个是最默认的值,很容易丧失优先权
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In versions prior to 1.5.4, facts discovered about a system were in the &#8220;most everything else&#8221; category above.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">在1.5.4版本级以后,关于系统的自发现的facts也包含在大多数的其它变量中.</p>
</div>
<p>这样看起来太理论化了.让我们来看一段示例,</p>
<p>First off, group variables are super powerful.</p>
<p>Site wide defaults should be defined as a &#8216;group_vars/all&#8217; setting.  Group variables are generally placed alongside
your inventory file.  They can also be returned by a dynamic inventory script (see <a class="reference internal" href="index.html#document-docs/intro_dynamic_inventory"><em>动态 Inventory</em></a>) or defined
in things like <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> from the UI or API:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: /etc/ansible/group_vars/all</span>
<span class="c"># this is the site wide default</span>
ntp_server: default-time.example.com
</pre></div>
</div>
<p>Regional information might be defined in a &#8216;group_vars/region&#8217; variable.  If this group is a child of the &#8216;all&#8217; group (which it is, because all groups are), it will override the group that is higher up and more general:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: /etc/ansible/group_vars/boston</span>
ntp_server: boston-time.example.com
</pre></div>
</div>
<p>If for some crazy reason we wanted to tell just a specific host to use a specific NTP server, it would then override the group variable!:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: /etc/ansible/host_vars/xyz.boston.example.com</span>
ntp_server: override.example.com
</pre></div>
</div>
<p>So that covers inventory and what you would normally set there.  It&#8217;s a great place for things that deal with geography or behavior.  Since groups are frequently the entity that maps roles onto hosts, it is sometimes a shortcut to set variables on the group instead of defining them on a role.  You could go either way.</p>
<p>Remember:  Child groups override parent groups, and hosts always override their groups.</p>
<p>Next up: learning about role variable precedence.</p>
<p>We&#8217;ll pretty much assume you are using roles at this point.  You should be using roles for sure.  Roles are great.  You are using
roles aren&#8217;t you?  Hint hint.</p>
<p>Ok, so if you are writing a redistributable role with reasonable defaults, put those in the &#8216;roles/x/defaults/main.yml&#8217; file.  This means
the role will bring along a default value but ANYTHING in Ansible will override it.  It&#8217;s just a default.  That&#8217;s why it says &#8220;defaults&#8221; :)
See <a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a> for more info about this:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: roles/x/defaults/main.yml</span>
<span class="c"># if not overridden in inventory or as a parameter, this is the value that will be used</span>
http_port: 80
</pre></div>
</div>
<p>if you are writing a role and want to ensure the value in the role is absolutely used in that role, and is not going to be overridden
by inventory, you should put it in roles/x/vars/main.yml like so, and inventory values cannot override it.  -e however, still will:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: roles/x/vars/main.yml</span>
<span class="c"># this will absolutely be used in this role</span>
http_port: 80
</pre></div>
</div>
<p>So the above is a great way to plug in constants about the role that are always true.  If you are not sharing your role with others,
app specific behaviors like ports is fine to put in here.  But if you are sharing roles with others, putting variables in here might
be bad. Nobody will be able to override them with inventory, but they still can by passing a parameter to the role.</p>
<p>Parameterized roles are useful.</p>
<p>If you are using a role and want to override a default, pass it as a parameter to the role like so:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles:
   - <span class="o">{</span> role: apache, http_port: <span class="m">8080</span> <span class="o">}</span>
</pre></div>
</div>
<p>This makes it clear to the playbook reader that you&#8217;ve made a conscious choice to override some default in the role, or pass in some
configuration that the role can&#8217;t assume by itself.  It also allows you to pass something site-specific that isn&#8217;t really part of the
role you are sharing with others.</p>
<p>This can often be used for things that might apply to some hosts multiple times,
like so:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles:
   - <span class="o">{</span> role: app_user, name: Ian    <span class="o">}</span>
   - <span class="o">{</span> role: app_user, name: Terry  <span class="o">}</span>
   - <span class="o">{</span> role: app_user, name: Graham <span class="o">}</span>
   - <span class="o">{</span> role: app_user, name: John   <span class="o">}</span>
</pre></div>
</div>
<p>That&#8217;s a bit arbitrary, but you can see how the same role was invoked multiple Times.  In that example it&#8217;s quite likely there was
no default for &#8216;name&#8217; supplied at all.  Ansible can yell at you when variables aren&#8217;t defined &#8211; it&#8217;s the default behavior in fact.</p>
<p>So that&#8217;s a bit about roles.</p>
<p>There are a few bonus things that go on with roles.</p>
<p>Generally speaking, variables set in one role are available to others.  This means if you have a &#8220;roles/common/vars/main.yml&#8221; you
can set variables in there and make use of them in other roles and elsewhere in your playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles:
   - <span class="o">{</span> role: common_settings <span class="o">}</span>
   - <span class="o">{</span> role: something, foo: <span class="m">12</span> <span class="o">}</span>
   - <span class="o">{</span> role: something_else <span class="o">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are some protections in place to avoid the need to namespace variables.
In the above, variables defined in common_settings are most definitely available to &#8216;something&#8217; and &#8216;something_else&#8217; tasks, but if
&#8220;something&#8217;s&#8221; guaranteed to have foo set at 12, even if somewhere deep in common settings it set foo to 20.</p>
</div>
<p>So, that&#8217;s precedence, explained in a more direct way.  Don&#8217;t worry about precedence, just think about if your role is defining a
variable that is a default, or a &#8220;live&#8221; variable you definitely want to use.  Inventory lies in precedence right in the middle, and
if you want to forcibly override something, use -e.</p>
<p>If you found that a little hard to understand, take a look at the <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-examples</a> repo on our github for a bit more about
how all of these things can work together.</p>
<p>如果你还感觉有点难以理解,你可以学习我们放在github中的 <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-examples</a> 代码库,来了解这些东西是如何一起协作的.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><code class="xref doc docutils literal"><span class="pre">playbooks_filters</span></code></dt>
<dd>Jinja2 filters and their uses</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_loops"><em>循环</em></a></dt>
<dd>Looping in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_conditionals"></span><div class="section" id="id1">
<h3><a class="toc-backref" href="#id6">条件选择</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id6">条件选择</a><ul>
<li><a class="reference internal" href="#when" id="id7">When 语句</a></li>
<li><a class="reference internal" href="#id2" id="id8">加载客户事件</a></li>
<li><a class="reference internal" href="#roles-includes-when" id="id9">在roles 和 includes 上面应用&#8217;when&#8217;语句</a></li>
<li><a class="reference internal" href="#id3" id="id10">条件导入</a></li>
<li><a class="reference internal" href="#id4" id="id11">基于变量选择文件和模版</a></li>
<li><a class="reference internal" href="#id5" id="id12">注册变量</a></li>
</ul>
</li>
</ul>
</div>
<p>常常来说,一个play的结果经常取决于一个变量的值,事件（从远端系统得到事件）,
或者之前任务的结果.在有些情况下,这些变量的值也会取决于其他变量.
进而,可以建立多余的组基于这些主机是否符合某些条件来操控主机,
Ansible 提供了很多不同选项,来控制执行流.
让我们详细看看这些都是啥.</p>
<div class="section" id="when">
<h4><a class="toc-backref" href="#id7">When 语句</a><a class="headerlink" href="#when" title="Permalink to this headline">¶</a></h4>
<p>有时候用户有可能需要某一个主机越过某一个特定的步骤.这个过程就可以简单的像在某一个特定版本的系统上
少装了一个包一样或者像在一个满了的文件系统上执行清理操作一样.
这些操作在Ansible上,若使用`when`语句都异常简单.When语句包含Jinja2表达式(参见:doc:<cite>playbooks_variables</cite>).
实际上真的很简单:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: <span class="s2">&quot;shutdown Debian flavored systems&quot;</span>
    <span class="nb">command</span>: /sbin/shutdown -t now
    when: <span class="nv">ansible_os_family</span> <span class="o">==</span> <span class="s2">&quot;Debian&quot;</span>
</pre></div>
</div>
<p>一系列的Jinja2 &#8220;过滤器&#8221; 也可以在when语句中使用, 但有些是Ansible中独有的.
比如我们想忽略某一错误,通过执行成功与否来做决定,我们可以像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - <span class="nb">command</span>: /bin/false
    register: result
    ignore_errors: True
  - <span class="nb">command</span>: /bin/something
    when: result<span class="p">|</span>failed
  - <span class="nb">command</span>: /bin/something_else
    when: result<span class="p">|</span>success
  - <span class="nb">command</span>: /bin/still/something_else
    when: result<span class="p">|</span>skipped
</pre></div>
</div>
<p>我知道,在这里讨论&#8217;register&#8217;语句命令,有点过于超前,我们将会在这议长靠后一点的地方接触这个.</p>
<p>友情提示,如果想查看哪些事件在某个特定系统中时允许的,可以执行以下命令:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible hostname.example.com -m setup
</pre></div>
</div>
<p>提示: 有些时候你得到一个返回参数的值是一个字符串,并且你还想使用数学操作来比较它,那么你可以执行一下操作:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - shell: <span class="nb">echo</span> <span class="s2">&quot;only on Red Hat 6, derivatives, and later&quot;</span>
    when: <span class="nv">ansible_os_family</span> <span class="o">==</span> <span class="s2">&quot;RedHat&quot;</span> and ansible_lsb.major_release<span class="p">|</span>int &gt;<span class="o">=</span> 6
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">以上事例需要目标主机上安装lsb_release软件包,来返回ansible_lsb.major_release 事件.</p>
</div>
<p>在playbooks 和 inventory中定义的变量都可以使用. 下面一个例子,就是基于布尔值来决定一个任务是否被执行:</p>
<div class="highlight-bash"><div class="highlight"><pre>vars:
  epic: <span class="nb">true</span>
</pre></div>
</div>
<p>一个条件选择执行也许看起来像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
    - shell: <span class="nb">echo</span> <span class="s2">&quot;This certainly is epic!&quot;</span>
      when: epic
</pre></div>
</div>
<p>或者像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
    - shell: <span class="nb">echo</span> <span class="s2">&quot;This certainly isn&#39;t epic!&quot;</span>
      when: not epic
</pre></div>
</div>
<p>如果一个变量不存在,你可以使用Jinja2的`defined`命令跳过或略过.例如:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
    - shell: <span class="nb">echo</span> <span class="s2">&quot;I&#39;ve got &#39;{{ foo }}&#39; and am not afraid to use it!&quot;</span>
      when: foo is defined

    - fail: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Bailing out. this play requires &#39;bar&#39;&quot;</span>
      when: bar is not defined
</pre></div>
</div>
<p>这个机制在选择引入变量文件时有时候特别有用,详情如下.</p>
<p>note当同时使用`when`he`with_items` (详见:doc:<cite>playbooks_loops</cite>), note`when`语句对于不同项目将会单独处理.这个源于原初设计:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
    - <span class="nb">command</span>: <span class="nb">echo</span> <span class="o">{{</span> item <span class="o">}}</span>
      with_items: <span class="o">[</span> 0, 2, 4, 6, 8, <span class="m">10</span> <span class="o">]</span>
      when: item &gt; 5
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h4><a class="toc-backref" href="#id8">加载客户事件</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>加载客户自己的事件,事实上也很简单,将在:doc:<cite>developing_modules</cite> 详细介绍.只要调用客户自己的事件,进而把所有的模块放在任务列表顶端,
变量的返回值今后就可以访问了:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
    - name: gather site specific fact data
      action: site_facts
    - <span class="nb">command</span>: /usr/bin/thingy
      when: <span class="nv">my_custom_fact_just_retrieved_from_the_remote_system</span> <span class="o">==</span> <span class="s1">&#39;1234&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="roles-includes-when">
<h4><a class="toc-backref" href="#id9">在roles 和 includes 上面应用&#8217;when&#8217;语句</a><a class="headerlink" href="#roles-includes-when" title="Permalink to this headline">¶</a></h4>
<p>note,如果你的很多任务都共享同样的条件语句的话,可以在选择语句后面添加inlcudes语句,参见下面事例.
这个特性并不适用于playbook的inclues,只有task 的 includes适用.所有的task都会被检验,
选择会应用到所有的task上面:</p>
<div class="highlight-bash"><div class="highlight"><pre>- include: tasks/sometasks.yml
  when: <span class="s2">&quot;&#39;reticulating splines&#39; in output&quot;</span>
</pre></div>
</div>
<p>或者应用于role:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: webservers
  roles:
     - <span class="o">{</span> role: debian_stock_config, when: <span class="nv">ansible_os_family</span> <span class="o">==</span> <span class="s1">&#39;Debian&#39;</span> <span class="o">}</span>
</pre></div>
</div>
<p>在系统中使用这个方法但是并不能匹配某些标准时,你会发现在Ansible中,有很多默认&#8217;skipped&#8217;的结果.
详情参见:doc:<cite>modules</cite> 文档中的 &#8216;group_by&#8217; 模块, 你会找到更加赏心悦目的方法来解决这个问题.</p>
</div>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id10">条件导入</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个很高级但是却被经常使用的话题.当然你也可以跳过这一节.</p>
</div>
<p>基于某个特定标准,又是你也许在一个playbook中你想以不同的方式做同一件事.
在不同平台或操作系统上使用痛一个playbook就是一个很好的例子.</p>
<p>举个例子,名字叫做Apache的包,在CentOS 和 Debian系统中也许不同,
但是这个问题可以一些简单的语法就可以被Ansible Playbook解决:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: all
  remote_user: root
  vars_files:
    - <span class="s2">&quot;vars/common.yml&quot;</span>
    - <span class="o">[</span> <span class="s2">&quot;vars/{{ ansible_os_family }}.yml&quot;</span>, <span class="s2">&quot;vars/os_defaults.yml&quot;</span> <span class="o">]</span>
  tasks:
  - name: make sure apache is running
    service: <span class="nv">name</span><span class="o">={{</span> apache <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>running
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">&#8216;ansible_os_family&#8217; 已经被导入到为vars_files定义的文件名列表中了.</p>
</div>
<p>提醒一下,很多的不同的YAML文件只是包含键和值:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># for vars/CentOS.yml</span>
apache: httpd
somethingelse: 42
</pre></div>
</div>
<p>这个具体事怎么工作的呢？ 如果操作系统是&#8217;CentOS&#8217;, Ansible导入的第一个文件将是&#8217;vars/CentOS.yml&#8217;,紧接着
是&#8217;/var/os_defaults.yml&#8217;,如果这个文件不存在.而且在列表中没有找到,就会报错.
在Debian,最先查看的将是&#8217;vars/Debian.yml&#8217;而不是&#8217;vars/CentOS.yml&#8217;, 如果没找到,则寻找默认文件&#8217;vars/os_defaults.yml&#8217;
很简单.如果使用这个条件性导入特性,你需要在运行playbook之前安装facter 或者 ohai.当然如果你喜欢,
你也可以把这个事情推给Ansible来做:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># for facter</span>
ansible -m yum -a <span class="s2">&quot;pkg=facter state=present&quot;</span>
ansible -m yum -a <span class="s2">&quot;pkg=ruby-json state=present&quot;</span>

<span class="c"># for ohai</span>
ansible -m yum -a <span class="s2">&quot;pkg=ohai state=present&quot;</span>
</pre></div>
</div>
<p>Ansible 中的设置方式———— 从任务中把参数分开,这样可避免代码中有太多丑陋嵌套if等复杂语句.
这样可以使得配置条目更加的流畅的赏心悦目———— 特别是因为这样可以尽量减少决定点</p>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id11">基于变量选择文件和模版</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个经常用到的高级话题.也可以跳过这章.</p>
</div>
<p>有时候,你想要复制一个配置文件,或者一个基于参数的模版.
下面的结构选载选第一个宿主给予的变量文件,这些可以比把很多if选择放在模版里要简单的多.
下面的例子展示怎样根据不同的系统,例如CentOS,Debian制作一个配置文件的模版:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: template a file
   template: <span class="nv">src</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">dest</span><span class="o">=</span>/etc/myapp/foo.conf
   with_first_found:
     - files:
        - <span class="o">{{</span> ansible_distribution <span class="o">}}</span>.conf
        - default.conf
       paths:
        - search_location_one/somedir/
        - /opt/other_location/somedir/
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h4><a class="toc-backref" href="#id12">注册变量</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>经常在playbook中,存储某个命令的结果在变量中,以备日后访问是很有用的.
这样使用命令模块可以在许多方面除去写站（site）特异事件,据哥例子
你可以检测某一个特定程序是否存在</p>
<p>这个 &#8216;register&#8217; 关键词决定了把结果存储在哪个变量中.结果参数可以用在模版中,动作条目,或者 <em>when</em> 语句. 像这样（这是一个浅显的例子）:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: <span class="nb">test </span>play
  hosts: all

  tasks:

      - shell: cat /etc/motd
        register: motd_contents

      - shell: <span class="nb">echo</span> <span class="s2">&quot;motd contains the word hi&quot;</span>
        when: motd_contents.stdout.find<span class="o">(</span><span class="s1">&#39;hi&#39;</span><span class="o">)</span> !<span class="o">=</span> -1
</pre></div>
</div>
<p>就像上面展示的那样,这个注册后的参数的内容为字符串&#8217;stdout&#8217;是可以访问.
这个注册了以后的结果,如果像上面展示的,可以转化为一个list（或者已经是一个list）,就可以在任务中的&#8221;with_items&#8221;中使用.
&#8220;stdout_lines&#8221;在对象中已经可以访问了,当然如果你喜欢也可以调用 &#8220;home_dirs.stdout.split()&#8221; , 也可以用其它字段切割:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: registered variable usage as a with_items list
  hosts: all

  tasks:

      - name: retrieve the list of home directories
        <span class="nb">command</span>: ls /home
        register: home_dirs

      - name: add home <span class="nb">dirs </span>to the backup spooler
        file: <span class="nv">path</span><span class="o">=</span>/mnt/bkspool/<span class="o">{{</span> item <span class="o">}}</span> <span class="nv">src</span><span class="o">=</span>/home/<span class="o">{{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>link
        with_items: home_dirs.stdout_lines
        <span class="c"># same as with_items: home_dirs.stdout.split()</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_loops"></span><div class="section" id="id1">
<h3><a class="toc-backref" href="#id17">循环</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>通常你想在一个任务中干很多事,比如创建一群用户,安装很多包,或者重复一个轮询步骤直到收到某个特定结果.</p>
<p>本章将对在playbook中如何使用循环做全面的介绍.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id17">循环</a><ul>
<li><a class="reference internal" href="#standard-loops" id="id18">标准循环</a></li>
<li><a class="reference internal" href="#nested-loops" id="id19">嵌套循环</a></li>
<li><a class="reference internal" href="#looping-over-hashes" id="id20">对哈希表使用循环</a></li>
<li><a class="reference internal" href="#looping-over-fileglobs" id="id21">对文件列表使用循环</a></li>
<li><a class="reference internal" href="#id6" id="id22">对并行数据集使用循环</a></li>
<li><a class="reference internal" href="#id7" id="id23">对子元素使用循环</a></li>
<li><a class="reference internal" href="#looping-over-integer-sequences" id="id24">对整数序列使用循环</a></li>
<li><a class="reference internal" href="#random-choice" id="id25">随机选择</a></li>
<li><a class="reference internal" href="#do-until" id="id26">Do-Until循环</a></li>
<li><a class="reference internal" href="#with-first-found" id="id27">查找第一个匹配的文件</a></li>
<li><a class="reference internal" href="#looping-over-the-results-of-a-program-execution" id="id28">迭代程序的执行结果</a></li>
<li><a class="reference internal" href="#indexed-lists" id="id29">使用索引循环列表</a></li>
<li><a class="reference internal" href="#using-ini-with-a-loop" id="id30">循环配置文件</a></li>
<li><a class="reference internal" href="#flattening-a-list" id="id31">扁平化列表</a></li>
<li><a class="reference internal" href="#using-register-with-a-loop" id="id32">循环中使用注册器</a></li>
<li><a class="reference internal" href="#writing-your-own-iterators" id="id33">自定义迭代</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="standard-loops">
<span id="id2"></span><h4><a class="toc-backref" href="#id18">标准循环</a><a class="headerlink" href="#standard-loops" title="Permalink to this headline">¶</a></h4>
<p>为了保持简洁,重复的任务可以用以下简写的方式:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: add several users
  user: <span class="nv">name</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present <span class="nv">groups</span><span class="o">=</span>wheel
  with_items:
     - testuser1
     - testuser2
</pre></div>
</div>
<p>如果你在变量文件中或者 &#8216;vars&#8217; 区域定义了一组YAML列表,你也可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>with_items: <span class="s2">&quot;{{somelist}}&quot;</span>
</pre></div>
</div>
<p>以上写法与下面是完全等同的:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: add user testuser1
  user: <span class="nv">name</span><span class="o">=</span>testuser1 <span class="nv">state</span><span class="o">=</span>present <span class="nv">groups</span><span class="o">=</span>wheel
- name: add user testuser2
  user: <span class="nv">name</span><span class="o">=</span>testuser2 <span class="nv">state</span><span class="o">=</span>present <span class="nv">groups</span><span class="o">=</span>wheel
</pre></div>
</div>
<p>yum和apt模块中使用with_items执行时会有较少的包管理事务.</p>
<p>请note使用 &#8216;with_items&#8217; 用于迭代的条目类型不仅仅支持简单的字符串列表.如果你有一个哈希列表,那么你可以用以下方式来引用子项:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: add several users
  user: <span class="nv">name</span><span class="o">={{</span> item.name <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present <span class="nv">groups</span><span class="o">={{</span> item.groups <span class="o">}}</span>
  with_items:
    - <span class="o">{</span> name: <span class="s1">&#39;testuser1&#39;</span>, groups: <span class="s1">&#39;wheel&#39;</span> <span class="o">}</span>
    - <span class="o">{</span> name: <span class="s1">&#39;testuser2&#39;</span>, groups: <span class="s1">&#39;root&#39;</span> <span class="o">}</span>
</pre></div>
</div>
<p>请note如果同时使用 <cite>when</cite> 和 <cite>with_items</cite> （或其它循环声明）,`when`声明会为每个条目单独执行.请参见 <span class="xref std std-ref">the_when_statement</span> 示例.</p>
</div>
<div class="section" id="nested-loops">
<span id="id3"></span><h4><a class="toc-backref" href="#id19">嵌套循环</a><a class="headerlink" href="#nested-loops" title="Permalink to this headline">¶</a></h4>
<p>循环也可以嵌套:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: give users access to multiple databases
  mysql_user: <span class="nv">name</span><span class="o">={{</span> item<span class="o">[</span>0<span class="o">]</span> <span class="o">}}</span> <span class="nv">priv</span><span class="o">={{</span> item<span class="o">[</span>1<span class="o">]</span> <span class="o">}}</span>.*:ALL <span class="nv">append_privs</span><span class="o">=</span>yes <span class="nv">password</span><span class="o">=</span>foo
  with_nested:
    - <span class="o">[</span> <span class="s1">&#39;alice&#39;</span>, <span class="s1">&#39;bob&#39;</span> <span class="o">]</span>
    - <span class="o">[</span> <span class="s1">&#39;clientdb&#39;</span>, <span class="s1">&#39;employeedb&#39;</span>, <span class="s1">&#39;providerdb&#39;</span> <span class="o">]</span>
</pre></div>
</div>
<p>和以上介绍的&#8217;with_items&#8217;一样,你也可以使用预定义变量.:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: here, <span class="s1">&#39;users&#39;</span> contains the above list of employees
  mysql_user: <span class="nv">name</span><span class="o">={{</span> item<span class="o">[</span>0<span class="o">]</span> <span class="o">}}</span> <span class="nv">priv</span><span class="o">={{</span> item<span class="o">[</span>1<span class="o">]</span> <span class="o">}}</span>.*:ALL <span class="nv">append_privs</span><span class="o">=</span>yes <span class="nv">password</span><span class="o">=</span>foo
  with_nested:
    - <span class="s2">&quot;{{users}}&quot;</span>
    - <span class="o">[</span> <span class="s1">&#39;clientdb&#39;</span>, <span class="s1">&#39;employeedb&#39;</span>, <span class="s1">&#39;providerdb&#39;</span> <span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-hashes">
<span id="id4"></span><h4><a class="toc-backref" href="#id20">对哈希表使用循环</a><a class="headerlink" href="#looping-over-hashes" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.5.</span></p>
</div>
<p>假如你有以下变量:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
users:
  alice:
    name: Alice Appleworth
    telephone: 123-456-7890
  bob:
    name: Bob Bananarama
    telephone: 987-654-3210
</pre></div>
</div>
<p>你想打印出每个用户的名称和电话号码.你可以使用 <code class="docutils literal"><span class="pre">with_dict</span></code> 来循环哈希表中的元素:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
  - name: Print phone records
    debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;User {{ item.key }} is {{ item.value.name }} ({{ item.value.telephone }})&quot;</span>
    with_dict: <span class="s2">&quot;{{users}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="looping-over-fileglobs">
<span id="id5"></span><h4><a class="toc-backref" href="#id21">对文件列表使用循环</a><a class="headerlink" href="#looping-over-fileglobs" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">with_fileglob</span></code> 可以以非递归的方式来模式匹配单个目录中的文件.如下面所示:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: all

  tasks:

    <span class="c"># first ensure our target directory exists</span>
    - file: <span class="nv">dest</span><span class="o">=</span>/etc/fooapp <span class="nv">state</span><span class="o">=</span>directory

    <span class="c"># copy each file over that matches the given pattern</span>
    - copy: <span class="nv">src</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">dest</span><span class="o">=</span>/etc/fooapp/ <span class="nv">owner</span><span class="o">=</span>root <span class="nv">mode</span><span class="o">=</span>600
      with_fileglob:
        - /playbooks/files/fooapp/*
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">当在role中对 <code class="docutils literal"><span class="pre">with_fileglob</span></code> 使用相对路径时, Ansible会把路径映射到`roles/&lt;rolename&gt;/files`目录.</p>
</div>
</div>
<div class="section" id="id6">
<h4><a class="toc-backref" href="#id22">对并行数据集使用循环</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个不常见的使用方式,但为了文档完整性我们还是把它写出来.你可能不会经常使用这种方式.</p>
</div>
<p>假设你通过某种方式加载了以下变量数据:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
alpha: <span class="o">[</span> <span class="s1">&#39;a&#39;</span>, <span class="s1">&#39;b&#39;</span>, <span class="s1">&#39;c&#39;</span>, <span class="s1">&#39;d&#39;</span> <span class="o">]</span>
numbers:  <span class="o">[</span> 1, 2, 3, <span class="m">4</span> <span class="o">]</span>
</pre></div>
</div>
<p>如果你想得到&#8217;(a, 1)&#8217;和&#8217;(b, 2)&#8217;之类的集合.可以使用&#8217;with_together&#8217;:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:
    - debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{ item.0 }} and {{ item.1 }}&quot;</span>
      with_together:
        - <span class="s2">&quot;{{alpha}}&quot;</span>
        - <span class="s2">&quot;{{numbers}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h4><a class="toc-backref" href="#id23">对子元素使用循环</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>假设你想对一组用户做一些动作,比如创建这些用户,并且允许它们使用一组SSH key来登录.</p>
<p>如何实现那? 先假设你有按以下方式定义的数据,可以通过&#8221;vars_files&#8221;或&#8221;group_vars/all&#8221;文件加载:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
users:
  - name: alice
    authorized:
      - /tmp/alice/onekey.pub
      - /tmp/alice/twokey.pub
    mysql:
        password: mysql-password
        hosts:
          - <span class="s2">&quot;%&quot;</span>
          - <span class="s2">&quot;127.0.0.1&quot;</span>
          - <span class="s2">&quot;::1&quot;</span>
          - <span class="s2">&quot;localhost&quot;</span>
        privs:
          - <span class="s2">&quot;*.*:SELECT&quot;</span>
          - <span class="s2">&quot;DB1.*:ALL&quot;</span>
  - name: bob
    authorized:
      - /tmp/bob/id_rsa.pub
    mysql:
        password: other-mysql-password
        hosts:
          - <span class="s2">&quot;db1&quot;</span>
        privs:
          - <span class="s2">&quot;*.*:SELECT&quot;</span>
          - <span class="s2">&quot;DB2.*:ALL&quot;</span>
</pre></div>
</div>
<p>那么可以这样实现:</p>
<div class="highlight-bash"><div class="highlight"><pre>- user: <span class="nv">name</span><span class="o">={{</span> item.name <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present <span class="nv">generate_ssh_key</span><span class="o">=</span>yes
  with_items: <span class="s2">&quot;{{users}}&quot;</span>

- authorized_key: <span class="s2">&quot;user={{ item.0.name }} key=&#39;{{ lookup(&#39;file&#39;, item.1) }}&#39;&quot;</span>
  with_subelements:
     - users
     - authorized
</pre></div>
</div>
<p>根据mysql hosts以及预先给定的privs subkey列表,我们也可以在嵌套的subkey中迭代列表:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: Setup MySQL users
  mysql_user: <span class="nv">name</span><span class="o">={{</span> item.0.user <span class="o">}}</span> <span class="nv">password</span><span class="o">={{</span> item.0.mysql.password <span class="o">}}</span> <span class="nv">host</span><span class="o">={{</span> item.1 <span class="o">}}</span> <span class="nv">priv</span><span class="o">={{</span> item.0.mysql.privs <span class="p">|</span> join<span class="o">(</span><span class="s1">&#39;/&#39;</span><span class="o">)</span> <span class="o">}}</span>
  with_subelements:
    - users
    - mysql.hosts
</pre></div>
</div>
<p>Subelements walks a list of hashes (aka dictionaries) and then traverses a list with a given key inside of those
records.</p>
<p>你也可以为字元素列表添加第三个元素,该元素可以放置标志位字典.现在你可以加入&#8217;skip_missing&#8217;标志位.如果设置为True,那么查找插件会跳过不包含指定子键的列表条目.如果没有该标志位,或者标志位值为False,插件会产生错误并指出缺少该子键.</p>
<p>这就是authorized_key模式中key的获取方式.</p>
</div>
<div class="section" id="looping-over-integer-sequences">
<span id="id8"></span><h4><a class="toc-backref" href="#id24">对整数序列使用循环</a><a class="headerlink" href="#looping-over-integer-sequences" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal"><span class="pre">with_sequence</span></code> 可以以升序数字顺序生成一组序列.你可以指定起始值、终止值,以及一个可选的步长值.</p>
<p>指定参数时也可以使用key=value这种键值对的方式.如果采用这种方式,&#8217;format&#8217;是一个可打印的字符串.</p>
<p>数字值可以被指定为10进制,16进制(0x3f8)或者八进制(0600).负数则不受支持.请看以下示例:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
- hosts: all

  tasks:

    <span class="c"># create groups</span>
    - group: <span class="nv">name</span><span class="o">=</span>evens <span class="nv">state</span><span class="o">=</span>present
    - group: <span class="nv">name</span><span class="o">=</span>odds <span class="nv">state</span><span class="o">=</span>present

    <span class="c"># create some test users</span>
    - user: <span class="nv">name</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present <span class="nv">groups</span><span class="o">=</span>evens
      with_sequence: <span class="nv">start</span><span class="o">=</span><span class="m">0</span> <span class="nv">end</span><span class="o">=</span><span class="m">32</span> <span class="nv">format</span><span class="o">=</span>testuser%02x

    <span class="c"># create a series of directories with even numbers for some reason</span>
    - file: <span class="nv">dest</span><span class="o">=</span>/var/stuff/<span class="o">{{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>directory
      with_sequence: <span class="nv">start</span><span class="o">=</span><span class="m">4</span> <span class="nv">end</span><span class="o">=</span><span class="m">16</span> <span class="nv">stride</span><span class="o">=</span>2

    <span class="c"># a simpler way to use the sequence plugin</span>
    <span class="c"># create 4 groups</span>
    - group: <span class="nv">name</span><span class="o">=</span>group<span class="o">{{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present
      with_sequence: <span class="nv">count</span><span class="o">=</span>4
</pre></div>
</div>
</div>
<div class="section" id="random-choice">
<span id="id9"></span><h4><a class="toc-backref" href="#id25">随机选择</a><a class="headerlink" href="#random-choice" title="Permalink to this headline">¶</a></h4>
<p>&#8216;random_choice&#8217;功能可以用来随机获取一些值.它并不是负载均衡器(已经有相关的模块了).它有时可以用作一个简化版的负载均衡器,比如作为条件判断:</p>
<div class="highlight-bash"><div class="highlight"><pre>- debug: <span class="nv">msg</span><span class="o">={{</span> item <span class="o">}}</span>
  with_random_choice:
     - <span class="s2">&quot;go through the door&quot;</span>
     - <span class="s2">&quot;drink from the goblet&quot;</span>
     - <span class="s2">&quot;press the red button&quot;</span>
     - <span class="s2">&quot;do nothing&quot;</span>
</pre></div>
</div>
<p>提供的字符串中的其中一个会被随机选中.</p>
<p>还有一个基本的场景,该功能可用于在一个可预测的自动化环境中添加混乱和兴奋点.</p>
</div>
<div class="section" id="do-until">
<span id="do-until-loops"></span><h4><a class="toc-backref" href="#id26">Do-Until循环</a><a class="headerlink" href="#do-until" title="Permalink to this headline">¶</a></h4>
<p>有时你想重试一个任务直到达到某个条件.比如下面这个例子:</p>
<div class="highlight-bash"><div class="highlight"><pre>- action: shell /usr/bin/foo
  register: result
  <span class="k">until</span>: result.stdout.find<span class="o">(</span><span class="s2">&quot;all systems go&quot;</span><span class="o">)</span> !<span class="o">=</span> -1
  retries: 5
  delay: 10
</pre></div>
</div>
<p>上面的例子递归运行shell模块,直到模块结果中的stdout输出中包含&#8221;all systems go&#8221;字符串,或者该任务按照10秒的延迟重试超过5次.&#8221;retries&#8221;和&#8221;delay&#8221;的默认值分别是3和5.</p>
<p>该任务返回最后一个任务返回的结果.单次重试的结果可以使用-vv选项来查看.
被注册的变量会有一个新的属性&#8217;attempts&#8217;,值为该任务重试的次数.</p>
</div>
<div class="section" id="with-first-found">
<span id="id10"></span><h4><a class="toc-backref" href="#id27">查找第一个匹配的文件</a><a class="headerlink" href="#with-first-found" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个不常见的使用方式,但为了文档完整性我们还是把它写出来.你可能不会经常使用这种方式.</p>
</div>
<p>这其实不是一个循环,但和循环很相似.如果你想引用一个文件,而该文件是从一组文件中根据给定条件匹配出来的.这组文件中部分文件名由变量拼接而成.针对该场景你可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: INTERFACES <span class="p">|</span> Create Ansible header <span class="k">for</span> /etc/network/interfaces
  template: <span class="nv">src</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
  with_first_found:
    - <span class="s2">&quot;{{ansible_virtualization_type}}_foo.conf&quot;</span>
    - <span class="s2">&quot;default_foo.conf&quot;</span>
</pre></div>
</div>
<p>该功能还有一个更完整的版本,可以配置搜索路径.请看以下示例:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: some configuration template
  template: <span class="nv">src</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">dest</span><span class="o">=</span>/etc/file.cfg <span class="nv">mode</span><span class="o">=</span><span class="m">0444</span> <span class="nv">owner</span><span class="o">=</span>root <span class="nv">group</span><span class="o">=</span>root
  with_first_found:
    - files:
       - <span class="s2">&quot;{{inventory_hostname}}/etc/file.cfg&quot;</span>
      paths:
       - ../../../templates.overwrites
       - ../../../templates
    - files:
        - etc/file.cfg
      paths:
        - templates
</pre></div>
</div>
</div>
<div class="section" id="looping-over-the-results-of-a-program-execution">
<span id="id11"></span><h4><a class="toc-backref" href="#id28">迭代程序的执行结果</a><a class="headerlink" href="#looping-over-the-results-of-a-program-execution" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个不常见的使用方式,但为了文档完整性我们还是把它写出来.你可能不会经常使用这种方式.</p>
</div>
<p>有时你想执行一个程序,而且按行循环该程序的输出.Ansible提供了一个优雅的方式来实现这一点.但请记住,该功能始终在控制机上执行,而不是本地机器:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: Example of looping over a <span class="nb">command </span>result
  shell: /usr/bin/frobnicate <span class="o">{{</span> item <span class="o">}}</span>
  with_lines: /usr/bin/frobnications_per_host --param <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
</pre></div>
</div>
<p>好吧,这好像有点随意.事实上,如果你在做一些与inventory有关的事情,比如你想编写一个动态的inventory源(参见 <a class="reference internal" href="index.html#document-docs/intro_dynamic_inventory"><em>动态 Inventory</em></a>),那么借助该功能能够快速实现.</p>
<p>如果你想远程执行命令,那么以上方法则不行.但你可以这样写:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: Example of looping over a REMOTE <span class="nb">command </span>result
  shell: /usr/bin/something
  register: command_result

- name: Do something with each result
  shell: /usr/bin/something_else --param <span class="o">{{</span> item <span class="o">}}</span>
  with_items: <span class="s2">&quot;{{command_result.stdout_lines}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="indexed-lists">
<span id="id12"></span><h4><a class="toc-backref" href="#id29">使用索引循环列表</a><a class="headerlink" href="#indexed-lists" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个不常见的使用方式,但为了文档完整性我们还是把它写出来.你可能不会经常使用这种方式.</p>
</div>
<p>如果你想循环一个列表,同时得到一个数字索引来标明你当前处于列表什么位置,那么你可以这样做.虽然该方法不太常用:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: indexed loop demo
  debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;at array position {{ item.0 }} there is a value {{ item.1 }}&quot;</span>
  with_indexed_items: <span class="s2">&quot;{{some_list}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-ini-with-a-loop">
<span id="id13"></span><h4><a class="toc-backref" href="#id30">循环配置文件</a><a class="headerlink" href="#using-ini-with-a-loop" title="Permalink to this headline">¶</a></h4>
<p>ini插件可以使用正则表达式来获取一组键值对.因此,我们可以遍历该集合.以下是我们使用的ini文件:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>section1<span class="o">]</span>
<span class="nv">value1</span><span class="o">=</span>section1/value1
<span class="nv">value2</span><span class="o">=</span>section1/value2

<span class="o">[</span>section2<span class="o">]</span>
<span class="nv">value1</span><span class="o">=</span>section2/value1
<span class="nv">value2</span><span class="o">=</span>section2/value2
</pre></div>
</div>
<p>以下是使用 <code class="docutils literal"><span class="pre">with_ini</span></code> 的例子:</p>
<div class="highlight-bash"><div class="highlight"><pre>- debug: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;{{item}}&quot;</span>
  with_ini: value<span class="o">[</span>1-2<span class="o">]</span> <span class="nv">section</span><span class="o">=</span>section1 <span class="nv">file</span><span class="o">=</span>lookup.ini <span class="nv">re</span><span class="o">=</span><span class="nb">true</span>
</pre></div>
</div>
<p>以下是返回的值:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
      <span class="s2">&quot;changed&quot;</span>: <span class="nb">false</span>,
      <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;All items completed&quot;</span>,
      <span class="s2">&quot;results&quot;</span>: <span class="o">[</span>
          <span class="o">{</span>
              <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                  <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;msg=\&quot;section1/value1\&quot;&quot;</span>,
                  <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;debug&quot;</span>
              <span class="o">}</span>,
              <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;section1/value1&quot;</span>,
              <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;section1/value1&quot;</span>,
              <span class="s2">&quot;verbose_always&quot;</span>: <span class="nb">true</span>
          <span class="o">}</span>,
          <span class="o">{</span>
              <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                  <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;msg=\&quot;section1/value2\&quot;&quot;</span>,
                  <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;debug&quot;</span>
              <span class="o">}</span>,
              <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;section1/value2&quot;</span>,
              <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;section1/value2&quot;</span>,
              <span class="s2">&quot;verbose_always&quot;</span>: <span class="nb">true</span>
          <span class="o">}</span>
      <span class="o">]</span>
  <span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="flattening-a-list">
<span id="id14"></span><h4><a class="toc-backref" href="#id31">扁平化列表</a><a class="headerlink" href="#flattening-a-list" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个不常见的使用方式,但为了文档完整性我们还是把它写出来.你可能不会经常使用这种方式.</p>
</div>
<p>在罕见的情况下,你可能有几组列表,列表中会嵌套列表.而你只是想迭代所有列表中的每个元素.比如有一个非常疯狂的假定的数据结构:</p>
<div class="highlight-bash"><div class="highlight"><pre>----
<span class="c"># file: roles/foo/vars/main.yml</span>
packages_base:
  - <span class="o">[</span> <span class="s1">&#39;foo-package&#39;</span>, <span class="s1">&#39;bar-package&#39;</span> <span class="o">]</span>
packages_apps:
  - <span class="o">[</span> <span class="o">[</span><span class="s1">&#39;one-package&#39;</span>, <span class="s1">&#39;two-package&#39;</span> <span class="o">]]</span>
  - <span class="o">[</span> <span class="o">[</span><span class="s1">&#39;red-package&#39;</span><span class="o">]</span>, <span class="o">[</span><span class="s1">&#39;blue-package&#39;</span><span class="o">]]</span>
</pre></div>
</div>
<p>你可以看到列表中的包到处都是.那么如果想安装两个列表中的所有包那?:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: flattened loop demo
  yum: <span class="nv">name</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>installed
  with_flattened:
     - packages_base
     - packages_apps
</pre></div>
</div>
<p>这就行了！</p>
</div>
<div class="section" id="using-register-with-a-loop">
<span id="id15"></span><h4><a class="toc-backref" href="#id32">循环中使用注册器</a><a class="headerlink" href="#using-register-with-a-loop" title="Permalink to this headline">¶</a></h4>
<p>当对处于循环中的某个数据结构使用 <code class="docutils literal"><span class="pre">register</span></code> 来注册变量时,结果包含一个 <code class="docutils literal"><span class="pre">results</span></code> 属性,这是从模块中得到的所有响应的一个列表.</p>
<p>以下是在 <code class="docutils literal"><span class="pre">with_items</span></code> 中使用 <code class="docutils literal"><span class="pre">register</span></code> 的示例:</p>
<div class="highlight-bash"><div class="highlight"><pre>- shell: <span class="nb">echo</span> <span class="s2">&quot;{{ item }}&quot;</span>
  with_items:
    - one
    - two
  register: <span class="nb">echo</span>
</pre></div>
</div>
<p>返回的数据结构如下,与非循环结构中使用 <code class="docutils literal"><span class="pre">register</span></code> 的返回结果是不同的:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
    <span class="s2">&quot;changed&quot;</span>: <span class="nb">true</span>,
    <span class="s2">&quot;msg&quot;</span>: <span class="s2">&quot;All items completed&quot;</span>,
    <span class="s2">&quot;results&quot;</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">&quot;changed&quot;</span>: <span class="nb">true</span>,
            <span class="s2">&quot;cmd&quot;</span>: <span class="s2">&quot;echo \&quot;one\&quot; &quot;</span>,
            <span class="s2">&quot;delta&quot;</span>: <span class="s2">&quot;0:00:00.003110&quot;</span>,
            <span class="s2">&quot;end&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.187153&quot;</span>,
            <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;echo \&quot;one\&quot;&quot;</span>,
                <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;shell&quot;</span>
            <span class="o">}</span>,
            <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;one&quot;</span>,
            <span class="s2">&quot;rc&quot;</span>: 0,
            <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.184043&quot;</span>,
            <span class="s2">&quot;stderr&quot;</span>: <span class="s2">&quot;&quot;</span>,
            <span class="s2">&quot;stdout&quot;</span>: <span class="s2">&quot;one&quot;</span>
        <span class="o">}</span>,
        <span class="o">{</span>
            <span class="s2">&quot;changed&quot;</span>: <span class="nb">true</span>,
            <span class="s2">&quot;cmd&quot;</span>: <span class="s2">&quot;echo \&quot;two\&quot; &quot;</span>,
            <span class="s2">&quot;delta&quot;</span>: <span class="s2">&quot;0:00:00.002920&quot;</span>,
            <span class="s2">&quot;end&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.245502&quot;</span>,
            <span class="s2">&quot;invocation&quot;</span>: <span class="o">{</span>
                <span class="s2">&quot;module_args&quot;</span>: <span class="s2">&quot;echo \&quot;two\&quot;&quot;</span>,
                <span class="s2">&quot;module_name&quot;</span>: <span class="s2">&quot;shell&quot;</span>
            <span class="o">}</span>,
            <span class="s2">&quot;item&quot;</span>: <span class="s2">&quot;two&quot;</span>,
            <span class="s2">&quot;rc&quot;</span>: 0,
            <span class="s2">&quot;start&quot;</span>: <span class="s2">&quot;2013-12-19 12:00:05.242582&quot;</span>,
            <span class="s2">&quot;stderr&quot;</span>: <span class="s2">&quot;&quot;</span>,
            <span class="s2">&quot;stdout&quot;</span>: <span class="s2">&quot;two&quot;</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<p>随后的任务可以用以下方式来循环注册变量,用来检查结果值:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: Fail <span class="k">if</span> <span class="k">return</span> code is not 0
  fail:
    msg: <span class="s2">&quot;The command ({{ item.cmd }}) did not have a 0 return code&quot;</span>
  when: item.rc !<span class="o">=</span> 0
  with_items: <span class="s2">&quot;{{echo.results}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-your-own-iterators">
<span id="id16"></span><h4><a class="toc-backref" href="#id33">自定义迭代</a><a class="headerlink" href="#writing-your-own-iterators" title="Permalink to this headline">¶</a></h4>
<p>虽然你通常无需自定义实现自己的迭代,但如果你想按你自己的方式来循环任意数据结构,你可以阅读:doc:<cite>developing_plugins</cite> 来作为开始.以上的每个功能都以插件的方式来实现,所以有很多的实现可供引用.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_best_practices"></span><div class="section" id="id1">
<h3><a class="toc-backref" href="#id9">最佳实践</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>这里有些给使用和编写 Ansible playbook 的贴士.</p>
<p>你能在我们的 <a class="reference external" href="https://github.com/ansible/ansible-examples">ansible-example repository</a>.找到展示这些最佳实践的 playbook 样例.(注意: 这些示例用的也许不是最新版的中所有特性,但它们仍旧是极佳的参考.)</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id9">最佳实践</a><ul>
<li><a class="reference internal" href="#content-organization" id="id10">Content Organization</a><ul>
<li><a class="reference internal" href="#directory-layout" id="id11">Directory Layout</a></li>
<li><a class="reference internal" href="#use-dynamic-inventory-with-clouds" id="id12">Use Dynamic Inventory With Clouds</a></li>
<li><a class="reference internal" href="#how-to-differentiate-stage-vs-production" id="id13">How to Differentiate  Stage vs Production</a></li>
<li><a class="reference internal" href="#group-and-host-variables" id="id14">Group And Host Variables</a></li>
<li><a class="reference internal" href="#top-level-playbooks-are-separated-by-role" id="id15">Top Level Playbooks Are Separated By Role</a></li>
<li><a class="reference internal" href="#task-and-handler-organization-for-a-role" id="id16">Task And Handler Organization For A Role</a></li>
<li><a class="reference internal" href="#what-this-organization-enables-examples" id="id17">What This Organization Enables (Examples)</a></li>
<li><a class="reference internal" href="#deployment-vs-configuration-organization" id="id18">Deployment vs Configuration Organization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#stage-vs-production" id="id19">Stage vs Production</a></li>
<li><a class="reference internal" href="#rolling-updates" id="id20">Rolling Updates</a></li>
<li><a class="reference internal" href="#always-mention-the-state" id="id21">Always Mention The State</a></li>
<li><a class="reference internal" href="#group-by-roles" id="id22">Group By Roles</a></li>
<li><a class="reference internal" href="#operating-system-and-distribution-variance" id="id23">Operating System and Distribution Variance</a></li>
<li><a class="reference internal" href="#bundling-ansible-modules-with-playbooks" id="id24">Bundling Ansible Modules With Playbooks</a></li>
<li><a class="reference internal" href="#whitespace-and-comments" id="id25">Whitespace and Comments</a></li>
<li><a class="reference internal" href="#always-name-tasks" id="id26">Always Name Tasks</a></li>
<li><a class="reference internal" href="#keep-it-simple" id="id27">Keep It Simple</a></li>
<li><a class="reference internal" href="#version-control" id="id28">Version Control</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="content-organization">
<span id="id2"></span><h4><a class="toc-backref" href="#id10">Content Organization</a><a class="headerlink" href="#content-organization" title="Permalink to this headline">¶</a></h4>
<p>接下来的章节将向你展示一种组织 playbook 内容方式.</p>
<p>你对 Ansible 的使用应该符合你的需求而不是我们的,所以请随意根据你的需求来组织修改接下来的示例.</p>
<p>有件事绝对是你想要做的,那就是使用 &#8220;roles&#8221; 组织特性.它作为主要的 playbook 的主要部分被文档化.详情参见 <a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a>. 你绝对应该使用 roles.
roles 是极好的. 快去使用 roles！ roles！ 重要的事情要重复说！roles 是极好的.(译者:..老外也知道重要的事情重复三遍啊！~~~)</p>
<div class="section" id="directory-layout">
<span id="id3"></span><h5><a class="toc-backref" href="#id11">Directory Layout</a><a class="headerlink" href="#directory-layout" title="Permalink to this headline">¶</a></h5>
<p>顶层目录结构应当包括下列文件和目录:</p>
<div class="highlight-bash"><div class="highlight"><pre>production                <span class="c"># inventory file for production servers 关于生产环境服务器的清单文件</span>
stage                     <span class="c"># inventory file for stage environment 关于 stage 环境的清单文件</span>

group_vars/
   group1                 <span class="c"># here we assign variables to particular groups 这里我们给特定的组赋值</span>
   group2                 <span class="c"># &quot;&quot;</span>
host_vars/
   hostname1              <span class="c"># if systems need specific variables, put them here 如果系统需要特定的变量,把它们放置在这里.</span>
   hostname2              <span class="c"># &quot;&quot;</span>

library/                  <span class="c"># if any custom modules, put them here (optional) 如果有自定义的模块,放在这里(可选)</span>
filter_plugins/           <span class="c"># if any custom filter plugins, put them here (optional) 如果有自定义的过滤插件,放在这里(可选)</span>

site.yml                  <span class="c"># master playbook 主 playbook</span>
webservers.yml            <span class="c"># playbook for webserver tier Web 服务器的 playbook</span>
dbservers.yml             <span class="c"># playbook for dbserver tier 数据库服务器的 playbook</span>

roles/
    common/               <span class="c"># this hierarchy represents a &quot;role&quot; 这里的结构代表了一个 &quot;role&quot;</span>
        tasks/            <span class="c">#</span>
            main.yml      <span class="c">#  &lt;-- tasks file can include smaller files if warranted</span>
        handlers/         <span class="c">#</span>
            main.yml      <span class="c">#  &lt;-- handlers file</span>
        templates/        <span class="c">#  &lt;-- files for use with the template resource</span>
            ntp.conf.j2   <span class="c">#  &lt;------- templates end in .j2</span>
        files/            <span class="c">#</span>
            bar.txt       <span class="c">#  &lt;-- files for use with the copy resource</span>
            foo.sh        <span class="c">#  &lt;-- script files for use with the script resource</span>
        vars/             <span class="c">#</span>
            main.yml      <span class="c">#  &lt;-- variables associated with this role</span>
        defaults/         <span class="c">#</span>
            main.yml      <span class="c">#  &lt;-- default lower priority variables for this role</span>
        meta/             <span class="c">#</span>
            main.yml      <span class="c">#  &lt;-- role dependencies</span>

    webtier/              <span class="c"># same kind of structure as &quot;common&quot; was above, done for the webtier role</span>
    monitoring/           <span class="c"># &quot;&quot;</span>
    fooapp/               <span class="c"># &quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="use-dynamic-inventory-with-clouds">
<span id="id4"></span><h5><a class="toc-backref" href="#id12">Use Dynamic Inventory With Clouds</a><a class="headerlink" href="#use-dynamic-inventory-with-clouds" title="Permalink to this headline">¶</a></h5>
<p>如果你正在使用云服务,你不应该在一个静态文件管理你的清单.详见 <a class="reference internal" href="index.html#document-docs/intro_dynamic_inventory"><em>动态 Inventory</em></a>.</p>
<p>这不仅适用于云环境 &#8211; 如果你的基础设施中还有其他系统维护着一系列标准系统,使用 动态清单 会是个好主意.</p>
</div>
<div class="section" id="how-to-differentiate-stage-vs-production">
<span id="stage-vs-prod"></span><h5><a class="toc-backref" href="#id13">How to Differentiate  Stage vs Production</a><a class="headerlink" href="#how-to-differentiate-stage-vs-production" title="Permalink to this headline">¶</a></h5>
<p>If managing static inventory, it is frequently asked how to differentiate different types of environments.  The following example
shows a good way to do this.  Similar methods of grouping could be adapted to dynamic inventory (for instance, consider applying the AWS
tag &#8220;environment:production&#8221;, and you&#8217;ll get a group of systems automatically discovered named &#8220;ec2_tag_environment_production&#8221;.</p>
<p>如果你管理着静态清单,如何区分不同的环境类型是个常见的问题.接下来的示例会做一个很好地说明.</p>
<p>Let&#8217;s show a static inventory example though.  Below, the <em>production</em> file contains the inventory of all of your production hosts.</p>
<p>It is suggested that you define groups based on purpose of the host (roles) and also geography or datacenter location (if applicable):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># file: production</span>

<span class="o">[</span>atlanta-webservers<span class="o">]</span>
www-atl-1.example.com
www-atl-2.example.com

<span class="o">[</span>boston-webservers<span class="o">]</span>
www-bos-1.example.com
www-bos-2.example.com

<span class="o">[</span>atlanta-dbservers<span class="o">]</span>
db-atl-1.example.com
db-atl-2.example.com

<span class="o">[</span>boston-dbservers<span class="o">]</span>
db-bos-1.example.com

<span class="c"># webservers in all geos</span>
<span class="o">[</span>webservers:children<span class="o">]</span>
atlanta-webservers
boston-webservers

<span class="c"># dbservers in all geos</span>
<span class="o">[</span>dbservers:children<span class="o">]</span>
atlanta-dbservers
boston-dbservers

<span class="c"># everything in the atlanta geo</span>
<span class="o">[</span>atlanta:children<span class="o">]</span>
atlanta-webservers
atlanta-dbservers

<span class="c"># everything in the boston geo</span>
<span class="o">[</span>boston:children<span class="o">]</span>
boston-webservers
boston-dbservers
</pre></div>
</div>
</div>
<div class="section" id="group-and-host-variables">
<span id="groups-and-hosts"></span><h5><a class="toc-backref" href="#id14">Group And Host Variables</a><a class="headerlink" href="#group-and-host-variables" title="Permalink to this headline">¶</a></h5>
<p>本章节内容基于前一章节示例.</p>
<p>分组有利于组织结构,但不是所有的分组都是有益的.你也可以给他们赋值!比如说亚特兰大有它自己的网络时间协议,
所以当配置 ntp.conf 时,我们就该使用它.让我们现在设置它们:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: group_vars/atlanta</span>
ntp: ntp-atlanta.example.com
backup: backup-atlanta.example.com
</pre></div>
</div>
<p>Variables aren&#8217;t just for geographic information either!  Maybe the webservers have some configuration that doesn&#8217;t make sense for the database servers:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: group_vars/webservers</span>
apacheMaxRequestsPerChild: 3000
apacheMaxClients: 900
</pre></div>
</div>
<p>If we had any default values, or values that were universally true, we would put them in a file called group_vars/all:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: group_vars/all</span>
ntp: ntp-boston.example.com
backup: backup-boston.example.com
</pre></div>
</div>
<p>We can define specific hardware variance in systems in a host_vars file, but avoid doing this unless you need to:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: host_vars/db-bos-1.example.com</span>
foo_agent_port: 86
bar_agent_port: 99
</pre></div>
</div>
<p>Again, if we are using dynamic inventory sources, many dynamic groups are automatically created.  So a tag like &#8220;class:webserver&#8221; would load in
variables from the file &#8220;group_vars/ec2_tag_class_webserver&#8221; automatically.</p>
</div>
<div class="section" id="top-level-playbooks-are-separated-by-role">
<span id="split-by-role"></span><h5><a class="toc-backref" href="#id15">Top Level Playbooks Are Separated By Role</a><a class="headerlink" href="#top-level-playbooks-are-separated-by-role" title="Permalink to this headline">¶</a></h5>
<p>在 site.yml 中,我们包含了一个定义了整个基础设施的 playbook.注意这个 playbook 是非常短的,
因为它仅仅包含了其他 playbooks.记住, playbook 不过就是一系列的 <cite>plays</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: site.yml</span>
- include: webservers.yml
- include: dbservers.yml
</pre></div>
</div>
<p>在诸如 like webservers.yml 的文件中(同样也在顶层结构),我们仅仅将 Web 服务器组与对应的 role 行为做映射.同样值得注意的是这也非常的短小精悍.例如:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: webservers.yml</span>
- hosts: webservers
  roles:
    - common
    - webtier
</pre></div>
</div>
<p>理念是我们能够通过 &#8220;运行&#8221;(running) site.yml 来选择整个基础设施的配置.或者我们能够通过运行其子集 webservers.yml 来配置.
这与 Ansible 的 &#8220;&#8211;limit&#8221; 类似,而且相对的更为显式:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook site.yml --limit webservers
ansible-playbook webservers.yml
</pre></div>
</div>
</div>
<div class="section" id="task-and-handler-organization-for-a-role">
<span id="role-organization"></span><h5><a class="toc-backref" href="#id16">Task And Handler Organization For A Role</a><a class="headerlink" href="#task-and-handler-organization-for-a-role" title="Permalink to this headline">¶</a></h5>
<p>接下来的示例任务文件展示了一个 role 是如何工作的.我们这里的普通 role 仅仅用来配置 NTP,但是如果我们想的话,它可以做更多:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: roles/common/tasks/main.yml</span>

- name: be sure ntp is installed
  yum: <span class="nv">pkg</span><span class="o">=</span>ntp <span class="nv">state</span><span class="o">=</span>installed
  tags: ntp

- name: be sure ntp is configured
  template: <span class="nv">src</span><span class="o">=</span>ntp.conf.j2 <span class="nv">dest</span><span class="o">=</span>/etc/ntp.conf
  notify:
    - restart ntpd
  tags: ntp

- name: be sure ntpd is running and enabled
  service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>running <span class="nv">enabled</span><span class="o">=</span>yes
  tags: ntp
</pre></div>
</div>
<p>这是个处理文件样例.作为一种审核,它只有当特定的任务报告发生变化时会被触发,并在每个 play 结束时运行:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: roles/common/handlers/main.yml</span>
- name: restart ntpd
  service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>restarted
</pre></div>
</div>
<p>详情请参阅 <a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a>.</p>
</div>
<div class="section" id="what-this-organization-enables-examples">
<span id="organization-examples"></span><h5><a class="toc-backref" href="#id17">What This Organization Enables (Examples)</a><a class="headerlink" href="#what-this-organization-enables-examples" title="Permalink to this headline">¶</a></h5>
<p>我们在前文分享了我们基础的组织结构.</p>
<p>那这种结构适用于何种应用场景？ 很多！若我想重新配置整个基础设施,如此即可:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook -i production site.yml
</pre></div>
</div>
<p>那只重新配置所有的 NTP 呢？太容易了.:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook -i production site.yml --tags ntp
</pre></div>
</div>
<p>只重新配置我的 Web 服务器呢？:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook -i production webservers.yml
</pre></div>
</div>
<p>只重新配置我在波士顿的 Web服务器呢?:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook -i production webservers.yml --limit boston
</pre></div>
</div>
<p>前10台 和 接下来的10台呢？</p>
<blockquote>
<div>ansible-playbook -i production webservers.yml &#8211;limit boston[0-10]
ansible-playbook -i production webservers.yml &#8211;limit boston[10-20]</div></blockquote>
<p>当然,只使用基础的 ad-hoc 也是 OK 的啦.:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible boston -i production -m ping
ansible boston -i production -m <span class="nb">command</span> -a <span class="s1">&#39;/sbin/reboot&#39;</span>
</pre></div>
</div>
<p>这里还有些有用的命令你需要知道(版本至少 1.1 或更高):</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># confirm what task names would be run if I ran this command and said &quot;just ntp tasks&quot;</span>
ansible-playbook -i production webservers.yml --tags ntp --list-tasks

<span class="c"># confirm what hostnames might be communicated with if I said &quot;limit to boston&quot;</span>
ansible-playbook -i production webservers.yml --limit boston --list-hosts
</pre></div>
</div>
</div>
<div class="section" id="deployment-vs-configuration-organization">
<span id="dep-vs-config"></span><h5><a class="toc-backref" href="#id18">Deployment vs Configuration Organization</a><a class="headerlink" href="#deployment-vs-configuration-organization" title="Permalink to this headline">¶</a></h5>
<p>The above setup models a typical configuration topology.  When doing multi-tier deployments, there are going
to be some additional playbooks that hop between tiers to roll out an application.  In this case, &#8216;site.yml&#8217;
may be augmented by playbooks like &#8216;deploy_exampledotcom.yml&#8217; but the general concepts can still apply.</p>
<p>Consider &#8220;playbooks&#8221; as a sports metaphor &#8211; you don&#8217;t have to just have one set of plays to use against your infrastructure
all the time &#8211; you can have situational plays that you use at different times and for different purposes.</p>
<p>Ansible allows you to deploy and configure using the same tool, so you would likely reuse groups and just
keep the OS configuration in separate playbooks from the app deployment.</p>
</div>
</div>
<div class="section" id="stage-vs-production">
<span id="id5"></span><h4><a class="toc-backref" href="#id19">Stage vs Production</a><a class="headerlink" href="#stage-vs-production" title="Permalink to this headline">¶</a></h4>
<p>如前所述,通过使用不同的清单文件来分离你的 stage 和 生产环境是个好方法.你可以通过 -i 来指定.把它们放在同一个文件中会有惊喜哦！
在部署到生产环境之前,先在 stage 环境中做测试是个好主意.你的环境不必保持同样的大小,你可以通过 分组变量来对不同的环境进行控制.</p>
</div>
<div class="section" id="rolling-updates">
<span id="rolling-update"></span><h4><a class="toc-backref" href="#id20">Rolling Updates</a><a class="headerlink" href="#rolling-updates" title="Permalink to this headline">¶</a></h4>
<p>请理解 &#8216;serial&#8217; 关键字.你会在批量升级中使用它来控制升级机器的数量.</p>
<p>See <a class="reference internal" href="index.html#document-docs/playbooks_delegation"><em>委托,滚动更新,本地动作</em></a>.</p>
</div>
<div class="section" id="always-mention-the-state">
<span id="mention-the-state"></span><h4><a class="toc-backref" href="#id21">Always Mention The State</a><a class="headerlink" href="#always-mention-the-state" title="Permalink to this headline">¶</a></h4>
<p>parameter in your playbooks to make it clear, especially as some modules support additional states.
对于很多模块来说 &#8216;state&#8217; 参数是可选的.无论是 &#8216;state=present&#8217; 亦或 &#8216;state=absent&#8217; ,你最好在 playbook 中显式指定该参数,毕竟有些模块是支持附加的 &#8216;state&#8217; 参数.</p>
</div>
<div class="section" id="group-by-roles">
<span id="id6"></span><h4><a class="toc-backref" href="#id22">Group By Roles</a><a class="headerlink" href="#group-by-roles" title="Permalink to this headline">¶</a></h4>
<p>在这条贴士中,我们某种程度上在重复自己,但这是值得的.一个系统可能被分成多分组.详情请查阅 <a class="reference internal" href="index.html#document-docs/intro_inventory"><em>Inventory文件</em></a> 和 <a class="reference internal" href="index.html#document-docs/intro_patterns"><em>Patterns</em></a>.
在样例中,分组名之后的 <em>webservers</em> 和 <em>dbservers</em> ,它们因为是很重要的概念所以反复出现.(译者:恩,重要的事情要重复三遍！)一个系统可以出现在多个分组中.</p>
<p>通过给 role 赋予特定的变量,这允许 playbooks 能基于角色来锁定机器.</p>
<p>See <a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a>.</p>
</div>
<div class="section" id="operating-system-and-distribution-variance">
<span id="os-variance"></span><h4><a class="toc-backref" href="#id23">Operating System and Distribution Variance</a><a class="headerlink" href="#operating-system-and-distribution-variance" title="Permalink to this headline">¶</a></h4>
<p>当处理在不同操作系统间参数值不同的参数时,使用 group_by 模块是个好主意.</p>
<p>这使宿主机的动态分组有了匹配的标准,即使该分组尚未在清单文件中被定义</p>
<div class="highlight-bash"><div class="highlight"><pre>---

<span class="c"># talk to all hosts just so we can learn about them</span>
- hosts: all
  tasks:
     - group_by: <span class="nv">key</span><span class="o">=</span>os_<span class="o">{{</span> ansible_distribution <span class="o">}}</span>

<span class="c"># now just on the CentOS hosts...</span>

- hosts: os_CentOS
  gather_facts: False
  tasks:
     - <span class="c"># tasks that only happen on CentOS go here</span>
</pre></div>
</div>
<p>这会抛出所有基于操作系统名的分组.</p>
<p>如果需要对特定分组做设定,这也是可以的.例:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: group_vars/all</span>
asdf: 10

---
<span class="c"># file: group_vars/os_CentOS</span>
asdf: 42
</pre></div>
</div>
<p>在上述的例子中, CentOS 的机器获取的 asdf 的值为 42,但其他机器获得是 &#8216;10&#8217;.这不止可以用于设置变量,也可以将特定的 role 应用于特定的操作系统.</p>
<p>相对的,如果只需要变量:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: all
  tasks:
    - include_vars: <span class="s2">&quot;os_{{ ansible_distribution }}.yml&quot;</span>
    - debug: <span class="nv">var</span><span class="o">=</span>asdf
</pre></div>
</div>
<p>这将根据操作系统名来拉取相应的值.</p>
</div>
<div class="section" id="bundling-ansible-modules-with-playbooks">
<span id="ship-modules-with-playbooks"></span><h4><a class="toc-backref" href="#id24">Bundling Ansible Modules With Playbooks</a><a class="headerlink" href="#bundling-ansible-modules-with-playbooks" title="Permalink to this headline">¶</a></h4>
<p>如果一个 playbook 有一个与它 YMAL 文件相关的 &#8221;./library&#8221; 目录,该目录可以用于添加 Ansible 模块,它会被自动添加到 Ansible 模块的路径中.这是一个将
playbook 与其模块放置在一起的方式.如下面的目录结构样例所展示:</p>
<div class="highlight-bash"><div class="highlight"><pre>.. _whitespace:
</pre></div>
</div>
</div>
<div class="section" id="whitespace-and-comments">
<h4><a class="toc-backref" href="#id25">Whitespace and Comments</a><a class="headerlink" href="#whitespace-and-comments" title="Permalink to this headline">¶</a></h4>
<p>鼓励使用空格来分隔内容,用 &#8216;#&#8217; 来写注释.</p>
</div>
<div class="section" id="always-name-tasks">
<span id="name-tasks"></span><h4><a class="toc-backref" href="#id26">Always Name Tasks</a><a class="headerlink" href="#always-name-tasks" title="Permalink to this headline">¶</a></h4>
<p>虽然推荐提供关于为什么要这么做的描述,但是直接给一个给定任务命名也是可以的.名字会在 playbook 运行时显示.</p>
</div>
<div class="section" id="keep-it-simple">
<span id="id7"></span><h4><a class="toc-backref" href="#id27">Keep It Simple</a><a class="headerlink" href="#keep-it-simple" title="Permalink to this headline">¶</a></h4>
<p>当你能简单的搞定某事时,就简单的搞定.不要试图一次性使用 Ansible 的所有的特性.仅仅使用对你有用的即可.
比如说你基本上不会需要一次性使用 <code class="docutils literal"><span class="pre">vars</span></code> , <code class="docutils literal"><span class="pre">vars_files</span></code> , <code class="docutils literal"><span class="pre">vars_prompt</span></code> 和 <code class="docutils literal"><span class="pre">--extra-vars</span></code> 同时还是用一个外部的节点配置文件.</p>
<p>如果你感觉任务很复杂时,它可能真的很复杂,这也许是个简化它的好机会.</p>
</div>
<div class="section" id="version-control">
<span id="id8"></span><h4><a class="toc-backref" href="#id28">Version Control</a><a class="headerlink" href="#version-control" title="Permalink to this headline">¶</a></h4>
<p>请使用版本控制.保持你的 playbook 和 清单文件 在 git(或其他版本控制系统)中,并将你的修改做提交.
这样你就有审计轨迹来描述什么时候以及为什么你做了这样的修改.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/YAMLSyntax"><em>YAML 语法</em></a></dt>
<dd>Learn about YAML syntax</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Review the basic playbook features</dd>
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>Learn how to extend Ansible by writing your own modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/intro_patterns"><em>Patterns</em></a></dt>
<dd>Learn about how to select hosts</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible/tree/devel/examples/playbooks">GitHub examples directory</a></dt>
<dd>Complete playbook files from the github project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<span id="document-docs/playbooks_special_topics"></span><div class="section" id="playbooks-special-topics">
<h2>Playbooks: Special Topics<a class="headerlink" href="#playbooks-special-topics" title="Permalink to this headline">¶</a></h2>
<p>这里的一些 playbook 特性可能不是每个人都需要学习的,但是它们对于一些特定的应用来说是相当有用的.推荐你浏览这些主题,你也许能在其中发现有用的贴士.
但请先学习 Ansible 的基础知识,并仅在他们对你的环境看似有关或有用时再采用.</p>
<div class="toctree-wrapper compound">
<span id="document-docs/playbooks_acceleration"></span><div class="section" id="accelerated-mode">
<h3>Accelerated Mode<a class="headerlink" href="#accelerated-mode" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<div class="section" id="id1">
<h4>你也许不需要这个！<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>你在使用 Ansible 1.5 或者 之后的版本吗？ 如果是的话,因为被称之为 &#8220;SSH pipelining&#8221; 的新特性,你也许就不需要加速模式了.详情请阅读:ref:<cite>pipelining</cite> 部分的章节.</p>
<p>对于使用 1.5 及之后版本的用户,加速模式只在以下情况下有用处: (A) 管理红帽企业版 Linux 6 或者更早的那些依然使用 paramiko 的版本 或者 (B) 像在文档中描述的那样:无法在 TTYs 中使用 sudo.</p>
<p>如果你能够使用pipelining,Ansible 将会降低通过 wire 传输文件的总量来提升有效率,并且在几乎所有情况下（甚至可能包括了传输大型文件）都能与加速模式相匹敌.归功于更少的移动文件块,管道几乎在所有的情况下优于加速模式.</p>
<p>加速模式将为了支持那些仍使用红帽企业版 Linux 6 做主控机或因其他环境因素受限制而保留.</p>
</div>
<div class="section" id="id2">
<h4>加速模式详解<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>尽管 OpenSSH 使用的 ControlPersist 特性既快速又可伸缩,但这会在 SSH 连接时造成少量的开销.虽然很多人不会遇到这样一个需求,但是如果你当前运行的平台不支持 ControlPersist (如 一台 EL6 control machine),
你大概会对 tuning 选项更感兴趣.</p>
<p>加速模式只是使用来加速连接的,它仍需使用 SSH 来进行初始安全密钥交换.它没有额外增加需要管理的基础设施的公共key,也不需要诸如 NTP 或 DNS.</p>
<p>加速模式在任何情况下将比启用 ControlPersist 特性的 SSH 快2-6倍,10倍于 paramiko.</p>
<p>加速模式通过启动一个临时的 SSH 守护进程来工作.只要这个守护进程在运行,Ansible 将会直接通过 socket 来连接.Ansible 通过在连接时交换临时的 AES key 来确保安全(这个秘钥对每个主机都是不同的并且会定期重新生成).</p>
<p>默认配置下,Ansible 会为加速模式开启5099端口(此配置可修改).一旦运行了,守护进程将会维持连接 30 分钟,过了时限后该连接将会自动终结,你需要重启一个 SSH.</p>
<p>加速模式对它所基于的 fireball 模式(已被废弃)做了许多改进:</p>
<ul class="simple">
<li>不需要 bootstrapping,仅需在你想要运行加速模式的playbook上添加一行代码.</li>
<li>支持 sudo 命令(下文参见详情)</li>
<li>更少的依赖需求.ZeroMQ 不在需要,除了 python-keyczar 外再无其他依赖包需要安装.</li>
<li>Python 版本必须大于等于 2.5</li>
</ul>
<p>只需在你的 play 中添加 <cite>accelerate: true</cite> 即可使用加速模式:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: all
  accelerate: <span class="nb">true</span>

<span class="nb">  </span>tasks:

  - name: some task
    <span class="nb">command</span>: <span class="nb">echo</span> <span class="o">{{</span> item <span class="o">}}</span>
    with_items:
    - foo
    - bar
    - baz
</pre></div>
</div>
<p>如果你希望改变 Ansible 用于加速模式的端口,你只需添加 <cite>accelerated_port</cite> 选项:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: all
  accelerate: <span class="nb">true</span>
  <span class="c"># default port is 5099</span>
  accelerate_port: 10000
</pre></div>
</div>
<p><cite>accelerate_port</cite> 选项也同样能通过指定环境变量 ACCELERATE_PORT 或者在你的 <cite>ansible.cfg</cite> 中配置:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">[</span>accelerate<span class="o">]</span>
<span class="nv">accelerate_port</span> <span class="o">=</span> 5099
</pre></div>
</div>
<p>如先前所述,加速模式同样支持通过 sudo 命令来运行任务.但是有两点需要予以提醒:</p>
<ul class="simple">
<li>你必须移除 sudoers 选项中的 requiretty.</li>
<li>目前仍不支持 sudo 密码提示,所以 NOPASSWD 选项是必须的.</li>
</ul>
<p>如果是 Ansible 版本是 <cite>1.6</cite>,你同样可以允许多个连接多个秘钥来连接多个 Ansible 管理节点.你可以通过在你的 <cite>ansible.cfg</cite> 中添加如下配置:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">accelerate_multi_key</span> <span class="o">=</span> yes
</pre></div>
</div>
<p>当启用时,守护进程将会打开一个 UNIX socket 文件(默认位于 <cite>$ANSIBLE_REMOTE_TEMP/.ansible-accelerate/.local.socket</cite>).来自 SSH 的新的连接能够通过这个 socket 文件来上载新的秘钥给守护进程.</p>
</div>
</div>
<span id="document-docs/playbooks_async"></span><div class="section" id="id1">
<h3>异步操作和轮询<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>默认情况下playbook中的任务执行时会一直保持连接,直到该任务在每个节点都执行完毕.有时这是不必要的,比如有些操作运行时间比SSH超时时间还要长.</p>
<p>解决该问题最简单的方式是一起执行它们,然后轮询直到任务执行完毕.</p>
<p>你也可以对执行时间非常长（有可能遭遇超时）的操作使用异步模式.</p>
<p>为了异步启动一个任务,可以指定其最大超时时间以及轮询其状态的频率.如果你没有为 <cite>poll</cite> 指定值,那么默认的轮询频率是10秒钟:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: all
  remote_user: root

  tasks:

  - name: simulate long running op <span class="o">(</span><span class="m">15</span> sec<span class="o">)</span>, <span class="nb">wait </span><span class="k">for</span> up to <span class="m">45</span> sec, poll every <span class="m">5</span> sec
    <span class="nb">command</span>: /bin/sleep 15
    async: 45
    poll: 5
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><cite>async</cite> 并没有默认值,如果你没有指定 <cite>async</cite> 关键字,那么任务会以同步的方式运行,这是Ansible的默认行为.</p>
</div>
<p>另外,如果你不需要等待任务执行完毕,你可以指定 <cite>poll</cite> 值为0而启用 &#8220;启动并忽略&#8221;</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: all
  remote_user: root

  tasks:

  - name: simulate long running op, allow to run <span class="k">for</span> <span class="m">45</span> sec, fire and forget
    <span class="nb">command</span>: /bin/sleep 15
    async: 45
    poll: 0
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">对于要求排它锁的操作,如果你需要在其之后对同一资源执行其它任务,那么你不应该对该操作使用&#8221;启动并忽略&#8221;.比如yum事务.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">--forks</span></code> 参数值过大会更快的触发异步任务.也会加快轮询的效率.</p>
</div>
<p>当你想对 &#8220;启动并忽略&#8221; 做个变种,改为&#8221;启动并忽略,稍后再检查&#8221;,你可以使用以下方式执行任务:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># Requires ansible 1.8+</span>
- name: <span class="s1">&#39;YUM - fire and forget task&#39;</span>
  yum: <span class="nv">name</span><span class="o">=</span>docker-io <span class="nv">state</span><span class="o">=</span>installed
  async: 1000
  poll: 0
  register: yum_sleeper

- name: <span class="s1">&#39;YUM - check on fire and forget task&#39;</span>
  async_status: <span class="nv">jid</span><span class="o">={{</span> yum_sleeper.ansible_job_id <span class="o">}}</span>
  register: job_result
  <span class="k">until</span>: job_result.finished
  retries: 30
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果 <code class="docutils literal"><span class="pre">async:</span></code> 值太小,可能会导致 &#8220;稍后检查&#8221; 任务执行失败,因为 <code class="docutils literal"><span class="pre">async_status::</span></code> 的临时状态文件还未被写入信息,而&#8221;稍后检查&#8221;任务就试图读取此文件.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-docs/playbooks_checkmode"></span><div class="section" id="check-mode-dry-run">
<h3><a class="toc-backref" href="#id2">Check Mode (&#8220;Dry Run&#8221;)</a><a class="headerlink" href="#check-mode-dry-run" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1.</span></p>
</div>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#check-mode-dry-run" id="id2">Check Mode (&#8220;Dry Run&#8221;)</a><ul>
<li><a class="reference internal" href="#forcing-to-run-in-check-mode" id="id3">在测试模式下运行一个任务.</a></li>
<li><a class="reference internal" href="#showing-differences-with-diff" id="id4">Showing Differences with <code class="docutils literal"><span class="pre">--diff</span></code></a></li>
</ul>
</li>
</ul>
</div>
<p>当以 <code class="docutils literal"><span class="pre">--check</span></code> 参数来运行 ansible-playbook 时,将不会对远程的系统作出任何更改.相对的,任何带有检测功能的模块(这几乎包含了所有的主要核心模块,但这不要求所有的模块都需支持.)
只要支持 &#8216;检测模式&#8217; 将会报告它们会做出什么改变而不是直接进行改变.其他不支持检测模式的模块将既不响应也不提出相应的报告.</p>
<p>检测模式只是一种模拟.如果你的playbook是以先前命令的执行结果作为条件的话,那它可能对你就没有什么大用处了.
但是对于基于一次一节点的基础配置管理的使用情形来说是很有用.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook foo.yml --check
</pre></div>
</div>
<div class="section" id="forcing-to-run-in-check-mode">
<span id="id1"></span><h4><a class="toc-backref" href="#id3">在测试模式下运行一个任务.</a><a class="headerlink" href="#forcing-to-run-in-check-mode" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>有时候你甚至会想在检测模式中执行一个任务.为了达到这样的效果,
你需要在相应的任务上使用 <cite>always_run</cite> 子句.跟 <cite>when</cite> 子句一样,它的值是一个 Jinja2 表达式.
在一个简单的例子中,布尔值也会表达为一个适当的 YAML 值.</p>
<p>Example:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

  - name: this task is run even in check mode
    <span class="nb">command</span>: /something/to/run --even-in-check-mode
    always_run: yes
</pre></div>
</div>
<p>友情提示,带有 <cite>when</cite> 子句的任务会返回false,该任务将会被跳过,即使它还被添加了会返回true的 <cite>always_run</cite> 子句.</p>
</div>
<div class="section" id="showing-differences-with-diff">
<span id="diff-mode"></span><h4><a class="toc-backref" href="#id4">Showing Differences with <code class="docutils literal"><span class="pre">--diff</span></code></a><a class="headerlink" href="#showing-differences-with-diff" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1: </span>对 ansible-playbook 来说 <code class="docutils literal"><span class="pre">--diff</span></code> 选项与 <code class="docutils literal"><span class="pre">--check</span></code> (详情参下)配合使用效果奇佳,不过它也可以单独使用.当提供了相应的标识后,当远程系统上任何模板文件的变化时,ansible-playbook CLI 将会报告文件上任何文本的变化
(或者,如果使用了 <code class="docutils literal"><span class="pre">--check</span></code> 参数,将报告会发生的变化.).因为 diff 特性会产生大量的输出结果,所以它在一次检测一个主机时使用为佳,如:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook foo.yml --check --diff --limit foo.example.com
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-docs/playbooks_delegation"></span><div class="section" id="id1">
<h3><a class="toc-backref" href="#id7">委托,滚动更新,本地动作</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id7">委托,滚动更新,本地动作</a><ul>
<li><a class="reference internal" href="#maximum-failure-percentage" id="id8">最大失败百分比</a></li>
<li><a class="reference internal" href="#delegation" id="id9">委任</a></li>
<li><a class="reference internal" href="#run-once" id="id10">Run Once</a></li>
<li><a class="reference internal" href="#playbooks" id="id11">本地Playbooks</a></li>
</ul>
</li>
</ul>
</div>
<p>由于设计初衷是作为多用户,Anisible很擅长在某一个主机上代表另一个做事,或者参考远程主机做一些本地工作.</p>
<p>这个特性对于架设连续实现某些设施或者0暂停滚动升级,这里你可能会提到负载均衡或者监控系统.</p>
<p>更多的特性允许调试事情完成的顺序,和设置一批窗口,来确定多少机器在一次中滚动更新.</p>
<p>这节会介绍所有这些特性.`详情案例参见 &lt;<a class="reference external" href="http://github.com/ansible/ansible-examples/">http://github.com/ansible/ansible-examples/</a>&gt;`_.这里有很多案例来说明对于不同程序来实行,0暂停更新步骤</p>
<p>你也可以参考:doc:<a href="#id2"><span class="problematic" id="id3">`</span></a>modules`部分,很多模块例如 &#8216;ec2_elb&#8217;, &#8216;nagios&#8217;, &#8216;bigip_pool&#8217;, &#8216;netscaler&#8217; 的一些概念会在这里介绍.</p>
<p>你可能也想参考:doc:<cite>playbooks_roles</cite>,你可以找到类似&#8217;pre_task&#8217;和&#8217;post_task&#8217;的详细介绍和调用方式.</p>
<p id="rolling-update-batch-size">Rolling Update Batch Size
滚动更新批量尺寸
<code class="docutils literal"><span class="pre">`````````````````````</span></code></p>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.</span></p>
</div>
<p>默认来说,Anisble 可以使图参考某一个play来并行操作所有主机.对于滚动更新案例,
你可以定义Ansible可以在一个特定时间同时控制多少主机,使用&#8217;&#8216;serial&#8217;&#8217; 关键词:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: <span class="nb">test </span>play
  hosts: webservers
  serial: 3
</pre></div>
</div>
<p>在上面的例子,如果我们有100台主机,3 台主机定义在组&#8217;webservers&#8217;
可以在下面3个主机开始之前完全完成</p>
<p>这个&#8217;&#8216;serial&#8217;&#8217; 关键词在Ansible 1.8 以后可以被定义为百分数,用来定义每一次操作一个play中百分之多少主机:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: <span class="nb">test </span>play
  hosts: websevers
  serial: <span class="s2">&quot;30%&quot;</span>
</pre></div>
</div>
<p>如果主机数不能被passes数量整除,最后的pass将会包含提醒信息</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">不管多小的百分比,每个pass的主机数一定会大于等于1.</p>
</div>
<div class="section" id="maximum-failure-percentage">
<span id="id4"></span><h4><a class="toc-backref" href="#id8">最大失败百分比</a><a class="headerlink" href="#maximum-failure-percentage" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>默认来说,Ansible 会持续执行行为只要在一个组中还有主机没有宕机.
在有些情况下,例如之前提到的滚动更新,也许理想的情况是当一个失败数上线达到时主动宕掉这个play.为了达到这个目的,在
1.3版本中,你可以设置最大失败半分比:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: webservers
  max_fail_percentage: 30
  serial: 10
</pre></div>
</div>
<p>在上面的例子中,如果在10个服务器中如果多余3个,其它的play就会主动宕掉.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这个百分比必须被超过,不仅仅是相等.例如如果serial值呗设置为4,并且你希望任务主动在2个系统失败时候放弃.那么这个百分比应该设置为49而不是50.</p>
</div>
</div>
<div class="section" id="delegation">
<span id="id5"></span><h4><a class="toc-backref" href="#id9">委任</a><a class="headerlink" href="#delegation" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.7.</span></p>
</div>
<p>This isn&#8217;t actually rolling update specific but comes up frequently in those cases.
这个虽然不属于滚动更新,但是在那些场景下经常会出现.</p>
<p>如果你想参考其它主机来在一个主机上执行一个任务,我们就可以使用&#8217;delegate_to&#8217;关键词在你要执行的任务上.
这个对于把节点放在一个负载均衡池里面活着从里面移除非常理想. 这个选项也对处理窗口中断非常有用.
使用&#8217;serial&#8217;关键词来控制一定数量的主机也是一个好想法:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers
  serial: 5

  tasks:

  - name: take out of load balancer pool
    <span class="nb">command</span>: /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
    delegate_to: 127.0.0.1

  - name: actual steps would go here
    yum: <span class="nv">name</span><span class="o">=</span>acme-web-stack <span class="nv">state</span><span class="o">=</span>latest

  - name: add back to load balancer pool
    <span class="nb">command</span>: /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
    delegate_to: 127.0.0.1
</pre></div>
</div>
<dl class="docutils">
<dt>这些命令可以在127.0.0.1上面运行,这个运行Ansible的主机.这个也是一个简写的语法用在每一个任务基础（per-task basis）: &#8216;local_action&#8217;.以上就是这样一个playbook.但是使用的是简化后的语法在172.0.0.1上面做代理::</dt>
<dd><p class="first">&#8212;</p>
<p># ...</p>
<blockquote>
<div><p>tasks:</p>
<ul class="simple">
<li>name: take out of load balancer pool
local_action: command /usr/bin/take_out_of_pool {{ inventory_hostname }}</li>
</ul>
</div></blockquote>
<p># ...</p>
<blockquote class="last">
<div><ul class="simple">
<li>name: add back to load balancer pool
local_action: command /usr/bin/add_back_to_pool {{ inventory_hostname }}</li>
</ul>
</div></blockquote>
</dd>
</dl>
<p>A common pattern is to use a local action to call &#8216;rsync&#8217; to recursively copy files to the managed servers.
Here is an example:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># ...</span>
  tasks:

  - name: recursively copy files from management server to target
    local_action: <span class="nb">command </span>rsync -a /path/to/files <span class="o">{{</span> inventory_hostname <span class="o">}}</span>:/path/to/target/
</pre></div>
</div>
<p>注意你必须拥有不需要密码SSH密钥或者ssh-agent配置,不然的话rsync会需要询问密码.</p>
</div>
<div class="section" id="run-once">
<span id="id6"></span><h4><a class="toc-backref" href="#id10">Run Once</a><a class="headerlink" href="#run-once" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.7.</span></p>
</div>
<p>有时候你有这样的需求,在一个主机上面只执行一次一个任务.这样的配置可以配置&#8221;run_once&#8221;来实现:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># ...</span>

  tasks:

    <span class="c"># ...</span>

    - <span class="nb">command</span>: /opt/application/upgrade_db.py
      run_once: <span class="nb">true</span>

    <span class="c"># ...</span>
</pre></div>
</div>
<p>这样可以添加在&#8221;delegat_to&#8221;选项对中来定义要执行的主机:</p>
<div class="highlight-bash"><div class="highlight"><pre>- <span class="nb">command</span>: /opt/application/upgrade_db.py
  run_once: <span class="nb">true</span>
<span class="nb">  </span>delegate_to: web01.example.org
</pre></div>
</div>
<p>当&#8221;run_once&#8221; 没有喝&#8221;delegate_to&#8221;一起使用,这个任务将会被清单指定的第一个主机.
在一组被play制定主机.例如 webservers[0], 如果play指定为 &#8220;hosts: webservers&#8221;.</p>
<p>这个方法也很类似,虽然比使用条件更加简单粗暴,如下事例:</p>
<div class="highlight-bash"><div class="highlight"><pre>- <span class="nb">command</span>: /opt/application/upgrade_db.py
  when: <span class="nv">inventory_hostname</span> <span class="o">==</span> webservers<span class="o">[</span>0<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="playbooks">
<span id="local-playbooks"></span><h4><a class="toc-backref" href="#id11">本地Playbooks</a><a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h4>
<p>在本地使用playbook有时候比ssh远程使用更加有用.可以通过把playbook放在crontab中,来确保一个系统的配置,可以很有用.
在OS installer 中运行一个playbook也很有用.例如Anaconda kickstart.</p>
<p>要想在本地运行一个play,可以直接设置&#8221;host:&#8221; 与 &#8220;hosts:127.0.0.1&#8221;, 然后使用下面的命令运行:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook playbook.yml --connection<span class="o">=</span><span class="nb">local</span>
</pre></div>
</div>
<p>或者,一个本地连接也可以作为一个单独的playbook play应用在playbook中, 即便playbook中其他的plays使用默认远程
连接如下:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: 127.0.0.1
  connection: <span class="nb">local</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="http://github.com/ansible/ansible-examples">Ansible Examples on GitHub</a></dt>
<dd>Many examples of full-stack deployments</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_environment"></span><div class="section" id="id1">
<h3>配置环境 (在代理环境中)<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1.</span></p>
</div>
<p>你完全有可能遇到一些更新包需要通过proxy才能正常获取,或者甚至一部分包需要通过proxy升级而另外一部分包则不需要通过proxy.或者可能你的某个脚本需要调用某个环境变量才能正常运行.</p>
<p>Ansible 使用 &#8216;environment&#8217; 关键字对于环境部署的配置非常简单容易,下面是一个使用案例:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: all
  remote_user: root

  tasks:

    - apt: <span class="nv">name</span><span class="o">=</span>cobbler <span class="nv">state</span><span class="o">=</span>installed
      environment:
        http_proxy: http://proxy.example.com:8080
</pre></div>
</div>
<p>environment 也可以被存储在变量中,像如下方式访问:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: all
  remote_user: root

  <span class="c"># here we make a variable named &quot;proxy_env&quot; that is a dictionary</span>
  vars:
    proxy_env:
      http_proxy: http://proxy.example.com:8080

  tasks:

    - apt: <span class="nv">name</span><span class="o">=</span>cobbler <span class="nv">state</span><span class="o">=</span>installed
      environment: proxy_env
</pre></div>
</div>
<p>虽然上面只展示了 proxy 设置,但其实可以同时其实支持多个设置. 大部分合合乎逻辑的地方来定义一个环境变量都可以成为 group_vars 文件,示例如下:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># file: group_vars/boston</span>

ntp_server: ntp.bos.example.com
backup: bak.bos.example.com
proxy_env:
  http_proxy: http://proxy.bos.example.com:8080
  https_proxy: http://proxy.bos.example.com:8080
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-docs/playbooks_error_handling"></span><div class="section" id="playbooks">
<h3><a class="toc-backref" href="#id4">Playbooks 中的错误处理</a><a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#playbooks" id="id4">Playbooks 中的错误处理</a><ul>
<li><a class="reference internal" href="#ignoring-failed-commands" id="id5">忽略错误的命令</a></li>
<li><a class="reference internal" href="#controlling-what-defines-failure" id="id6">控制对失败的定义</a></li>
<li><a class="reference internal" href="#override-the-changed-result" id="id7">覆写更改结果</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible 通常默认会确保检测模块和命令的返回码并且会快速失败 &#8211; 专注于一个错误除非你另作打算.</p>
<p>有时一条命令会返回 0 但那不是报错.有时命令不会总是报告它 &#8216;改变&#8217; 了远程系统.本章节描述了
如何将 Ansible 处理输出结果和错误处理的默认行为改变成你想要的.</p>
<div class="section" id="ignoring-failed-commands">
<span id="id1"></span><h4><a class="toc-backref" href="#id5">忽略错误的命令</a><a class="headerlink" href="#ignoring-failed-commands" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 0.6.</span></p>
</div>
<p>通常情况下, 当出现失败时 Ansible 会停止在宿主机上执行.有时候,你会想要继续执行下去.为此
你需要像这样编写任务:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: this will not be counted as a failure
  <span class="nb">command</span>: /bin/false
  ignore_errors: yes
</pre></div>
</div>
<p>注意上面的系统仅仅处理那个特定的任务,所以当你在使用一个未定义的变量时, Ansible 仍然会报
错,需要使用者进行处理.</p>
</div>
<div class="section" id="controlling-what-defines-failure">
<span id="id2"></span><h4><a class="toc-backref" href="#id6">控制对失败的定义</a><a class="headerlink" href="#controlling-what-defines-failure" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.4.</span></p>
</div>
<p>假设一条命令的错误码毫无意义只有它的输出结果能告诉你什么出了问题,比如说字符串 &#8220;FAILED&#8221; 出
现在输出结果中.</p>
<p>在 Ansible 1.4及之后的版本中提供了如下的方式来指定这样的特殊行为:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: this <span class="nb">command </span>prints FAILED when it fails
  <span class="nb">command</span>: /usr/bin/example-command -x -y -z
  register: command_result
  failed_when: <span class="s2">&quot;&#39;FAILED&#39; in command_result.stderr&quot;</span>
</pre></div>
</div>
<p>在 Ansible 1.4 之前的版本能通过如下方式完成:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: this <span class="nb">command </span>prints FAILED when it fails
  <span class="nb">command</span>: /usr/bin/example-command -x -y -z
  register: command_result
  ignore_errors: True

- name: fail the play <span class="k">if</span> the previous <span class="nb">command </span>did not succeed
  fail: <span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;the command failed&quot;</span>
  when: <span class="s2">&quot;&#39;FAILED&#39; in command_result.stderr&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="override-the-changed-result">
<span id="id3"></span><h4><a class="toc-backref" href="#id7">覆写更改结果</a><a class="headerlink" href="#override-the-changed-result" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>When a shell/command or other module runs it will typically report
&#8220;changed&#8221; status based on whether it thinks it affected machine state.
当一个 shell或命令或其他模块运行时,它们往往都会在它们认为其影响机器状态时报告 &#8220;changed&#8221;
状态</p>
<dl class="docutils">
<dt>有时你可以通过返回码或是输出结果来知道它们其实并没有做出任何更改.你希望覆写结果的</dt>
<dd><p class="first">&#8220;changed&#8221; 状态使它不会出现在输出的报告或不会触发其他处理程序:</p>
<div class="last highlight-bash"><div class="highlight"><pre>tasks:

  - shell: /usr/bin/billybass --mode<span class="o">=</span><span class="s2">&quot;take me to the river&quot;</span>
    register: bass_result
    changed_when: <span class="s2">&quot;bass_result.rc != 2&quot;</span>

  <span class="c"># this will never report &#39;changed&#39; status</span>
  - shell: wall <span class="s1">&#39;beep&#39;</span>
    changed_when: False
</pre></div>
</div>
</dd>
</dl>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Best practices in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_conditionals"><em>条件选择</em></a></dt>
<dd>Conditional statements in playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a></dt>
<dd>All about variables</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/playbooks_tags"></span><div class="section" id="id1">
<h3>标签<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>如果你有一个大型的 playbook,那能够只运行其中特定部分的配置而无需运行整个 playbook
将会很有用.</p>
<p>plays 和 tasks 都因这个理由而支持 &#8220;tags:&#8221;</p>
<p>例:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

    - yum: <span class="nv">name</span><span class="o">={{</span> item <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>installed
      with_items:
         - httpd
         - memcached
      tags:
         - packages

    - template: <span class="nv">src</span><span class="o">=</span>templates/src.j2 <span class="nv">dest</span><span class="o">=</span>/etc/foo.conf
      tags:
         - configuration
</pre></div>
</div>
<p>如果你只想运行一个非常大的 playbook 中的 &#8220;configuration&#8221; 和 &#8220;packages&#8221;,你可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook example.yml --tags <span class="s2">&quot;configuration,packages&quot;</span>
</pre></div>
</div>
<p>另一方面,如果你只想执行 playbook 中某个特定任务 <em>之外</em> 的所有任务,你可以这样做:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook example.yml --skip-tags <span class="s2">&quot;notification&quot;</span>
</pre></div>
</div>
<p>你同样也可以对 roles 应用 tags:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles:
  - <span class="o">{</span> role: webserver, port: 5000, tags: <span class="o">[</span> <span class="s1">&#39;web&#39;</span>, <span class="s1">&#39;foo&#39;</span> <span class="o">]</span> <span class="o">}</span>
</pre></div>
</div>
<p>你同样也可以对基本的 include 语句使用 tag:</p>
<div class="highlight-bash"><div class="highlight"><pre>- include: foo.yml <span class="nv">tags</span><span class="o">=</span>web,foo
</pre></div>
</div>
<p>以上这样也有对每个 include 语句中的单个任务进行标签的功能.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a></dt>
<dd>Playbook organization by roles</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-docs/playbooks_vault"></span><div class="section" id="vault">
<h3><a class="toc-backref" href="#id7">Vault</a><a class="headerlink" href="#vault" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#vault" id="id7">Vault</a><ul>
<li><a class="reference internal" href="#what-can-be-encrypted-with-vault" id="id8">Vault可以加密些什么</a></li>
<li><a class="reference internal" href="#creating-files" id="id9">创建加密文件</a></li>
<li><a class="reference internal" href="#editing" id="id10">Editing加密文件</a></li>
<li><a class="reference internal" href="#rekeying-files" id="id11">密钥更新加密文件</a></li>
<li><a class="reference internal" href="#encrypting-files" id="id12">加密普通文件</a></li>
<li><a class="reference internal" href="#decrypting-files" id="id13">解密已加密文件</a></li>
<li><a class="reference internal" href="#viewing-files" id="id14">查阅已加密文件</a></li>
<li><a class="reference internal" href="#vaultplaybook" id="id15">在Vault下运行Playbook</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible 1.5的新版本中, &#8220;Vault&#8221; 作为 ansible 的一项新功能可将例如passwords,keys等敏感数据文件进行加密,而非存放在明文的 playbooks 或 roles 中. 这些 vault 文件可以分散存放也可以集中存放.</p>
<p>通过`ansible-vault` 来编辑文件,经常用到的命令如 <cite>&#8211;ask-vault-pass</cite> , <cite>&#8211;vault-password-file</cite> . 这里,你可以在 ansible.cfg 中定义密码文件所在位置,这个选项就不需要在命令行中指定标志了.</p>
<div class="section" id="what-can-be-encrypted-with-vault">
<span id="id1"></span><h4><a class="toc-backref" href="#id8">Vault可以加密些什么</a><a class="headerlink" href="#what-can-be-encrypted-with-vault" title="Permalink to this headline">¶</a></h4>
<p>vault 可以加密任何 Ansible 使用的结构化数据文件. 甚至可以包括 &#8220;group_vars/&#8221; 或 &#8220;host_vars/&#8221; inventory 变量, &#8220;include_vars&#8221; 或 &#8220;vars_files&#8221; 加载的变量, 通过 ansible-playbook 命令行使用 &#8220;-e &#64;file.yml&#8221; 或 &#8220;-e &#64;file.json&#8221; 命令传输的变量文件. Role 变量和所有默认的变量都可以被 vault 加密.</p>
<p>因为 Ansible tasks, handlers等都是数据文件, 所有的这些均可以被 vault 加密. 如果你不喜欢你使用的变量被泄漏,你可以将整个 task 文件部分加密. 然后,这个工作量比较大而且可能给你的同事带来不便哦 :)</p>
</div>
<div class="section" id="creating-files">
<span id="id2"></span><h4><a class="toc-backref" href="#id9">创建加密文件</a><a class="headerlink" href="#creating-files" title="Permalink to this headline">¶</a></h4>
<p>执行如下命令,创建加密文件:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-vault create foo.yml
</pre></div>
</div>
<p>首先你将被提示输出密码, 经过Vault加密过的文件如需查看需同时输入密码后才能进行.</p>
<p>提供密码后, 工具将加载你定义的 $EDITOR 的编辑工具默认是 vim, 一旦你关闭了编辑会话框,生成后的文件将会是加密文件.</p>
<p>默认加密方式是 AES (基于共享密钥)</p>
</div>
<div class="section" id="editing">
<span id="editing-encrypted-files"></span><h4><a class="toc-backref" href="#id10">Editing加密文件</a><a class="headerlink" href="#editing" title="Permalink to this headline">¶</a></h4>
<p>编辑加密文件,使用 <cite>ansible-vault edit</cite> . 该命令会先加密文件为临时文件并允许你编辑这个文件,当完成编辑后会保存回你所命名的文件并删除临时文件:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-vault edit foo.yml
</pre></div>
</div>
</div>
<div class="section" id="rekeying-files">
<span id="id3"></span><h4><a class="toc-backref" href="#id11">密钥更新加密文件</a><a class="headerlink" href="#rekeying-files" title="Permalink to this headline">¶</a></h4>
<p>如果你希望变更密码,使用如下 命令:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-vault rekey foo.yml bar.yml baz.yml
</pre></div>
</div>
<p>如上命令可以同时批量修改多个文件的组织密码并重新设置新密码.</p>
</div>
<div class="section" id="encrypting-files">
<span id="id4"></span><h4><a class="toc-backref" href="#id12">加密普通文件</a><a class="headerlink" href="#encrypting-files" title="Permalink to this headline">¶</a></h4>
<p>如果你希望加密一个已经存在的文件,使用 <cite>ansible-vault encrypt</cite> . 该命令也可同时批量操作多个文件:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-vault encrypt foo.yml bar.yml baz.yml
</pre></div>
</div>
</div>
<div class="section" id="decrypting-files">
<span id="id5"></span><h4><a class="toc-backref" href="#id13">解密已加密文件</a><a class="headerlink" href="#decrypting-files" title="Permalink to this headline">¶</a></h4>
<p>如果不希望继续加密一个已经加密过的文件,通过 <cite>ansible-vault decrypt</cite>  你可以永久解密. 命令将解密并保存到硬盘上,这样你不用再使用 <cite>ansible-vault edit</cite> 来编辑文件了:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-vault decrypt foo.yml bar.yml baz.yml
</pre></div>
</div>
</div>
<div class="section" id="viewing-files">
<span id="id6"></span><h4><a class="toc-backref" href="#id14">查阅已加密文件</a><a class="headerlink" href="#viewing-files" title="Permalink to this headline">¶</a></h4>
<p><em>Available since Ansible 1.8</em></p>
<p>如果你不希望通过编辑的方式来查看文件, <cite>ansible-vault view</cite>  可以满足你的需要:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-vault view foo.yml bar.yml baz.yml
</pre></div>
</div>
</div>
<div class="section" id="vaultplaybook">
<span id="running-a-playbook-with-vault"></span><h4><a class="toc-backref" href="#id15">在Vault下运行Playbook</a><a class="headerlink" href="#vaultplaybook" title="Permalink to this headline">¶</a></h4>
<p>执行 vault 加密后的playbook文件,最少需要提交如下两个标志之一. 交互式的指定 vault 的密码文件:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook site.yml --ask-vault-pass
</pre></div>
</div>
<p>该提示被用来解密(仅在内存中)任何 vault 加密访问过的文件. 目前这些文件中所有的指令请求将被使用相同的密码加密.</p>
<p>另外,密码也可以定义在一个文件或者一个脚本中,但是需要 Ansible 1.7 以上的版本才能支持. 当使用该功能时,一定要确认密码文件的权限是安全的以确保没有人可以随意访问或者变更密码文件:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook site.yml --vault-password-file ~/.vault_pass.txt

ansible-playbook site.yml --vault-password-file ~/.vault_pass.py
</pre></div>
</div>
<p>密码存储一行一个</p>
<p>如果你使用的是脚本而不是普通文件,确保脚本是可执行的,这样密码可以输出至标准设备.如果你的脚本需要提示输入数据,那提示可以被发送到标准错误.</p>
<p>如果你是从持续集成系统(例如Jenkins)中使用 Ansible 的话上面的这种情况你会用的到.</p>
<p>(<cite>&#8211;vault-password-file</cite> 参数可以在 <a class="reference internal" href="index.html#ansible-pull"><span>Ansible-Pull（拉取配置而非推送配置）</span></a> 命令中被使用,尽管这将需要分发keys到对应的节点上,所以 这些了解这些隐性问题后 &#8211;  vault 更倾向使用 push 方式)</p>
</div>
</div>
<span id="document-docs/playbooks_startnstep"></span><div class="section" id="palybookplaybook">
<h3>从指定任务开始运行palybook以及分步运行playbook<a class="headerlink" href="#palybookplaybook" title="Permalink to this headline">¶</a></h3>
<p>以下列出了几种方式来运行playbook.这对于测试或调试新的playbook很有帮助.</p>
<div class="section" id="start-at-task">
<span id="id1"></span><h4>Start-at-task<a class="headerlink" href="#start-at-task" title="Permalink to this headline">¶</a></h4>
<p>如果你想从指定的任务开始执行playbook,可以使用``&#8211;start-at``选项:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook playbook.yml --start-at<span class="o">=</span><span class="s2">&quot;install packages&quot;</span>
</pre></div>
</div>
<p>以上命令就会在名为&#8221;install packages&#8221;的任务开始执行你的playbook.</p>
</div>
<div class="section" id="playbook">
<span id="step"></span><h4>分步运行playbook<a class="headerlink" href="#playbook" title="Permalink to this headline">¶</a></h4>
<p>我们也可以通过``&#8211;step``选项来交互式的执行playbook:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook playbook.yml --step
</pre></div>
</div>
<p>这样ansible在每个任务前会自动停止,并询问是否应该执行该任务.</p>
<p>比如你有个名为``configure ssh``的任务,playbook执行到这里会停止并询问:</p>
<div class="highlight-bash"><div class="highlight"><pre>Perform task: configure ssh <span class="o">(</span>y/n/c<span class="o">)</span>:
</pre></div>
</div>
<p>&#8220;y&#8221;回答会执行该任务,&#8221;n&#8221;回答会跳过该任务,而&#8221;c&#8221;回答则会继续执行剩余的所有任务而不再询问你.</p>
</div>
</div>
</div>
</div>
<span id="document-docs/modules"></span><div class="section" id="id1">
<h2>模块相关<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<span id="document-docs/modules_intro"></span><div class="section" id="id1">
<h3>简介<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>模块(也被称为 &#8220;task plugins&#8221; 或 &#8220;library plugins&#8221;)是在 Ansible 中实际在执行的.它们就
是在每个 playbook 任务中被执行的.你也可以仅仅通过 &#8216;ansible&#8217; 命令来运行它们.</p>
<p>让我们回顾一下我们是如何通过命令行来执行三个不同的模块:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible webservers -m service -a <span class="s2">&quot;name=httpd state=started&quot;</span>
ansible webservers -m ping
ansible webservers -m <span class="nb">command</span> -a <span class="s2">&quot;/sbin/reboot -t now&quot;</span>
</pre></div>
</div>
<p>每个模块都能接收参数. 几乎所有的模块都接受键值对(<code class="docutils literal"><span class="pre">key=value</span></code>)参数,空格分隔.一些模块
不接收参数,只需在命令行输入相关的命令就能调用.</p>
<p>在 playbook 中, Ansible 模块以类似的方式执行:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: reboot the servers
  action: <span class="nb">command</span> /sbin/reboot -t now
</pre></div>
</div>
<p>也可以简写成:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: reboot the servers
  <span class="nb">command</span>: /sbin/reboot -t now
</pre></div>
</div>
<p>另一种给模块传递参数的方式是使用 ymal 语法,这也被称为 &#8216;complex args&#8217;</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: restart webserver
  service:
    name: httpd
    state: restarted
</pre></div>
</div>
<p>无论你是使用命令行还是 playbooks 所有模块都会返回以 JSON 格式组织的数据.一般来说,对此你
无需知道太多.但如果你在编写你自己的模块,那你需要在意,这意味着你不需要以特定的语言来编写
你的模块 &#8211; 你可以自行选择.</p>
<p>模块努力使自身幂等,这意味着它们会尽可能避免对系统做出改动除非那是必须的.当使用 Ansible
playbooks 时,这些模块能够触发 &#8216;change events&#8217;,以这种形式通知 &#8216;handlers&#8217; 去运行附加任务.</p>
<p>每个模块的文档能够通过命令行的 ansible-doc 工具来获取:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-doc yum
</pre></div>
</div>
<p>列出所有已安装的模块文档:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-doc -l
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a></dt>
<dd>Examples of using modules in /usr/bin/ansible</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Examples of using modules with /usr/bin/ansible-playbook</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>How to write your own modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_api"><em>Python API</em></a></dt>
<dd>Examples of using modules with the Python API</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-docs/modules_core"></span><div class="section" id="id1">
<h3>核心模块<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>这些模块是 ansible 团队维护的核心模块,同样也是 ansible 自带的模块,在收到的的请求中,它们有比 &#8220;extras&#8221; 源更高的优先级</p>
<p>核心模块的源码托管在 Github 的 <a class="reference external" href="http://github.com/ansible/ansible-modules-core">ansible-modules-core</a> repo.</p>
<p>如果你确信你在核心模块上发现了一个 bug ,同时你使用的是最新的稳定版或者开发版本的 Ansible ,首先你需要看看  github.com/ansible/ansible-modules-core 上的 &#8220;issue tracker&#8221; ,确保你的 bug 还没有被提交.如果还没被提交, 非常感谢你的提交</p>
<p>你肯能更想去问问题,而不是提交 bug ,欢迎在 Ansible-project 的 google-group 里咨询 <a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-project">https://groups.google.com/forum/#!forum/ansible-project</a> ,在 Ansible 的 #ansible_chanel 咨询也是可以的,它们位于 irc.freenode.net .开发方向的应该用类似的讨论组,位于 &lt;<a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-devel">https://groups.google.com/forum/#!forum/ansible-devel</a>&gt;`_</p>
<p>这些模块的文档更新可以直接编辑在模块自身里面,然后提交一个 pull 请求到源码,不过你需要找到源码树的 &#8220;DOCUMENTATION&#8221; 块</p>
</div>
<span id="document-docs/modules_extra"></span><div class="section" id="id1">
<h3>额外模块<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>这些模块是当前ansible附带的,但是也可能在以后被分开.额外模块主要被社区人员维护.非核心模块仍然是完全可用的,但是在发出和拉取请求时可能收到稍微低的响应速率</p>
<p>受欢迎的的 “extras” 模块将来可能会提升为核心模块</p>
<p>这些额外的模块托管在Github上的,`ansible-modules-extras &lt;<a class="reference external" href="http://github.com/ansible/ansible-modules-extras">http://github.com/ansible/ansible-modules-extras</a>&gt;`_ repo.</p>
<p>如果你确信你在额外模块上发现了一个 bug ,同时你使用的是最新的稳定版或者开发版本的 Ansible ,首先你需要看看  github.com/ansible/ansible-modules-extras 上的 &#8220;issue tracker&#8221; ,确保你的 bug 还没有被提交.如果还没被提交, 非常感谢你的提交</p>
<p>你肯能更想去问问题,而不是提交 bug ,欢迎在 Ansible-project 的 google-group 里咨询 <a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-project">https://groups.google.com/forum/#!forum/ansible-project</a> ,在 Ansible 的 #ansible_chanel 咨询也是可以的,它们位于 irc.freenode.net .开发方向的应该用类似的讨论组,位于 &lt;<a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-devel">https://groups.google.com/forum/#!forum/ansible-devel</a>&gt;`_</p>
<p>这些模块的文档更新可以直接编辑在模块自身里面,然后提交一个 pull 请求到源码,不过你需要找到源码树的 &#8220;DOCUMENTATION&#8221; 块</p>
<p>获取开发模块的更多们帮助,请阅读,:doc:<cite>community</cite>, <a class="reference internal" href="index.html#document-docs/developing_test_pr"><em>帮助测试PR</em></a> and <a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a>.</p>
</div>
<span id="document-docs/common_return_values"></span><div class="section" id="id1">
<h3><a class="toc-backref" href="#id5">共同的返回值</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#id1" id="id5">共同的返回值</a><ul>
<li><a class="reference internal" href="#facts" id="id6">Facts</a></li>
<li><a class="reference internal" href="#status" id="id7">Status</a></li>
<li><a class="reference internal" href="#other" id="id8">其他的共同返回</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible模块通常返回一个数据结构将其注册到变量中, 或者直接作为`ansible`程序的输出. 这里我们记录了所有模块的共同值, 每一个模块可以任意返回他们所独有的值. 因为这些文档的存在人们可以通过ansible-doc和https://docs.ansible.com看到.</p>
<div class="section" id="facts">
<span id="id2"></span><h4><a class="toc-backref" href="#id6">Facts</a><a class="headerlink" href="#facts" title="Permalink to this headline">¶</a></h4>
<p>一些模块返回&#8217;facts&#8217;(例如 setup), 这些是通过一个&#8217;ansible_facts&#8217;作为key和内部一些自动收集的值直接作为当前主机的变量并且他们不需要注册这些数据</p>
</div>
<div class="section" id="status">
<span id="id3"></span><h4><a class="toc-backref" href="#id7">Status</a><a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h4>
<p>每一个模块都必须返回一个status, 来表示这个模块是成功的,是否有任何改变或没有. 当因为用户的条件(when: )或在检查模式下运行时发现该模块不支持, Ansible自己将会返回一个status并跳过这个模块.</p>
</div>
<div class="section" id="other">
<span id="id4"></span><h4><a class="toc-backref" href="#id8">其他的共同返回</a><a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h4>
<p>通常在失败或者成功时返回一个&#8217;msg&#8217;, 这被用来解释执行失败的原因或者关于执行的过程说明
一些模块, 特别是那些执行shell或者commands指令, 将返回stdout和stderr, 如果ansible发现输出结果, 它将追加一条线, 这在输出上仅仅是一个列表或一条线.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-modules-core/tree/devel">GitHub Core modules directory</a></dt>
<dd>Browse source of core modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-modules-extras/tree/devel">Github Extras modules directory</a></dt>
<dd>Browse source of extras modules.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>Development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<p>ansible 附带了很多可以直接在远端主机或者通过 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> 执行的模块</p>
<p>用户也可以写出属于自己的模块.这些模块可以控制系统的资源 ,像服务,包管理,文件,或执行系统命令.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/intro_adhoc"><em>Introduction To Ad-Hoc Commands</em></a></dt>
<dd>Examples of using modules in /usr/bin/ansible</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Examples of using modules with /usr/bin/ansible-playbook</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>How to write your own modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_api"><em>Python API</em></a></dt>
<dd>Examples of using modules with the Python API</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
<span id="document-docs/guides"></span><div class="section" id="id1">
<h2>详细指南<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>这个部分是新的和展开的,这里的概念是更深的层面探索特定的用法在,同时提供了一个对基本特性的自顶向下的解释</p>
<div class="toctree-wrapper compound">
<span id="document-docs/guide_aws"></span><div class="section" id="amazon-web-services-guide">
<h3>Amazon Web Services Guide<a class="headerlink" href="#amazon-web-services-guide" title="Permalink to this headline">¶</a></h3>
<div class="section" id="aws-intro">
<span id="id1"></span><h4>简介<a class="headerlink" href="#aws-intro" title="Permalink to this headline">¶</a></h4>
<p>Ansible包含了大量的控制Amazon web service(AWS)模块.这个章节的目的是为了说明如何在AWS环境下组合ansible的模块使用ansible(The purpose of this
section is to explain how to put Ansible modules together (and use inventory scripts) to use Ansible in AWS context)</p>
<p>AWS模块的需求(requiement)是很少的</p>
<p>所有需要的模块以及被最近的 boto 版本测试过了.你需要这个模块安装在你的控制机器上面.boto 可以从linux发行版或者使用python的pip安装</p>
<p>然而典型的ansible执行任务,对多个主机进行循环(Whereas classically ansible will execute tasks in its host loop against multiple remote machines),大部分的云控制步骤发生在你的本地机器所关联的区域</p>
<p>在你的 playbook 步骤里,我们会使用下面的样式演示步骤:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: localhost
  connection: <span class="nb">local</span>
<span class="nb">  </span>gather_facts: False
  tasks:
    - ...
</pre></div>
</div>
</div>
<div class="section" id="aws-authentication">
<span id="id2"></span><h4>认证<a class="headerlink" href="#aws-authentication" title="Permalink to this headline">¶</a></h4>
<p>AWS 认证相关的模块通过指定访问密钥作为 ENV 的变量或者模块参数.</p>
<p>对于环境变量:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s1">&#39;AK123&#39;</span>
<span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s1">&#39;abc123&#39;</span>
</pre></div>
</div>
<p>存储变量在一个 vars_file ,最好使用ansible-vault:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
ec2_access_key: <span class="s2">&quot;--REMOVED--&quot;</span>
ec2_secret_key: <span class="s2">&quot;--REMOVED--&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="provisioning">
<span id="aws-provisioning"></span><h4>供给(Provisioning)<a class="headerlink" href="#provisioning" title="Permalink to this headline">¶</a></h4>
<p>在EC2中提供和取消实例的ec2模块</p>
<p>一个确保只有5个实例标签为“Demo”的例子</p>
<p>在下面的例子里,&#8221;exact_count&#8221;实例被设置为了5,这意味着如果0个实例存在,将会创建5个.如果两个实例创建,将会创建三个,如果8个实例存在,将会终止3个.</p>
<p>指定&#8221;count_tag&#8221;参数的将被计数, &#8220;instance_tags&#8221; 参数用于给新创建的实例应用标签:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># demo_setup.yml</span>

- hosts: localhost
  connection: <span class="nb">local</span>
<span class="nb">  </span>gather_facts: False

  tasks:

    - name: Provision a <span class="nb">set </span>of instances
      ec2:
         key_name: my_key
         group: <span class="nb">test</span>
<span class="nb">         </span>instance_type: t2.micro
         image: <span class="s2">&quot;{{ ami_id }}&quot;</span>
         <span class="nb">wait</span>: <span class="nb">true</span>
<span class="nb">         </span>exact_count: 5
         count_tag:
            Name: Demo
         instance_tags:
            Name: Demo
      register: ec2
</pre></div>
</div>
<p>有关实例被常见的数据被保存在通过 &#8220;register&#8221; 关键字设置的&#8221;ec2&#8221;变量</p>
<p>我们将会使用 add_host 模块动态的创建主机组组成新的实例.这将会在后来的任务里面立即执行这些配置文件:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># demo_setup.yml</span>

- hosts: localhost
  connection: <span class="nb">local</span>
<span class="nb">  </span>gather_facts: False

  tasks:

    - name: Provision a <span class="nb">set </span>of instances
      ec2:
         key_name: my_key
         group: <span class="nb">test</span>
<span class="nb">         </span>instance_type: t2.micro
         image: <span class="s2">&quot;{{ ami_id }}&quot;</span>
         <span class="nb">wait</span>: <span class="nb">true</span>
<span class="nb">         </span>exact_count: 5
         count_tag:
            Name: Demo
         instance_tags:
            Name: Demo
      register: ec2

   - name: Add all instance public IPs to host group
     add_host: <span class="nv">hostname</span><span class="o">={{</span> item.public_ip <span class="o">}}</span> <span class="nv">groups</span><span class="o">=</span>ec2hosts
     with_items: ec2.instances
</pre></div>
</div>
<p>在主机组添加之后,规则剧本底部的第二个演出将会开始一些配置步骤:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># demo_setup.yml</span>

- name: Provision a <span class="nb">set </span>of instances
  hosts: localhost
  <span class="c"># ... AS ABOVE ...</span>

- hosts: ec2hosts
  name: configuration play
  user: ec2-user
  gather_facts: <span class="nb">true</span>

<span class="nb">  </span>tasks:

     - name: Check NTP service
       service: <span class="nv">name</span><span class="o">=</span>ntpd <span class="nv">state</span><span class="o">=</span>started
</pre></div>
</div>
</div>
<div class="section" id="aws-host-inventory">
<span id="id3"></span><h4>主机清单<a class="headerlink" href="#aws-host-inventory" title="Permalink to this headline">¶</a></h4>
<p>一旦你的节点开始运转起来了,你可能想去和它们通信.在云的配置下,最好不要维护静态的云主机名.最好的方式是使用ec2动态清单脚本来处理.</p>
<p>这将会动态的挑选节点甚至不是由Ansible创建的,同样允许Ansible管理它们.</p>
<p>阅读  doc:<cite>aws_example</cite> 查看如何使用,然后继续回到这个章节.</p>
</div>
<div class="section" id="aws-tags-and-groups">
<span id="id4"></span><h4>标签,组和变量<a class="headerlink" href="#aws-tags-and-groups" title="Permalink to this headline">¶</a></h4>
<p>当使用ec2清单脚本的时候,主机基于它们如何在EC2里面的标签动态的出现在组里面</p>
<p>例如,如果一个主机给了 &#8220;class&#8221; 标签,同时给它&#8221;webserver&#8221;作为值,它会自动被动态组发现,就像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: tag_class_webserver
  tasks:
    - ping
</pre></div>
</div>
<p>这是很好的根据他们的性能划分系统的方式.</p>
<p>在这个例子里,如果我们想去定义自动应用每台机器上面的变量,同时 &#8220;webserver&#8221; 带有标签 &#8220;class&#8221; , 在ansible里面可以使用的&#8221;group_vars&#8221;, 阅读:ref:<cite>splitting_out_vars</cite>.</p>
<p>对于区域和其它分类,相似的组是可用的,可以使用同一种机制分配相似的变量.(Similar groups are available for regions and other classifications, and can be similarly assigned variables using the same mechanism.)</p>
</div>
<div class="section" id="ansible-pull">
<span id="aws-pull"></span><h4>使用Ansible Pull自动伸缩<a class="headerlink" href="#ansible-pull" title="Permalink to this headline">¶</a></h4>
<p>Amazon有基于负载自动的增加和减少容量的特性. 在 cloud 文档里,也有一些 Ansible 模块可以配置自动伸缩策略.</p>
<p>当节点在线的时候,可能没有足够的时间等待下一个周期来临,让ansible命令配置那个节点.</p>
<p>为了这么做,(To do this, pre-bake machine images which contain the necessary ansible-pull invocation.).Ansible-pull 是从git服务器上面抓取playbook在本地运行的一个命令行工具.</p>
<p>这种方式的一个挑战在于在自动伸缩的环境里面需要一个中心化的方式存取 pull 命令的数据.因为这个原因,下面提供自动伸缩解决方案更好一些.</p>
<p>阅读 <a class="reference internal" href="index.html#ansible-pull"><span>Ansible-Pull（拉取配置而非推送配置）</span></a> 在pull-node playbook 获取更多的信息</p>
</div>
<div class="section" id="asnible-tower">
<span id="aws-autoscale"></span><h4>使用Asnible Tower自动伸缩<a class="headerlink" href="#asnible-tower" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> 同样包含了一个非常好的特性来自动伸缩.在这种方式下,简单的curl脚本可以调用定义的URL,服务器也会对请求&#8221;dial out&#8221;和配置正在运行的实例.这是一个很好的方式重新配置生存周期短暂的节点.阅读Tower安装和产品文档获取更多的信息.</p>
<p>在Tower使用回收机制有个好处是,任务结果仍然是中心化的,但是和远程主机分享更少的信息(A benefit of using the callback in Tower over pull mode is that job results are still centrally recorded and less information has to be shared
with remote hosts.)</p>
</div>
<div class="section" id="ansible">
<span id="aws-cloudformation-example"></span><h4>Ansible云构造<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h4>
<p>云构造是一个Amazon的技术,让云栈作为JSON文档</p>
<p>Ansible摸块提供了一个比云构造更容易的接口,不需要定义复杂的JSON文档.这是推荐用户使用的.</p>
<p>然而,当用户决定使用云构造,也有 Ansible 模块可以应用于云构造模板.</p>
<p>当使用Ansible配合云构造的时候,Ansible通常使用一个工具像 Packer 来构建镜像,CloudFormation 运行这些镜像, 或者通过用户数据,一旦镜像上线,ansible会被激发.(When using Ansible with CloudFormation, typically Ansible will be used with a tool like Packer to build images, and CloudFormation will launch
those images, or ansible will be invoked through user data once the image comes online, or a combination of the two.)</p>
<p>请阅读ansible云构造的例子获取更多的细节.</p>
</div>
<div class="section" id="ansible-aws">
<span id="aws-image-build"></span><h4>使用Ansible 构造AWS镜像<a class="headerlink" href="#ansible-aws" title="Permalink to this headline">¶</a></h4>
<p>Many users may want to have images boot to a more complete configuration rather than configuring them entirely after instantiation.  To do this,
one of many programs can be used with Ansible playbooks to define and upload a base image, which will then get its own AMI ID for usage with
the ec2 module or other Ansible AWS modules such as ec2_asg or the cloudformation module.   Possible tools include Packer, aminator, and Ansible&#8217;s
ec2_ami module.</p>
<p>许多用户想去开机启动更完整的配置而不是安装之后配置.为了这样做,许多程序可以用于ansible playbook定义和上传基本的镜像,这让他们使用 ec2 模块后得到自己的AMI ID,或者其它的Ansible AWS模块例如ec2_asg 或者cloudformation 模块.可能的工具包含 Packer,aminator,和Ansible&#8217;s ec2_ami 模块</p>
<p>总的来说,我们发现许多用户使用Packer</p>
<p>Ansible Packer的文档可以在这里找到 <a class="reference external" href="https://www.packer.io/docs/provisioners/ansible-local.html">https://www.packer.io/docs/provisioners/ansible-local.html</a>.</p>
<p>如果你想采用Packer这时,配置一个基本的镜像使用Ansible在规则之后是可以接受的.</p>
</div>
<div class="section" id="aws-next-steps">
<span id="id5"></span><h4>下一步:探索模块<a class="headerlink" href="#aws-next-steps" title="Permalink to this headline">¶</a></h4>
<p>Ansible附带许多模块来配置许多EC2服务.浏览 模块的 &#8220;Cloud&#8221; 目录查看完整的列表</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>All the documentation for Ansible modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_delegation"><em>委托,滚动更新,本地动作</em></a></dt>
<dd>Delegation, useful for working with loud balancers, clouds, and locally executed steps.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/guide_rax"></span><div class="section" id="rackspace-cloud-guide">
<h3>Rackspace Cloud Guide<a class="headerlink" href="#rackspace-cloud-guide" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<span id="id1"></span><h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section of the documentation is under construction. We are in the process of adding more examples about the Rackspace modules and how they work together.  Once complete, there will also be examples for Rackspace Cloud in <a class="reference external" href="https://github.com/ansible/ansible-examples/">ansible-examples</a>.</p>
</div>
<p>Ansible contains a number of core modules for interacting with Rackspace Cloud.</p>
<p>The purpose of this section is to explain how to put Ansible modules together
(and use inventory scripts) to use Ansible in a Rackspace Cloud context.</p>
<p>Prerequisites for using the rax modules are minimal.  In addition to ansible itself,
all of the modules require and are tested against pyrax 1.5 or higher.
You&#8217;ll need this Python module installed on the execution host.</p>
<p>pyrax is not currently available in many operating system
package repositories, so you will likely need to install it via pip:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pip install pyrax
</pre></div>
</div>
<p>The following steps will often execute from the control machine against the Rackspace Cloud API, so it makes sense
to add localhost to the inventory file.  (Ansible may not require this manual step in the future):</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[localhost]</span>
<span class="na">localhost ansible_connection</span><span class="o">=</span><span class="s">local</span>
</pre></div>
</div>
<p>In playbook steps, we&#8217;ll typically be using the following pattern:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
</pre></div>
</div>
</div>
<div class="section" id="credentials-file">
<span id="id2"></span><h4>Credentials File<a class="headerlink" href="#credentials-file" title="Permalink to this headline">¶</a></h4>
<p>The <cite>rax.py</cite> inventory script and all <cite>rax</cite> modules support a standard <cite>pyrax</cite> credentials file that looks like:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[rackspace_cloud]</span>
<span class="na">username</span> <span class="o">=</span> <span class="s">myraxusername</span>
<span class="na">api_key</span> <span class="o">=</span> <span class="s">d41d8cd98f00b204e9800998ecf8427e</span>
</pre></div>
</div>
<p>Setting the environment parameter RAX_CREDS_FILE to the path of this file will help Ansible find how to load
this information.</p>
<p>More information about this credentials file can be found at
<a class="reference external" href="https://github.com/rackspace/pyrax/blob/master/docs/getting_started.md#authenticating">https://github.com/rackspace/pyrax/blob/master/docs/getting_started.md#authenticating</a></p>
<div class="section" id="running-from-a-python-virtual-environment-optional">
<span id="virtual-environment"></span><h5>Running from a Python Virtual Environment (Optional)<a class="headerlink" href="#running-from-a-python-virtual-environment-optional" title="Permalink to this headline">¶</a></h5>
<p>Most users will not be using virtualenv, but some users, particularly Python developers sometimes like to.</p>
<p>There are special considerations when Ansible is installed to a Python virtualenv, rather than the default of installing at a global scope. Ansible assumes, unless otherwise instructed, that the python binary will live at /usr/bin/python.  This is done via the interpreter line in modules, however when instructed by setting the inventory variable &#8216;ansible_python_interpreter&#8217;, Ansible will use this specified path instead to find Python.  This can be a cause of confusion as one may assume that modules running on &#8216;localhost&#8217;, or perhaps running via &#8216;local_action&#8217;, are using the virtualenv Python interpreter.  By setting this line in the inventory, the modules will execute in the virtualenv interpreter and have available the virtualenv packages, specifically pyrax. If using virtualenv, you may wish to modify your localhost inventory definition to find this location as follows:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[localhost]</span>
<span class="na">localhost ansible_connection</span><span class="o">=</span><span class="s">local ansible_python_interpreter=/path/to/ansible_venv/bin/python</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">pyrax may be installed in the global Python package scope or in a virtual environment.  There are no special considerations to keep in mind when installing pyrax.</p>
</div>
</div>
</div>
<div class="section" id="provisioning">
<span id="id3"></span><h4>Provisioning<a class="headerlink" href="#provisioning" title="Permalink to this headline">¶</a></h4>
<p>Now for the fun parts.</p>
<p>The &#8216;rax&#8217; module provides the ability to provision instances within Rackspace Cloud.  Typically the provisioning task will be performed from your Ansible control server (in our example, localhost) against the Rackspace cloud API.  This is done for several reasons:</p>
<blockquote>
<div><ul class="simple">
<li>Avoiding installing the pyrax library on remote nodes</li>
<li>No need to encrypt and distribute credentials to remote nodes</li>
<li>Speed and simplicity</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Authentication with the Rackspace-related modules is handled by either
specifying your username and API key as environment variables or passing
them as module arguments, or by specifying the location of a credentials
file.</p>
</div>
<p>Here is a basic example of provisioning an instance in ad-hoc mode:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible localhost -m rax -a <span class="s2">&quot;name=awx flavor=4 image=ubuntu-1204-lts-precise-pangolin wait=yes&quot;</span> -c <span class="nb">local</span>
</pre></div>
</div>
<p>Here&#8217;s what it would look like in a playbook, assuming the parameters were defined in variables:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Provision a set of instances</span>
    <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">flavor</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_flavor</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_image</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">count</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_count</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">group</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>
</pre></div>
</div>
<p>The rax module returns data about the nodes it creates, like IP addresses, hostnames, and login passwords.  By registering the return value of the step, it is possible used this data to dynamically add the resulting hosts to inventory (temporarily, in memory). This facilitates performing configuration actions on the hosts in a follow-on task.  In the following example, the servers that were successfully created using the above task are dynamically added to a group called &#8220;raxhosts&#8221;, with each nodes hostname, IP address, and root password being added to the inventory.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add the instances we created (by public IP) to the group &#39;raxhosts&#39;</span>
  <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">add_host</span>
      <span class="l-Scalar-Plain">hostname</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l-Scalar-Plain">ansible_ssh_host</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l-Scalar-Plain">ansible_ssh_pass</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_adminpass</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l-Scalar-Plain">groups</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">raxhosts</span>
  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.success</span>
  <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.action == &#39;create&#39;</span>
</pre></div>
</div>
<p>With the host group now created, the next play in this playbook could now configure servers belonging to the raxhosts group.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Configuration play</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">raxhosts</span>
  <span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ntp</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">webserver</span>
</pre></div>
</div>
<p>The method above ties the configuration of a host with the provisioning step.  This isn&#8217;t always what you want, and leads us
to the next section.</p>
</div>
<div class="section" id="host-inventory">
<span id="id4"></span><h4>Host Inventory<a class="headerlink" href="#host-inventory" title="Permalink to this headline">¶</a></h4>
<p>Once your nodes are spun up, you&#8217;ll probably want to talk to them again.  The best way to handle his is to use the &#8220;rax&#8221; inventory plugin, which dynamically queries Rackspace Cloud and tells Ansible what nodes you have to manage.  You might want to use this even if you are spinning up Ansible via other tools, including the Rackspace Cloud user interface. The inventory plugin can be used to group resources by metadata, region, OS, etc.  Utilizing metadata is highly recommended in &#8220;rax&#8221; and can provide an easy way to sort between host groups and roles. If you don&#8217;t want to use the <code class="docutils literal"><span class="pre">rax.py</span></code> dynamic inventory script, you could also still choose to manually manage your INI inventory file, though this is less recommended.</p>
<p>In Ansible it is quite possible to use multiple dynamic inventory plugins along with INI file data.  Just put them in a common directory and be sure the scripts are chmod +x, and the INI-based ones are not.</p>
<div class="section" id="rax-py">
<span id="raxpy"></span><h5>rax.py<a class="headerlink" href="#rax-py" title="Permalink to this headline">¶</a></h5>
<p>To use the rackspace dynamic inventory script, copy <code class="docutils literal"><span class="pre">rax.py</span></code> into your inventory directory and make it executable. You can specify a credentials file for <code class="docutils literal"><span class="pre">rax.py</span></code> utilizing the <code class="docutils literal"><span class="pre">RAX_CREDS_FILE</span></code> environment variable.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dynamic inventory scripts (like <code class="docutils literal"><span class="pre">rax.py</span></code>) are saved in <code class="docutils literal"><span class="pre">/usr/share/ansible/inventory</span></code> if Ansible has been installed globally.  If installed to a virtualenv, the inventory scripts are installed to <code class="docutils literal"><span class="pre">$VIRTUALENV/share/inventory</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Users of <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> will note that dynamic inventory is natively supported by Tower, and all you have to do is associate a group with your Rackspace Cloud credentials, and it will easily synchronize without going through these steps:</p>
<div class="last highlight-bash"><div class="highlight"><pre><span class="nv">$ RAX_CREDS_FILE</span><span class="o">=</span>~/.raxpub ansible all -i rax.py -m setup
</pre></div>
</div>
</div>
<p><code class="docutils literal"><span class="pre">rax.py</span></code> also accepts a <code class="docutils literal"><span class="pre">RAX_REGION</span></code> environment variable, which can contain an individual region, or a comma separated list of regions.</p>
<p>When using <code class="docutils literal"><span class="pre">rax.py</span></code>, you will not have a &#8216;localhost&#8217; defined in the inventory.</p>
<p>As mentioned previously, you will often be running most of these modules outside of the host loop, and will need &#8216;localhost&#8217; defined.  The recommended way to do this, would be to create an <code class="docutils literal"><span class="pre">inventory</span></code> directory, and place both the <code class="docutils literal"><span class="pre">rax.py</span></code> script and a file containing <code class="docutils literal"><span class="pre">localhost</span></code> in it.</p>
<p>Executing <code class="docutils literal"><span class="pre">ansible</span></code> or <code class="docutils literal"><span class="pre">ansible-playbook</span></code> and specifying the <code class="docutils literal"><span class="pre">inventory</span></code> directory instead
of an individual file, will cause ansible to evaluate each file in that directory for inventory.</p>
<p>Let&#8217;s test our inventory script to see if it can talk to Rackspace Cloud.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ RAX_CREDS_FILE</span><span class="o">=</span>~/.raxpub ansible all -i inventory/ -m setup
</pre></div>
</div>
<p>Assuming things are properly configured, the <code class="docutils literal"><span class="pre">rax.py</span></code> inventory script will output information similar to the
following information, which will be utilized for inventory and variables.</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;ORD&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;test&quot;</span>
    <span class="p">],</span>
    <span class="nt">&quot;_meta&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;hostvars&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ansible_ssh_host&quot;</span><span class="p">:</span> <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_accessipv4&quot;</span><span class="p">:</span> <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_accessipv6&quot;</span><span class="p">:</span> <span class="s2">&quot;2607:f0d0:1002:51::4&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_addresses&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;2.2.2.2&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                        <span class="p">}</span>
                    <span class="p">],</span>
                    <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;2607:f0d0:1002:51::4&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">6</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_config_drive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_created&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:48:22Z&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_flavor&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;performance1-1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/flavors/performance1-1&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_hostid&quot;</span><span class="p">:</span> <span class="s2">&quot;e7b6961a9bd943ee82b13816426f1563bfda6846aad84d52af45a4904660cde0&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_human_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_id&quot;</span><span class="p">:</span> <span class="s2">&quot;099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_image&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/images/b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_key_name&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nt">&quot;rax_links&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/v2/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="nt">&quot;rax_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_name_attr&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_networks&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;2.2.2.2&quot;</span>
                    <span class="p">],</span>
                    <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;2607:f0d0:1002:51::4&quot;</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="nt">&quot;rax_os-dcf_diskconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_os-ext-sts_power_state&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;rax_os-ext-sts_task_state&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nt">&quot;rax_os-ext-sts_vm_state&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="nt">&quot;rax_status&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_tenant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;111111&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:49:27Z&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rax_user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;22222&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="standard-inventory">
<span id="id5"></span><h5>Standard Inventory<a class="headerlink" href="#standard-inventory" title="Permalink to this headline">¶</a></h5>
<p>When utilizing a standard ini formatted inventory file (as opposed to the inventory plugin), it may still be advantageous to retrieve discoverable hostvar information  from the Rackspace API.</p>
<p>This can be achieved with the <code class="docutils literal"><span class="pre">rax_facts</span></code> module and an inventory file similar to the following:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[test_servers]</span>
<span class="na">hostname1 rax_region</span><span class="o">=</span><span class="s">ORD</span>
<span class="na">hostname2 rax_region</span><span class="o">=</span><span class="s">ORD</span>
</pre></div>
</div>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Gather info about servers</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test_servers</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get facts about servers</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">inventory_hostname</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_region</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Map some facts</span>
      <span class="l-Scalar-Plain">set_fact</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">ansible_ssh_host</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<p>While you don&#8217;t need to know how it works, it may be interesting to know what kind of variables are returned.</p>
<p>The <code class="docutils literal"><span class="pre">rax_facts</span></code> module provides facts as followings, which match the <code class="docutils literal"><span class="pre">rax.py</span></code> inventory script:</p>
<div class="highlight-json"><div class="highlight"><pre><span class="p">{</span>
    <span class="nt">&quot;ansible_facts&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;rax_accessipv4&quot;</span><span class="p">:</span> <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_accessipv6&quot;</span><span class="p">:</span> <span class="s2">&quot;2607:f0d0:1002:51::4&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_addresses&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;2.2.2.2&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">4</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&quot;addr&quot;</span><span class="p">:</span> <span class="s2">&quot;2607:f0d0:1002:51::4&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="mi">6</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_config_drive&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_created&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:48:22Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_flavor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;performance1-1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/flavors/performance1-1&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_hostid&quot;</span><span class="p">:</span> <span class="s2">&quot;e7b6961a9bd943ee82b13816426f1563bfda6846aad84d52af45a4904660cde0&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_human_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_id&quot;</span><span class="p">:</span> <span class="s2">&quot;099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_image&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
            <span class="nt">&quot;links&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/images/b211c7bf-b5b4-4ede-a8de-a4368750c653&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_key_name&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nt">&quot;rax_links&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/v2/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;href&quot;</span><span class="p">:</span> <span class="s2">&quot;https://ord.servers.api.rackspacecloud.com/111111/servers/099a447b-a644-471f-87b9-a7f580eb0c2a&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rel&quot;</span><span class="p">:</span> <span class="s2">&quot;bookmark&quot;</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="nt">&quot;rax_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;foo&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_name&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_name_attr&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_networks&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;private&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;2.2.2.2&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;public&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;2607:f0d0:1002:51::4&quot;</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;rax_os-dcf_diskconfig&quot;</span><span class="p">:</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_os-ext-sts_power_state&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;rax_os-ext-sts_task_state&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nt">&quot;rax_os-ext-sts_vm_state&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_progress&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nt">&quot;rax_status&quot;</span><span class="p">:</span> <span class="s2">&quot;ACTIVE&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_tenant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;111111&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_updated&quot;</span><span class="p">:</span> <span class="s2">&quot;2013-11-14T20:49:27Z&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rax_user_id&quot;</span><span class="p">:</span> <span class="s2">&quot;22222&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;changed&quot;</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="use-cases">
<h4>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h4>
<p>This section covers some additional usage examples built around a specific use case.</p>
<div class="section" id="network-and-server">
<span id="id6"></span><h5>Network and Server<a class="headerlink" href="#network-and-server" title="Permalink to this headline">¶</a></h5>
<p>Create an isolated cloud network and build a server</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Build Servers on an Isolated Network</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Network create request</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_network</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-net</span>
        <span class="l-Scalar-Plain">cidr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">192.168.3.0/24</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IAD</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Server create request</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web%04d.example.org</span>
        <span class="l-Scalar-Plain">flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu-1204-lts-precise-pangolin</span>
        <span class="l-Scalar-Plain">disk_config</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">manual</span>
        <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">public</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-net</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IAD</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
        <span class="l-Scalar-Plain">count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
        <span class="l-Scalar-Plain">exact_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
        <span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
        <span class="l-Scalar-Plain">wait_timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">360</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>
</pre></div>
</div>
</div>
<div class="section" id="complete-environment">
<span id="id7"></span><h5>Complete Environment<a class="headerlink" href="#complete-environment" title="Permalink to this headline">¶</a></h5>
<p>Build a complete webserver environment with servers, custom networks and load balancers, install nginx and create a custom index.html</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="nn">---</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Build environment</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Load Balancer create request</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_clb</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-lb</span>
        <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
        <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">HTTP</span>
        <span class="l-Scalar-Plain">algorithm</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ROUND_ROBIN</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">PUBLIC</span>
        <span class="l-Scalar-Plain">timeout</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IAD</span>
        <span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
        <span class="l-Scalar-Plain">meta</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">app</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-cool-app</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">clb</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Network create request</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_network</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">my-net</span>
        <span class="l-Scalar-Plain">cidr</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">192.168.3.0/24</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IAD</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">network</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Server create request</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web%04d.example.org</span>
        <span class="l-Scalar-Plain">flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">performance1-1</span>
        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu-1204-lts-precise-pangolin</span>
        <span class="l-Scalar-Plain">disk_config</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">manual</span>
        <span class="l-Scalar-Plain">networks</span><span class="p-Indicator">:</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">public</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">private</span>
          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">my-net</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IAD</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
        <span class="l-Scalar-Plain">count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
        <span class="l-Scalar-Plain">exact_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
        <span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add servers to web host group</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">add_host</span>
        <span class="l-Scalar-Plain">hostname</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">ansible_ssh_host</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">ansible_ssh_pass</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_adminpass</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">ansible_ssh_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
        <span class="l-Scalar-Plain">groups</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
      <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.success</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.action == &#39;create&#39;</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add servers to Load balancer</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_clb_nodes</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">load_balancer_id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">clb.balancer.id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">address</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_networks.private|first</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">80</span>
        <span class="l-Scalar-Plain">condition</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">enabled</span>
        <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">primary</span>
        <span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">IAD</span>
      <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.success</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.action == &#39;create&#39;</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Configure servers</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
  <span class="l-Scalar-Plain">handlers</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">restart nginx</span>
      <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=restarted</span>

  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Install nginx</span>
      <span class="l-Scalar-Plain">apt</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=nginx state=latest update_cache=yes cache_valid_time=86400</span>
      <span class="l-Scalar-Plain">notify</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restart nginx</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ensure nginx starts on boot</span>
      <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=nginx state=started enabled=yes</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create custom index.html</span>
      <span class="l-Scalar-Plain">copy</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">content=&quot;{{ inventory_hostname }}&quot; dest=/usr/share/nginx/www/index.html</span>
            <span class="l-Scalar-Plain">owner=root group=root mode=0644</span>
</pre></div>
</div>
</div>
<div class="section" id="rackconnect-and-managed-cloud">
<span id="rackconnect-and-manged-cloud"></span><h5>RackConnect and Managed Cloud<a class="headerlink" href="#rackconnect-and-managed-cloud" title="Permalink to this headline">¶</a></h5>
<p>When using RackConnect version 2 or Rackspace Managed Cloud there are Rackspace automation tasks that are executed on the servers you create after they are successfully built. If your automation executes before the RackConnect or Managed Cloud automation, you can cause failures and un-usable servers.</p>
<p>These examples show creating servers, and ensuring that the Rackspace automation has completed before Ansible continues onwards.</p>
<p>For simplicity, these examples are joined, however both are only needed when using RackConnect.  When only using Managed Cloud, the RackConnect portion can be ignored.</p>
<p>The RackConnect portions only apply to RackConnect version 2.</p>
<div class="section" id="using-a-control-machine">
<span id="id8"></span><h6>Using a Control Machine<a class="headerlink" href="#using-a-control-machine" title="Permalink to this headline">¶</a></h6>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create an exact count of servers</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">False</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Server build requests</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web%03d.example.org</span>
        <span class="l-Scalar-Plain">flavor</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">performance1-1</span>
        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ubuntu-1204-lts-precise-pangolin</span>
        <span class="l-Scalar-Plain">disk_config</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">manual</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DFW</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">present</span>
        <span class="l-Scalar-Plain">count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
        <span class="l-Scalar-Plain">exact_count</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
        <span class="l-Scalar-Plain">wait</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add servers to in memory groups</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">add_host</span>
        <span class="l-Scalar-Plain">hostname</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">ansible_ssh_host</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_accessipv4</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">ansible_ssh_pass</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_adminpass</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">ansible_ssh_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
        <span class="l-Scalar-Plain">rax_id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.rax_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">groups</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web,new_web</span>
      <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.success</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax.action == &#39;create&#39;</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for rackconnect and managed cloud automation to complete</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">new_web</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for rackconnnect automation to complete</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DFW</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts.ansible_facts[&#39;rax_metadata&#39;][&#39;rackconnect_automation_status&#39;]|default(&#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for managed cloud automation to complete</span>
      <span class="l-Scalar-Plain">local_action</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">module</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts</span>
        <span class="l-Scalar-Plain">credentials</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/.raxpub</span>
        <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">rax_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l-Scalar-Plain">region</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DFW</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_facts.ansible_facts[&#39;rax_metadata&#39;][&#39;rax_service_level_automation&#39;]|default(&#39;&#39;) == &#39;Complete&#39;</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Base Configure Servers</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">web</span>
  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openssh</span>
      <span class="l-Scalar-Plain">opensshd_PermitRootLogin</span><span class="p-Indicator">:</span> <span class="s">&quot;no&quot;</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ntp</span>
</pre></div>
</div>
</div>
<div class="section" id="using-ansible-pull">
<span id="id9"></span><h6>Using Ansible Pull<a class="headerlink" href="#using-ansible-pull" title="Permalink to this headline">¶</a></h6>
<div class="highlight-yaml"><div class="highlight"><pre><span class="nn">---</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ensure Rackconnect and Managed Cloud Automation is complete</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check for completed bootstrap</span>
      <span class="l-Scalar-Plain">stat</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/bootstrap_complete</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Get region</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xenstore-read vm-data/provider_data/region</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rax_region</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for rackconnect automation to complete</span>
      <span class="l-Scalar-Plain">uri</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span> <span class="s">&quot;https://{{</span><span class="nv"> </span><span class="s">rax_region.stdout|trim</span><span class="nv"> </span><span class="s">}}.api.rackconnect.rackspace.com/v1/automation_status?format=json&quot;</span>
        <span class="l-Scalar-Plain">return_content</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">automation_status</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">automation_status[&#39;automation_status&#39;]|default(&#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for managed cloud automation to complete</span>
      <span class="l-Scalar-Plain">wait_for</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/tmp/rs_managed_cloud_automation_complete</span>
        <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set bootstrap completed</span>
      <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/bootstrap_complete</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">touch</span>
        <span class="l-Scalar-Plain">owner</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
        <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0400</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Base Configure Servers</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openssh</span>
      <span class="l-Scalar-Plain">opensshd_PermitRootLogin</span><span class="p-Indicator">:</span> <span class="s">&quot;no&quot;</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ntp</span>
</pre></div>
</div>
</div>
<div class="section" id="using-ansible-pull-with-xenstore">
<span id="id10"></span><h6>Using Ansible Pull with XenStore<a class="headerlink" href="#using-ansible-pull-with-xenstore" title="Permalink to this headline">¶</a></h6>
<div class="highlight-yaml"><div class="highlight"><pre><span class="nn">---</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Ensure Rackconnect and Managed Cloud Automation is complete</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Check for completed bootstrap</span>
      <span class="l-Scalar-Plain">stat</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/bootstrap_complete</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for rackconnect_automation_status xenstore key to exist</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xenstore-exists vm-data/user-metadata/rackconnect_automation_status</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rcas_exists</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l-Scalar-Plain">failed_when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rcas_exists.rc|int &gt; 1</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rcas_exists.rc|int == 0</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for rackconnect automation to complete</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xenstore-read vm-data/user-metadata/rackconnect_automation_status</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rcas</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rcas.stdout|replace(&#39;&quot;&#39;, &#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for rax_service_level_automation xenstore key to exist</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xenstore-exists vm-data/user-metadata/rax_service_level_automation</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rsla_exists</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l-Scalar-Plain">failed_when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rsla_exists.rc|int &gt; 1</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rsla_exists.rc|int == 0</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for managed cloud automation to complete</span>
      <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">xenstore-read vm-data/user-metadata/rackconnect_automation_status</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rsla</span>
      <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">bootstrap.stat.exists != True</span>
      <span class="l-Scalar-Plain">until</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rsla.stdout|replace(&#39;&quot;&#39;, &#39;&#39;) == &#39;DEPLOYED&#39;</span>
      <span class="l-Scalar-Plain">retries</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">30</span>
      <span class="l-Scalar-Plain">delay</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Set bootstrap completed</span>
      <span class="l-Scalar-Plain">file</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/etc/bootstrap_complete</span>
        <span class="l-Scalar-Plain">state</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">touch</span>
        <span class="l-Scalar-Plain">owner</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
        <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
        <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0400</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Base Configure Servers</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">all</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">openssh</span>
      <span class="l-Scalar-Plain">opensshd_PermitRootLogin</span><span class="p-Indicator">:</span> <span class="s">&quot;no&quot;</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">role</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ntp</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="advanced-usage">
<span id="id11"></span><h4>Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permalink to this headline">¶</a></h4>
<div class="section" id="autoscaling-with-tower">
<span id="awx-autoscale"></span><h5>Autoscaling with Tower<a class="headerlink" href="#autoscaling-with-tower" title="Permalink to this headline">¶</a></h5>
<p><a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> also contains a very nice feature for auto-scaling use cases.
In this mode, a simple curl script can call a defined URL and the server will &#8220;dial out&#8221; to the requester
and configure an instance that is spinning up.  This can be a great way to reconfigure ephemeral nodes.
See the Tower documentation for more details.</p>
<p>A benefit of using the callback in Tower over pull mode is that job results are still centrally recorded
and less information has to be shared with remote hosts.</p>
</div>
<div class="section" id="orchestration-in-the-rackspace-cloud">
<span id="pending-information"></span><h5>Orchestration in the Rackspace Cloud<a class="headerlink" href="#orchestration-in-the-rackspace-cloud" title="Permalink to this headline">¶</a></h5>
<p>Ansible is a powerful orchestration tool, and rax modules allow you the opportunity to orchestrate complex tasks, deployments, and configurations.  The key here is to automate provisioning of infrastructure, like any other piece of software in an environment.  Complex deployments might have previously required manual manipulation of load balancers, or manual provisioning of servers.  Utilizing the rax modules included with Ansible, one can make the deployment of additional nodes contingent on the current number of running nodes, or the configuration of a clustered application dependent on the number of nodes with common metadata.  One could automate the following scenarios, for example:</p>
<ul class="simple">
<li>Servers that are removed from a Cloud Load Balancer one-by-one, updated, verified, and returned to the load balancer pool</li>
<li>Expansion of an already-online environment, where nodes are provisioned, bootstrapped, configured, and software installed</li>
<li>A procedure where app log files are uploaded to a central location, like Cloud Files, before a node is decommissioned</li>
<li>Servers and load balancers that have DNS records created and destroyed on creation and decommissioning, respectively</li>
</ul>
</div>
</div>
</div>
<span id="document-docs/guide_gce"></span><div class="section" id="google-cloud-platform-guide">
<h3>Google Cloud Platform Guide<a class="headerlink" href="#google-cloud-platform-guide" title="Permalink to this headline">¶</a></h3>
<div class="section" id="introduction">
<h4>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section of the documentation is under construction. We are in the process of adding more examples about all of the GCE modules and how they work together. Upgrades via github pull requests are welcomed!</p>
</div>
<p>Ansible contains modules for managing Google Compute Engine resources, including creating instances, controlling network access, working with persistent disks, and managing
load balancers.  Additionally, there is an inventory plugin that can automatically suck down all of your GCE instances into Ansible dynamic inventory, and create groups by tag and other properties.</p>
<p>The GCE modules all require the apache-libcloud module, which you can install from pip:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pip install apache-libcloud
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;re using Ansible on Mac OS X, libcloud also needs to access a CA cert chain. You&#8217;ll need to download one (you can get one for <a class="reference external" href="http://curl.haxx.se/docs/caextract.html">here</a>.)</p>
</div>
</div>
<div class="section" id="credentials">
<h4>Credentials<a class="headerlink" href="#credentials" title="Permalink to this headline">¶</a></h4>
<p>To work with the GCE modules, you&#8217;ll first need to get some credentials. You can create new one from the <a class="reference external" href="https://console.developers.google.com/">console</a> by going to the &#8220;APIs and Auth&#8221; section and choosing to create a new client ID for a service account. Once you&#8217;ve created a new client ID and downloaded (you must click <strong>Generate new P12 Key</strong>) the generated private key (in the <a class="reference external" href="http://en.wikipedia.org/wiki/PKCS_12">pkcs12 format</a>), you&#8217;ll need to convert the key by running the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>openssl pkcs12 -in pkey.pkcs12 -passin pass:notasecret -nodes -nocerts <span class="p">|</span> openssl rsa -out pkey.pem
</pre></div>
</div>
<p>There are two different ways to provide credentials to Ansible so that it can talk with Google Cloud for provisioning and configuration actions:</p>
<ul class="simple">
<li>by providing to the modules directly</li>
<li>by populating a <code class="docutils literal"><span class="pre">secrets.py</span></code> file</li>
</ul>
<div class="section" id="calling-modules-by-passing-credentials">
<h5>Calling Modules By Passing Credentials<a class="headerlink" href="#calling-modules-by-passing-credentials" title="Permalink to this headline">¶</a></h5>
<p>For the GCE modules you can specify the credentials as arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">service_account_email</span></code>: email associated with the project</li>
<li><code class="docutils literal"><span class="pre">pem_file</span></code>: path to the pem file</li>
<li><code class="docutils literal"><span class="pre">project_id</span></code>: id of the project</li>
</ul>
<p>For example, to create a new instance using the cloud module, you can use the following configuration:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance(s)</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">no</span>

  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">service_account_email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unique-id@developer.gserviceaccount.com</span>
    <span class="l-Scalar-Plain">pem_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/project.pem</span>
    <span class="l-Scalar-Plain">project_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">project-id</span>
    <span class="l-Scalar-Plain">machine_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">n1-standard-1</span>
    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">debian-7</span>

  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>

   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Launch instances</span>
     <span class="l-Scalar-Plain">gce</span><span class="p-Indicator">:</span>
         <span class="l-Scalar-Plain">instance_names</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dev</span>
         <span class="l-Scalar-Plain">machine_type</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">machine_type</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l-Scalar-Plain">service_account_email</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">service_account_email</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l-Scalar-Plain">pem_file</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">pem_file</span><span class="nv"> </span><span class="s">}}&quot;</span>
         <span class="l-Scalar-Plain">project_id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">project_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="calling-modules-with-secrets-py">
<h5>Calling Modules with secrets.py<a class="headerlink" href="#calling-modules-with-secrets-py" title="Permalink to this headline">¶</a></h5>
<p>Create a file <code class="docutils literal"><span class="pre">secrets.py</span></code> looking like following, and put it in some folder which is in your <code class="docutils literal"><span class="pre">$PYTHONPATH</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">GCE_PARAMS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;i...@project.googleusercontent.com&#39;</span><span class="p">,</span> <span class="s">&#39;/path/to/project.pem&#39;</span><span class="p">)</span>
<span class="n">GCE_KEYWORD_PARAMS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;project&#39;</span><span class="p">:</span> <span class="s">&#39;project_id&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Ensure to enter the email address from the created services account and not the one from your main account.</p>
<p>Now the modules can be used as above, but the account information can be omitted.</p>
</div>
</div>
<div class="section" id="gce-dynamic-inventory">
<h4>GCE Dynamic Inventory<a class="headerlink" href="#gce-dynamic-inventory" title="Permalink to this headline">¶</a></h4>
<p>The best way to interact with your hosts is to use the gce inventory plugin, which dynamically queries GCE and tells Ansible what nodes can be managed.</p>
<p>Note that when using the inventory script <code class="docutils literal"><span class="pre">gce.py</span></code>, you also need to populate the <code class="docutils literal"><span class="pre">gce.ini</span></code> file that you can find in the contrib/inventory directory of the ansible checkout.</p>
<p>To use the GCE dynamic inventory script, copy <code class="docutils literal"><span class="pre">gce.py</span></code> from <code class="docutils literal"><span class="pre">contrib/inventory</span></code> into your inventory directory and make it executable. You can specify credentials for <code class="docutils literal"><span class="pre">gce.py</span></code> using the <code class="docutils literal"><span class="pre">GCE_INI_PATH</span></code> environment variable &#8211; the default is to look for gce.ini in the same directory as the inventory script.</p>
<p>Let&#8217;s see if inventory is working:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>./gce.py --list
</pre></div>
</div>
<p>You should see output describing the hosts you have, if any, running in Google Compute Engine.</p>
<p>Now let&#8217;s see if we can use the inventory script to talk to Google.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ GCE_INI_PATH</span><span class="o">=</span>~/.gce.ini ansible all -i gce.py -m setup
hostname <span class="p">|</span> success &gt;&gt; <span class="o">{</span>
  <span class="s2">&quot;ansible_facts&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;ansible_all_ipv4_addresses&quot;</span>: <span class="o">[</span>
      <span class="s2">&quot;x.x.x.x&quot;</span>
    <span class="o">]</span>,
</pre></div>
</div>
<p>As with all dynamic inventory scripts in Ansible, you can configure the inventory path in ansible.cfg.  The recommended way to use the inventory is to create an <code class="docutils literal"><span class="pre">inventory</span></code> directory, and place both the <code class="docutils literal"><span class="pre">gce.py</span></code> script and a file containing <code class="docutils literal"><span class="pre">localhost</span></code> in it.  This can allow for cloud inventory to be used alongside local inventory (such as a physical datacenter) or machines running in different providers.</p>
<p>Executing <code class="docutils literal"><span class="pre">ansible</span></code> or <code class="docutils literal"><span class="pre">ansible-playbook</span></code> and specifying the <code class="docutils literal"><span class="pre">inventory</span></code> directory instead of an individual file will cause ansible to evaluate each file in that directory for inventory.</p>
<p>Let&#8217;s once again use our inventory script to see if it can talk to Google Cloud:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible all -i inventory/ -m setup
hostname <span class="p">|</span> success &gt;&gt; <span class="o">{</span>
  <span class="s2">&quot;ansible_facts&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;ansible_all_ipv4_addresses&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;x.x.x.x&quot;</span>
    <span class="o">]</span>,
</pre></div>
</div>
<p>The output should be similar to the previous command.  If you&#8217;re wanting less output and just want to check for SSH connectivity, use &#8220;-m&#8221; ping instead.</p>
</div>
<div class="section" id="use-cases">
<h4>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h4>
<p>For the following use case, let&#8217;s use this small shell script as a wrapper.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>
<span class="nv">PLAYBOOK</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>

<span class="k">if</span> <span class="o">[[</span> -z <span class="nv">$PLAYBOOK</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;You need to pass a playbook as argument to this script.&quot;</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="nb">export </span><span class="nv">SSL_CERT_FILE</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/cacert.cer
<span class="nb">export </span><span class="nv">ANSIBLE_HOST_KEY_CHECKING</span><span class="o">=</span>False

<span class="k">if</span> <span class="o">[[</span> ! -f <span class="s2">&quot;</span><span class="nv">$SSL_CERT_FILE</span><span class="s2">&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  curl -O http://curl.haxx.se/ca/cacert.pem
<span class="k">fi</span>

ansible-playbook -v -i inventory/ <span class="s2">&quot;</span><span class="nv">$PLAYBOOK</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="section" id="create-an-instance">
<h5>Create an instance<a class="headerlink" href="#create-an-instance" title="Permalink to this headline">¶</a></h5>
<p>The GCE module provides the ability to provision instances within Google Compute Engine. The provisioning task is typically performed from your Ansible control server against Google Cloud&#8217;s API.</p>
<p>A playbook would looks like this:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Create instance(s)</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
  <span class="l-Scalar-Plain">gather_facts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">no</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">local</span>

  <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">machine_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">n1-standard-1</span> <span class="c1"># default</span>
    <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">debian-7</span>
    <span class="l-Scalar-Plain">service_account_email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unique-id@developer.gserviceaccount.com</span>
    <span class="l-Scalar-Plain">pem_file</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/path/to/project.pem</span>
    <span class="l-Scalar-Plain">project_id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">project-id</span>

  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Launch instances</span>
      <span class="l-Scalar-Plain">gce</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">instance_names</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dev</span>
          <span class="l-Scalar-Plain">machine_type</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">machine_type</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">image</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l-Scalar-Plain">service_account_email</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">service_account_email</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l-Scalar-Plain">pem_file</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">pem_file</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l-Scalar-Plain">project_id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">project_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
          <span class="l-Scalar-Plain">tags</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">webserver</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gce</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Wait for SSH to come up</span>
      <span class="l-Scalar-Plain">wait_for</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">host={{ item.public_ip }} port=22 delay=10 timeout=60</span>
      <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gce.instance_data</span>

    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Add host to groupname</span>
      <span class="l-Scalar-Plain">add_host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">hostname={{ item.public_ip }} groupname=new_instances</span>
      <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gce.instance_data</span>

<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Manage new instances</span>
  <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">new_instances</span>
  <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ssh</span>
  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">True</span>
  <span class="l-Scalar-Plain">roles</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">base_configuration</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">production_server</span>
</pre></div>
</div>
<p>Note that use of the &#8220;add_host&#8221; module above creates a temporary, in-memory group.  This means that a play in the same playbook can then manage machines
in the &#8216;new_instances&#8217; group, if so desired.  Any sort of arbitrary configuration is possible at this point.</p>
</div>
<div class="section" id="configuring-instances-in-a-group">
<h5>Configuring instances in a group<a class="headerlink" href="#configuring-instances-in-a-group" title="Permalink to this headline">¶</a></h5>
<p>All of the created instances in GCE are grouped by tag.  Since this is a cloud, it&#8217;s probably best to ignore hostnames and just focus on group management.</p>
<p>Normally we&#8217;d also use roles here, but the following example is a simple one.  Here we will also use the &#8220;gce_net&#8221; module to open up access to port 80 on
these nodes.</p>
<p>The variables in the &#8216;vars&#8217; section could also be kept in a &#8216;vars_files&#8217; file or something encrypted with Ansible-vault, if you so choose.  This is just
a basic example of what is possible:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: Setup web servers
  hosts: tag_webserver
  gather_facts: no

  vars:
    machine_type: n1-standard-1 <span class="c"># default</span>
    image: debian-7
    service_account_email: unique-id@developer.gserviceaccount.com
    pem_file: /path/to/project.pem
    project_id: project-id

  roles:

    - name: Install lighttpd
      apt: <span class="nv">pkg</span><span class="o">=</span>lighttpd <span class="nv">state</span><span class="o">=</span>installed
      sudo: True

    - name: Allow HTTP
      local_action: gce_net
      args:
        fwname: <span class="s2">&quot;all-http&quot;</span>
        name: <span class="s2">&quot;default&quot;</span>
        allowed: <span class="s2">&quot;tcp:80&quot;</span>
        state: <span class="s2">&quot;present&quot;</span>
        service_account_email: <span class="s2">&quot;{{ service_account_email }}&quot;</span>
        pem_file: <span class="s2">&quot;{{ pem_file }}&quot;</span>
        project_id: <span class="s2">&quot;{{ project_id }}&quot;</span>
</pre></div>
</div>
<p>By pointing your browser to the IP of the server, you should see a page welcoming you.</p>
<p>Upgrades to this documentation are welcome, hit the github link at the top right of this page if you would like to make additions!</p>
</div>
</div>
</div>
<span id="document-docs/guide_vagrant"></span><div class="section" id="vagrantansible">
<h3>使用Vagrant和Ansible<a class="headerlink" href="#vagrantansible" title="Permalink to this headline">¶</a></h3>
<div class="section" id="vagrant-intro">
<span id="id1"></span><h4>简介<a class="headerlink" href="#vagrant-intro" title="Permalink to this headline">¶</a></h4>
<p>Vargrant是一个管理虚拟机环境的工具,允许你在不同的虚拟化和云平台 配置和使用可再生的工作环境.它也集成了Ansible作为对虚拟机的服务提供者,而且这两个工具配合的很好.</p>
<p>这个指南会叙述如何同时配合使用Vagrant和Ansible.</p>
<p>如果你对Vagrant还不了解,你应该看看这个文档 <a class="reference external" href="http://docs.vagrantup.com/v2/">the documentation</a>.</p>
<p>假设你已经安装了Ansible,在Git上检测,运行的也很好,查看下面的:doc:<cite>intro_installation</cite> 获取更多的信息.</p>
</div>
<div class="section" id="vagrant">
<span id="vagrant-setup"></span><h4>配置Vagrant<a class="headerlink" href="#vagrant" title="Permalink to this headline">¶</a></h4>
<p>第一步安装了Vagrant之后,创建一个 <code class="docutils literal"><span class="pre">Vagrantfile</span></code> ,修改它来适应你的需要.Vagrant文档里面已经包含了很多细节了,这里仅仅给出一个快速的参考实例</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>mkdir vagrant-test
<span class="nv">$ </span><span class="nb">cd </span>vagrant-test
<span class="nv">$ </span>vagrant init precise32 http://files.vagrantup.com/precise32.box
</pre></div>
</div>
<p>这会创建名称为 Vagrantfile 的文件,你可以编辑它适应你的需要.默认的Vagrantfile有很多注释.这里是一个简化的例子包括了一个使用ansible提供服务的部分.</p>
<div class="highlight-ruby"><div class="highlight"><pre><span class="c1">#Vagrant API/syntax 版本.不要修改它除非你知道你自己在做什么.</span>

<span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;precise32&quot;</span>
    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://files.vagrantup.com/precise32.box&quot;</span>

    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:public_network</span>

    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
        <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Vagrantfile 有很多选项,但这些是最重要的.注意 <code class="docutils literal"><span class="pre">config.vm.provision``部分,引用了叫做``playbook.yml</span></code> 的 Ansible playbook,它与Vagrantfile的在同样的目录里面.Vagrant 一旦虚拟机启动和已经准备好了ssh访问的时候.运行这个提供的服务(prvisoner)</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vagrant up
</pre></div>
</div>
<p>这将会启动VM和运行提供的playbook文件.</p>
<p>在你的Vagrantfile里面,有许多Ansible选项可以配置.有用的选项有 <code class="docutils literal"><span class="pre">ansible.extra_vars</span></code>, <code class="docutils literal"><span class="pre">ansible.sudo</span></code> 和 <code class="docutils literal"><span class="pre">ansible.sudo_user</span></code> , 和可以避免SSH对新的虚拟机的连接问题的 <code class="docutils literal"><span class="pre">ansible.host_key_checking</span></code></p>
<p>查看 <a class="reference external" href="http://docs.vagrantup.com/v2/provisioning/ansible.html">Ansible Provisioner documentation</a> 获取更多信息</p>
<p>重新运行一个在已存在的VM上的playbook,运行</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>vagrant provision
</pre></div>
</div>
<p>这将会重新运行playbook</p>
</div>
<div class="section" id="ansible">
<span id="running-ansible"></span><h4>手动运行Ansible<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h4>
<p>有时你想手动运行Ansible,而不是机器.这相对来说很简单.</p>
<p>Vargrant自动的为Vagrant机器创建清单文件,存在相同的目录下面 <code class="docutils literal"><span class="pre">.vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory</span></code>.它根据Vagrant自动创建的SSH管道配置清单文件,执行``ansible-playbook`` 使用正确的用户名和SSH密钥选项来访问.一个典型的自动创建清单文件的例子看起来就像下面这样.</p>
<div class="highlight-none"><div class="highlight"><pre># Generated by Vagrant

machine ansible_ssh_host=127.0.0.1 ansible_ssh_port=2222
</pre></div>
</div>
<p>如果你想运行Ansible手动的,你会想确保是否传递给``ansible`` 或者 <code class="docutils literal"><span class="pre">ansible-playbook</span></code> 命令正确的参数,和自动生成了清单文件.</p>
<p>这是一个例子</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>ansible-playbook -i .vagrant/provisioners/ansible/inventory/vagrant_ansible_inventory --private-key<span class="o">=</span>.vagrant/machines/default/virtualbox/private_key -u vagrant playbook.yml
</pre></div>
</div>
<p>注意:Vagrant地域1.7.0的版本会使用私钥位于``~/.vagrant.d/insecure_private_key.``</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="http://www.vagrantup.com/">Vagrant Home</a></dt>
<dd>The Vagrant homepage with downloads</dd>
<dt><a class="reference external" href="http://docs.vagrantup.com/v2/">Vagrant Documentation</a></dt>
<dd>Vagrant Documentation</dd>
<dt><a class="reference external" href="http://docs.vagrantup.com/v2/provisioning/ansible.html">Ansible Provisioner</a></dt>
<dd>The Vagrant documentation for the Ansible provisioner</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/guide_rolling_upgrade"></span><div class="section" id="id1">
<h3>持续交付与滚动升级<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="lamp-introduction">
<span id="id2"></span><h4>介绍<a class="headerlink" href="#lamp-introduction" title="Permalink to this headline">¶</a></h4>
<p>持续交付是频繁对软件应用程序持续更新的概念.</p>
<p>这个想法使在大量频繁的更新面前, 你不必等待在一个指定的特殊时间点, 并且使你的组织在响应过程中变得更好.</p>
<p>一些 Ansible 用户每小时都在部署更新给他们的最终用户甚至更加频繁 &#8211; 每时每刻都有代码修改的批准. 要实现这一点, 你需要工具能在零停机的时间内快速的应用这些更新.</p>
<p>本文档详细介绍了如何现实这一目标, 使用 Ansible playbooks 作为一个完整例子的模板: lamp_haproxy. 这个例子使用了大量的 Ansible 特性: roles, templates 和 group variables, 并且它还配备了一个业务流程的 playbook 可以做到零停机滚动升级 web 应用程序栈.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><a class="reference external" href="https://github.com/ansible/ansible-examples/tree/master/lamp_haproxy">点击这里查看最新版本的 playbook 例子</a>.</p>
</div>
<p>这个 playbooks 基于 CentOS 部署 Apache, PHP, MySQL, Nagios, 和 HAProxy 这些服务.</p>
<p>在这里我们不去讨论如何运行这些 playbooks. 阅读包含在 github 项目中关于这个例子的 README 信息. 相反的, 我们将进一步观察这些 playbook 并且去解释它们.</p>
</div>
<div class="section" id="lamp-deployment">
<span id="id3"></span><h4>部署网站<a class="headerlink" href="#lamp-deployment" title="Permalink to this headline">¶</a></h4>
<p>让我们首先使用 <code class="docutils literal"><span class="pre">site.yml</span></code>. 这是我们网站部署的 playbook. 它被用来部署我们最初的网站以及推送更新到所有的服务器:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># 这个 playbook 在这个网站上部署整个应用程序.</span>

<span class="c"># 应用通用的配置到所有的主机上</span>
- hosts: all

  roles:
  - common

<span class="c"># 配置和部署数据库服务器.</span>
- hosts: dbservers

  roles:
  - db

<span class="c"># 配置和部署 web 服务器. 注意这里我们包含了两个 roles, 这个 &#39;base-apache&#39; role 用来简单设置 Apache, 而 &#39;web&#39; 则包含了我们的 web 应用程序.</span>

- hosts: webservers

  roles:
  - base-apache
  - web

<span class="c"># 配置和部署 load balancer(s).</span>
- hosts: lbservers

  roles:
  - haproxy

<span class="c"># 配置和部署 Nagios 监控节点(s).</span>
- hosts: monitoring

  roles:
  - base-apache
  - nagios
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果你不熟悉 playbooks 和 plays, 你应该回顾 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a>.</p>
</div>
<p>在这个 palybook 我们有 5 个 plays. 首先第一个目标 <code class="docutils literal"><span class="pre">all</span></code> (所有)主机和适用于所有主机的 <code class="docutils literal"><span class="pre">common</span></code> role. 这是整个网站要做的事像 yum 仓库的配置, 防火墙的配置, 和其他任何需要适用于所有服务器的配置.</p>
<p>接下来的这四个 plays 将运行于指定的主机组并特定的角色应用于这些服务器. 随着对 Nagios monitoring, 数据库角色, 和 web应用程序的应用, 我们可以通过 <code class="docutils literal"><span class="pre">base-apache</span></code> 角色安装和配置一个基本的 Apache. 这是 Nagios 主机和 web 应用程序所需要的.</p>
</div>
<div class="section" id="roles">
<span id="lamp-roles"></span><h4>可重用的: Roles<a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h4>
<p>关于 roles 你现在应该有一点了解以及它们是如何工作的. Roles 是组织: tasks, handlers, templates, 和 files, 到可重用的组件中的方法.</p>
<p>这个例子有 6 个 roles: <code class="docutils literal"><span class="pre">common</span></code>, <code class="docutils literal"><span class="pre">base-apache</span></code>, <code class="docutils literal"><span class="pre">db</span></code>, <code class="docutils literal"><span class="pre">haproxy</span></code>, <code class="docutils literal"><span class="pre">nagios</span></code>, 和 <code class="docutils literal"><span class="pre">web</span></code>.
你如何组织你的 roles 是由你和你的应用程序所决定, 但是大部分网站都将适用一个或多个共同的 roles, 和一些列关于应用程序特定的 roles 来安装和配置这个网站的特定部分.</p>
<p>Roles 可以用变量和依赖关系, 你可以通过参数来调整它们的行为.
你可以在 <a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a> 章节中阅读更多关于 roles</p>
</div>
<div class="section" id="group-variables">
<span id="lamp-group-variables"></span><h4>配置: Group Variables<a class="headerlink" href="#group-variables" title="Permalink to this headline">¶</a></h4>
<p>Group variables 是应用在服务器组上的. 通过设置和修改参数将他们应用在 templates 中来定义 playbooks 的行为. 他们被存储在和你的 inventory 相同目录下名为 <code class="docutils literal"><span class="pre">group_vars</span></code> 的目录中.
下面是 lamp_haproxy 的 <code class="docutils literal"><span class="pre">group_vars/all</span></code> 文件内容. 正如你所期望的, 这些变量将会应用到 inventory 中的所有服务器上:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
httpd_port: 80
ntpserver: 192.168.1.2
</pre></div>
</div>
<p>这是一个 YAML 文件, 并且你可以创建列表和字典等更加复杂的变量结构. 在这种情况下, 我们只设置了两个变量, 一个做为 web server 的端口, 一个作为我们服务器所使用的时间同步 NTP 服务的地址.</p>
<p>这是另外一个 group variables 文件. 这个 <code class="docutils literal"><span class="pre">group_vars/dbservers</span></code> 适用于在 <code class="docutils literal"><span class="pre">dbservers</span></code> 组中的主机:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
mysqlservice: mysqld
mysql_port: 3306
dbuser: root
dbname: foodb
upassword: usersecret
</pre></div>
</div>
<p>如果你看了这个例子, 你会发现对于 <code class="docutils literal"><span class="pre">webservers</span></code> 组合 <code class="docutils literal"><span class="pre">lbservers</span></code> 组的 group variables 十分相似.</p>
<p>这些变量可以用于任何地方. 你可以在 playbooks 中使用它们, 像这样, 在 <code class="docutils literal"><span class="pre">roles/db/tasks/main.yml</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre>- name: Create Application Database
  mysql_db: <span class="nv">name</span><span class="o">={{</span> dbname <span class="o">}}</span> <span class="nv">state</span><span class="o">=</span>present

- name: Create Application DB User
  mysql_user: <span class="nv">name</span><span class="o">={{</span> dbuser <span class="o">}}</span> <span class="nv">password</span><span class="o">={{</span> upassword <span class="o">}}</span>
              <span class="nv">priv</span><span class="o">=</span>*.*:ALL <span class="nv">host</span><span class="o">=</span><span class="s1">&#39;%&#39;</span> <span class="nv">state</span><span class="o">=</span>present
</pre></div>
</div>
<p>你也可以在 templates 中使用这些变量, 想这样, 在 <code class="docutils literal"><span class="pre">roles/common/templates/ntp.conf.j2</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre>driftfile /var/lib/ntp/drift

restrict 127.0.0.1
restrict -6 ::1

server <span class="o">{{</span> ntpserver <span class="o">}}</span>

includefile /etc/ntp/crypto/pw

keys /etc/ntp/keys
</pre></div>
</div>
<p>你可以看到这些变量替换的语法 {{ and }} 和 templates 中的变量是相同的. 这种花括号格式是采用的jinj2语法, 你在对于内部的数据做各种操作及应用不同的过滤器. 在 templates, 你也可以使用循环和 if 语句来处理更加复杂的情况, 想这样, 在 <code class="docutils literal"><span class="pre">roles/common/templates/iptables.j2</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>% <span class="k">if</span> inventory_hostname in groups<span class="o">[</span><span class="s1">&#39;dbservers&#39;</span><span class="o">]</span> %<span class="o">}</span>
-A INPUT -p tcp  --dport <span class="m">3306</span> -j  ACCEPT
<span class="o">{</span>% endif %<span class="o">}</span>
</pre></div>
</div>
<p>这是用来判断, 名为 (<code class="docutils literal"><span class="pre">inventory_hostname</span></code>) 的机器是否存在于组 <code class="docutils literal"><span class="pre">dbservers</span></code>. 如果这样的话, 该机器将会添加一条 目标端口为 3306 的 iptables 允许规则.</p>
<p>这有一些其他的例子, 来自相同的模板:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>% <span class="k">for</span> host in groups<span class="o">[</span><span class="s1">&#39;monitoring&#39;</span><span class="o">]</span> %<span class="o">}</span>
-A INPUT -p tcp -s <span class="o">{{</span> hostvars<span class="o">[</span>host<span class="o">]</span>.ansible_default_ipv4.address <span class="o">}}</span> --dport <span class="m">5666</span> -j ACCEPT
<span class="o">{</span>% endfor %<span class="o">}</span>
</pre></div>
</div>
<p>这里循环了一个组名为 <code class="docutils literal"><span class="pre">monitoring</span></code> 中的所有主机, 并且配置了源地址为所有监控主机的 IPV4 地址目标端口为 5666 的 iptables 允许规则到当前主机上, 正因为如此 Nagios 才可以监控这些主机.</p>
<p>你可以学到更多关于 Jinja2 的功能 <a class="reference external" href="http://jinja.pocoo.org/docs/">here</a>, 并且你可以读到更多关于 Ansible 所有的变量在这个 <a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a> 章节</p>
</div>
<div class="section" id="lamp-rolling-upgrade">
<span id="id4"></span><h4>滚动升级<a class="headerlink" href="#lamp-rolling-upgrade" title="Permalink to this headline">¶</a></h4>
<p>现在你有了一个全面的网站包含 web servers, 一个 load balancer, 和 monitoring. 如何更新它? 这就是 Ansible 的特殊功能发挥作用. 尽管一些应用程序使用&#8217;业务流程&#8217;来编排命令执行的逻辑, Ansible将指挥编排这些机器, 并且拥有一个相当复杂的引擎.</p>
<p>Ansible 有能力在一次操作中协调多种应用程序, 使在进行更新升级我们的 web 应用程序时更加实现零停机时间. 这是一个单独的 playbook, 叫做 <code class="docutils literal"><span class="pre">roleing_upgrade.yml</span></code>.</p>
<p>看这个 playbook, 你可以看到它是由两个 plays 组成. 首先第一个看起来十分简单像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: monitoring
  tasks: <span class="o">[]</span>
</pre></div>
</div>
<p>这里要做什么, 为什么没有 tasks? 你可能知道 Ansible 在运行之前会从服务上收集 &#8220;facts&#8221;. 这些 facts 是很多种有用的信息: 网络信息, OS/发行版本, 配置. 在我们的方案中, 在更新之前我们需要了解关于所有监控服务器的环境信息, 因此这个简单的 paly 将会在我们的所监控的服务器上强制收集 fact 信息. 你有时会见到这种模式, 这是一个有用的技巧.</p>
<p>接下来的部分是更新 play. 第一部分看起来是这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>- hosts: webservers
  user: root
  serial: 1
</pre></div>
</div>
<p>我们仅仅是像通常一样在 <code class="docutils literal"><span class="pre">webservers</span></code> 组中定义了 play. 这个 <code class="docutils literal"><span class="pre">serial</span></code> 关键字告诉 Ansible 每次操作多少服务器. 如果它没有被指定, Ansible 默认根据配置文件中 &#8220;forks&#8221; 限制指定的值进行并发操作. 但是对于零停机时间的更新, 你可能不希望一次操作多个主机. 如果你仅仅有少数的 web 服务器, 你可能希望设置 <code class="docutils literal"><span class="pre">serial</span></code> 为 1, 在同一时间只执行一台主机. 如果你有 100 台, 你可以设置 <code class="docutils literal"><span class="pre">serial</span></code> 为 10, 同一时间执行 10 台.</p>
<p>下面是更新 play 接下来的部分:</p>
<div class="highlight-bash"><div class="highlight"><pre>pre_tasks:
- name: disable nagios alerts <span class="k">for</span> this host webserver service
  nagios: <span class="nv">action</span><span class="o">=</span>disable_alerts <span class="nv">host</span><span class="o">={{</span> inventory_hostname <span class="o">}}</span> <span class="nv">services</span><span class="o">=</span>webserver
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: groups.monitoring

- name: disable the server in haproxy
  shell: <span class="nb">echo</span> <span class="s2">&quot;disable server myapplb/{{ inventory_hostname }}&quot;</span> <span class="p">|</span> socat stdio /var/lib/haproxy/stats
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: groups.lbservers
</pre></div>
</div>
<p>这个 <code class="docutils literal"><span class="pre">pre_tasks</span></code> 关键字仅仅是让在 roles 调用前列出运行的 tasks. 这段时间将十分有用. 如果你看到这些 tasks 的名称, 你会发现我们禁用了 Nagios 的报警并且将当前更新的服务器从 HAProxy load balancing pool 中移除.</p>
<p>参数``delegate_to`` 和 <code class="docutils literal"><span class="pre">with_items</span></code> 一起来使用, 因为 Ansible 循环每一个 monitoring 服务器和 load balancer, 并且针对循环的值在 monitoring 或 load balancing 上操作(delegate 代表操作). 从编程方面来说, 外部的循环是 web 服务器列表, 内部的循环是 monitoring 服务器列表.</p>
<p>请注意 HAProxy 的步骤看起来有点复杂. 我们使用它作为例子是因为它是免费的, 但如果你有(例如)一个 F5 或 Netscaler 在你的基础设施上(或者你有一个 AWS 弹性 IP 的设置?), 你可以使用 Ansible 的模块而不是直接和他们进行交互. 你也可能希望使用其他的 monitoring 模块来代替 nagios, 但是这仅仅是展示了在任务开始前的部分 &#8211; 把服务从监控中移除并且轮换它们.</p>
<p>下一步重新简单的使正确的角色应用在 web 服务器上. 这将导致一些名为 <code class="docutils literal"><span class="pre">web</span></code> 和 <code class="docutils literal"><span class="pre">base-apache</span></code> 的配置管理角色应用到 web 服务器上, 包含一个更新 web 应用程序自身代码. 我们不需要这样做 &#8211; 我们仅需要将其修改为纯碎的更新 web 程序, 但是这是一个很好的例子关于如何通过 roles 来重用这些任务:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles:
- common
- base-apache
- web
</pre></div>
</div>
<p>最后, 在 <code class="docutils literal"><span class="pre">post_tasks</span></code> 部分, 我们反向的改变 Nagios 的配置并且将 web 服务器重新添加到 load balancing pool:</p>
<div class="highlight-bash"><div class="highlight"><pre>post_tasks:
- name: Enable the server in haproxy
  shell: <span class="nb">echo</span> <span class="s2">&quot;enable server myapplb/{{ inventory_hostname }}&quot;</span> <span class="p">|</span> socat stdio /var/lib/haproxy/stats
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: groups.lbservers

- name: re-enable nagios alerts
  nagios: <span class="nv">action</span><span class="o">=</span>enable_alerts <span class="nv">host</span><span class="o">={{</span> inventory_hostname <span class="o">}}</span> <span class="nv">services</span><span class="o">=</span>webserver
  delegate_to: <span class="s2">&quot;{{ item }}&quot;</span>
  with_items: groups.monitoring
</pre></div>
</div>
<p>再一次说明, 如果你在使用一个 Netscaler 或 F5 或 Elastic 的负载均衡器, 你仅仅需要替换为适合的模块对象.</p>
</div>
<div class="section" id="lamp-end-notes">
<span id="id5"></span><h4>管理其他的负载均衡<a class="headerlink" href="#lamp-end-notes" title="Permalink to this headline">¶</a></h4>
<p>在这个例子中, 我们使用了简单的 HAProxy 负载均衡到后端的 web 服务器. 它是非常容易配置和管理的. 正如我们所提到的, Ansible 已经为其他的负载均衡器像 Citrix NetScaler, F5 BigIP, Amazon Elastic Load Balancers 等提供了内建的支持.阅读更多信息 <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></p>
<p>对于其他的负载均衡器, 如果公开一个负载均衡时, 你可能需要向它们发送 shell 命令 (像上面我们对 HAProxy 一样), 或者调用一些 API. 你可以越多更多关于 local actions 在这个 <a class="reference internal" href="index.html#document-docs/playbooks_delegation"><em>委托,滚动更新,本地动作</em></a> 章节中. 对于一些硬件的开发将更加有趣, 他们没有一个核心模块, 所以你可以使用更好的模块将他们封装起来!</p>
</div>
<div class="section" id="lamp-end-to-end">
<span id="id6"></span><h4>持续交付结束<a class="headerlink" href="#lamp-end-to-end" title="Permalink to this headline">¶</a></h4>
<p>现在你有一个自动化的方式来部署更新你的应用程序, 你将如何将他们绑定在一起? 许多组织使用持续集成的工具像 <a class="reference external" href="http://jenkins-ci.org/">Jenkins</a> 或 <a class="reference external" href="https://www.atlassian.com/software/bamboo">Atlassian Bamboo</a> 来完成开发, 测试, 发布, 和部署这样的流程步骤. 你也可以使用这些工具像 <a class="reference external" href="https://code.google.com/p/gerrit/">Gerrit</a> 来添加一个 code review 的步骤来审查提交的应用程序的本身或者 Ansible playbooks.</p>
<p>根据你的环境, 你可能会部署到一个测试环境, 在这个环境中运行一些集成测试, 然后自动部署到生产环境. 你可以保持他们的简单性仅按需来进行滚动升级到测试或者指定的生产环境中. 这些你都随你决定.</p>
<p>与持续集成工具的结合, 你可以通过 <code class="docutils literal"><span class="pre">ansible-playbook</span></code> 命令行工具很容易的触发 playbook 的运行, 或者, 如果你使用 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a>, <code class="docutils literal"><span class="pre">tower-cli</span></code> 或者内置的 REST API. (这个 tower-cli 命令的 &#8216;joblaunch&#8217; 将通过 REST API 远程产生一个 job 这非常棒).</p>
<p>Ansible 对于如何组合多层应用程序在任务编排和持续交付给客户的最终目标上给了你很好的主意. 你可以使用滚动升级的思路来扩展一些应用程序之间的不同部分; 也许向前端 web 服务器添加后端应用服务, 例如, 使用 MongoDB 或 Riak 来替换 SQL 数据库. Ansible 可以给你在复杂的环境中轻松完成常见的自动化操作.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples/tree/master/lamp_haproxy">lamp_haproxy example</a></dt>
<dd>The lamp_haproxy example discussed here.</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a></dt>
<dd>An introduction to playbook roles</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_variables"><em>Variables</em></a></dt>
<dd>An introduction to Ansible variables</dd>
<dt><a class="reference external" href="http://www.ansible.com/ansible-continuous-delivery">Ansible.com: Continuous Delivery</a></dt>
<dd>An introduction to Continuous Delivery with Ansible</dd>
</dl>
</div>
</div>
</div>
</div>
<p>即将包含的,目前未定的主题包括: Docerk,Jenkins , Google Compute Engine, Linode/DigitalOcean, Continuous Deployment,等等</p>
</div>
<span id="document-docs/developing"></span><div class="section" id="id1">
<h2>开发者须知<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>学习如何使用其他语言开发自己的模块,并且通过各种插件来扩展Ansible.探索Ansible的Python API,并且编写Python插件,将其结合到你自己系统的各种解决方案中,这是非常有意义的.</p>
<div class="toctree-wrapper compound">
<span id="document-docs/developing_api"></span><div class="section" id="python-api">
<h3><a class="toc-backref" href="#id4">Python API</a><a class="headerlink" href="#python-api" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#python-api" id="id4">Python API</a><ul>
<li><a class="reference internal" href="#id1" id="id5">Python API</a><ul>
<li><a class="reference internal" href="#detailed-api-example" id="id6">更具体的例子</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>本章将展示几种有趣的Ansible API调用方式.你可以使用Ansible的Python API来管理节点,可以通过扩展Ansible来响应大量的Python事件,你可以写各种的插件,并且,你可以通过插件来调取外部数据源.本文主要向读者简单介绍一下 Runner 和 Playbook 的API.</p>
<p>如果你想使用除Python的其他方法调用Ansible,使用其异步回调事件,或者访问控制,日志管理,可以访问 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a>,它提供了非常丰富的 REST API.</p>
<p>此外,Ansible本身也是基于他本身的API来实现的,所以你将拥有足够的权限来进行二次封装.本章将讨论Python API的使用.</p>
<div class="section" id="id1">
<span id="id2"></span><h4><a class="toc-backref" href="#id5">Python API</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Ansible的Python API 功能十分强大,它造就了ansible CLI和ansible-playbook.</p>
<p>以下是一个简单调用的例子:</p>
<div class="highlight-bash"><div class="highlight"><pre>import ansible.runner

<span class="nv">runner</span> <span class="o">=</span> ansible.runner.Runner<span class="o">(</span>
   <span class="nv">module_name</span><span class="o">=</span><span class="s1">&#39;ping&#39;</span>,
   <span class="nv">module_args</span><span class="o">=</span><span class="s1">&#39;&#39;</span>,
   <span class="nv">pattern</span><span class="o">=</span><span class="s1">&#39;web*&#39;</span>,
   <span class="nv">forks</span><span class="o">=</span>10
<span class="o">)</span>
<span class="nv">datastructure</span> <span class="o">=</span> runner.run<span class="o">()</span>
</pre></div>
</div>
<p>该方法将返回每个host主机是否可以被ping通.返回类型详情请参阅 <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a>.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
    <span class="s2">&quot;dark&quot;</span> : <span class="o">{</span>
       <span class="s2">&quot;web1.example.com&quot;</span> : <span class="s2">&quot;failure message&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;contacted&quot;</span> : <span class="o">{</span>
       <span class="s2">&quot;web2.example.com&quot;</span> : 1
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>每个模型均可以返回任意JSON格式数据,所以Ansible可以作为一个框架被封装在各种应用程序和脚本之中.</p>
<div class="section" id="detailed-api-example">
<span id="id3"></span><h5><a class="toc-backref" href="#id6">更具体的例子</a><a class="headerlink" href="#detailed-api-example" title="Permalink to this headline">¶</a></h5>
<p>以下的脚本将打印出所有机器的运行时间和系统负载信息:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span>

import ansible.runner
import sys

<span class="c"># 构造ansible runner 并且开启10个线程向远程主机执行uptime命令</span>
<span class="nv">results</span> <span class="o">=</span> ansible.runner.Runner<span class="o">(</span>
    <span class="nv">pattern</span><span class="o">=</span><span class="s1">&#39;*&#39;</span>, <span class="nv">forks</span><span class="o">=</span>10,
    <span class="nv">module_name</span><span class="o">=</span><span class="s1">&#39;command&#39;</span>, <span class="nv">module_args</span><span class="o">=</span><span class="s1">&#39;/usr/bin/uptime&#39;</span>,
<span class="o">)</span>.run<span class="o">()</span>

<span class="k">if</span> results is None:
   print <span class="s2">&quot;No hosts found&quot;</span>
   sys.exit<span class="o">(</span>1<span class="o">)</span>

print <span class="s2">&quot;UP ***********&quot;</span>
<span class="k">for</span> <span class="o">(</span>hostname, result<span class="o">)</span> in results<span class="o">[</span><span class="s1">&#39;contacted&#39;</span><span class="o">]</span>.items<span class="o">()</span>:
    <span class="k">if</span> not <span class="s1">&#39;failed&#39;</span> in result:
        print <span class="s2">&quot;%s &gt;&gt;&gt; %s&quot;</span> % <span class="o">(</span>hostname, result<span class="o">[</span><span class="s1">&#39;stdout&#39;</span><span class="o">])</span>

print <span class="s2">&quot;FAILED *******&quot;</span>
<span class="k">for</span> <span class="o">(</span>hostname, result<span class="o">)</span> in results<span class="o">[</span><span class="s1">&#39;contacted&#39;</span><span class="o">]</span>.items<span class="o">()</span>:
    <span class="k">if</span> <span class="s1">&#39;failed&#39;</span> in result:
        print <span class="s2">&quot;%s &gt;&gt;&gt; %s&quot;</span> % <span class="o">(</span>hostname, result<span class="o">[</span><span class="s1">&#39;msg&#39;</span><span class="o">])</span>

print <span class="s2">&quot;DOWN *********&quot;</span>
<span class="k">for</span> <span class="o">(</span>hostname, result<span class="o">)</span> in results<span class="o">[</span><span class="s1">&#39;dark&#39;</span><span class="o">]</span>.items<span class="o">()</span>:
    print <span class="s2">&quot;%s &gt;&gt;&gt; %s&quot;</span> % <span class="o">(</span>hostname, result<span class="o">)</span>
</pre></div>
</div>
<p>高级的开发人员可能会去阅读ansible的源码,但使用 Runner() API （使用它能提供的选项）可以增强命令行执行 <code class="docutils literal"><span class="pre">ansible</span></code> 和 <code class="docutils literal"><span class="pre">ansible-playbook</span></code> 的功能.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/developing_inventory"><em>开发动态的Inventory数据源</em></a></dt>
<dd>Developing dynamic inventory integrations</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>How to develop modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a></dt>
<dd>How to develop plugins</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Development Mailing List</a></dt>
<dd>Mailing list for development topics</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-docs/developing_inventory"></span><div class="section" id="inventory">
<h3>开发动态的Inventory数据源<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h3>
<div class="contents local topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#inventory-script-conventions" id="id3">脚本规范</a></li>
<li><a class="reference internal" href="#inventory-script-tuning" id="id4">开启调用外部Inventory脚本</a></li>
</ul>
</div>
<p>如 <a class="reference internal" href="index.html#document-docs/intro_dynamic_inventory"><em>动态 Inventory</em></a> 所介绍,ansible可以从一个动态的数据源获取到inventory信息,包含云端数据源</p>
<p>怎么写一个自己的数据源?</p>
<p>很简单！我们仅仅需要创建一个在适当参数下,能够返回正确JSON格式数据的脚本或者程序,你可以使用任何语言来实现.</p>
<div class="section" id="inventory-script-conventions">
<span id="id1"></span><h4><a class="toc-backref" href="#id3">脚本规范</a><a class="headerlink" href="#inventory-script-conventions" title="Permalink to this headline">¶</a></h4>
<p>当我们在外部使用``&#8211;list``参数调用这个脚本时,这个脚本必须返回一个JSON散列/字典,它包含所管理的所有组.每个组的value应该是一个关于其包含的主机/IP哈希/字典,它可能是一个子组或者组的变量或者仅仅是一个主机/IP的列表, 例如:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
    <span class="s2">&quot;databases&quot;</span>   : <span class="o">{</span>
        <span class="s2">&quot;hosts&quot;</span>   : <span class="o">[</span> <span class="s2">&quot;host1.example.com&quot;</span>, <span class="s2">&quot;host2.example.com&quot;</span> <span class="o">]</span>,
        <span class="s2">&quot;vars&quot;</span>    : <span class="o">{</span>
            <span class="s2">&quot;a&quot;</span>   : <span class="nb">true</span>
        <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&quot;webservers&quot;</span>  : <span class="o">[</span> <span class="s2">&quot;host2.example.com&quot;</span>, <span class="s2">&quot;host3.example.com&quot;</span> <span class="o">]</span>,
    <span class="s2">&quot;atlanta&quot;</span>     : <span class="o">{</span>
        <span class="s2">&quot;hosts&quot;</span>   : <span class="o">[</span> <span class="s2">&quot;host1.example.com&quot;</span>, <span class="s2">&quot;host4.example.com&quot;</span>, <span class="s2">&quot;host5.example.com&quot;</span> <span class="o">]</span>,
        <span class="s2">&quot;vars&quot;</span>    : <span class="o">{</span>
            <span class="s2">&quot;b&quot;</span>   : <span class="nb">false</span>
        <span class="o">}</span>,
        <span class="s2">&quot;children&quot;</span>: <span class="o">[</span> <span class="s2">&quot;marietta&quot;</span>, <span class="s2">&quot;5points&quot;</span> <span class="o">]</span>
    <span class="o">}</span>,
    <span class="s2">&quot;marietta&quot;</span>    : <span class="o">[</span> <span class="s2">&quot;host6.example.com&quot;</span> <span class="o">]</span>,
    <span class="s2">&quot;5points&quot;</span>     : <span class="o">[</span> <span class="s2">&quot;host7.example.com&quot;</span> <span class="o">]</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.0.</span></p>
</div>
<p>在版本1.0之前,每一个组只能是一个包含hostnames/IP Address的列表,像上面的webservers, marietta, 5points组</p>
<p>当我们使用``&#8211;host &lt;hostname&gt;``(这里的&lt;hostname&gt;只指相对上面数据中的host)参数调用时,这个脚本必须返回一条空的JSON 哈希/字典, 或者关于变量的JSON哈希/字典,这些变量将被用来模板或者playbooks. 返回变量是可选的,如果脚本不希望这样做,返回一条空的哈希/字典即可:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
    <span class="s2">&quot;favcolor&quot;</span>   : <span class="s2">&quot;red&quot;</span>,
    <span class="s2">&quot;ntpserver&quot;</span>  : <span class="s2">&quot;wolf.example.com&quot;</span>,
    <span class="s2">&quot;monitoring&quot;</span> : <span class="s2">&quot;pack.example.com&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="inventory-script-tuning">
<span id="id2"></span><h4><a class="toc-backref" href="#id4">开启调用外部Inventory脚本</a><a class="headerlink" href="#inventory-script-tuning" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.3.</span></p>
</div>
<p>这个inventory脚本系统在所有的Ansible版本中都将会被调用,但是当使用``&#8211;host``参数操作每一台主机时,这将是十分麻烦(低效率),尤其是当它用在调用远程子系统时.在Ansible 1.3以后的版本(包含1.3),如果inventory脚本返回的顶级元素为&#8221;_meta&#8221;,它可能会返回所有主机的变量.如果这个元素中包含一个名为&#8221;hostvars&#8221;的value,这个inventory脚本对每一台主机使用``&#8211;host``时将不会被调用.这将大大增加主机的执行效率,并且也使客户端更容易实现这个脚本的数据缓存.</p>
<p>这个数据将会被添加到JSON字典的顶级,像下面的格式:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>

    <span class="c"># results of inventory script as above go here</span>
    <span class="c"># inventory脚本将到此终止</span>
    <span class="c"># ...</span>

    <span class="s2">&quot;_meta&quot;</span> : <span class="o">{</span>
       <span class="s2">&quot;hostvars&quot;</span> : <span class="o">{</span>
          <span class="s2">&quot;moocow.example.com&quot;</span>     : <span class="o">{</span> <span class="s2">&quot;asdf&quot;</span> : <span class="m">1234</span> <span class="o">}</span>,
          <span class="s2">&quot;llama.example.com&quot;</span>      : <span class="o">{</span> <span class="s2">&quot;asdf&quot;</span> : <span class="m">5678</span> <span class="o">}</span>,
       <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/developing_api"><em>Python API</em></a></dt>
<dd>Python API to Playbooks and Ad Hoc Task Execution</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>How to develop modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a></dt>
<dd>How to develop plugins</dd>
<dt><a class="reference external" href="http://ansible.com/ansible-tower">Ansible Tower</a></dt>
<dd>REST API endpoint and GUI for Ansible, syncs with dynamic inventory</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Development Mailing List</a></dt>
<dd>Mailing list for development topics</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/developing_modules"></span><div class="section" id="developing-modules">
<h3><a class="toc-backref" href="#id4">Developing Modules</a><a class="headerlink" href="#developing-modules" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#developing-modules" id="id4">Developing Modules</a><ul>
<li><a class="reference internal" href="#tutorial" id="id5">Tutorial</a></li>
<li><a class="reference internal" href="#testing-modules" id="id6">Testing Modules</a></li>
<li><a class="reference internal" href="#reading-input" id="id7">Reading Input</a></li>
<li><a class="reference internal" href="#module-provided-facts" id="id8">Module Provided &#8216;Facts&#8217;</a></li>
<li><a class="reference internal" href="#common-module-boilerplate" id="id9">Common Module Boilerplate</a></li>
<li><a class="reference internal" href="#check-mode" id="id10">Check Mode</a></li>
<li><a class="reference internal" href="#common-pitfalls" id="id11">Common Pitfalls</a></li>
<li><a class="reference internal" href="#conventions-recommendations" id="id12">Conventions/Recommendations</a></li>
<li><a class="reference internal" href="#documenting-your-module" id="id13">Documenting Your Module</a><ul>
<li><a class="reference internal" href="#example" id="id14">Example</a></li>
<li><a class="reference internal" href="#building-testing" id="id15">Building &amp; Testing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-paths" id="id16">Module Paths</a></li>
<li><a class="reference internal" href="#getting-your-module-into-ansible" id="id17">Getting Your Module Into Ansible</a></li>
<li><a class="reference internal" href="#module-checklist" id="id18">Module checklist</a></li>
<li><a class="reference internal" href="#windows-modules-checklist" id="id19">Windows modules checklist</a></li>
<li><a class="reference internal" href="#deprecating-and-making-module-aliases" id="id20">Deprecating and making module aliases</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible modules are reusable units of magic that can be used by the Ansible API,
or by the <cite>ansible</cite> or <cite>ansible-playbook</cite> programs.</p>
<p>See <a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a> for a list of various ones developed in core.</p>
<p>Modules can be written in any language and are found in the path specified
by <cite>ANSIBLE_LIBRARY</cite> or the <code class="docutils literal"><span class="pre">--module-path</span></code> command line option.</p>
<p>By default, everything that ships with ansible is pulled from its source tree, but
additional paths can be added.</p>
<p>The directory &#8221;./library&#8221;, alongside your top level playbooks, is also automatically
added as a search directory.</p>
<p>Should you develop an interesting Ansible module, consider sending a pull request to the
<a class="reference external" href="https://github.com/ansible/ansible-modules-extras">modules-extras project</a>.  There&#8217;s also a core
repo for more established and widely used modules.  &#8220;Extras&#8221; modules may be promoted to core periodically,
but there&#8217;s no fundamental difference in the end - both ship with ansible, all in one package, regardless
of how you acquire ansible.</p>
<div class="section" id="tutorial">
<span id="module-dev-tutorial"></span><h4><a class="toc-backref" href="#id5">Tutorial</a><a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h4>
<p>Let&#8217;s build a very-basic module to get and set the system time.  For starters, let&#8217;s build
a module that just outputs the current time.</p>
<p>We are going to use Python here but any language is possible.  Only File I/O and outputting to standard
out are required.  So, bash, C++, clojure, Python, Ruby, whatever you want
is fine.</p>
<p>Now Python Ansible modules contain some extremely powerful shortcuts (that all the core modules use)
but first we are going to build a module the very hard way.  The reason we do this is because modules
written in any language OTHER than Python are going to have to do exactly this.  We&#8217;ll show the easy
way later.</p>
<p>So, here&#8217;s an example.  You would never really need to build a module to set the system time,
the &#8216;command&#8217; module could already be used to do this.  Though we&#8217;re going to make one.</p>
<p>Reading the modules that come with ansible (linked above) is a great way to learn how to write
modules.   Keep in mind, though, that some modules in ansible&#8217;s source tree are internalisms,
so look at <cite>service</cite> or <cite>yum</cite>, and don&#8217;t stare too close into things like <cite>async_wrapper</cite> or
you&#8217;ll turn to stone.  Nobody ever executes async_wrapper directly.</p>
<p>Ok, let&#8217;s get going with an example.  We&#8217;ll use Python.  For starters, save this as a file named <cite>timetest.py</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span>

import datetime
import json

<span class="nv">date</span> <span class="o">=</span> str<span class="o">(</span>datetime.datetime.now<span class="o">())</span>
print json.dumps<span class="o">({</span>
    <span class="s2">&quot;time&quot;</span> : date
<span class="o">})</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-modules">
<span id="module-testing"></span><h4><a class="toc-backref" href="#id6">Testing Modules</a><a class="headerlink" href="#testing-modules" title="Permalink to this headline">¶</a></h4>
<p>There&#8217;s a useful test script in the source checkout for ansible:</p>
<div class="highlight-bash"><div class="highlight"><pre>git clone git@github.com:ansible/ansible.git --recursive
<span class="nb">source </span>ansible/hacking/env-setup
chmod +x ansible/hacking/test-module
</pre></div>
</div>
<p>Let&#8217;s run the script you just wrote with that:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible/hacking/test-module -m ./timetest.py
</pre></div>
</div>
<p>You should see output that looks something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>u<span class="s1">&#39;time&#39;</span>: u<span class="s1">&#39;2012-03-14 22:13:48.539183&#39;</span><span class="o">}</span>
</pre></div>
</div>
<p>If you did not, you might have a typo in your module, so recheck it and try again.</p>
</div>
<div class="section" id="reading-input">
<span id="id1"></span><h4><a class="toc-backref" href="#id7">Reading Input</a><a class="headerlink" href="#reading-input" title="Permalink to this headline">¶</a></h4>
<p>Let&#8217;s modify the module to allow setting the current time.  We&#8217;ll do this by seeing
if a key value pair in the form <cite>time=&lt;string&gt;</cite> is passed in to the module.</p>
<p>Ansible internally saves arguments to an arguments file.  So we must read the file
and parse it.  The arguments file is just a string, so any form of arguments are legal.
Here we&#8217;ll do some basic parsing to treat the input as key=value.</p>
<p>The example usage we are trying to achieve to set the time is:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">time time</span><span class="o">=</span><span class="s2">&quot;March 14 22:10&quot;</span>
</pre></div>
</div>
<p>If no time parameter is set, we&#8217;ll just leave the time as is and return the current time.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is obviously an unrealistic idea for a module.  You&#8217;d most likely just
use the shell module.  However, it probably makes a decent tutorial.</p>
</div>
<p>Let&#8217;s look at the code.  Read the comments as we&#8217;ll explain as we go.  Note that this
is highly verbose because it&#8217;s intended as an educational example.  You can write modules
a lot shorter than this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span>

<span class="c"># import some python modules that we&#39;ll use.  These are all</span>
<span class="c"># available in Python&#39;s core</span>

import datetime
import sys
import json
import os
import shlex

<span class="c"># read the argument string from the arguments file</span>
<span class="nv">args_file</span> <span class="o">=</span> sys.argv<span class="o">[</span>1<span class="o">]</span>
<span class="nv">args_data</span> <span class="o">=</span> file<span class="o">(</span>args_file<span class="o">)</span>.read<span class="o">()</span>

<span class="c"># for this module, we&#39;re going to do key=value style arguments</span>
<span class="c"># this is up to each module to decide what it wants, but all</span>
<span class="c"># core modules besides &#39;command&#39; and &#39;shell&#39; take key=value</span>
<span class="c"># so this is highly recommended</span>

<span class="nv">arguments</span> <span class="o">=</span> shlex.split<span class="o">(</span>args_data<span class="o">)</span>
<span class="k">for</span> arg in arguments:

    <span class="c"># ignore any arguments without an equals in it</span>
    <span class="k">if</span> <span class="s2">&quot;=&quot;</span> in arg:

        <span class="o">(</span>key, value<span class="o">)</span> <span class="o">=</span> arg.split<span class="o">(</span><span class="s2">&quot;=&quot;</span><span class="o">)</span>

        <span class="c"># if setting the time, the key &#39;time&#39;</span>
        <span class="c"># will contain the value we want to set the time to</span>

        <span class="k">if</span> <span class="nv">key</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span>:

            <span class="c"># now we&#39;ll affect the change.  Many modules</span>
            <span class="c"># will strive to be &#39;idempotent&#39;, meaning they</span>
            <span class="c"># will only make changes when the desired state</span>
            <span class="c"># expressed to the module does not match</span>
            <span class="c"># the current state.  Look at &#39;service&#39;</span>
            <span class="c"># or &#39;yum&#39; in the main git tree for an example</span>
            <span class="c"># of how that might look.</span>

            <span class="nv">rc</span> <span class="o">=</span> os.system<span class="o">(</span><span class="s2">&quot;date -s \&quot;%s\&quot;&quot;</span> % value<span class="o">)</span>

            <span class="c"># always handle all possible errors</span>
            <span class="c">#</span>
            <span class="c"># when returning a failure, include &#39;failed&#39;</span>
            <span class="c"># in the return data, and explain the failure</span>
            <span class="c"># in &#39;msg&#39;.  Both of these conventions are</span>
            <span class="c"># required however additional keys and values</span>
            <span class="c"># can be added.</span>

            <span class="k">if</span> rc !<span class="o">=</span> 0:
                print json.dumps<span class="o">({</span>
                    <span class="s2">&quot;failed&quot;</span> : True,
                    <span class="s2">&quot;msg&quot;</span>    : <span class="s2">&quot;failed setting the time&quot;</span>
                <span class="o">})</span>
                sys.exit<span class="o">(</span>1<span class="o">)</span>

            <span class="c"># when things do not fail, we do not</span>
            <span class="c"># have any restrictions on what kinds of</span>
            <span class="c"># data are returned, but it&#39;s always a</span>
            <span class="c"># good idea to include whether or not</span>
            <span class="c"># a change was made, as that will allow</span>
            <span class="c"># notifiers to be used in playbooks.</span>

            <span class="nv">date</span> <span class="o">=</span> str<span class="o">(</span>datetime.datetime.now<span class="o">())</span>
            print json.dumps<span class="o">({</span>
                <span class="s2">&quot;time&quot;</span> : date,
                <span class="s2">&quot;changed&quot;</span> : True
            <span class="o">})</span>
            sys.exit<span class="o">(</span>0<span class="o">)</span>

<span class="c"># if no parameters are sent, the module may or</span>
<span class="c"># may not error out, this one will just</span>
<span class="c"># return the time</span>

<span class="nv">date</span> <span class="o">=</span> str<span class="o">(</span>datetime.datetime.now<span class="o">())</span>
print json.dumps<span class="o">({</span>
    <span class="s2">&quot;time&quot;</span> : date
<span class="o">})</span>
</pre></div>
</div>
<p>Let&#8217;s test that module:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible/hacking/test-module -m ./time -a <span class="nb">time</span><span class="o">=</span><span class="se">\&quot;</span>March <span class="m">14</span> 12:23<span class="se">\&quot;</span>
</pre></div>
</div>
<p>This should return something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span><span class="s2">&quot;changed&quot;</span>: <span class="nb">true</span>, <span class="s2">&quot;time&quot;</span>: <span class="s2">&quot;2012-03-14 12:23:00.000307&quot;</span><span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="module-provided-facts">
<span id="id2"></span><h4><a class="toc-backref" href="#id8">Module Provided &#8216;Facts&#8217;</a><a class="headerlink" href="#module-provided-facts" title="Permalink to this headline">¶</a></h4>
<p>The &#8216;setup&#8217; module that ships with Ansible provides many variables about a system that can be used in playbooks
and templates.  However, it&#8217;s possible to also add your own facts without modifying the system module.  To do
this, just have the module return a <cite>ansible_facts</cite> key, like so, along with other return data:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{</span>
    <span class="s2">&quot;changed&quot;</span> : True,
    <span class="s2">&quot;rc&quot;</span> : 5,
    <span class="s2">&quot;ansible_facts&quot;</span> : <span class="o">{</span>
        <span class="s2">&quot;leptons&quot;</span> : 5000,
        <span class="s2">&quot;colors&quot;</span> : <span class="o">{</span>
            <span class="s2">&quot;red&quot;</span>   : <span class="s2">&quot;FF0000&quot;</span>,
            <span class="s2">&quot;white&quot;</span> : <span class="s2">&quot;FFFFFF&quot;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>These &#8216;facts&#8217; will be available to all statements called after that module (but not before) in the playbook.
A good idea might be make a module called &#8216;site_facts&#8217; and always call it at the top of each playbook, though
we&#8217;re always open to improving the selection of core facts in Ansible as well.</p>
</div>
<div class="section" id="common-module-boilerplate">
<span id="id3"></span><h4><a class="toc-backref" href="#id9">Common Module Boilerplate</a><a class="headerlink" href="#common-module-boilerplate" title="Permalink to this headline">¶</a></h4>
<p>As mentioned, if you are writing a module in Python, there are some very powerful shortcuts you can use.
Modules are still transferred as one file, but an arguments file is no longer needed, so these are not
only shorter in terms of code, they are actually FASTER in terms of execution time.</p>
<p>Rather than mention these here, the best way to learn is to read some of the <a class="reference external" href="https://github.com/ansible/ansible-modules-core">source of the modules</a> that come with Ansible.</p>
<p>The &#8216;group&#8217; and &#8216;user&#8217; modules are reasonably non-trivial and showcase what this looks like.</p>
<p>Key parts include always ending the module file with:</p>
<div class="highlight-bash"><div class="highlight"><pre>from ansible.module_utils.basic import *
<span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span>:
    main<span class="o">()</span>
</pre></div>
</div>
<p>And instantiating the module class like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">module</span> <span class="o">=</span> AnsibleModule<span class="o">(</span>
    <span class="nv">argument_spec</span> <span class="o">=</span> dict<span class="o">(</span>
        <span class="nv">state</span>     <span class="o">=</span> dict<span class="o">(</span><span class="nv">default</span><span class="o">=</span><span class="s1">&#39;present&#39;</span>, <span class="nv">choices</span><span class="o">=[</span><span class="s1">&#39;present&#39;</span>, <span class="s1">&#39;absent&#39;</span><span class="o">])</span>,
        <span class="nv">name</span>      <span class="o">=</span> dict<span class="o">(</span><span class="nv">required</span><span class="o">=</span>True<span class="o">)</span>,
        <span class="nv">enabled</span>   <span class="o">=</span> dict<span class="o">(</span><span class="nv">required</span><span class="o">=</span>True, <span class="nv">choices</span><span class="o">=</span>BOOLEANS<span class="o">)</span>,
        <span class="nv">something</span> <span class="o">=</span> dict<span class="o">(</span><span class="nv">aliases</span><span class="o">=[</span><span class="s1">&#39;whatever&#39;</span><span class="o">])</span>
    <span class="o">)</span>
<span class="o">)</span>
</pre></div>
</div>
<p>The AnsibleModule provides lots of common code for handling returns, parses your arguments
for you, and allows you to check inputs.</p>
<p>Successful returns are made like this:</p>
<div class="highlight-bash"><div class="highlight"><pre>module.exit_json<span class="o">(</span><span class="nv">changed</span><span class="o">=</span>True, <span class="nv">something_else</span><span class="o">=</span>12345<span class="o">)</span>
</pre></div>
</div>
<p>And failures are just as simple (where &#8216;msg&#8217; is a required parameter to explain the error):</p>
<div class="highlight-bash"><div class="highlight"><pre>module.fail_json<span class="o">(</span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;Something fatal happened&quot;</span><span class="o">)</span>
</pre></div>
</div>
<p>There are also other useful functions in the module class, such as module.sha1(path).  See
lib/ansible/module_common.py in the source checkout for implementation details.</p>
<p>Again, modules developed this way are best tested with the hacking/test-module script in the git
source checkout.  Because of the magic involved, this is really the only way the scripts
can function outside of Ansible.</p>
<p>If submitting a module to ansible&#8217;s core code, which we encourage, use of the AnsibleModule
class is required.</p>
</div>
<div class="section" id="check-mode">
<span id="developing-for-check-mode"></span><h4><a class="toc-backref" href="#id10">Check Mode</a><a class="headerlink" href="#check-mode" title="Permalink to this headline">¶</a></h4>
<div class="versionadded">
<p><span class="versionmodified">New in version 1.1.</span></p>
</div>
<p>Modules may optionally support check mode. If the user runs Ansible in check
mode, the module should try to predict whether changes will occur.</p>
<p>For your module to support check mode, you must pass <code class="docutils literal"><span class="pre">supports_check_mode=True</span></code>
when instantiating the AnsibleModule object. The AnsibleModule.check_mode attribute
will evaluate to True when check mode is enabled. For example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">module</span> <span class="o">=</span> AnsibleModule<span class="o">(</span>
    <span class="nv">argument_spec</span> <span class="o">=</span> dict<span class="o">(</span>...<span class="o">)</span>,
    <span class="nv">supports_check_mode</span><span class="o">=</span>True
<span class="o">)</span>

<span class="k">if</span> module.check_mode:
    <span class="c"># Check if any changes would be made but don&#39;t actually make those changes</span>
    module.exit_json<span class="o">(</span><span class="nv">changed</span><span class="o">=</span>check_if_system_state_would_be_changed<span class="o">())</span>
</pre></div>
</div>
<p>Remember that, as module developer, you are responsible for ensuring that no
system state is altered when the user enables check mode.</p>
<p>If your module does not support check mode, when the user runs Ansible in check
mode, your module will simply be skipped.</p>
</div>
<div class="section" id="common-pitfalls">
<span id="module-dev-pitfalls"></span><h4><a class="toc-backref" href="#id11">Common Pitfalls</a><a class="headerlink" href="#common-pitfalls" title="Permalink to this headline">¶</a></h4>
<p>You should also never do this in a module:</p>
<div class="highlight-bash"><div class="highlight"><pre>print <span class="s2">&quot;some status message&quot;</span>
</pre></div>
</div>
<p>Because the output is supposed to be valid JSON.</p>
<p>Modules must not output anything on standard error, because the system will merge
standard out with standard error and prevent the JSON from parsing. Capturing standard
error and returning it as a variable in the JSON on standard out is fine, and is, in fact,
how the command module is implemented.</p>
<p>If a module returns stderr or otherwise fails to produce valid JSON, the actual output
will still be shown in Ansible, but the command will not succeed.</p>
<p>Always use the hacking/test-module script when developing modules and it will warn
you about these kind of things.</p>
</div>
<div class="section" id="conventions-recommendations">
<span id="module-dev-conventions"></span><h4><a class="toc-backref" href="#id12">Conventions/Recommendations</a><a class="headerlink" href="#conventions-recommendations" title="Permalink to this headline">¶</a></h4>
<p>As a reminder from the example code above, here are some basic conventions
and guidelines:</p>
<ul class="simple">
<li>If the module is addressing an object, the parameter for that object should be called &#8216;name&#8217; whenever possible, or accept &#8216;name&#8217; as an alias.</li>
<li>If you have a company module that returns facts specific to your installations, a good name for this module is <cite>site_facts</cite>.</li>
<li>Modules accepting boolean status should generally accept &#8216;yes&#8217;, &#8216;no&#8217;, &#8216;true&#8217;, &#8216;false&#8217;, or anything else a user may likely throw at them.  The AnsibleModule common code supports this with &#8220;choices=BOOLEANS&#8221; and a module.boolean(value) casting function.</li>
<li>Include a minimum of dependencies if possible.  If there are dependencies, document them at the top of the module file, and have the module raise JSON error messages when the import fails.</li>
<li>Modules must be self-contained in one file to be auto-transferred by ansible.</li>
<li>If packaging modules in an RPM, they only need to be installed on the control machine and should be dropped into /usr/share/ansible.  This is entirely optional and up to you.</li>
<li>Modules must output valid JSON only. The toplevel return type must be a hash (dictionary) although they can be nested.  Lists or simple scalar values are not supported, though they can be trivially contained inside a dictionary.</li>
<li>In the event of failure, a key of &#8216;failed&#8217; should be included, along with a string explanation in &#8216;msg&#8217;.  Modules that raise tracebacks (stacktraces) are generally considered &#8216;poor&#8217; modules, though Ansible can deal with these returns and will automatically convert anything unparseable into a failed result.  If you are using the AnsibleModule common Python code, the &#8216;failed&#8217; element will be included for you automatically when you call &#8216;fail_json&#8217;.</li>
<li>Return codes from modules are not actually not significant, but continue on with 0=success and non-zero=failure for reasons of future proofing.</li>
<li>As results from many hosts will be aggregated at once, modules should return only relevant output.  Returning the entire contents of a log file is generally bad form.</li>
</ul>
</div>
<div class="section" id="documenting-your-module">
<span id="module-documenting"></span><h4><a class="toc-backref" href="#id13">Documenting Your Module</a><a class="headerlink" href="#documenting-your-module" title="Permalink to this headline">¶</a></h4>
<p>All modules included in the CORE distribution must have a
<code class="docutils literal"><span class="pre">DOCUMENTATION</span></code> string. This string MUST be a valid YAML document
which conforms to the schema defined below. You may find it easier to
start writing your <code class="docutils literal"><span class="pre">DOCUMENTATION</span></code> string in an editor with YAML
syntax highlighting before you include it in your Python file.</p>
<div class="section" id="example">
<span id="module-doc-example"></span><h5><a class="toc-backref" href="#id14">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h5>
<p>See an example documentation string in the checkout under <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/examples/DOCUMENTATION.yml">examples/DOCUMENTATION.yml</a>.</p>
<p>Include it in your module file like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/python</span>
<span class="c"># Copyright header....</span>

<span class="nv">DOCUMENTATION</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">---</span>
<span class="s1">module: modulename</span>
<span class="s1">short_description: This is a sentence describing the module</span>
<span class="s1"># ... snip ...</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">description</span></code>, and <code class="docutils literal"><span class="pre">notes</span></code> fields
support formatting with some special macros.</p>
<p>These formatting functions are <code class="docutils literal"><span class="pre">U()</span></code>, <code class="docutils literal"><span class="pre">M()</span></code>, <code class="docutils literal"><span class="pre">I()</span></code>, and <code class="docutils literal"><span class="pre">C()</span></code>
for URL, module, italic, and constant-width respectively. It is suggested
to use <code class="docutils literal"><span class="pre">C()</span></code> for file and option names, and <code class="docutils literal"><span class="pre">I()</span></code> when referencing
parameters; module names should be specified as <code class="docutils literal"><span class="pre">M(module)</span></code>.</p>
<p>Examples (which typically contain colons, quotes, etc.) are difficult
to format with YAML, so these must be
written in plain text in an <code class="docutils literal"><span class="pre">EXAMPLES</span></code> string within the module
like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">EXAMPLES</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">- action: modulename opt1=arg1 opt2=arg2</span>
<span class="s1">&#39;&#39;&#39;</span>
</pre></div>
</div>
<p>The EXAMPLES section, just like the documentation section, is required in
all module pull requests for new modules.</p>
</div>
<div class="section" id="building-testing">
<span id="module-dev-testing"></span><h5><a class="toc-backref" href="#id15">Building &amp; Testing</a><a class="headerlink" href="#building-testing" title="Permalink to this headline">¶</a></h5>
<p>Put your completed module file into the &#8216;library&#8217; directory and then
run the command: <code class="docutils literal"><span class="pre">make</span> <span class="pre">webdocs</span></code>. The new &#8216;modules.html&#8217; file will be
built and appear in the &#8216;docsite/&#8217; directory.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">If you&#8217;re having a problem with the syntax of your YAML you can
validate it on the <a class="reference external" href="http://www.yamllint.com/">YAML Lint</a> website.</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">You can set the environment variable ANSIBLE_KEEP_REMOTE_FILES=1 on the controlling host to prevent ansible from
deleting the remote files so you can debug your module.</p>
</div>
</div>
</div>
<div class="section" id="module-paths">
<span id="module-contribution"></span><h4><a class="toc-backref" href="#id16">Module Paths</a><a class="headerlink" href="#module-paths" title="Permalink to this headline">¶</a></h4>
<p>If you are having trouble getting your module &#8220;found&#8221; by ansible, be
sure it is in the <code class="docutils literal"><span class="pre">ANSIBLE_LIBRARY</span></code> environment variable.</p>
<p>If you have a fork of one of the ansible module projects, do something like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">ANSIBLE_LIBRARY</span><span class="o">=</span>~/ansible-modules-core:~/ansible-modules-extras
</pre></div>
</div>
<p>And this will make the items in your fork be loaded ahead of what ships with Ansible.  Just be sure
to make sure you&#8217;re not reporting bugs on versions from your fork!</p>
<p>To be safe, if you&#8217;re working on a variant on something in Ansible&#8217;s normal distribution, it&#8217;s not
a bad idea to give it a new name while you are working on it, to be sure you know you&#8217;re pulling
your version.</p>
</div>
<div class="section" id="getting-your-module-into-ansible">
<h4><a class="toc-backref" href="#id17">Getting Your Module Into Ansible</a><a class="headerlink" href="#getting-your-module-into-ansible" title="Permalink to this headline">¶</a></h4>
<p>High-quality modules with minimal dependencies
can be included in Ansible, but modules (just due to the programming
preferences of the developers) will need to be implemented in Python and use
the AnsibleModule common code, and should generally use consistent arguments with the rest of
the program.   Stop by the mailing list to inquire about requirements if you like, and submit
a github pull request to the <a class="reference external" href="https://github.com/ansible/ansible-modules-extras">extras</a> project.
Included modules will ship with ansible, and also have a chance to be promoted to &#8216;core&#8217; status, which
gives them slightly higher development priority (though they&#8217;ll work in exactly the same way).</p>
</div>
<div class="section" id="module-checklist">
<h4><a class="toc-backref" href="#id18">Module checklist</a><a class="headerlink" href="#module-checklist" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">The shebang should always be #!/usr/bin/python, this allows ansible_python_interpreter to work</p>
</li>
<li><dl class="first docutils">
<dt>Documentation: Make sure it exists</dt>
<dd><ul class="first last simple">
<li><cite>required</cite> should always be present, be it true or false</li>
<li>If <cite>required</cite> is false you need to document <cite>default</cite>, even if the default is &#8216;None&#8217; (which is the default if no parameter is supplied). Make sure default parameter in docs matches default parameter in code.</li>
<li><cite>default</cite> is not needed for <cite>required: true</cite></li>
<li>Remove unnecessary doc like <cite>aliases: []</cite> or <cite>choices: []</cite></li>
<li>The version is not a float number and value the current development version</li>
<li>Verify  that arguments in doc and module spec dict are identical</li>
<li>For password / secret arguments no_log=True should be set</li>
<li>Requirements should  be documented, using the <cite>requirements=[]</cite> field</li>
<li>Author should be set, name and github id at least</li>
<li>Made use of U() for urls, C() for files and options, I() for params, M() for modules?</li>
<li>GPL 3 License header</li>
<li>Does module use check_mode? Could it be modified to use it? Document it</li>
<li>Examples: make sure they are reproducible</li>
<li>Return: document the return structure of the module</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Exceptions: The module must handle them. (exceptions are bugs)</dt>
<dd><ul class="first last simple">
<li>Give out useful messages on what you were doing and you can add the exception message to that.</li>
<li>Avoid catchall exceptions, they are not very useful unless the underlying API gives very good error messages pertaining the attempted action.</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">The module must not use sys.exit() &#8211;&gt; use fail_json() from the module object</p>
</li>
<li><p class="first">Import custom packages in try/except and handled with fail_json() in main() e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre>try:
    import foo
    <span class="nv">HAS_LIB</span><span class="o">=</span>True
except:
    <span class="nv">HAS_LIB</span><span class="o">=</span>False
</pre></div>
</div>
</li>
<li><p class="first">The return structure should be consistent, even if NA/None are used for keys normally returned under other options.</p>
</li>
<li><p class="first">Are module actions idempotent? If not document in the descriptions or the notes</p>
</li>
<li><p class="first">Import module snippets <cite>from ansible.module_utils.basic import *</cite> at the bottom, conserves line numbers for debugging.</p>
</li>
<li><p class="first">Call your <code class="xref py py-func docutils literal"><span class="pre">main()</span></code> from a conditional so that it would be possible to
test them in the future example:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span>:
    main<span class="o">()</span>
</pre></div>
</div>
</li>
<li><p class="first">Try to normalize parameters with other modules, you can have aliases for when user is more familiar with underlying API name for the option</p>
</li>
<li><p class="first">Being pep8 compliant is nice, but not a requirement. Specifically, the 80 column limit now hinders readability more that it improves it</p>
</li>
<li><p class="first">Avoid &#8216;<cite>action</cite>/<cite>command</cite>&#8216;, they are imperative and not declarative, there are other ways to express the same thing</p>
</li>
<li><p class="first">Sometimes you want to split the module, specially if you are adding a list/info state, you want a _facts version</p>
</li>
<li><p class="first">If you are asking &#8216;how can I have a module execute other modules&#8217; ... you want to write a role</p>
</li>
<li><p class="first">Return values must be able to be serialized as json via the python stdlib
json library.  basic python types (strings, int, dicts, lists, etc) are
serializable.  A common pitfall is to try returning an object via
exit_json().  Instead, convert the fields you need from the object into the
fields of a dictionary and return the dictionary.</p>
</li>
<li><p class="first">When fetching URLs, please use either fetch_url or open_url from ansible.module_utils.urls
rather than urllib2; urllib2 does not natively verify TLS certificates and so is insecure for https.</p>
</li>
</ul>
</div>
<div class="section" id="windows-modules-checklist">
<h4><a class="toc-backref" href="#id19">Windows modules checklist</a><a class="headerlink" href="#windows-modules-checklist" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Favour native powershell and .net ways of doing things over calls to COM libraries or calls to native executables which may or may not be present in all versions of windows</p>
</li>
<li><p class="first">modules are in powershell (.ps1 files) but the docs reside in same name python file (.py)</p>
</li>
<li><p class="first">look at ansible/lib/ansible/module_utils/powershell.ps1 for commmon code, avoid duplication</p>
</li>
<li><p class="first">start with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!powershell</span>
</pre></div>
</div>
</li>
</ul>
<dl class="docutils">
<dt>then::</dt>
<dd>&lt;GPL header&gt;</dd>
<dt>then::</dt>
<dd># WANT_JSON
# POWERSHELL_COMMON</dd>
</dl>
<ul>
<li><dl class="first docutils">
<dt>Arguments:</dt>
<dd><ul class="first last">
<li><p class="first">Try and use state present and state absent like other modules</p>
</li>
<li><p class="first">You need to check that all your mandatory args are present:</p>
<div class="highlight-bash"><div class="highlight"><pre>If <span class="o">(</span><span class="nv">$params</span>.state<span class="o">)</span> <span class="o">{</span>
    <span class="nv">$state</span> <span class="o">=</span> <span class="nv">$params</span>.state.ToString<span class="o">()</span>.ToLower<span class="o">()</span>
    If <span class="o">((</span><span class="nv">$state</span> -ne <span class="s1">&#39;started&#39;</span><span class="o">)</span> -and <span class="o">(</span><span class="nv">$state</span> -ne <span class="s1">&#39;stopped&#39;</span><span class="o">)</span> -and <span class="o">(</span><span class="nv">$state</span> -ne <span class="s1">&#39;restarted&#39;</span><span class="o">))</span> <span class="o">{</span>
        Fail-Json <span class="nv">$result</span> <span class="s2">&quot;state is &#39;</span><span class="nv">$state</span><span class="s2">&#39;; must be &#39;started&#39;, &#39;stopped&#39;, or &#39;restarted&#39;&quot;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Look at existing modules for more examples of argument checking.</p>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Results</dt>
<dd><ul class="first last">
<li><p class="first">The result object should allways contain an attribute called changed set to either $true or $false</p>
</li>
<li><p class="first">Create your result object like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$result</span> <span class="o">=</span> New-Object psobject @<span class="o">{</span>
<span class="nv">changed</span> <span class="o">=</span> <span class="nv">$false</span>
<span class="nv">other_result_attribute</span> <span class="o">=</span> <span class="nv">$some_value</span>
<span class="o">}</span><span class="p">;</span>

If all is well, <span class="nb">exit </span>with a
Exit-Json <span class="nv">$result</span>
</pre></div>
</div>
</li>
<li><p class="first">Ensure anything you return, including errors can be converted to json.</p>
</li>
<li><p class="first">Be aware that because exception messages could contain almost anything.</p>
</li>
<li><p class="first">ConvertTo-Json will fail if it encounters a trailing in a string.</p>
</li>
<li><p class="first">If all is not well use Fail-Json to exit.</p>
</li>
</ul>
</dd>
</dl>
</li>
<li><p class="first">Have you tested for powershell 3.0 and 4.0 compliance?</p>
</li>
</ul>
</div>
<div class="section" id="deprecating-and-making-module-aliases">
<h4><a class="toc-backref" href="#id20">Deprecating and making module aliases</a><a class="headerlink" href="#deprecating-and-making-module-aliases" title="Permalink to this headline">¶</a></h4>
<p>Starting in 1.8 you can deprecate modules by renaming them with a preceding _, i.e. old_cloud.py to
_old_cloud.py, This will keep the module available but hide it from the primary docs and listing.</p>
<p>You can also rename modules and keep an alias to the old name by using a symlink that starts with _.
This example allows the stat module to be called with fileinfo, making the following examples equivalent</p>
<blockquote>
<div>EXAMPLES = &#8216;&#8217;&#8217;
ln -s stat.py _fileinfo.py
ansible -m stat -a &#8220;path=/tmp&#8221; localhost
ansible -m fileinfo -a &#8220;path=/tmp&#8221; localhost
&#8216;&#8217;&#8216;</div></blockquote>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>Learn about available modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_plugins"><em>Developing Plugins</em></a></dt>
<dd>Learn about developing plugins</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_api"><em>Python API</em></a></dt>
<dd>Learn about the Python API for playbook and task execution</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-modules-core/tree/devel">GitHub Core modules directory</a></dt>
<dd>Browse source of core modules</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-modules-extras/tree/devel">Github Extras modules directory</a></dt>
<dd>Browse source of extras modules.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>Development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/developing_plugins"></span><div class="section" id="developing-plugins">
<h3><a class="toc-backref" href="#id2">Developing Plugins</a><a class="headerlink" href="#developing-plugins" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#developing-plugins" id="id2">Developing Plugins</a><ul>
<li><a class="reference internal" href="#connection-type-plugins" id="id3">Connection Type Plugins</a></li>
<li><a class="reference internal" href="#lookup-plugins" id="id4">Lookup Plugins</a></li>
<li><a class="reference internal" href="#vars-plugins" id="id5">Vars Plugins</a></li>
<li><a class="reference internal" href="#filter-plugins" id="id6">Filter Plugins</a></li>
<li><a class="reference internal" href="#callbacks" id="id7">Callbacks</a><ul>
<li><a class="reference internal" href="#examples" id="id8">Examples</a></li>
<li><a class="reference internal" href="#configuring" id="id9">Configuring</a></li>
<li><a class="reference internal" href="#development" id="id10">Development</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distributing-plugins" id="id11">Distributing Plugins</a></li>
</ul>
</li>
</ul>
</div>
<p>Ansible is pluggable in a lot of other ways separate from inventory scripts and callbacks.  Many of these features are there to cover fringe use cases and are infrequently needed, and others are pluggable simply because they are there to implement core features
in ansible and were most convenient to be made pluggable.</p>
<p>This section will explore these features, though they are generally not common in terms of things people would look to extend quite
as often.</p>
<div class="section" id="connection-type-plugins">
<span id="developing-connection-type-plugins"></span><h4><a class="toc-backref" href="#id3">Connection Type Plugins</a><a class="headerlink" href="#connection-type-plugins" title="Permalink to this headline">¶</a></h4>
<p>By default, ansible ships with a &#8216;paramiko&#8217; SSH, native ssh (just called &#8216;ssh&#8217;), &#8216;local&#8217; connection type, and there are also some minor players like &#8216;chroot&#8217; and &#8216;jail&#8217;.  All of these can be used
in playbooks and with /usr/bin/ansible to decide how you want to talk to remote machines.  The basics of these connection types
are covered in the <a class="reference internal" href="index.html#document-docs/intro_getting_started"><em>新手上路</em></a> section.  Should you want to extend Ansible to support other transports (SNMP? Message bus?
Carrier Pigeon?) it&#8217;s as simple as copying the format of one of the existing modules and dropping it into the connection plugins
directory.   The value of &#8216;smart&#8217; for a connection allows selection of paramiko or openssh based on system capabilities, and chooses
&#8216;ssh&#8217; if OpenSSH supports ControlPersist, in Ansible 1.2.1 an later.  Previous versions did not support &#8216;smart&#8217;.</p>
<p>More documentation on writing connection plugins is pending, though you can jump into <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/connections">lib/ansible/plugins/connections</a> and figure things out pretty easily.</p>
</div>
<div class="section" id="lookup-plugins">
<span id="developing-lookup-plugins"></span><h4><a class="toc-backref" href="#id4">Lookup Plugins</a><a class="headerlink" href="#lookup-plugins" title="Permalink to this headline">¶</a></h4>
<p>Language constructs like &#8220;with_fileglob&#8221; and &#8220;with_items&#8221; are implemented via lookup plugins.  Just like other plugin types, you can write your own.</p>
<p>More documentation on writing lookup plugins is pending, though you can jump into <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/lookup">lib/ansible/plugins/lookup</a> and figure
things out pretty easily.</p>
</div>
<div class="section" id="vars-plugins">
<span id="developing-vars-plugins"></span><h4><a class="toc-backref" href="#id5">Vars Plugins</a><a class="headerlink" href="#vars-plugins" title="Permalink to this headline">¶</a></h4>
<p>Playbook constructs like &#8216;host_vars&#8217; and &#8216;group_vars&#8217; work via &#8216;vars&#8217; plugins.  They inject additional variable
data into ansible runs that did not come from an inventory, playbook, or command line.  Note that variables
can also be returned from inventory, so in most cases, you won&#8217;t need to write or understand vars_plugins.</p>
<p>More documentation on writing vars plugins is pending, though you can jump into <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/inventory/vars_plugins">lib/ansible/inventory/vars_plugins</a> and figure
things out pretty easily.</p>
<p>If you find yourself wanting to write a vars_plugin, it&#8217;s more likely you should write an inventory script instead.</p>
</div>
<div class="section" id="filter-plugins">
<span id="developing-filter-plugins"></span><h4><a class="toc-backref" href="#id6">Filter Plugins</a><a class="headerlink" href="#filter-plugins" title="Permalink to this headline">¶</a></h4>
<p>If you want more Jinja2 filters available in a Jinja2 template (filters like to_yaml and to_json are provided by default), they can be extended by writing a filter plugin.  Most of the time, when someone comes up with an idea for a new filter they would like to make available in a playbook, we&#8217;ll just include them in &#8216;core.py&#8217; instead.</p>
<p>Jump into <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/filter">lib/ansible/plugins/filter</a> for details.</p>
</div>
<div class="section" id="callbacks">
<span id="developing-callbacks"></span><h4><a class="toc-backref" href="#id7">Callbacks</a><a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h4>
<p>Callbacks are one of the more interesting plugin types.  Adding additional callback plugins to Ansible allows for adding new behaviors when responding to events.</p>
<div class="section" id="examples">
<span id="callback-examples"></span><h5><a class="toc-backref" href="#id8">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h5>
<p>Example callbacks are shown in <a class="reference external" href="https://github.com/ansible/ansible/tree/devel/lib/ansible/plugins/callback">lib/ansible/plugins/callback</a>.</p>
<p>The <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/callback/log_plays.py">log_plays</a>
callback is an example of how to intercept playbook events to a log
file, and the <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/callback/mail.py">mail</a>
callback sends email when playbooks complete.</p>
<p>The <a class="reference external" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/callback/osx_say.py">osx_say</a>
callback provided is particularly entertaining &#8211; it will respond with
computer synthesized speech on OS X in relation to playbook events,
and is guaranteed to entertain and/or annoy coworkers.</p>
</div>
<div class="section" id="configuring">
<span id="configuring-callbacks"></span><h5><a class="toc-backref" href="#id9">Configuring</a><a class="headerlink" href="#configuring" title="Permalink to this headline">¶</a></h5>
<p>To activate a callback drop it in a callback directory as configured in <span class="xref std std-ref">ansible.cfg</span>.</p>
</div>
<div class="section" id="development">
<span id="callback-development"></span><h5><a class="toc-backref" href="#id10">Development</a><a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h5>
<p>More information will come later, though see the source of any of the existing callbacks and you should be able to get started quickly.
They should be reasonably self-explanatory.</p>
</div>
</div>
<div class="section" id="distributing-plugins">
<span id="id1"></span><h4><a class="toc-backref" href="#id11">Distributing Plugins</a><a class="headerlink" href="#distributing-plugins" title="Permalink to this headline">¶</a></h4>
<p>Plugins are loaded from both Python&#8217;s site_packages (those that ship with ansible) and a configured plugins directory, which defaults
to /usr/share/ansible/plugins, in a subfolder for each plugin type:</p>
<div class="highlight-bash"><div class="highlight"><pre>* action_plugins
* lookup_plugins
* callback_plugins
* connection_plugins
* filter_plugins
* vars_plugins
</pre></div>
</div>
<p>To change this path, edit the ansible configuration file.</p>
<p>In addition, plugins can be shipped in a subdirectory relative to a top-level playbook, in folders named the same as indicated above.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>List of built-in modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_api"><em>Python API</em></a></dt>
<dd>Learn about the Python API for task execution</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_inventory"><em>开发动态的Inventory数据源</em></a></dt>
<dd>Learn about how to develop dynamic inventory sources</dd>
<dt><a class="reference internal" href="index.html#document-docs/developing_modules"><em>Developing Modules</em></a></dt>
<dd>Learn about how to write Ansible modules</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">Mailing List</a></dt>
<dd>The development mailing list</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/developing_test_pr"></span><div class="section" id="pr">
<h3>帮助测试PR<a class="headerlink" href="#pr" title="Permalink to this headline">¶</a></h3>
<p>作为一名开发者，最具能展现自我价值的事情就是在github上看讨论列表来帮助修复bug。我们通常在解决了bug之后再进行新功能的开发，因此解决bug将是一个非常有价值的事情。</p>
<p>即使你不是一个开发者，帮助测试bug的修复情况以及新功能还是非常有必要的。</p>
<p>这同样适用于测试新功能以及测试错误修正。</p>
<p>通常情况下，编码工作应当包含测试用例来保证编码的正确性，但这并不总能照顾到代码的方方面面，尤其在各平台下测试用户没有足够的访问权限，或者使用的是API或者web服务。</p>
<p>在这种情况下，在真实的环境下上线测试将会比自动测试更有价值。在任何情况下，都是应该进行一次人工测试。</p>
<p>幸运的是在你充分了解ansible的工作机制的情况下，帮助测试ansible是一件非常简单的事情。</p>
<div class="section" id="id1">
<h4>开始测试<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>你可以在ansible主分支上切出一个分支来保持和主分支隔离，合并GitHub上的问题，测试，然后在GitHub对这一特定问题做一个回馈。具体方法如下：</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">帮助测试GitHub上那些提交合并请求的代码是否存在风险，这些风险可能包括存在错误或恶意代码。我们建议在虚拟机上测试，无论是云，或在本地。有些人喜欢Vagrant，或Docker，这是可以的，但我们并不推荐。 在不同的Linux系统环境下进行测试也是非常有意义的，因为某些功能（诸如APT和yum等包管理工具）专用于这些操作系统。</p>
</div>
<p>当然配置您的测试环境来运行我们的测试套件需要一系列工具。以下软件是必须的:</p>
<div class="highlight-bash"><div class="highlight"><pre>git
python-nosetests <span class="o">(</span>sometimes named python-nose<span class="o">)</span>
python-passlib
python-mock
</pre></div>
</div>
<p>如果你想运行完整的集成测试套件，你还需要安装以下软件包:</p>
<div class="highlight-bash"><div class="highlight"><pre>svn
hg
python-pip
gem
</pre></div>
</div>
<p>当准备完以上环境后，您可以从github上拉取Ansible的原代码进行测试了:</p>
<div class="highlight-bash"><div class="highlight"><pre>git clone https://github.com/ansible/ansible.git --recursive
<span class="nb">cd </span>ansible/
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果您已经Fork了我们的代码，您就可以从你自己代码仓库里克隆了。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">如果你打算更新你的仓库作为测试一些相关模块，请使用&#8221;git rebase origin/devel&#8221;，并且使用&#8221;git submodule update&#8221;更新子模块，如不更新，您将使用旧版本的模块。</p>
</div>
</div>
<div class="section" id="id2">
<h4>使用开发环境<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Ansible源代码包括一个脚本，可以让你直接使用Ansible从源代码，而无需完全安装，这对于的Ansible开发者来说十分便利。</p>
<p>使用以下命令进入开发环境，这主要针对的是Linux/Unix的终端测试环境:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">source</span> ./hacking/env-setup
</pre></div>
</div>
<p>该脚本修改了PYTHONPATH（以及一些其他的东西），这仅仅对于当次shell 会话有效。</p>
<p>如果你想永久使测试环境生效，你可以将其放入开机启动脚本中（例如，<cite>.bash_profile</cite>）。</p>
</div>
<div class="section" id="id3">
<h4>找到对应分支并测试<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>接下来，手动合并你想测试的提交请求，并且记录下源和仓库的信息。它会是这个样子:</p>
<div class="highlight-bash"><div class="highlight"><pre>Someuser wants to merge <span class="m">1</span> commit into ansible:devel from someuser:feature_branch_name
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">请务必将提交合并请求提交到ansible:devel分支，我们不会接受您提交到其他分支。版本的更新将由我们的工作人员手动进行。</p>
</div>
<p>用户名和分支名是十分重要的，这将显示在以下命令行中:</p>
<div class="highlight-bash"><div class="highlight"><pre>git checkout -b testing_PRXXXX devel
git pull https://github.com/someuser/ansible.git feature_branch_name
</pre></div>
</div>
<p>第一行命令表示在devel分支上新建一个新分支名叫testing_PRXXXX，而XXXX是实际合并请求申请的ID号（例如，1234），并切换到该分支下。第二行命令则表示拉取对应用户的对应分支的代码。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the GitHub user interface shows that the pull request will not merge cleanly, we do not recommend proceeding if you
are not somewhat familiar with git and coding, as you will have to resolve a merge conflict.  This is the responsibility of
the original pull request contributor.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Some users do not create feature branches, which can cause problems when they have multiple, un-related commits in
their version of <cite>devel</cite>. If the source looks like <cite>someuser:devel</cite>, make sure there is only one commit listed on
the pull request.</p>
</div>
</div>
<div class="section" id="for-those-about-to-test-we-salute-you">
<h4>For Those About To Test, We Salute You<a class="headerlink" href="#for-those-about-to-test-we-salute-you" title="Permalink to this headline">¶</a></h4>
<p>At this point, you should be ready to begin testing!</p>
<p>If the PR is a bug-fix pull request, the first things to do are to run the suite of unit and integration tests, to ensure
the pull request does not break current functionality:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># Unit Tests</span>
make tests

<span class="c"># Integration Tests</span>
<span class="nb">cd test</span>/integration
make
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ansible does provide integration tests for cloud-based modules as well, however we do not recommend using them for some users
due to the associated costs from the cloud providers.  As such, typically it&#8217;s better to run specific parts of the integration battery
and skip these tests.</p>
</div>
<p>Integration tests aren&#8217;t the end all beat all - in many cases what is fixed might not <em>HAVE</em> a test, so determining if it works means
checking the functionality of the system and making sure it does what it said it would do.</p>
<p>Pull requests for bug-fixes should reference the bug issue number they are fixing.</p>
<p>We encourage users to provide playbook examples for bugs that show how to reproduce the error, and these playbooks should be used to verify the bugfix does resolve
the issue if available.  You may wish to also do your own review to poke the corners of the change.</p>
<p>Since some reproducers can be quite involved, you might wish to create a testing directory with the issue # as a sub-
directory to keep things organized:</p>
<div class="highlight-bash"><div class="highlight"><pre>mkdir -p testing/XXXX <span class="c"># where XXXX is again the issue # for the original issue or PR</span>
<span class="nb">cd </span>testing/XXXX
&lt;create files or git clone example playbook repo&gt;
</pre></div>
</div>
<p>While it should go without saying, be sure to read any playbooks before you run them.  VMs help with running untrusted content greatly,
though a playbook could still do something to your computing resources that you&#8217;d rather not like.</p>
<p>Once the files are in place, you can run the provided playbook (if there is one) to test the functionality:</p>
<div class="highlight-bash"><div class="highlight"><pre>ansible-playbook -vvv playbook_name.yml
</pre></div>
</div>
<p>If there&#8217;s not a playbook, you may have to copy and paste playbook snippets or run a ad-hoc command that was pasted in.</p>
<p>Our issue template also included sections for &#8220;Expected Output&#8221; and &#8220;Actual Output&#8221;, which should be used to gauge the output
from the provided examples.</p>
<p>If the pull request resolves the issue, please leave a comment on the pull request, showing the following information:</p>
<blockquote>
<div><ul class="simple">
<li>&#8220;Works for me!&#8221;</li>
<li>The output from <cite>ansible &#8211;version</cite>.</li>
</ul>
</div></blockquote>
<p>In some cases, you may wish to share playbook output from the test run as well.</p>
<p>Example!:</p>
<div class="highlight-bash"><div class="highlight"><pre>Works <span class="k">for</span> me!  Tested on <span class="sb">`</span>Ansible 1.7.1<span class="sb">`</span>.  I verified this on CentOS 6.5 and also Ubuntu 14.04.
</pre></div>
</div>
<p>If the PR does not resolve the issue, or if you see any failures from the unit/integration tests, just include that output instead:</p>
<div class="highlight-bash"><div class="highlight"><pre>This doesn&#39;t work for me.

When I ran this my toaster started making loud noises!

Output from the toaster looked like this:

   ```
   BLARG
   StrackTrace
   RRRARRGGG
   ```
</pre></div>
</div>
<p>When you are done testing a feature branch, you can remove it with the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre>git branch -D someuser-feature_branch_name
</pre></div>
</div>
<p>We understand some users may be inexperienced with git, or other aspects of the above procedure, so feel free to stop by ansible-devel
list for questions and we&#8217;d be happy to help answer them.</p>
</div>
</div>
</div>
<p>开发者同时可能也对完全发现感兴趣,可以参考 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a>.这是一个将Ansible集成一体的非常棒的工具.</p>
</div>
<span id="document-docs/tower"></span><div class="section" id="ansible-tower">
<h2>Ansible Tower<a class="headerlink" href="#ansible-tower" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://ansible.com/tower">Ansible Tower</a> (以前叫&#8217;AWX&#8217;)是能够帮助任何IT团队更容易使用Ansible的解决方案。该方案基于web。</p>
<p>Tower允许对用户进行权限控制，即使某用户不能传送某SSH凭证，你也可以通过Tower来对该用户共享该凭证。我们可以通过图形化界面来管理Inventory，也可以对各种各样的云资源做同步。Tower可以记录所有job的日志，也可以与LDAP集成，并且拥有强大的可浏览的REST API。Tower也提供了命令行工具，可以与Jenkins轻松集成。Provisioning回调对自动伸缩拓扑图提供了强大的支持。</p>
<p>请在`Ansible Tower 页面 &lt;<a class="reference external" href="http://ansible.com/tower">http://ansible.com/tower</a>&gt;`_了解Tower更多的功能，并且了解如何下载使用。Tower的免费版本最多支持10个节点，并且Ansible公司会提供强大的支持。正如你期望的那样，可以用Ansible playbook来安装Tower！</p>
</div>
<span id="document-docs/community"></span><p>Community Information &amp; Contributing
社区信息与贡献
<code class="docutils literal"><span class="pre">````````````````````````````````</span></code></p>
<p>Ansible是一个开源项目,它被设计于让开发者和管理员在共同构建自动化解决方案的时候更好的合作.</p>
<p>你想要参与进来吗 &#8211; 不论是问问题,帮助其它用户,像新人介绍ansible,或者帮助软件和文档的完善,我们都非常欢迎你对这个项目的贡献.</p>
<div class="contents topic" id="topics">
<p class="topic-title first">Topics</p>
<ul class="simple">
<li><a class="reference internal" href="#ansible" id="id16">Ansible用户</a><ul>
<li><a class="reference internal" href="#id1" id="id17">我有个问题</a></li>
<li><a class="reference internal" href="#id2" id="id18">我想跟上版本发布公告</a></li>
<li><a class="reference internal" href="#id3" id="id19">我想帮助分享和改善Ansible</a></li>
<li><a class="reference internal" href="#id4" id="id20">我想让Ansible开发的更快</a></li>
<li><a class="reference internal" href="#bug" id="id21">我想报告 Bug</a></li>
<li><a class="reference internal" href="#id5" id="id22">我想帮助改善文档</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id6" id="id23">对当前和未来的开发人员</a><ul>
<li><a class="reference internal" href="#id7" id="id24">我想学习如何在 Ansible 上开发</a></li>
<li><a class="reference internal" href="#id8" id="id25">贡献代码(特性或者修复bug)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id9" id="id26">其它主题</a><ul>
<li><a class="reference internal" href="#id10" id="id27">Ansible 职员</a></li>
<li><a class="reference internal" href="#id11" id="id28">邮件列表信息</a></li>
<li><a class="reference internal" href="#id12" id="id29">版本号</a></li>
<li><a class="reference internal" href="#tower" id="id30">Tower 支持问题</a></li>
<li><a class="reference internal" href="#irc" id="id31">IRC 频道</a></li>
<li><a class="reference internal" href="#id13" id="id32">注意优先级的标识</a></li>
<li><a class="reference internal" href="#id14" id="id33">社区代码和产品</a></li>
<li><a class="reference internal" href="#id15" id="id34">贡献执照许可</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="ansible">
<h2><a class="toc-backref" href="#id16">Ansible用户</a><a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id17">我有个问题</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>我们很乐意帮助你！</p>
<p>Ansible问题最好在Ansible的google谈论组上面询问.`Ansible Google Group Mailing List &lt;<a class="reference external" href="http://groups.google.com/group/ansible-project">http://groups.google.com/group/ansible-project</a>&gt;`_.</p>
<p>这里有非常多的回答问题的列表和分享的技巧.任何人都可以加入进来,如果你只想在线阅读的话,发送邮件是可选的.为了减少垃圾邮件,尽管投递很快就被批准,你的第一次投递还是可能比较慢.</p>
<p>在问问题的时候,确保让大家知道你运行的相关命令,输出内容,一些细节,和你使用的Ansible版本</p>
<p>在需要的使用实例场合,尽量链接到 github 上展示,而不是在邮件列表中发送附件.</p>
<p>推荐你在问问题之前使用 Google 搜索,查看是否相关问题已经被回答过了,但是如果在注释中发现时间很久了,相关主题可能不再回复.</p>
<p>在问问题之前,确保使用的是最新的稳定版本的 Ansible ,你可以通过对比命令 &#8216;ansible &#8211;version&#8217; 的输出和 <cite>PyPi &lt;https://pypi.python.org/pypi/ansible&gt;</cite> 上面的版本来进行检查.</p>
<p>同样,你可以加入 IRC 频道 - #ansible on irc.freenode.net .这也是一个很活跃的频道, 如果还没在邮件列表中没有找到你想要的答案,因为邮件是异步的,请暂停发送邮件,你的邮件可能会引起核心开发人员的注意.</p>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id18">我想跟上版本发布公告</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>版本通知发布在 ansible 的项目上面,如果你不想跟上最新的邮件列表,你可以加入 Ansible 匿名邮件列表 <a class="reference external" href="http://groups.google.com/group/ansible-announce">Ansible Announce Mailing List</a></p>
<p>这是一个低流量的只读邮件列表,我们指挥在这里发布版本通知和 可选的通向到 Ansible 大事件的链接</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id19">我想帮助分享和改善Ansible</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>你可以通过告诉朋友和同事,写博客,来把 Ansible 分享给其它人,或者出现在用户讨论组上面(像 DevOps组,或者本地 LUG)</p>
<p>你可以注册一个免费的账户标记为 &#8220;Ansible&#8221;,在 speakerdeck 上面分享你的幻灯片.在推特上,你可以和 ansible 一起分享,或者跟随我们  <a class="reference external" href="https://twitter.com/ansible">follow us</a>.</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id20">我想让Ansible开发的更快</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>如果你是一个开发者,最有价值的事情就是查看 github issue 列表,帮助修复 bug.我们总是在特性开发时,优先考虑修复 bug 问题,因此你可以做的最好的事情就是清楚 bug .</p>
<p>如果你不是开发者,帮助测试提交的 bug 修复问题,也是很有价值的.你可以检验 ansible,在主分支下,开一个测试分支,合并 github 上的问题,测试,然后在指定的 issue 上面注释.</p>
</div>
<div class="section" id="bug">
<h3><a class="toc-backref" href="#id21">我想报告 Bug</a><a class="headerlink" href="#bug" title="Permalink to this headline">¶</a></h3>
<p>Ansible实际使用中暴露的问题 &#8211; 如果和安全相关,请发邮件到 <cite>security&#64;ansible.com &lt;mailto:security&#64;ansible.com&gt;</cite>,而不是发到 Google 讨论组上面 .</p>
<p>有关核心语言的 Bug 应该被报道到 <cite>github.com/ansible/ansible &lt;https://github.com/ansible/ansible&gt;</cite> .在报告一个 Bug 之前首先检查 bug/issue 查看有关 issue 是否被报告了.</p>
<p>模块相关的 Bugs 应该基于模块的分类发到 <cite>ansible-modules-core &lt;https://github.com/ansible/ansible-modules-core&gt;</cite> 或者  <cite>ansible-modules-extras &lt;https://github.com/ansible/ansible-modules-extras&gt;</cite> .这会被列到模块文档的底部.</p>
<p>当你填bug信息的时候,模块请使用 <cite>issue template &lt;https://github.com/ansible/ansible/raw/devel/ISSUE_TEMPLATE.md&gt;</cite> 提供所有相关的信息,不管你正在填什么类型的表格.
(When filing a bug, please use the <a class="reference external" href="https://github.com/ansible/ansible/raw/devel/ISSUE_TEMPLATE.md">issue template</a> to provide all relevant information, regardless of what repo you are filing a ticket against.)</p>
<p>知道你ansible的版本,和你运行的具体的命令,你期望什得到什么结果,将会帮助我们和每个人世间,更快的知道问题.</p>
<p>不要使用类似,&#8221;我如何做(how do I do this)&#8221; 类型的问题.这里都是 IRC 的参与者回答有用的问题,而不是讨论有什么问题的.学会提问.</p>
<p>尊重审稿人,使审稿人有时间帮助更多的忍,请提供 良好注释,语言简洁的playbook,包括playbook的片段和输出内容.有用的信息尽量提出来,省略无用的信息</p>
<p>当在 playbook 分享 YAML 时候,格式可以被保存通过使用 <cite>code blocks &lt;https://help.github.com/articles/github-flavored-markdown#fenced-code-blocks&gt;</cite></p>
<p>对于多文件的内容,推荐使用 gist.github.com. 在线 pastebin 内容可能会过期,因此如果他们被长时间的引用,最好时间放久一点.(For multiple-file content, we encourage use of gist.github.com.  Online pastebin content can expire, so it&#8217;s nice to have things around for a longer term if they
are referenced in a ticket.)</p>
<p>如果你不确定你提供的是否为 bug,欢迎到 IRC 邮件列表提问一些相关的事情.</p>
<p>因为我们是一个大文献的项目,如果你确定你有一个 bug ,请确保你打开 issue ,确保我们有这个与你有关的issue记录.不要依靠社区的其他人代替你上传这个bug.</p>
<p>得到你的报告可能会花一些世间,具体信息查看下面的优先级标识.</p>
</div>
<div class="section" id="id5">
<h3><a class="toc-backref" href="#id22">我想帮助改善文档</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>ansible 的文档也是一个社区项目.</p>
<p>如果你想帮助改善文档,纠正错别字,或者改善一些章节,或者写一个新特性的文档, 提交一个 github pull 请求,代码位于“docsite/rst” 子目录,同样也有一个 &#8220;Edit On Github&#8221;连接到哪里的.</p>
<p>模块文档嵌入在源码模块的底部,模块可能是 ansible-modules-core 或者 ansible-modules-extra 取决于在github上的模块.关于这的信息一直列在网页文档的每个模块底部</p>
<p>除了模块,主文档也在重建文本格式.(Aside from modules, the main docs are in restructured text format.  )</p>
<p>如果你对新的重组的文本不满意,你可以在 github 上打开一个的标签,关于你发现的错误,或者你想添加的部分.更多的信息或者创建 pull 请求,请参考 <a class="reference external" href="https://help.github.com/articles/using-pull-requests">github help guide</a>.</p>
</div>
</div>
<div class="section" id="id6">
<h2><a class="toc-backref" href="#id23">对当前和未来的开发人员</a><a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3><a class="toc-backref" href="#id24">我想学习如何在 Ansible 上开发</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>如果你刚开始使用 Ansible,想弄明白 Ansible 内部的工作机制,停止 Ansible-devel 邮件列表,像我们打个招呼,我们会带你开始的.</p>
<p>一个好的开始方式可以是在模块网站上阅读一些开发文档,然后找到一个 bug 然后修复,或者添加一些新的小特性.</p>
<p>模块最容易开始地方.</p>
</div>
<div class="section" id="id8">
<h3><a class="toc-backref" href="#id25">贡献代码(特性或者修复bug)</a><a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>Ansible 项目的源代码托管在 github 上 ,核心应用位于 <a class="reference external" href="https://github.com/ansible/ansible">github.com/ansible/ansible</a> ,还有两个模块相关的子项目  <a class="reference external" href="https://github.com/ansible/ansible-modules-core">github.com/ansible/ansible-modules-core</a>. 如果你想知道一个模块是核心模块(&#8220;core&#8221;)还是额外模块(&#8220;extras&#8221;),查阅那个模块的网页文档.</p>
<p>在提交代码之前,先到 ansible-devel 邮件列表讨论一下特性问题,这可以有效的避免后期重复的工作.如果你不确定一个新的特性是否合适,先去开发邮件列表讨论一下,这样相对后来不得不修改一个 pull 请求更容易一些.</p>
<p>提交补丁的时候,一定要先运行单元测试“make tests”, 有一些基本的测试会自动运行当创建PR时候. 有更多的深入测试在测试/集成目录,分为 destructive 和 non_destructive,运行这些如果他们属于你的修改.他们被设置了标签,这样你就可以运行子集,一些测试需要云凭证和只有他们提供的时候才会运行.当添加修复 bug 的新的特性的时候,最好添加新的测试防止后期重新回滚.</p>
<p>使用 &#8220;git rebase&#8221; vs &#8220;git merge&#8221;(让git pull 别名为git pull -rebase 是一个好主意) ,来避免合并提交.也有一些基础测试可以运行在 &#8220;test/integration&#8221; 目录</p>
<p>为了保证历史代码的整洁,和对新假如的代码做更好的审计,我们会要求那些包含合并注释的重新提交.使用&#8221;git pull &#8211;rebase&#8221; 而不是 &#8220;git pull&#8221; 和 &#8220;git rebase&#8221; 而不是 &#8220;git merge&#8221;.同样确保有主要分支在使用其他的分支的时候,这样你才不会丢失注释信息.(Also be sure to use topic branches to keep your additions on different branches, such that they won&#8217;t pick up stray commits later.)</p>
<p>如果你犯错了,你不需要关闭你的 PR ,创建一个清洁的本地分支然后推送到github上面使用 &#8211;force 选项,轻质覆盖已存在的分支(在没人使用哪个分支作为参考的情况下是允许的).代码注释不会丢失,他们只是不会连接到现有的分支</p>
<p>然后我们将审阅你的贡献和参与你的问题等等.</p>
<p>因为我们有一个非常大的和活跃的社区,我们可能需要一段时间才能看到你的贡献,看一下后面的优先级部分来了解一下我们的工作队列.要有耐心,你的要求可能不会马上合并,我们也让 devel 能够使用,因此我们需要小心的测试pull 请求,而这需要花费时间.</p>
<p>补丁应该一直在开发分支之上.</p>
<p>记住,小而专请求更容易检查和接受,如果有实例,会更加帮助我们理解 bug 修复的工具和新的特性.</p>
<p>贡献可以是新的特性,像模块,或者是修复一些你或其他人发现的 bug .如果你对写新模块感兴趣,请参考 <a class="reference external" href="http://docs.ansible.com/developing_modules.html">module development documentation</a>.</p>
<p>Ansible的理念鼓励简单、可读的代码和 一致的,保守扩展, 向后兼容的改进.代码开发Ansible需要支持Python 2.6 +, 而代码模块运行需要在Python 2.4之上.请使用4个空格的缩进,而不是tab,(we do not enforce 80 column lines, we are fine with 120-140. We do not take &#8216;style only&#8217; requests unless the code is nearly unreadable, we are &#8220;PEP8ish&#8221;, but not strictly compliant.)</p>
<p>你也可以通过测试和修改其他请求贡献,特别是如果它是一个你用着有趣的东西.请保持你的评论清楚和中肯,礼貌的和有建设性的, ticket 不是一个好开始讨论的地方( ansible-devel 和 IRC 是专门为 tickets 的).</p>
<p>技巧：为了更容易的从一个分支运行,source &#8221;./hacking/env-setup&#8221; 就这样,不需要安装.</p>
</div>
</div>
<div class="section" id="id9">
<h2><a class="toc-backref" href="#id26">其它主题</a><a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id10">
<h3><a class="toc-backref" href="#id27">Ansible 职员</a><a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p>Ansible 一家支持Ansible和基于 Ansible 构建额外的解决方案的公司.我们会服务和支持那些有趣的东西.我们还提供了一个企业 web 前端 Ansible(见下面的 Tower ).</p>
<p>我们最重要的任务是使 ansible 社区发生一些大事,包括组织Ansible的软件版本.想获取更多的信息,联系 <a class="reference external" href="mailto:info&#37;&#52;&#48;ansible&#46;com">info<span>&#64;</span>ansible<span>&#46;</span>com</a></p>
<p>在 IRC 上,你可以找到我们 jimi_c, abadger1999, Tybstar, bcoca.在邮件列表上,我们使用 &#64;ansible.com 的地址发送.</p>
</div>
<div class="section" id="id11">
<h3><a class="toc-backref" href="#id28">邮件列表信息</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>Ansible有一些邮件列表,因为审核的原因,你的第一次投递邮件可能时间稍长,请允许一天时间的延迟.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-project">Ansible Project List</a> 分享 Ansible的技巧,问题解答,用户讨论.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-devel">Ansible Development List</a> 学习如何在Ansible上开发,询问ansible未来的设计特性,讨论扩展ansible或者正在进行的ansible特性.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-announce">Ansible Announce list</a> 关于ansible版本号的只读共享信息,小频率的ansible事件信息.例如：通知AnsibleFest的出现.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/ansible-lockdown">Ansible Lockdown List</a> 关于ansible lockdown项目的所有信息,包括DISA STIG 自动化和 CIS Benchmarks</p>
<p>对于非google账户订阅一个组,你可以发送邮件到这订阅地址请求订阅,例如：<a class="reference external" href="mailto:ansible-devel+subscribe&#37;&#52;&#48;googlegroups&#46;com">ansible-devel+subscribe<span>&#64;</span>googlegroups<span>&#46;</span>com</a></p>
</div>
<div class="section" id="id12">
<h3><a class="toc-backref" href="#id29">版本号</a><a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>以 &#8221;.0&#8221; 结尾的版本是朱版本,同时将会有很多新的特性.以其他整数结尾的 ,像&#8221;0.X.1&#8221; 和 &#8220;0.X.2&#8221;是小版本,这些仅仅包含 bug 修复</p>
<p>通常来说,我们不会发布小版本号(保存用于大的项目),但是如果现在具体下次发布会有很长时间的话,偶尔可能决定去除包含大量修复的小版本.</p>
<p>版本号基于没有其他人使用 Van Halen 的歌曲命名.</p>
</div>
<div class="section" id="tower">
<h3><a class="toc-backref" href="#id30">Tower 支持问题</a><a class="headerlink" href="#tower" title="Permalink to this headline">¶</a></h3>
<p>Ansible <cite>Tower &lt;http://ansible.com/tower&gt;</cite> 是一个对 ansible 提供的用户接口,服务,应用程序接口等等.</p>
<p>如果你有关于 tower的问题,发送邮件到 <cite>support&#64;ansible.com &lt;mailto:support&#64;ansible.com&gt;</cite> 而不是在IRC频道上,或者一般邮件列表上提问</p>
</div>
<div class="section" id="irc">
<h3><a class="toc-backref" href="#id31">IRC 频道</a><a class="headerlink" href="#irc" title="Permalink to this headline">¶</a></h3>
<p>Ansible 有IRC 频道 #ansible on irc.freenode.net.</p>
</div>
<div class="section" id="id13">
<h3><a class="toc-backref" href="#id32">注意优先级的标识</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>在2013年,Ansible 位于 github 上开源软件的前 5 名,到目前为止,有 800 多个对此项目贡献者,更不用说一个非常大的用户社区,下载了这个应用超过一百万次了.因此,我们有将会有很多的活动.</p>
<p>下面,我们会告诉你如何处理新来的请求的.</p>
<p>在我们的 bug traker 中你会注意到一些标签- P1,P2,P3,P4和P5.这是我们的内部用于对提交的 bug 排序的.</p>
<p>除了一些例外,便于合并(比如文档类型), 我们都会首先花时间处理 P1 和 P2 item,包括 pull 请求.这些通常与重大的 bug 有关,同时影响大量的用户群里.因此,如果你看到一些 &#8220;P3 or P4 的分类,那些将不会得到立即的关注.</p>
<p>这些标签没有定义,它们只是简单的排序.然而,有些东西影响核心模块(yum,apt,等等)可能会有更高的优先级,相比那些影响少数用户的模块来说.</p>
<p>因为我们非常强调测试和代码审查,可能需要几个月的小功能合并.</p>
<p>但是不要担心,我们也会定期的给迪有限的队列做定期的清理,给予一些关注,由其在新模块的改变上面.因此,这不意味着我们把精力都花费在高优先级的东西上,而忽略了你的 请求(ticket)</p>
<p>任何努力都会有帮助的,如果你促进快P3的 pull request 特性 ,你可以做的最好的事情是帮助处理 P2 bug 报告.</p>
</div>
<div class="section" id="id14">
<h3><a class="toc-backref" href="#id33">社区代码和产品</a><a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>社区欢迎所有类型的用户,什么背景,什么技术级别都可以.请尊敬其他人就像你想让其他人尊敬你一样,保持讨论的活跃氛围,不要产生冲突,避免各种歧视,亵渎,避免无用的争论(例如:vi和emace那个更好一样.)</p>
<p>在社区事件上面也是希望大家好好相处</p>
<p>邮件列表应该集中在IT自动化上面.滥用社区的指南将不会被容忍,后果是禁用社区资源</p>
</div>
<div class="section" id="id15">
<h3><a class="toc-backref" href="#id34">贡献执照许可</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>通过贡献,你被授予一个完整的,不可吊销的版权执照,依据这个项目的执照,这个执照对这个项目的所有用户和开发者都有效.</p>
</div>
</div>
<span id="document-docs/galaxy"></span><div class="section" id="ansible-galaxy">
<h2>Ansible Galaxy<a class="headerlink" href="#ansible-galaxy" title="Permalink to this headline">¶</a></h2>
<p>&#8220;Ansible Galaxy&#8221; 指的是一个网站共享和下载 Ansible 角色,也可以是者是帮助 roles 更好的工作的命令行工具。</p>
<p>The Website
网站
<code class="docutils literal"><span class="pre">```````</span></code></p>
<p>这个网站 <a class="reference external" href="https://galaxy.ansible.com">Ansible Galaxy</a>，是一个免费的用于查找，下载，评论各种社区开发的 Ansible 角色，在你的自动化项目中引入一些角色也是不错的。</p>
<p>你可以使用 social auth 注册和使用 &#8220;ansible-galaxy&#8221; 下载客户端，&#8221;ansible-galaxy&#8221;在 Ansible 1.4.2 就已经被包含了。</p>
<p>阅读 Galaxy 网站的 &#8220;About&#8221; 页面获取更多信息。</p>
<div class="section" id="id2">
<h3>ansible-galaxy命令行工具<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>ansible-galaxy 有许多不同的子命令</p>
<div class="section" id="id3">
<h4>安装角色<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>很明显从 Ansible Galaxy 网站下载角色</p>
<blockquote>
<div>ansible-galaxy install username.rolename</div></blockquote>
</div>
<div class="section" id="id4">
<h4>构建角色架构<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>也可以用于初始化一个新角色的基本文件结构，节省创建不同的目录和main.yml的时间了。</p>
<blockquote>
<div>ansible-galaxy init rolename</div></blockquote>
</div>
<div class="section" id="id5">
<h4>从一个文件安装多个角色<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>想安装多个角色，ansible-galaxy 命令行可以通过一个 requirements 文件实现。各种版本的ansible 都允许使用下面的语法从 Ansible galaxy 网站安装角色。</p>
<blockquote>
<div>ansible-galaxy install -r requirements.txt</div></blockquote>
<p>requirements.txt 文件看起来就像这样</p>
<blockquote>
<div>username1.foo_role
username2.bar_role</div></blockquote>
<p>想得到指定版本(tag)的role，使用下面的语法</p>
<blockquote>
<div>username1.foo_role,version
username2.bar_role,version</div></blockquote>
<p>可用的版本在 Ansible Galaxy 网页上都有列出来。</p>
</div>
<div class="section" id="requirements">
<h4>Requirements 文件高级用法<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h4>
<p>一些控制从哪里下载角色，支持远程源的用法，在 Ansible 1.8 之后支持通过 YMAL 语法的 requirements 文件实现，但是必须以 yml为文件扩展名。就像这样</p>
<blockquote>
<div>ansible-galaxy install -r requirements.yml</div></blockquote>
<p>扩展名是很重要的，如果 .yml 扩展忘记写了， ansible-galaxy 命令行会假设这个文件是普通格式的，而且会失败，</p>
<p>这里有个例子展示通过多个源下载一些指定版本。 其中也实现了覆盖下载角色的名字到其它名字。</p>
<blockquote>
<div><p># from galaxy
- src: yatesr.timezone</p>
<p># from github
- src: <a class="reference external" href="https://github.com/bennojoy/nginx">https://github.com/bennojoy/nginx</a></p>
<p># from github installing to a relative path
- src: <a class="reference external" href="https://github.com/bennojoy/nginx">https://github.com/bennojoy/nginx</a></p>
<blockquote>
<div>path: vagrant/roles/</div></blockquote>
<p># from github, overriding the name and specifying a specific tag
- src: <a class="reference external" href="https://github.com/bennojoy/nginx">https://github.com/bennojoy/nginx</a></p>
<blockquote>
<div>version: master
name: nginx_role</div></blockquote>
<p># from a webserver, where the role is packaged in a tar.gz
- src: <a class="reference external" href="https://some.webserver.example.com/files/master.tar.gz">https://some.webserver.example.com/files/master.tar.gz</a></p>
<blockquote>
<div>name: http-role</div></blockquote>
<p># from bitbucket, if bitbucket happens to be operational right now :)
- src: git+http://bitbucket.org/willthames/git-ansible-galaxy</p>
<blockquote>
<div>version: v1.4</div></blockquote>
<p># from bitbucket, alternative syntax and caveats
- src: <a class="reference external" href="http://bitbucket.org/willthames/hg-ansible-galaxy">http://bitbucket.org/willthames/hg-ansible-galaxy</a></p>
<blockquote>
<div>scm: hg</div></blockquote>
</div></blockquote>
<p>从上面你可以看到，有许多控制命令可以使用去自定义那些角色从哪里获得，保存为什么角色名称。</p>
<p>Roles pulled from galaxy work as with other SCM sourced roles above. To download a role with dependencies, and automatically install those dependencies, the role must be uploaded to the Ansible Galaxy website.
有些角色之间会有依赖关系，想要从依赖关系中自动安装，这个角色需要被上传到 Ansible Galaxy 网站上。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks_roles"><em>Playbook Roles and Include Statements</em></a></dt>
<dd>关于 Ansible role 的内容</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
<span id="document-docs/test_strategies"></span><div class="section" id="id1">
<h2>测试策略<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ansible-playbooks">
<span id="testing-intro"></span><h3>Ansible Playbooks 的集成测试<a class="headerlink" href="#ansible-playbooks" title="Permalink to this headline">¶</a></h3>
<p>很多时候, 人们问, &#8220;我怎样才能最好的将 Ansible playbooks 和测试结合在一起?&#8221; 这有很多选择. Ansible 的设计实际上是一个&#8221;fail-fast&#8221;有序系统, 因此它可以很容易地嵌入到 Ansible playbooks. 在这一章节, 我们将讨论基础设施的集成测试及合适的测试等级.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">这是一个关于测试你部署应用程序的章节, 不是如何测试开发的 Ansible 模块. 对于那些内容, 请移步开发区域.</p>
</div>
<p>通过将某种程度的测试部署合并到部署工作流中, 当代码运行在生产环境中这将减少意外的产生, 在许多情况下, 测试可以避免在生产中因为更新失败而导致的迁移整个安装. 因为它是基于推送的, 它可以很容易的运行在 localhost 或者测试服务器上. Ansible 允许你添加尽可能多的检查在你的升级流程中.</p>
</div>
<div class="section" id="id2">
<h3>正确的测试等级<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Ansible 资源是期望状态的模块. 因此测试服务是否处于运行, 包是否已经安装, 或其他这样的事情它不是必要的. Ansible 确保这些系统中的这些声明是真实的. 相反, 在你的 playbooks 中 assert 这些事情.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=foo state=started enabled=yes</span>
</pre></div>
</div>
<p>如果你认为该服务可能没有启动, 最好的事情就是要求它处于启动状态. 如果这个服务启动失败, Ansible 将适当的抛出. (这不应该和服务是否正在做一些功能性的事情混淆, 而我们应该更多的展示如何做这些事).</p>
</div>
<div class="section" id="check">
<h3>Check 模块作为主要测试<a class="headerlink" href="#check" title="Permalink to this headline">¶</a></h3>
<p>在上面的设置中, <cite>&#8211;check</cite> 模块在 Ansible 中可以作为一层测试. 如果在一个现有的系统部署 playbook, 使用 <cite>&#8211;check</cite> 选项 <cite>ansible</cite> 命令将会报告出 Ansible 使系统进入一个期望状态所做的任何更改.</p>
<p>这可以让你知道前面任何需要不如到给定系统的信息. 一般的脚本和命令不运行在检查模式, 所以如果你想要某些步骤总是在检查模式下执行, 例如调用 script 模块, 添加 &#8216;always_run&#8217; 标记:</p>
<div class="highlight-bash"><div class="highlight"><pre>roles:
  - webserver

tasks:
  - script: verify.sh
    always_run: True
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>用于测试的模块<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>某些 playbook 模块对于测试特别友好. 下面的例子保证端口处于打开状态:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

  - wait_for: <span class="nv">host</span><span class="o">={{</span> inventory_hostname <span class="o">}}</span> <span class="nv">port</span><span class="o">=</span>22
    delegate_to: localhost
</pre></div>
</div>
<p>这是使用 URI 模块来确保 web service 有正确的返回:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

  - action: uri <span class="nv">url</span><span class="o">=</span>http://www.example.com <span class="nv">return_content</span><span class="o">=</span>yes
    register: webpage

  - fail: <span class="nv">msg</span><span class="o">=</span><span class="s1">&#39;service is not happy&#39;</span>
    when: <span class="s2">&quot;&#39;AWESOME&#39; not in webpage.content&quot;</span>
</pre></div>
</div>
<p>可以很容易的将任意(语言)的脚本推送到远程主机上, 如果这个脚本有一个非零的返回码, 它将自动失效:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

  - script: test_script1
  - script: test_script2 --parameter value --parameter2 value
</pre></div>
</div>
<p>如果使用 roles(你应该这样做, roles 是伟大的!), 脚本模块可以推送 role 下的 &#8216;files/&#8217; 目录下的脚本</p>
<p>添加 assert 模块, 它可以很容易的验证各种真理:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

   - shell: /usr/bin/some-command --parameter value
     register: cmd_result

   - assert:
       that:
         - <span class="s2">&quot;&#39;not ready&#39; not in cmd_result.stderr&quot;</span>
         - <span class="s2">&quot;&#39;gizmo enabled&#39; in cmd_result.stdout&quot;</span>
</pre></div>
</div>
<p>如果你觉得需要测试通过 Ansible 设置的文件是否存在, &#8216;stat&#8217; 模块是一个不错的选择:</p>
<div class="highlight-bash"><div class="highlight"><pre>tasks:

   - stat: <span class="nv">path</span><span class="o">=</span>/path/to/something
     register: p

   - assert:
       that:
         - p.stat.exists and p.stat.isdir
</pre></div>
</div>
<p>如上所处, 哪些没必要检查的东西如命令的返回码. Ansible 自动检查它们.
如果检查用户存在, 考虑使用 user 模块使其存在.</p>
<p>Ansible 是一个 fail-fast 系统, 所以当创建用户失败, 它将停止 playbook 的运行. 你不必检查它背后的原因.</p>
</div>
<div class="section" id="id4">
<h3>测试的生命周期<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>如果将你的应用程序的基本验证写入了你的 playbooks 中, 在你每次部署的适合他们都将运行.</p>
<p>因此部署到本地开发的虚拟机和临时的环境都将根据你的生产环境的部署计划来验证这一切.</p>
<p>你的工作流可能是这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>- 使用相同的 playbook 在开发过程中嵌入测试
- 使用 playbook 部署一个临时环境<span class="o">(</span>使用相同的playbooks<span class="o">)</span>来模拟生产
- 运行一个由 QA 团建编写的集成测试用例
- 使用相同的总和测试部署到生产.
</pre></div>
</div>
<p>如果你是一个产品服务, 一些像集成测试系列需要通过你的 QA 团队来编写. 这将包含诸如测试用例或自动化 API 测试, 这些通常不是嵌入到 Ansible 的 playbooks 中的.</p>
<p>然而, 它包含基本的健康的检查使 playbooks 有意义, 而且在某些情况下它可能会相对于远程节点运行一些 QA 的子集合. 这是下一节所涵盖的内容.</p>
</div>
<div class="section" id="id5">
<h3>结合滚动更新测试<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>如果你已经读到 <a class="reference internal" href="index.html#document-docs/playbooks_delegation"><em>委托,滚动更新,本地动作</em></a> 滚动更新的扩展好处可以迅速变得明显, 你可以使用 playbook 运行的成功或失败来决定是否增加机器到负载均衡器中.</p>
<p>这是嵌入测试的显著结果:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers
  serial: 5

  pre_tasks:

    - name: take out of load balancer pool
      <span class="nb">command</span>: /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: 127.0.0.1

  roles:

     - common
     - webserver
     - apply_testing_checks

  post_tasks:

    - name: add back to load balancer pool
      <span class="nb">command</span>: /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: 127.0.0.1
</pre></div>
</div>
<p>在上述过程中, &#8220;task out of the pool&#8221; 和 &#8220;add back&#8221; 的步骤将会代替 Ansible 调用负载均衡模块或对应的 shell 命令. 您还可以使用监控模块对机器进行创建和关闭中断的窗口.</p>
<p>然而, 你可以从上面看出测试作为入口 &#8211; 如果&#8221;apply_testing_checks&#8221;这一步不执行, 这个机器将不会被添加到池中.</p>
<p>阅读关于&#8221;max_fail_percentage&#8221;的代表章节, 你可以控制有多少失败的测试后停止程序的滚动更新.</p>
<p>这种方式也可以被修改为先在测试机器上执行测试步骤然后在远程机器执行测试的步骤:</p>
<div class="highlight-bash"><div class="highlight"><pre>---

- hosts: webservers
  serial: 5

  pre_tasks:

    - name: take out of load balancer pool
      <span class="nb">command</span>: /usr/bin/take_out_of_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: 127.0.0.1

  roles:

     - common
     - webserver

  tasks:
     - script: /srv/qa_team/app_testing_script.sh --server <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
       delegate_to: testing_server

  post_tasks:

    - name: add back to load balancer pool
      <span class="nb">command</span>: /usr/bin/add_back_to_pool <span class="o">{{</span> inventory_hostname <span class="o">}}</span>
      delegate_to: 127.0.0.1
</pre></div>
</div>
<p>在上面的例子中, 从测试服务器上执行一个脚本紧接着将一个远程的节点添加到 pool 中.</p>
<p>在出现问题时, 解决一些服务器不能使用 Ansible 自动生成的重试文件重复部署这些服务器.</p>
</div>
<div class="section" id="id6">
<h3>实现连续部署<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>如果需要, 上述技术可以扩展到启用连续部署中.</p>
<p>这个工作流可能像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>- 编写和使用自动部署本地开发虚拟机
- 有一个 CI 系统像 Jenkins, 来将每一次的代码变更部署到临时环境中
- 这个部署任务调用测试脚本, 参考通过/失败来确定每一次的部署是否进行 build
- 如果部署任务成功, 它将在生产环境中运行相同的部署 playbook
</pre></div>
</div>
<p>一些 Ansible 用户使用上述方式, 在一个小时内多次部署使它们所有的基础设施不下线. 如果你想达到那种水平, 一个自动 QA 系统是至关重要的.</p>
<p>如果你仍然在大量使用人工 QA, 你仍然需要决定手动部署是否是最好的, 但它仍然可以帮助滚动更新前的一部分工作, 包括基本的健康检查使用模块 &#8216;script&#8217;, &#8216;stat&#8217;, &#8216;uri&#8217;, 和 &#8216;assert&#8217;.</p>
</div>
<div class="section" id="id7">
<h3>结尾<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>Ansible 相信你应该不需要另一个框架来验证你的基础设施是正确的. 这种情况是因为 Ansible 是基于顺序的系统, 处理失败后将立即在主机上引发错误, 并阻止该主机进一步的配置. 这迫使 Ansible 在运行结束后将错误作为摘要显示在顶端.</p>
<p>然而, Ansible 作为一个多层编排系统, 它可以很轻松的将测试合并到 playbook 中运行完毕, 使用 tasks 或 roles. 当使用滚动更新时, 测试步骤可以决定是否要把一台服务器添加到负载均衡池中.</p>
<p>最后, 因为 Ansible 错误会通过所有的方式进行传播以及 Ansible 程序本身的返回码, Ansible 默认运行在一个简单的推送模式, 如果你想使用它作为部署系统, 持续集成/持续交付道路上的组成部分, Ansible 是作为构建环境的最好的阶段, 如上面部分的介绍.</p>
<p>重点不应该放在基础设施测试上, 而是在应用程序的测试, 所以我们强烈鼓励你和你的 QA 团队商量出对于每一次部署的开发虚拟机什么样的测试是有意义的, 并将他们希望对每个部署的临时环境的测试进行排序. Ansible 描述了资源应该所处的状态, 所以你不需要考虑这些. 如果存在你需要确定的东西, 使用 stat/assert 这些伟大的模块来实现你的目的, 这将是最棒的.</p>
<p>总之, 测试是一个组织非常明确的事情. 每一个人都应该这样做, 但是这些要根据你要部署什么以及谁在使用它们来确定最适合的方案 &#8211; 但每个人肯定都会从一个更加强大和可靠的部署系统中受益.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/modules"><em>模块相关</em></a></dt>
<dd>All the documentation for Ansible modules</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_delegation"><em>委托,滚动更新,本地动作</em></a></dt>
<dd>Delegation, useful for working with loud balancers, clouds, and locally executed steps.</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/faq"></span><div class="section" id="id1">
<h2>常见问题<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>这是一些常见问题和回答</p>
<div class="section" id="task-playbook-path">
<span id="set-environment"></span><h3>我可以为一个任务(task)或剧本(playbook)设置 PATH 或者其它环境变量吗？<a class="headerlink" href="#task-playbook-path" title="Permalink to this headline">¶</a></h3>
<p>可以通过 <cite>environment</cite> 关键字设置环境变量，可以用在 task 或者 play 上</p>
<blockquote>
<div><dl class="docutils">
<dt>environment:</dt>
<dd>PATH: &#8220;{{ ansible_env.PATH }}:/thingy/bin&#8221;
SOME: value</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="id2">
<h3>如何处理需要不同账户与端口登录的不同机器？<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>设置清单(inventory)文件是最简单的方式</p>
<p>例如，假设这些主机有不同的用户名和端口</p>
<blockquote>
<div>[webservers]
asdf.example.com  ansible_ssh_port=5000   ansible_ssh_user=alice
jkl.example.com   ansible_ssh_port=5001   ansible_ssh_user=bob</div></blockquote>
<p>你也可以指定什么类型的连接。</p>
<blockquote>
<div>[testcluster]
localhost           ansible_connection=local
/path/to/chroot1    ansible_connection=chroot
foo.example.com
bar.example.com</div></blockquote>
<p>你可能想保存这些组变量，或者一些变量文件。 看剩余的文档获取更多有关如何组织变量的信息</p>
</div>
<div class="section" id="ansible-kerberized-ssh-ansible-ssh-config">
<span id="use-ssh"></span><h3>如何让 ansible 重用连接，启用 Kerberized SSH，或者让Ansible 注意本地的 SSH config 文件。<a class="headerlink" href="#ansible-kerberized-ssh-ansible-ssh-config" title="Permalink to this headline">¶</a></h3>
<p>转换默认连接类型，在配置文件里面设置为,&#8217;ssh&#8217;，或者使用 &#8216;-c ssh&#8217;选项使用OpenSSH连接，而不是python的paramiko库。在 Ansible 1.2.1之后，&#8217;ssh&#8217;会默认使用。</p>
<p>paramiko在刚开始的时候是不错的，但是OpenSSH提供更多的高级选项。如果你正在使用这种连接类型的话，你可能会想在一个支持 ControlPersist 的新机器上运行 Ansible。你同样可以管理老的客户端。如果你正在用 RHEL6，CentOS6，SLES 10或 SLES 11，OpenSSH的版本仍然有些过时，因此考虑使用Fedora或OpenSUSE客户端来管理节点，或者使用paramiko。</p>
<p>我们默认让paramiko作为默认选项，如果你第一次安装Ansible在一个EL box上，它提供了更好的用户体验。</p>
</div>
<div class="section" id="ec2">
<span id="ec2-cloud-performance"></span><h3>如何在EC2内加速管理？<a class="headerlink" href="#ec2" title="Permalink to this headline">¶</a></h3>
<p>不要试着用你的笔记本电脑管理一群 EC2 机器。连接到EC2内的管理节点然后在里面运行Ansible</p>
</div>
<div class="section" id="usr-bin-python">
<span id="python-interpreters"></span><h3>如何处理远程机器上没有 /usr/bin/python 路径？<a class="headerlink" href="#usr-bin-python" title="Permalink to this headline">¶</a></h3>
<p>尽管你可以使用其他语言编写 Ansible 模块，但大部分 Ansible 模块是用 Python 写的 ，而且一些事非常重要的核心模块</p>
<p>默认情况下， Ansible 假定它可以在远程机器上找到 2.x版本以上的 /usr/bin/python ，指定为2.4或者更高的版本。</p>
<p>设置 inventory 变量 &#8216;ansible_python_interpreter&#8217; ，允许 Ansible自动替换掉默认的 python解释器。因此你可以指向任何版本的 python ，尽管/usr/bin/python不存在</p>
<p>一些 Linux 操作系统，例如 Arch 可能默认安装的是 Python 3. 这会让你在运行模块的时候出现语法错误信息。 Python 3和 Python 2 在本质上还是有些区别的。Ansible 当前需要支持哪些更老版本的 Python 用户，因此还没有支持 Python 3.0。这不是一个问题，只需要安装 Python2 就可以解决问题。</p>
<p>当 Ansible 或 Python3.0 后来变得更加主流的时候，会支持Python 3.0</p>
<p>不要替换 python 模块的 shebang 行，Ansible 在部署的时候会自动处理。</p>
</div>
<div class="section" id="use-roles">
<span id="id3"></span><h3>让内容重用和重新分发的最好方式是什么？<a class="headerlink" href="#use-roles" title="Permalink to this headline">¶</a></h3>
<p>如果你还没有做好， 请阅读 playbooks 文档的 &#8220;Roles&#8221; 部分。 这会让你更好的理解 playbook 的内容。(This helps you make playbook content self-contained, and works well with things like git submodules for sharing content with others.)</p>
<p>如果你对这些插件很陌生，查看 API 文档获取更多的有关扩展 Ansible 的细节信息
.. _configuration_file:</p>
</div>
<div class="section" id="id4">
<h3>配置文件在那个地方，我如何配置它？<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>看 <a class="reference internal" href="index.html#document-docs/intro_configuration"><em>Ansible的配置文件</em></a>.</p>
</div>
<div class="section" id="cowsay">
<span id="who-would-ever-want-to-disable-cowsay-but-ok-here-is-how"></span><h3>如何禁止 cowsay?<a class="headerlink" href="#cowsay" title="Permalink to this headline">¶</a></h3>
<p>如果你确定你想运行在没有cowsay的环境下，你可以卸载 cowsay，或者设置环境变量</p>
<blockquote>
<div>export ANSIBLE_NOCOWS=1</div></blockquote>
<p id="browse-facts">How do I see a list of all of the ansible_ variables?
如何查看所有的 ansible_variables?
++++++++++++++++++++++++++++++++++++++++++++++++++++++</p>
<p>默认情况下，Ansible 收集 有关机器的 &#8220;facts&#8221; ，这些 facts 可以被Playbook或templates访问。想要查看相关机器的所有的facts，运行 &#8220;setup&#8221; 模块。</p>
<blockquote>
<div>ansible -m setup hostname</div></blockquote>
<p>这会打印指定主机上的所有的字典形式的facts。</p>
</div>
<div class="section" id="host-loops">
<span id="id5"></span><h3>如何遍历某一组内的所有主机，在模板中？<a class="headerlink" href="#host-loops" title="Permalink to this headline">¶</a></h3>
<p>一个通用的做法是遍历组内的所有主机，你可以访问 &#8220;$groups&#8221; 字典在模板中，就像这样</p>
<blockquote>
<div><dl class="docutils">
<dt>{% for host in groups[&#8216;db_servers&#8217;] %}</dt>
<dd>{{ host }}</dd>
</dl>
<p>{% endfor %}</p>
</div></blockquote>
<p>如果你需要访问有关这些主机的 facts ，例如每个主机的IP地址，你需要确保 facts 已经被 populated 了。例如</p>
<blockquote>
<div><ul>
<li><p class="first">hosts:  db_servers
tasks:</p>
<blockquote>
<div><ul class="simple">
<li># doesn&#8217;t matter what you do, just that they were talked to previously.</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>然后你可以使用 facts 在模板里面，就像这样</p>
<blockquote>
<div><dl class="docutils">
<dt>{% for host in groups[&#8216;db_servers&#8217;] %}</dt>
<dd>{{ hostvars[host][&#8216;ansible_eth0&#8217;][&#8216;ipv4&#8217;][&#8216;address&#8217;] }}</dd>
</dl>
<p>{% endfor %}</p>
</div></blockquote>
</div>
<div class="section" id="programatic-access-to-a-variable">
<span id="id6"></span><h3>如何以编程方式访问变量名<a class="headerlink" href="#programatic-access-to-a-variable" title="Permalink to this headline">¶</a></h3>
<p>可能出现这种情况,我们需要一个任意的ipv4地址接口,同时这个接口是通过角色提供参数或其他输入提供的。变量名可以通过组合字符串来构建，就像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">{{</span> hostvars<span class="o">[</span>inventory_hostname<span class="o">][</span><span class="s1">&#39;ansible_&#39;</span> + which_interface<span class="o">][</span><span class="s1">&#39;ipv4&#39;</span><span class="o">][</span><span class="s1">&#39;address&#39;</span><span class="o">]</span> <span class="o">}}</span>
</pre></div>
</div>
<p>这个遍历主机变量的技巧是必要的，因为它是一变量名称扣减的字典。&#8217;inventory_hostname&#8217; 是一个神奇的变量，因为它告诉你你在主机组循环中当前的主机是谁。</p>
</div>
<div class="section" id="first-host-in-a-group">
<span id="id7"></span><h3>如何访问组内第一个主机的变量？<a class="headerlink" href="#first-host-in-a-group" title="Permalink to this headline">¶</a></h3>
<p>如果我们想要在 webservers 组内的第一个 webserver 的 ip 地址怎么办？我们可以这么做。注意如果再使用动态 inventory ， &#8216;first&#8217; 的主机可能不会一致 ，因此你不希望这样，除非你耳朵 inventory 是静态。(如果你在用 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a>,它会使用数据库指令，因此这不是个问题尽管你正在使用基于云环境的 inventory 脚本)</p>
<p>这里是技巧：</p>
<blockquote>
<div>{{ hostvars[groups[&#8216;webservers&#8217;][0]][&#8216;ansible_eth0&#8217;][&#8216;ipv4&#8217;][&#8216;address&#8217;] }}</div></blockquote>
<p>注意我们如何获得 webserver 组内的第一台机器的主机名的。如果你也在在模板中这么做，你可以用 Jinja2 &#8220;#set&#8221; 指令来简化这，或者在一个基本中，你也可以设置 fact</p>
<blockquote>
<div><ul class="simple">
<li>set_fact: headnode={{ groups[[&#8216;webservers&#8217;][0]] }}</li>
<li>debug: msg={{ hostvars[headnode].ansible_eth0.ipv4.address }}</li>
</ul>
</div></blockquote>
<p>注意我们如何交换花括号的语法点(Notice how we interchanged the bracket syntax for dots)。</p>
</div>
<div class="section" id="file-recursion">
<span id="id8"></span><h3>如何递归的宝贝文件到目标主机上?<a class="headerlink" href="#file-recursion" title="Permalink to this headline">¶</a></h3>
<p>&#8220;copy&#8221; 模块有递归的参数，如果你想更加高徐璈的处理大量的文件，看一下 &#8220;synchronize&#8221;模块，封装了rsync。自行看一些模块索引获取一些他们的信息。</p>
</div>
<div class="section" id="shell">
<span id="shell-env"></span><h3>如何查看 shell 环境变量？<a class="headerlink" href="#shell" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>如果是只是想看看，使用 <cite>env</cite> 查看。例如，如果想查看在管理机器上 HOME 环境变量的值。</dt>
<dd><p class="first">&#8212;
# ...</p>
<blockquote class="last">
<div><dl class="docutils">
<dt>vars:</dt>
<dd>local_home: &#8220;{{ lookup(&#8216;env&#8217;,&#8217;HOME&#8217;) }}&#8221;</dd>
</dl>
</div></blockquote>
</dd>
</dl>
<p>如果你是想设置环境变量，查看高级的有关环境的 Playbook 部分。</p>
<p>Ansible 1.4 will also make remote environment variables available via facts in the &#8216;ansible_env&#8217; variable::
Ansible1.4也会让远程的环境变量可用通过 facts 在 &#8216;ansible_env&#8217; 变量。</p>
<blockquote>
<div>{{ ansible_env.SOME_VARIABLE }}</div></blockquote>
</div>
<div class="section" id="user-passwords">
<span id="id9"></span><h3>如何为用户模块生成加密密码？<a class="headerlink" href="#user-passwords" title="Permalink to this headline">¶</a></h3>
<p>mkpasswd工具在大多数linux系统上都可以使用，是一个不错的选项</p>
<blockquote>
<div>mkpasswd &#8211;method=SHA-512</div></blockquote>
<p>如果这个工具在你系统上面没安装，你可以简单的通过 Python 生成密码。首先确保 <a class="reference external" href="https://code.google.com/p/passlib/">Passlib</a> 密码哈西库已经安装了。</p>
<blockquote>
<div>pip install passlib</div></blockquote>
<p>一旦库准备好了，SHA512密码值可以被生成通过下面命令生成。</p>
<blockquote>
<div>python -c &#8220;from passlib.hash import sha512_crypt; import getpass; print sha512_crypt.encrypt(getpass.getpass())&#8221;</div></blockquote>
</div>
<div class="section" id="ansible">
<span id="commercial-support"></span><h3>如何获得Ansible培训到商业支持？<a class="headerlink" href="#ansible" title="Permalink to this headline">¶</a></h3>
<p>Yes！ 看我们的 <a class="reference external" href="http://www.ansible.com/services">services page</a>  获得更多的信息关于我们的服务和培训服务。支持也包含在 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a> 。发邮件到`info&#64;ansible.com &lt;<a class="reference external" href="mailto:info&#37;&#52;&#48;ansible&#46;com">mailto:info<span>&#64;</span>ansible<span>&#46;</span>com</a>&gt;`_ 获取更深的细节。</p>
<p>我们也会提供免费的培训课程在基础上。 看  <a class="reference external" href="http://www.ansible.com/webinars-training">webinar page</a> 获得更多信息在下面的研讨会上。</p>
</div>
<div class="section" id="rest-api-etc">
<span id="web-interface"></span><h3>有网络接口  / REST API / etc?<a class="headerlink" href="#rest-api-etc" title="Permalink to this headline">¶</a></h3>
<p>Yes！Ansible 做了很好的产品让 Ansible 更加的强大容器使用，看 <a class="reference internal" href="index.html#document-docs/tower"><em>Ansible Tower</em></a></p>
</div>
<div class="section" id="docs-contributions">
<span id="id10"></span><h3>如何提交文档改变信息？<a class="headerlink" href="#docs-contributions" title="Permalink to this headline">¶</a></h3>
<p>不错的问题！ Ansible 文档保存在主项目git 源下面，指导贡献可以在 docs README <a href="#id11"><span class="problematic" id="id12">`</span></a>viewable on GitHub &lt;<a class="reference external" href="https://github.com/ansible/ansible/blob/devel/docsite/README.md">https://github.com/ansible/ansible/blob/devel/docsite/README.md</a>&gt;`_找到。谢谢！</p>
</div>
<div class="section" id="keep-secret-data">
<span id="id13"></span><h3>如何加密我的剧本数据？<a class="headerlink" href="#keep-secret-data" title="Permalink to this headline">¶</a></h3>
<p>如果你想加密数据，仍然想要在源码控制上分享给大家。看 <a class="reference internal" href="index.html#document-docs/playbooks_vault"><em>Vault</em></a>.</p>
<p id="i-dont-see-my-question">在 Ansible 1.8后，如果你有一个任务，你不想显示结果，或者给了命令 -v 选项，下面的例子很有用</p>
<blockquote>
<div><ul class="simple">
<li>name: secret task
shell: /usr/bin/do_something &#8211;value={{ secret_value }}
no_log: True</li>
</ul>
</div></blockquote>
<p>这个对保持详细的输出，但是从其他人那里隐藏了敏感的信息。</p>
<p>no_log属性也可以应用在整个 play 里面。</p>
<blockquote>
<div><ul class="simple">
<li>hosts: all
no_log: True</li>
</ul>
</div></blockquote>
<p>尽管这回让play很难调试。推荐使用这个应用到单一任务上。</p>
</div>
<div class="section" id="id14">
<h3>在这里我没看到我的问题<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>请看下面的部分链接到 IRC 和 Google Group，你可以在那里提问你的问题。</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/index"><em>Ansible 文档</em></a></dt>
<dd>The documentation index</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Best practices advice</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/glossary"></span><div class="section" id="glossary">
<h2>Glossary<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h2>
<p>The following is a list (and re-explanation) of term definitions used elsewhere in the Ansible documentation.</p>
<p>Consult the documentation home page for the full documentation and to see the terms in context, but this should be a good resource
to check your knowledge of Ansible&#8217;s components and understand how they fit together.  It&#8217;s something you might wish to read for review or
when a term comes up on the mailing list.</p>
<div class="section" id="action">
<h3>Action<a class="headerlink" href="#action" title="Permalink to this headline">¶</a></h3>
<p>An action is a part of a task that specifies which of the modules to run and the arguments to pass to that module.  Each task can have only one action, but it may also have other parameters.</p>
</div>
<div class="section" id="ad-hoc">
<h3>Ad Hoc<a class="headerlink" href="#ad-hoc" title="Permalink to this headline">¶</a></h3>
<p>Refers to running Ansible to perform some quick command, using /usr/bin/ansible, rather than the orchestration language, which is
/usr/bin/ansible-playbook.  An example of an ad-hoc command might be rebooting 50 machines in your infrastructure.  Anything
you can do ad-hoc can be accomplished by writing a playbook, and playbooks can also glue lots of other operations together.</p>
</div>
<div class="section" id="async">
<h3>Async<a class="headerlink" href="#async" title="Permalink to this headline">¶</a></h3>
<p>Refers to a task that is configured to run in the background rather than waiting for completion.  If you have a long process
that would run longer than the SSH timeout, it would make sense to launch that task in async mode.  Async modes can poll
for completion every so many seconds, or can be configured to &#8220;fire and forget&#8221; in which case Ansible will not even
check on the task again, it will just kick it off and proceed to future steps.  Async modes work with both /usr/bin/ansible
and /usr/bin/ansible-playbook.</p>
</div>
<div class="section" id="callback-plugin">
<h3>Callback Plugin<a class="headerlink" href="#callback-plugin" title="Permalink to this headline">¶</a></h3>
<p>Refers to some user-written code that can intercept results from Ansible and do something with them.  Some supplied examples
in the GitHub project perform custom logging, send email, or even play sound effects.</p>
</div>
<div class="section" id="check-mode">
<h3>Check Mode<a class="headerlink" href="#check-mode" title="Permalink to this headline">¶</a></h3>
<p>Refers to running Ansible with the <code class="docutils literal"><span class="pre">--check</span></code> option, which does not make any changes on the remote systems, but only outputs the changes that
might occur if the command ran without this flag.  This is analogous to so-called &#8220;dry run&#8221; modes in other systems, though the user should
be warned that this does not take into account unexpected command failures or cascade effects (which is true of similar modes in other
systems).  Use this to get an idea of what might happen, but it is not a substitute for a good staging environment.</p>
</div>
<div class="section" id="connection-type-connection-plugin">
<h3>Connection Type, Connection Plugin<a class="headerlink" href="#connection-type-connection-plugin" title="Permalink to this headline">¶</a></h3>
<p>By default, Ansible talks to remote machines through pluggable libraries.  Ansible supports native OpenSSH (&#8216;ssh&#8217;), or a Python
implementation called &#8216;paramiko&#8217;.  OpenSSH is preferred if you are using a recent version, and also enables some features
like Kerberos and jump hosts.  This is covered in the getting started section.
There are also other connection types like &#8216;accelerate&#8217; mode, which must be bootstrapped
over one of the SSH-based connection types but is very fast, and local mode, which acts on the local system.
Users can also write their own connection plugins.</p>
</div>
<div class="section" id="conditionals">
<h3>Conditionals<a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h3>
<p>A conditional is an expression that evaluates to true or false that decides whether a given task will be executed on a given
machine or not.   Ansible&#8217;s conditionals are powered by the &#8216;when&#8217; statement, and are
discussed in the playbook documentation.</p>
</div>
<div class="section" id="diff-mode">
<h3>Diff Mode<a class="headerlink" href="#diff-mode" title="Permalink to this headline">¶</a></h3>
<p>A <code class="docutils literal"><span class="pre">--diff</span></code> flag can be passed to Ansible to show how template files change when they are overwritten, or how they might change when used
with <code class="docutils literal"><span class="pre">--check</span></code> mode.   These diffs come out in unified diff format.</p>
</div>
<div class="section" id="facts">
<h3>Facts<a class="headerlink" href="#facts" title="Permalink to this headline">¶</a></h3>
<p>Facts are simply things that are discovered about remote nodes.  While they can be used in playbooks and templates just like variables, facts
are things that are inferred, rather than set.  Facts are automatically discovered by Ansible when running plays by executing the internal &#8216;setup&#8217;
module on the remote nodes.  You never have to call the setup module explicitly, it just runs, but it can be disabled to save time if it is
not needed.  For the convenience of users who are switching from other configuration management systems, the fact module will also pull in facts from the &#8216;ohai&#8217; and &#8216;facter&#8217;
tools if they are installed, which are fact libraries from Chef and Puppet, respectively.</p>
</div>
<div class="section" id="filter-plugin">
<h3>Filter Plugin<a class="headerlink" href="#filter-plugin" title="Permalink to this headline">¶</a></h3>
<p>A filter plugin is something that most users will never need to understand.  These allow for the creation of new Jinja2 filters, which
are more or less only of use to people who know what Jinja2 filters are.  If you need them, you can learn how to write them in the API
docs section.</p>
</div>
<div class="section" id="forks">
<h3>Forks<a class="headerlink" href="#forks" title="Permalink to this headline">¶</a></h3>
<p>Ansible talks to remote nodes in parallel and the level of parallelism can be set either by passing <code class="docutils literal"><span class="pre">--forks</span></code>, or editing the default in a configuration
file.  The default is a very conservative 5 forks, though if you have a lot of RAM, you can easily set this to a value like 50 for increased
parallelism.</p>
</div>
<div class="section" id="gather-facts-boolean">
<h3>Gather Facts (Boolean)<a class="headerlink" href="#gather-facts-boolean" title="Permalink to this headline">¶</a></h3>
<p>Facts are mentioned above.  Sometimes when running a multi-play playbook, it is desirable to have some plays that don&#8217;t bother with fact
computation if they aren&#8217;t going to need to utilize any of these values.  Setting <cite>gather_facts: False</cite> on a playbook allows this implicit
fact gathering to be skipped.</p>
</div>
<div class="section" id="globbing">
<h3>Globbing<a class="headerlink" href="#globbing" title="Permalink to this headline">¶</a></h3>
<p>Globbing is a way to select lots of hosts based on wildcards, rather than the name of the host specifically, or the name of the group
they are in.  For instance, it is possible to select &#8220;www*&#8221; to match all hosts starting with &#8220;www&#8221;.   This concept is pulled directly
from Func, one of Michael&#8217;s earlier projects.  In addition to basic globbing, various set operations are also possible, such as
&#8216;hosts in this group and not in another group&#8217;, and so on.</p>
</div>
<div class="section" id="group">
<h3>Group<a class="headerlink" href="#group" title="Permalink to this headline">¶</a></h3>
<p>A group consists of several hosts assigned to a pool that can be conveniently targeted together, and also given variables that they share in
common.</p>
</div>
<div class="section" id="group-vars">
<h3>Group Vars<a class="headerlink" href="#group-vars" title="Permalink to this headline">¶</a></h3>
<p>The &#8220;group_vars/&#8221; files are files that live in a directory alongside an inventory file, with an optional filename named after each group.
This is a convenient place to put variables that will be provided to a given group, especially complex data structures, so that these
variables do not have to be embedded in the inventory file or playbook.</p>
</div>
<div class="section" id="handlers">
<h3>Handlers<a class="headerlink" href="#handlers" title="Permalink to this headline">¶</a></h3>
<p>Handlers are just like regular tasks in an Ansible playbook (see Tasks), but are only run if the Task contains a &#8220;notify&#8221; directive and
also indicates that it changed something.  For example, if a config file is changed then the task referencing the config file templating
operation may notify a service restart handler.  This means services can be bounced only if they need to be restarted.
Handlers can be used for things other than service restarts, but service restarts are the most common usage.</p>
</div>
<div class="section" id="host">
<h3>Host<a class="headerlink" href="#host" title="Permalink to this headline">¶</a></h3>
<p>A host is simply a remote machine that Ansible manages.  They can have individual variables assigned to them, and can also be organized
in groups.  All hosts have a name they can be reached at (which is either an IP address or a domain name) and optionally a port number
if they are not to be accessed on the default SSH port.</p>
</div>
<div class="section" id="host-specifier">
<h3>Host Specifier<a class="headerlink" href="#host-specifier" title="Permalink to this headline">¶</a></h3>
<p>Each Play in Ansible maps a series of tasks (which define the role, purpose, or orders of a system) to a set of systems.</p>
<p>This &#8220;hosts:&#8221; directive in each play is often called the hosts specifier.</p>
<p>It may select one system, many systems, one or more groups, or even some hosts that are in one group and explicitly not in another.</p>
</div>
<div class="section" id="host-vars">
<h3>Host Vars<a class="headerlink" href="#host-vars" title="Permalink to this headline">¶</a></h3>
<p>Just like &#8220;Group Vars&#8221;, a directory alongside the inventory file named &#8220;host_vars/&#8221; can contain a file named after each hostname in
the inventory file, in YAML format.  This provides a convenient place to assign variables to the host without having to embed
them in the inventory file.  The Host Vars file can also be used to define complex data structures that can&#8217;t be represented in the
inventory file.</p>
</div>
<div class="section" id="lazy-evaluation">
<h3>Lazy Evaluation<a class="headerlink" href="#lazy-evaluation" title="Permalink to this headline">¶</a></h3>
<p>In general, Ansible evaluates any variables in playbook content at the last possible second, which means that if you define a data structure
that data structure itself can define variable values within it, and everything &#8220;just works&#8221; as you would expect.  This also means variable
strings can include other variables inside of those strings.</p>
</div>
<div class="section" id="lookup-plugin">
<h3>Lookup Plugin<a class="headerlink" href="#lookup-plugin" title="Permalink to this headline">¶</a></h3>
<p>A lookup plugin is a way to get data into Ansible from the outside world.  These are how such things as &#8220;with_items&#8221;, a basic looping plugin, are implemented,
but there are also lookup plugins like &#8220;with_file&#8221; which loads data from a file, and even ones for querying environment variables,
DNS text records, or key value stores.  Lookup plugins can also be accessed in templates, e.g., <code class="docutils literal"><span class="pre">{{</span> <span class="pre">lookup('file','/path/to/file')</span> <span class="pre">}}</span></code>.</p>
</div>
<div class="section" id="multi-tier">
<h3>Multi-Tier<a class="headerlink" href="#multi-tier" title="Permalink to this headline">¶</a></h3>
<p>The concept that IT systems are not managed one system at a time, but by interactions between multiple systems, and groups of systems, in
well defined orders.  For instance, a web server may need to be updated before a database server, and pieces on the web server may need
to be updated after <em>THAT</em> database server, and various load balancers and monitoring servers may need to be contacted.  Ansible models
entire IT topologies and workflows rather than looking at configuration from a &#8220;one system at a time&#8221; perspective.</p>
</div>
<div class="section" id="idempotency">
<h3>Idempotency<a class="headerlink" href="#idempotency" title="Permalink to this headline">¶</a></h3>
<p>The concept that change commands should only be applied when they need to be applied, and that it is better to describe the desired
state of a system than the process of how to get to that state.  As an analogy, the path from North Carolina in the United States to
California involves driving a very long way West, but if I were instead in Anchorage, Alaska, driving a long way west is no longer
the right way to get to California.  Ansible&#8217;s Resources like you to say &#8220;put me in California&#8221; and then decide how to get there.  If
you were already in California, nothing needs to happen, and it will let you know it didn&#8217;t need to change anything.</p>
</div>
<div class="section" id="includes">
<h3>Includes<a class="headerlink" href="#includes" title="Permalink to this headline">¶</a></h3>
<p>The idea that playbook files (which are nothing more than lists of plays) can include other lists of plays, and task lists
can externalize lists of tasks in other files, and similarly with handlers.  Includes can be parameterized, which means that the
loaded file can pass variables.  For instance, an included play for setting up a WordPress blog may take a parameter called &#8220;user&#8221;
and that play could be included more than once to create a blog for both &#8220;alice&#8221; and &#8220;bob&#8221;.</p>
</div>
<div class="section" id="inventory">
<h3>Inventory<a class="headerlink" href="#inventory" title="Permalink to this headline">¶</a></h3>
<p>A file (by default, Ansible uses a simple INI format) that describes Hosts and Groups in Ansible.  Inventory can also be provided
via an &#8220;Inventory Script&#8221; (sometimes called an &#8220;External Inventory Script&#8221;).</p>
</div>
<div class="section" id="inventory-script">
<h3>Inventory Script<a class="headerlink" href="#inventory-script" title="Permalink to this headline">¶</a></h3>
<p>A very simple program (or a complicated one) that looks up hosts, group membership for hosts, and variable information from an external
resource &#8211; whether that be a SQL database, a CMDB solution, or something like LDAP.  This concept was adapted from Puppet (where it is
called an &#8220;External Nodes Classifier&#8221;) and works more or less exactly the same way.</p>
</div>
<div class="section" id="jinja2">
<h3>Jinja2<a class="headerlink" href="#jinja2" title="Permalink to this headline">¶</a></h3>
<p>Jinja2 is the preferred templating language of Ansible&#8217;s template module.  It is a very simple Python template language that is generally
readable and easy to write.</p>
</div>
<div class="section" id="json">
<h3>JSON<a class="headerlink" href="#json" title="Permalink to this headline">¶</a></h3>
<p>Ansible uses JSON for return data from remote modules.  This allows modules to be written in any language, not just Python.</p>
</div>
<div class="section" id="library">
<h3>Library<a class="headerlink" href="#library" title="Permalink to this headline">¶</a></h3>
<p>A collection of modules made available to /usr/bin/ansible or an Ansible playbook.</p>
</div>
<div class="section" id="limit-groups">
<h3>Limit Groups<a class="headerlink" href="#limit-groups" title="Permalink to this headline">¶</a></h3>
<p>By passing <code class="docutils literal"><span class="pre">--limit</span> <span class="pre">somegroup</span></code> to ansible or ansible-playbook, the commands can be limited to a subset of hosts.  For instance,
this can be used to run a playbook that normally targets an entire set of servers to one particular server.</p>
</div>
<div class="section" id="local-connection">
<h3>Local Connection<a class="headerlink" href="#local-connection" title="Permalink to this headline">¶</a></h3>
<p>By using &#8220;connection: local&#8221; in a playbook, or passing &#8220;-c local&#8221; to /usr/bin/ansible, this indicates that we are managing the local
host and not a remote machine.</p>
</div>
<div class="section" id="local-action">
<h3>Local Action<a class="headerlink" href="#local-action" title="Permalink to this headline">¶</a></h3>
<p>A local_action directive in a playbook targeting remote machines means that the given step will actually occur on the local
machine, but that the variable &#8216;{{ ansible_hostname }}&#8217; can be passed in to reference the remote hostname being referred to in
that step.  This can be used to trigger, for example, an rsync operation.</p>
</div>
<div class="section" id="loops">
<h3>Loops<a class="headerlink" href="#loops" title="Permalink to this headline">¶</a></h3>
<p>Generally, Ansible is not a programming language. It prefers to be more declarative, though various constructs like &#8220;with_items&#8221;
allow a particular task to be repeated for multiple items in a list.  Certain modules, like yum and apt, are actually optimized
for this, and can install all packages given in those lists within a single transaction, dramatically speeding up total
time to configuration.</p>
</div>
<div class="section" id="modules">
<h3>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h3>
<p>Modules are the units of work that Ansible ships out to remote machines.   Modules are kicked off by either /usr/bin/ansible or
/usr/bin/ansible-playbook (where multiple tasks use lots of different modules in conjunction).  Modules can be implemented in any
language, including Perl, Bash, or Ruby &#8211; but can leverage some useful communal library code if written in Python.  Modules just
have to return JSON or simple key=value pairs.  Once modules are executed on remote machines, they are removed, so no long running
daemons are used.  Ansible refers to the collection of available modules as a &#8216;library&#8217;.</p>
</div>
<div class="section" id="notify">
<h3>Notify<a class="headerlink" href="#notify" title="Permalink to this headline">¶</a></h3>
<p>The act of a task registering a change event and informing a handler task that another action needs to be run at the end of the play.
If a handler is notified by multiple tasks, it will still be run only once.  Handlers are run in the order they are listed, not
in the order that they are notified.</p>
</div>
<div class="section" id="orchestration">
<h3>Orchestration<a class="headerlink" href="#orchestration" title="Permalink to this headline">¶</a></h3>
<p>Many software automation systems use this word to mean different things.  Ansible uses it as a conductor would conduct an orchestra.
A datacenter or cloud architecture is full of many systems, playing many parts &#8211; web servers, database servers, maybe load balancers,
monitoring systems, continuous integration systems, etc.  In performing any process, it is necessary to touch systems in particular orders,
often to simulate rolling updates or to deploy software correctly.  Some system may perform some steps, then others, then previous systems
already processed may need to perform more steps.  Along the way, emails may need to be sent or web services contacted.  Ansible
orchestration is all about modeling that kind of process.</p>
</div>
<div class="section" id="paramiko">
<h3>paramiko<a class="headerlink" href="#paramiko" title="Permalink to this headline">¶</a></h3>
<p>By default, Ansible manages machines over SSH.   The library that Ansible uses by default to do this is a Python-powered library called
paramiko.  The paramiko library is generally fast and easy to manage, though users desiring Kerberos or Jump Host support may wish to switch
to a native SSH binary such as OpenSSH by specifying the connection type in their playbook, or using the &#8220;-c ssh&#8221; flag.</p>
</div>
<div class="section" id="playbooks">
<h3>Playbooks<a class="headerlink" href="#playbooks" title="Permalink to this headline">¶</a></h3>
<p>Playbooks are the language by which Ansible orchestrates, configures, administers, or deploys systems.  They are called playbooks partially because it&#8217;s a sports analogy, and it&#8217;s supposed to be fun using them.  They aren&#8217;t workbooks :)</p>
</div>
<div class="section" id="plays">
<h3>Plays<a class="headerlink" href="#plays" title="Permalink to this headline">¶</a></h3>
<p>A playbook is a list of plays.  A play is minimally a mapping between a set of hosts selected by a host specifier (usually chosen by groups, but sometimes by hostname
globs) and the tasks which run on those hosts to define the role that those systems will perform. There
can be one or many plays in a playbook.</p>
</div>
<div class="section" id="pull-mode">
<h3>Pull Mode<a class="headerlink" href="#pull-mode" title="Permalink to this headline">¶</a></h3>
<p>By default, Ansible runs in push mode, which allows it very fine-grained control over when it talks to each system.  Pull mode is
provided for when you would rather have nodes check in every N minutes on a particular schedule.  It uses a program called ansible-pull and can also be set up (or reconfigured) using a push-mode playbook.  Most Ansible users use push mode, but pull mode is included for variety and the sake
of having choices.</p>
<p>ansible-pull works by checking configuration orders out of git on a crontab and then managing the machine locally, using the local
connection plugin.</p>
</div>
<div class="section" id="push-mode">
<h3>Push Mode<a class="headerlink" href="#push-mode" title="Permalink to this headline">¶</a></h3>
<p>Push mode is the default mode of Ansible. In fact, it&#8217;s not really a mode at all &#8211; it&#8217;s just how Ansible works when you aren&#8217;t
thinking about it.  Push mode allows Ansible to be fine-grained and conduct nodes through complex orchestration processes without
waiting for them to check in.</p>
</div>
<div class="section" id="register-variable">
<h3>Register Variable<a class="headerlink" href="#register-variable" title="Permalink to this headline">¶</a></h3>
<p>The result of running any task in Ansible can be stored in a variable for use in a template or a conditional statement.
The keyword used to define the variable is called &#8216;register&#8217;, taking its name from the idea of registers in assembly
programming (though Ansible will never feel like assembly programming).  There are an infinite number of variable names
you can use for registration.</p>
</div>
<div class="section" id="resource-model">
<h3>Resource Model<a class="headerlink" href="#resource-model" title="Permalink to this headline">¶</a></h3>
<p>Ansible modules work in terms of resources.   For instance, the file module will select a particular file
and ensure that the attributes of that resource match a particular model. As an example, we might wish to change the owner of /etc/motd
to &#8216;root&#8217; if it is not already set to root, or set its mode to &#8216;0644&#8217; if it is not already set to &#8216;0644&#8217;.  The resource models
are &#8216;idempotent&#8217; meaning change commands are not run unless needed, and Ansible will bring the system back to a desired
state regardless of the actual state &#8211; rather than you having to tell it how to get to the state.</p>
</div>
<div class="section" id="roles">
<h3>Roles<a class="headerlink" href="#roles" title="Permalink to this headline">¶</a></h3>
<p>Roles are units of organization in Ansible.  Assigning a role to a group of hosts (or a set of groups, or host patterns, etc.) implies that they should implement a specific behavior.  A role
may include applying certain variable values, certain tasks, and certain handlers &#8211; or just one or more of these things.  Because of the file structure associated with a role, roles become
redistributable units that allow you to share behavior among playbooks &#8211; or even with other users.</p>
</div>
<div class="section" id="rolling-update">
<h3>Rolling Update<a class="headerlink" href="#rolling-update" title="Permalink to this headline">¶</a></h3>
<p>The act of addressing a number of nodes in a group N at a time to avoid updating them all at once and bringing the system
offline.  For instance, in a web topology of 500 nodes handling very large volume, it may be reasonable to update 10 or 20
machines at a time, moving on to the next 10 or 20 when done.  The &#8220;serial:&#8221; keyword in an Ansible playbook controls the
size of the rolling update pool.  The default is to address the batch size all at once, so this is something that you must
opt-in to.  OS configuration (such as making sure config files are correct) does not typically have to use the rolling update
model, but can do so if desired.</p>
</div>
<div class="section" id="runner">
<h3>Runner<a class="headerlink" href="#runner" title="Permalink to this headline">¶</a></h3>
<p>A core software component of Ansible that is the power behind /usr/bin/ansible directly &#8211; and corresponds to the invocation
of each task in a playbook.  The Runner is something Ansible developers may talk about, but it&#8217;s not really user land
vocabulary.</p>
</div>
<div class="section" id="serial">
<h3>Serial<a class="headerlink" href="#serial" title="Permalink to this headline">¶</a></h3>
<p>See &#8220;Rolling Update&#8221;.</p>
</div>
<div class="section" id="sudo">
<h3>Sudo<a class="headerlink" href="#sudo" title="Permalink to this headline">¶</a></h3>
<p>Ansible does not require root logins, and since it&#8217;s daemonless, definitely does not require root level daemons (which can
be a security concern in sensitive environments).  Ansible can log in and perform many operations wrapped in a sudo command,
and can work with both password-less and password-based sudo.  Some operations that don&#8217;t normally work with sudo (like scp
file transfer) can be achieved with Ansible&#8217;s copy, template, and fetch modules while running in sudo mode.</p>
</div>
<div class="section" id="ssh-native">
<h3>SSH (Native)<a class="headerlink" href="#ssh-native" title="Permalink to this headline">¶</a></h3>
<p>Native OpenSSH as an Ansible transport is specified with &#8220;-c ssh&#8221; (or a config file, or a directive in the playbook)
and can be useful if wanting to login via Kerberized SSH or using SSH jump hosts, etc.  In 1.2.1, &#8216;ssh&#8217; will be used by default if the OpenSSH binary
on the control machine is sufficiently new.  Previously, Ansible selected &#8216;paramiko&#8217; as a default.
Using a client that supports ControlMaster and ControlPersist is recommended for maximum performance &#8211; if you don&#8217;t have that and don&#8217;t need Kerberos, jump hosts, or other features, paramiko is a good choice.  Ansible will warn you if it doesn&#8217;t detect ControlMaster/ControlPersist capability.</p>
</div>
<div class="section" id="tags">
<h3>Tags<a class="headerlink" href="#tags" title="Permalink to this headline">¶</a></h3>
<p>Ansible allows tagging resources in a playbook with arbitrary keywords, and then running only the parts of the playbook that
correspond to those keywords.  For instance, it is possible to have an entire OS configuration, and have certain steps
labeled &#8220;ntp&#8221;, and then run just the &#8220;ntp&#8221; steps to reconfigure the time server information on a remote host.</p>
</div>
<div class="section" id="tasks">
<h3>Tasks<a class="headerlink" href="#tasks" title="Permalink to this headline">¶</a></h3>
<p>Playbooks exist to run tasks.  Tasks combine an action (a module and its arguments) with a name and optionally some other keywords (like looping directives).   Handlers are also tasks, but they are a special kind of task that do not run unless they are notified by name when a task reports an underlying change on a remote system.</p>
</div>
<div class="section" id="templates">
<h3>Templates<a class="headerlink" href="#templates" title="Permalink to this headline">¶</a></h3>
<p>Ansible can easily transfer files to remote systems, but often it is desirable to substitute variables in other files.  Variables
may come from the inventory file, Host Vars, Group Vars, or Facts. Templates use the Jinja2 template engine and can also include logical
constructs like loops and if statements.</p>
</div>
<div class="section" id="transport">
<h3>Transport<a class="headerlink" href="#transport" title="Permalink to this headline">¶</a></h3>
<p>Ansible uses &#8220;Connection Plugins&#8221; to define types of available transports.  These are simply how Ansible will reach out to managed systems.  Transports included are paramiko, SSH (using OpenSSH), and local.</p>
</div>
<div class="section" id="when">
<h3>When<a class="headerlink" href="#when" title="Permalink to this headline">¶</a></h3>
<p>An optional conditional statement attached to a task that is used to determine if the task should run or not. If the expression following the &#8220;when:&#8221; keyword evaluates to false, the task will be ignored.</p>
</div>
<div class="section" id="van-halen">
<h3>Van Halen<a class="headerlink" href="#van-halen" title="Permalink to this headline">¶</a></h3>
<p>For no particular reason, other than the fact that Michael really likes them, all Ansible releases are codenamed after Van Halen songs.  There is no preference given to David Lee Roth vs. Sammy Lee Hagar-era songs, and instrumentals are also allowed.  It is unlikely that there will ever be a Jump release, but a Van Halen III codename release is possible.  You never know.</p>
</div>
<div class="section" id="vars-variables">
<h3>Vars (Variables)<a class="headerlink" href="#vars-variables" title="Permalink to this headline">¶</a></h3>
<p>As opposed to Facts, variables are names of values (they can be simple scalar values &#8211; integers, booleans, strings) or complex ones (dictionaries/hashes, lists) that can be used in templates and playbooks.  They are declared things, not things that are inferred from the remote system&#8217;s current state or nature (which is what Facts are).</p>
</div>
<div class="section" id="yaml">
<h3>YAML<a class="headerlink" href="#yaml" title="Permalink to this headline">¶</a></h3>
<p>Ansible does not want to force people to write programming language code to automate infrastructure, so Ansible uses YAML to define playbook configuration languages and also variable files.  YAML is nice because it has a minimum of syntax and is very clean and easy for people to skim.  It is a good data format for configuration files and humans, but also machine readable.  Ansible&#8217;s usage of YAML stemmed from Michael&#8217;s first use of it inside of Cobbler around 2006.  YAML is fairly popular in the dynamic language community and the format has libraries available
for serialization in many languages (Python, Perl, Ruby, etc.).</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/faq"><em>常见问题</em></a></dt>
<dd>Frequently asked questions</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="index.html#document-docs/playbooks_best_practices"><em>最佳实践</em></a></dt>
<dd>Best practices advice</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-devel">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
<span id="document-docs/YAMLSyntax"></span><div class="section" id="yaml">
<h2>YAML 语法<a class="headerlink" href="#yaml" title="Permalink to this headline">¶</a></h2>
<p>这个页面提供一个正确的 YAML 语法的基本概述, 它被用来描述一个 playbooks(我们的配置管理语言).</p>
<p>我们使用 YAML 是因为它像 XML 或 JSON 是一种利于人们读写的数据格式. 此外在大多数变成语言中有使用 YAML 的库.</p>
<p>你可能希望读 <a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a> 实践中如何使用的.</p>
<div class="section" id="id1">
<h3>基本的 YAML<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>对于 Ansible, 每一个 YAML 文件都是从一个列表开始. 列表中的每一项都是一个键值对, 通常它们被称为一个 &#8220;哈希&#8221; 或 &#8220;字典&#8221;. 所以, 我们需要知道如何在 YAML 中编写列表和字典.</p>
<p>YAML 还有一个小的怪癖. 所有的 YAML 文件(无论和 Ansible 有没有关系)开始行都应该是 <code class="docutils literal"><span class="pre">---</span></code>.  这是 YAML 格式的一部分, 表明一个文件的开始.</p>
<p>列表中的所有成员都开始于相同的缩进级别, 并且使用一个 <code class="docutils literal"><span class="pre">&quot;-</span> <span class="pre">&quot;</span></code> 作为开头(一个横杠和一个空格):</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># 一个美味水果的列表</span>
- Apple
- Orange
- Strawberry
- Mango
</pre></div>
</div>
<p>一个字典是由一个简单的 <code class="docutils literal"><span class="pre">键:</span> <span class="pre">值</span></code> 的形式组成(这个冒号后面必须是一个空格):</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># 一位职工的记录</span>
name: Example Developer
job: Developer
skill: Elite
</pre></div>
</div>
<p>字典也可以使用缩进形式来表示, 如果你喜欢这样的话:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># 一位职工的记录</span>
<span class="o">{</span>name: Example Developer, job: Developer, skill: Elite<span class="o">}</span>
</pre></div>
</div>
<p id="truthiness">Ansible并不是太多的使用这种格式, 但是你可以通过以下格式来指定一个布尔值(true/fase):</p>
<div class="highlight-bash"><div class="highlight"><pre>---
create_key: yes
needs_agent: no
knows_oop: True
likes_emacs: TRUE
uses_cvs: <span class="nb">false</span>
</pre></div>
</div>
<p>让我们把目前所学到的 YAML 例子组合在一起. 这些在 Ansible 中什么也干不了, 但这些格式将会给你感觉:</p>
<div class="highlight-bash"><div class="highlight"><pre>---
<span class="c"># 一位职工记录</span>
name: Example Developer
job: Developer
skill: Elite
employed: True
foods:
    - Apple
    - Orange
    - Strawberry
    - Mango
languages:
    ruby: Elite
    python: Elite
    dotnet: Lame
</pre></div>
</div>
<p>这就是你开始编写 <cite>Ansible</cite> playbooks 所需要知道的所有 YAML 语法.</p>
</div>
<div class="section" id="gotchas">
<h3>Gotchas<a class="headerlink" href="#gotchas" title="Permalink to this headline">¶</a></h3>
<p>尽管 YAML 通常是友好的, 但是下面将会导致一个 YAML 语法错误:</p>
<div class="highlight-bash"><div class="highlight"><pre>foo: somebody said I should put a colon here: so I did
</pre></div>
</div>
<p>你需要使用引号来包裹任何包含冒号的哈希值, 像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>foo: <span class="s2">&quot;somebody said I should put a colon here: so I did&quot;</span>
</pre></div>
</div>
<p>然后这个冒号将会被结尾.</p>
<p>此外, Ansible 使用 &#8220;{{ var }}&#8221; 来引用变量. 如果一个值以 &#8220;{&#8221; 开头, YAML 将认为它是一个字典, 所以我们必须引用它, 像这样:</p>
<div class="highlight-bash"><div class="highlight"><pre>foo: <span class="s2">&quot;{{ variable }}&quot;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="index.html#document-docs/playbooks"><em>Playbooks</em></a></dt>
<dd>Learn what playbooks can do and how to write/run them.</dd>
<dt><a class="reference external" href="http://yamllint.com/">YAMLLint</a></dt>
<dd>YAML Lint (online) helps you debug YAML syntax if you are having problems</dd>
<dt><a class="reference external" href="https://github.com/ansible/ansible-examples">Github examples directory</a></dt>
<dd>Complete playbook files from the github project source</dd>
<dt><a class="reference external" href="http://groups.google.com/group/ansible-project">Mailing List</a></dt>
<dd>Questions? Help? Ideas?  Stop by the list on Google Groups</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, www.magedu.com, AUTHORS: 薛定谔的章鱼 &amp; guli &amp; 以马内利 &amp; 黄博文 &amp; stanley.
      
        <span class="commit">
          Revision <code>4bdb8e9a</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//readthedocs.org/projects/ansible-tran/downloads/htmlzip/latest/">htmlzip</a></dd>
        
          <dd><a href="//readthedocs.org/projects/ansible-tran/downloads/epub/latest/">epub</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/ansible-tran/?fromdocs=ansible-tran">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/ansible-tran/?fromdocs=ansible-tran">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
      <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
      <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
      <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
      <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>

  

  
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>